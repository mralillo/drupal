<?php
/**
  * Implementación hook_init()
**/
function oficina_init(){

//drupal_add_js(drupal_get_path('module', 'oficina') , '/oficina.js');

}


/**
 * Implementation hook_menu()
**/

function oficina_menu() {
/*variables*/
$items=array();

/************** Cursos Académicos **************/
 $items['oficina/cursos_oficiales']=array(	
 'title' => 'CURSOS OFICIALES',
 'page callback' => 'listar_unidades',
 'page arguments' => array('Unidades'),
 'access callback' => TRUE,
 'type' => MENU_NORMAL_ITEM,
 'weight' => -1,
 );
 $items['oficina/cursos_oficiales/unidades']=array(
 'title' => 'Unidades',
 'access arguments' => array('Unidades'),
 'type' => MENU_DEFAULT_LOCAL_TASK,
 'weight' => 0,
 );
 $items['oficina/cursos_oficiales/cursos']=array(
 'title' => 'Cursos',
 'access arguments' => array('Cursos'),
 'access callback'=> TRUE,
 'page callback' => 'listar_cursos',
 'type' => MENU_LOCAL_TASK,
 'weight' => 1,
 ); 
$items['oficina/cursos_oficiales/ciclos']=array(
 'title' => 'Ciclos',
 'access arguments' => array('Ciclos'),
 'access callback'=> TRUE,
 'page callback' => 'listar_ciclos',
 'type' => MENU_LOCAL_TASK,
 'weight' => 2,
 );

$items['oficina/cursos_oficiales/convocatorias']=array(
 'title' => 'Convocatorias',
 'access arguments' => array('Convocatorias'),
 'access callback'=> TRUE,
 'page callback' => 'listar_convocatorias',
 'type' => MENU_LOCAL_TASK,
 'weight' => 3,
 );
/******** Cursos ********/

$items['oficina/cursos_oficiales/cursos/listar_cursos']=array(
 'title' => 'Listar Cursos',
 'access arguments' => array('Cursos'),
 'access callback'=> TRUE,
 'page callback' => 'listar_cursos',
 'page arguments' => array(2),
 'type' => MENU_LOCAL_TASK,
 'weight'=> 0,
 ); 
$items['oficina/cursos_oficiales/cursos/alta_curso'] = array(
 'title' => 'Alta Curso',
 'access arguments' => array('Cursos'),
 'access callback'=> TRUE,
 'page callback' => 'alta_curso',
 'page arguments' => array(2), 
 'type' => MENU_LOCAL_TASK,
 'weight'=> 2,	
 );
 $items['oficina/cursos_oficiales/cursos/baja_curso'] = array(
 'title' => 'Baja Curso',
 'access arguments' => array('Cursos'),
 'access callback'=> TRUE,
 'page callback' => 'baja_curso',
 'page arguments' => array(2), 
 'type' => MENU_LOCAL_TASK,
 'weight'=> 3,
 );
$items['oficina/cursos_oficiales/cursos/modificar_curso'] = array(
 'title' => 'Modificar Curso',
 'access arguments' => array('Cursos'),
 'access callback'=> TRUE,
 'page callback' => 'modificar_curso',
 'page arguments' => array(2),
 'type' => MENU_LOCAL_TASK,
 'weight'=> 1,
 );

/******** Ciclos ********/

$items['oficina/cursos_oficiales/ciclos/listar_ciclos'] = array(
 'title' => 'Listar Ciclos',
 'access arguments' => array('Ciclos'),
 'access callback'=> TRUE,
 'page callback' => 'listar_ciclos',
 'page arguments' => array(2),
 'type' => MENU_LOCAL_TASK,
 'weight'=> 0,
 ); 
$items['oficina/cursos_oficiales/ciclos/alta_ciclo'] = array(
 'title' => 'Alta Ciclo',
 'access arguments' => array('Ciclos'),
 'access callback'=> TRUE,
 'page callback' => 'alta_ciclo',
 'page arguments' => array(2), 
 'type' => MENU_LOCAL_TASK,
 'weight'=> 2,
 );
 $items['oficina/cursos_oficiales/ciclos/baja_ciclo'] = array(
 'title' => 'Baja Ciclo',
 'access arguments' => array('Ciclos'),
 'access callback'=> TRUE,
 'page callback' => 'baja_ciclo',
 'page arguments' => array(2), 
 'type' => MENU_LOCAL_TASK,
 'weight'=> 3,
 );
$items['oficina/cursos_oficiales/ciclos/modificar_ciclo'] = array(
 'title' => 'Modificar Ciclo',
 'access arguments' => array('Ciclos'),
 'access callback'=> TRUE,
 'page callback' => 'modificar_ciclo',
 'page arguments' => array(2),
 'type' => MENU_LOCAL_TASK,
 'weight'=> 1,
 );

/******** Unidades ********/

$items['oficina/cursos_oficiales/unidades/listar_unidades'] = array(
 'title' => 'Listar Unidades',
 'access arguments' => array('Unidades'),
 'access callback'=> TRUE,
 'page callback' => 'listar_unidades',
 'page arguments' => array(2),
 'type' => MENU_LOCAL_TASK,
 'weight'=> 0,
 ); 
$items['oficina/cursos_oficiales/unidades/alta_unidad'] = array(
 'title' => 'Alta Unidad',
 'access arguments' => array('Unidades'),
 'access callback'=> TRUE,
 'page callback' => 'alta_unidad',
 'page arguments' => array(2), 
 'type' => MENU_LOCAL_TASK,
 'weight'=> 2,
 );
 $items['oficina/cursos_oficiales/unidades/baja_unidad'] = array(
 'title' => 'Baja Unidad',
 'access arguments' => array('Unidades'),
 'access callback'=> TRUE,
 'page callback' => 'baja_unidad',
 'page arguments' => array(2), 
 'type' => MENU_LOCAL_TASK,
 'weight'=> 3,
 );
$items['oficina/cursos_oficiales/unidades/modificar_unidad'] = array(
 'title' => 'Modificar Unidad',
 'access arguments' => array('Unidades'),
 'access callback'=> TRUE,
 'page callback' => 'modificar_unidad',
 'page arguments' => array(2), 
 'type' => MENU_LOCAL_TASK,
 'weight'=> 1,
 );
/******** Convocatorias ********/

$items['oficina/cursos_oficiales/convocatorias/listar_convocatorias'] = array(
 'title' => 'Listar Convocatorias',
 'access arguments' => array('Convocatorias'),
 'access callback'=> TRUE,
 'page callback' => 'listar_convocatorias',
 'page arguments' => array(2),
 'type' => MENU_LOCAL_TASK,
 'weight'=> 0,
 ); 
$items['oficina/cursos_oficiales/convocatorias/alta_convocatoria'] = array(
 'title' => 'Alta Convocatoria',
 'access arguments' => array('Convocatorias'),
 'access callback'=> TRUE,
 'page callback' => 'alta_convocatoria',
 'page arguments' => array(2), 
 'type' => MENU_LOCAL_TASK,
 'weight'=> 2,
 );
 $items['oficina/cursos_oficiales/convocatorias/baja_convocatoria'] = array(
 'title' => 'Baja Convocatoria',
 'access arguments' => array('Convocatorias'),
 'access callback'=> TRUE,
 'page callback' => 'baja_convocatoria',
 'page arguments' => array(2), 
 'type' => MENU_LOCAL_TASK,
 'weight'=> 3,
 );
$items['oficina/cursos_oficiales/convocatorias/modificar_convocatoria'] = array(
 'title' => 'Modificar Convocatoria',
 'access arguments' => array('Convocatorias'),
 'access callback'=> TRUE,
 'page callback' => 'modificar_convocatoria',
 'page arguments' => array(2),
 'type' => MENU_LOCAL_TASK,
 'weight'=> 1,
 );

/*************** Departamentos *****************/
$items['oficina/departamentos']=array(		
	'title' => 'DEPARTAMENTOS',
	'access arguments'=> array('Listar Departamentos'),
	'page callback' => 'listar_departamentos',
	'access callback'=> TRUE,
	'type'=> MENU_NORMAL_ITEM,
	'weight'=> -1,
	);

$items['oficina/departamentos/listar_departamentos']=array(
	'title' => 'Listar Departamentos',
	'access arguments'=> array('Listar Departamentos'),
	'type'=> MENU_DEFAULT_LOCAL_TASK,
	'weight'=> 0,
	);
$items['oficina/departamentos/alta_departamento']=array(
 	'title' => 'Alta Departamento',
 	'access arguments' => array('Alta Departamento'),
	'access callback'=> TRUE,
 	'page callback' => 'alta_departamento',
 	'type' => MENU_LOCAL_TASK,
	'weight'=> 1,
 	); 
$items['oficina/departamentos/baja_departamento']=array(
	'title' => 'Baja Departamento',
	'access arguments'=> array('Baja Departamento'),
	'access callback'=> TRUE,
	'page callback' => 'baja_departamento',
	'type'=> MENU_LOCAL_TASK,
	'weight'=> 2,
	);
$items['oficina/departamentos/modificar_departamento']=array(
	'title' => 'Modificar Departamento',
	'access arguments'=> array('Modificar Departamento'),
	'access callback'=> TRUE,
	'page callback' => 'modificar_departamento',
	'type'=> MENU_LOCAL_TASK,
	'weight'=> 3,
	);
/*************** Docentes *****************/
$items['oficina/docentes']=array(	
	'title' => 'DOCENTES',
	'access arguments'=> array('Listar Docentes'),
	'page callback' => 'listar_docentes',
	'access callback'=> TRUE,
	'type'=> MENU_NORMAL_ITEM,
	'weight'=> -1,
	);
$items['oficina/docentes/listar_docentes']=array(
	'title' => 'Listar Docentes',
	'access arguments'=> array('Listar Docentes'),
	'type'=> MENU_DEFAULT_LOCAL_TASK,
	'weight'=> 0,
	);
$items['oficina/docentes/alta_docente']=array(
	'title' => 'Alta Docente',
	'access arguments'=> array('Alta Docente'),
	'access callback'=> TRUE,
	'page callback' => 'alta_docente',
	'type'=> MENU_LOCAL_TASK,
	'weight'=> 1,
	);//200
$items['oficina/docentes/baja_docente']=array(
	'title' => 'Baja Docente',
	'access arguments'=> array('Baja Docente'),
	'access callback'=> TRUE,
	'page callback' => 'baja_docente',
	'type'=> MENU_LOCAL_TASK,
 	'weight'=> 2,
	);
$items['oficina/docentes/modificar_docente']=array(
	'title' => 'Modificar Docente',
	'access arguments'=> array('Modificar Docente'),
	'access callback'=> TRUE,
	'page callback' => 'modificar_docente',
	'type'=> MENU_LOCAL_TASK,
	'weight'=> 3,
	);	
/****************** Estudiantes ******************/

$items['oficina/estudiantes']=array(		
	'title' => 'ESTUDIANTES',
	'access arguments'=> array('Listar estudiantes'),
	'page callback' => 'listar_estudiantes',
	'access callback'=> TRUE,
	'type'=> MENU_NORMAL_ITEM,
	'weight'=> -1,
	);
$items['oficina/estudiantes/listar_estudiantes']=array(
	'title' => 'Listar Estudiantes',
	'access arguments'=> array('Listar estudiantes'),
	'type'=> MENU_DEFAULT_LOCAL_TASK,
	'weight'=> 0,
	);
$items['oficina/estudiantes/alta_estudiante']=array(
	'title' => 'Alta Estudiante',
	'access arguments'=> array('Alta Estudiante'),
	'access callback'=> TRUE,
	'page callback' => 'alta_estudiante',
	'type'=> MENU_LOCAL_TASK,
	'weight'=> 1,
	);
$items['oficina/estudiantes/baja_estudiante']=array(
	'title' => 'Baja Estudiante',
	'access arguments'=> array('Baja Estudiante'),
	'access callback'=> TRUE,
	'page callback' => 'baja_estudiante',
	'type'=> MENU_LOCAL_TASK,
	'weight'=> 2,
	);
$items['oficina/estudiantes/modificar_estudiante']=array(
	'title' => 'Modificar Estudiante',
	'access arguments'=> array('Modificar Estudiante'),//250
	'access callback'=> TRUE,
	'page callback' => 'modificar_estudiante',
	'type'=> MENU_LOCAL_TASK,
	'weight'=> 3,
	);	
/***************** Expedientes  *************/

$items['oficina/historial_de_expedientes']=array(	
	'title' => 'HISTORIAL DE EXPEDIENTES',
	'access arguments' => array('Historial de Expedientes'),
	'page callback' => 'listar_historial',   //527
	'access callback'=> TRUE,
	'type' => MENU_NORMAL_ITEM,
	'weight'=> -1,
	);
$items['oficina/historial_de_expedientes/listar_historial']=array(
	'title' => 'Listar Historial de Expedientes',
	'access arguments'=> array('Listar Historial de Expedientes'),
	'type'=> MENU_DEFAULT_LOCAL_TASK,
	'weight'=> 0,
	);
$items['oficina/historial_de_expedientes/alta_historial']=array(
	'title' => 'Alta Historial de Expediente',
	'access arguments'=> array('Alta Historial de Expediente'),
	'access callback'=> TRUE,
	'page callback' => 'alta_historial',
	'type'=> MENU_LOCAL_TASK,
	'weight'=> 1,
	);
$items['oficina/historial_de_expedientes/baja_historial']=array(
	'title' => 'Baja Historial de Expediente',
	'access arguments'=> array('Baja Historial de Expediente'),
	'access callback'=> TRUE,
	'page callback' => 'baja_historial',
	'type'=> MENU_LOCAL_TASK,
	'weight'=> 2,
	);
$items['oficina/historial_de_expedientes/modificar_historial']=array(
	'title' => 'Modificar Historial de Expediente',
	'access arguments'=> array('Modificar Historial de Expediente'),
	'access callback'=> TRUE,
	'page callback' => 'modificar_historial',//300
	'type'=> MENU_LOCAL_TASK,
	'weight'=> 3,
	);

/**************** Materias *****************/

$items['oficina/materias']=array(	
	'title' => 'MATERIAS',
	'access arguments'=> array('Listar Materias'),
	'page callback' => 'listar_materias',
	'access callback'=> TRUE,
	'type'=> MENU_NORMAL_ITEM,
	'weight'=> -1,
	);	
$items['oficina/materias/listar_materias']=array(
	'title' => 'Listar Materias',
	'access arguments'=> array('Listar Materias'),
	'type'=> MENU_DEFAULT_LOCAL_TASK,
	'weight'=> 0,
	);
$items['oficina/materias/alta_materia']=array(
	'title' => 'Alta Materia',
	'access arguments'=> array('Alta Materia'),
	'access callback'=> TRUE,
	'page callback' => 'alta_materia',
	'type'=> MENU_LOCAL_TASK,
	'weight'=> 1,
	);
$items['oficina/materias/baja_materia']=array(
	'title' => 'Baja Materia',
	'access arguments'=> array('Baja Materia'),
	'access callback'=> TRUE,
	'page callback' => 'baja_materia',
	'type'=> MENU_LOCAL_TASK,
	'weight'=> 2,
	);
$items['oficina/materias/modificar_materia']=array(
	'title' => 'Modificar Materia',
	'access arguments'=> array('Modificar Materia'),
	'access callback'=> TRUE,
	'page callback' => 'modificar_materia',//300
	'type'=> MENU_LOCAL_TASK,
	'weight'=> 3,
	);

$items['oficina/materias/asignar_materia']=array(
	'title' => 'Asignar Materias del Curso',
	'access arguments'=> array('Asignar Materias del Curso'),
	'access callback'=> TRUE,
	'page callback' => 'asignar_materia',//300
	'type'=> MENU_LOCAL_TASK,
	'weight'=> 4,
	);

$items['oficina/materias/anular_materia']=array(
	'title' => 'Anular Materias del Curso',
	'access arguments'=> array('Anular Materias del Curso'),
	'access callback'=> TRUE,
	'page callback' => 'anular_materia',//300
	'type'=> MENU_LOCAL_TASK,
	'weight'=> 5,
	);
/************** Registro (matrículas) *************/

$items['oficina/registro_de_estudiantes']=array(	
	'title' => 'REGISTRO DE ESTUDIANTES',
	'access arguments'=> array('Listar Registros'),
	'page callback' => 'listar_registros',
	'access callback'=> TRUE,
	'type'=> MENU_NORMAL_ITEM,
	'weight'=> -1,
	);	
$items['oficina/registro_de_estudiantes/listar_registros']=array(
	'title' => 'Listar Registros',
	'access arguments'=> array('Listar Registros'),
	'type'=> MENU_DEFAULT_LOCAL_TASK,
	'weight'=> 0,
	);
$items['oficina/registro_de_estudiantes/alta_registro']=array(
	'title' => 'Alta Registro',
	'access arguments'=> array('Alta Registro'),
	'access callback'=> TRUE,
	'page callback' => 'alta_registro',
	'type'=> MENU_LOCAL_TASK,
	'weight'=> 1,
	);
$items['oficina/registro_de_estudiantes/baja_registro']=array(
	'title' => 'Baja Registro',
	'access arguments'=> array('Baja Registro'),
	'access callback'=> TRUE,
	'page callback' => 'baja_registro',
	'type'=> MENU_LOCAL_TASK,
	'weight'=> 3,
	);
$items['oficina/registro_de_estudiantes/modificar_registro']=array(
	'title' => 'Modificar Registro',
	'access arguments'=> array('Modificar Registro'),
	'access callback'=> TRUE,
	'page callback' => 'modificar_registro',
	'type'=> MENU_LOCAL_TASK,
	'weight'=> 2,
	);

 return $items;
}

/**
 * Page callback
**/
/*function menufun_greeting($first_name = '', $last_name = ''){
 return t('Hello @first_name @last_name', array('@first_name' => $first_name, '@last_name' => $last_name));
}*/ 
//351

function overvie() {
 $output = t('The following flavors are available...');
 // ... more code here
 return $output;
 }
 
function agregare() {

if (!$_POST){
$output='<form id="formAlta" action="http://localhost/drupal/colegio/inicia/dptos" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formAlta">
	<legend align="left"><SPAN style="text-align:top">Introducir el nuevo departamento</SPAN></legend>
       <br><br>
	<p><SPAN style="text-align:center">   Nombre:   <input type="text" name="nombDpto"></SPAN></p>
	</fieldset>
	</p>
	<p><input type="submit" value="Grabar" style="font-weight:bold; color:black"><input type="reset" value="Borrar" style="font-weight:bold; color:black">  <input type="button" style="font-wight:bold" value="Salir">
	</p>
	</form>';
}
else{

$output = "Departamento nuevo: " . $_POST["nombDpto"];
}
 //return t('A handy form to add flavors might go here...');
return $output;
 }
 
 function listare($type) {
 return t('List @type flavors', array('@type' => $type));
 }
function baja_est() {
 return ('hola');
 }

/*********************
		**** Base de Datos Externa *****
						*******************************/
function bdexterna(){
$conn=mysqli_connect("localhost", "colegio", "colegio", "colegio");
	if (!$conn){
		die("Conexión ha fallado:" . mysqli_connect_error());
	}
mysqli_select_db($conn, "colegio");	
return($conn);
}

/**********
		*********************** Cursos oficiales ***********************
***********/


/**************Convocatorias*******************/

function listar_convocatorias(){
$output="";
$tamano_pagina="10";

if(array_key_exists('pagina', $_GET)){
	$pagina=$_GET["pagina"];
}
else{
	$pagina=1;
}

$conexion=bdexterna();

$sql="SELECT * FROM convocatorias";
$result=mysqli_query($conexion, $sql);
$total_filas=mysqli_num_rows($result);
$total_paginas=ceil($total_filas / $tamano_pagina);

$sql="SELECT * FROM convocatorias LIMIT " . (($pagina-1) * $tamano_pagina) . "," . $tamano_pagina;
$result=mysqli_query($conexion, $sql);
$output='<p align="center"><b><font size="4">Listado de tipos de Convocatorias</font></b></p>';
$output=$output . '<table border="2"><tr><th><font size="3">Identificador</font></th><th><font size="3">Nombre Convocatoria</font></th></tr>';
if($total_filas > 0){
	while ($row=mysqli_fetch_assoc($result)){
		$output=$output . '<tr><td><font color="blue" size="2">'. $row["ID_CONV"] . '</font></td><td><font color="blue" size="2">' . $row["NOMBRE"] . '</font></td></tr>';
	}
	$output=$output . '</table><br>';
}

mysqli_close($conexion);

if ($total_paginas > 1){
	for ($i=1;$i<=$total_paginas;$i++){
		if($pagina == $i){
			$output=$output . 'P&aacute;gina ' . $pagina . "&nbsp;&nbsp;";
		}
		else{
			$output=$output . '<a href="http://localhost/drupal/oficina/cursos_oficiales/convocatorias/listar_convocatorias?pagina=' . $i . '">P&aacute;gina ' . $i . '</a>&nbsp;&nbsp;';
		}

	}
}

return $output;
}

function alta_convocatoria(){
$output="";

if (!$_POST){
	$output='<form id="formAltaConv" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formAltaConv">
	<legend align="left"><SPAN style="text-align:top">Introducir una nueva convocatoria</SPAN></legend>
        <br><br>
	<p><SPAN style="text-align:center">&emsp;&nbsp;Nombre de Convocatoria:&nbsp;<input type="text" style="color:blue" name="nombConv" required autofocus></SPAN></p>
	</fieldset>
	</p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="submit" value="Agregar" style="font-weight:bold; color:black">
	</p>
	</form>';
 }elseif ($_POST["nombConv"] == ""){
		$output='<br><b>Atenci&oacute;n</b><br><br><p>No puede dar de alta una Convocatoria sin nombre</p><p>Para volver hacia atr&aacute;s&nbsp;<a href="http://localhost/drupal/oficina/cursos_oficiales/convocatorias/alta_convocatoria">pulse aqu&iacute;</a></p>'; 

	}
else{
	$conexion=bdexterna();

	$nombre=$_POST["nombConv"];
	
	mysqli_select_db($conexion, "colegio");
	$sql="INSERT INTO convocatorias (ID_CONV, NOMBRE) VALUES (NULL, '$nombre')";
	
	if(mysqli_query($conexion, $sql)){
		$ant_id=mysqli_insert_id($conexion);
		$output= '<p><b>Nueva convocatoria registrada satisfactoriamente con:</b></p>
		<p>Identificador&nbsp;<b>' . $ant_id . '</b></p> 
		<p>Nombre&nbsp; <b>' . $nombre . '</b></p>
		<br><br>
		<p align="center">Si desea agregar otro ciclo <a href="http://localhost/drupal/oficina/cursos_oficiales/convocatorias/alta_convocatoria">pulse aqu&iacute;</a></p>'; 
	}
	
	mysqli_close($conexion);
}
return $output;
}

function baja_convocatoria(){
$output="";
$conexion=bdexterna();	

if (!$_POST){
	$output='<form id="formBajaConv" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formBajaConv">
	<legend align="left"><SPAN style="text-align:top">Eliminar una convocatoria</SPAN></legend>
        <br><br>
	<p><SPAN style="text-align:top">&emsp;&nbsp;Seleccionar una convocatoria:&nbsp;<p align="center"><select name="nombConv" size="5" required>';
	
	$sql="SELECT nombre FROM convocatorias";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result) > 0){
		$cont=0;
		while($row=mysqli_fetch_assoc($result)){
			$output= $output . '<option>' . $row["nombre"] . '</option>';
			$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$lista='Lista sin convocatorias';  $output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}
	$output= $output . '</p></select></fieldset>
	</p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&emsp;&nbsp;';//923
	if ($error){
		$output= $output . '<input type="submit" name="Eliminar" value="Eliminar" style="font-weight:bold; color:black" disabled>';
	}else{
		$output= $output . '<input type="submit" name="Eliminar" value="Eliminar" style="font-weight:bold; color:black">';
	}
	$output= $output . '</p></form>';
} 
elseif(isset($_POST["Eliminar"])){
	$output='<form id="formConfirmarConv" action="" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formConfirmarConv">
	<legend align="left"><SPAN style="text-align:top">Confirmar Baja</SPAN></legend>
        <br><br><p align="center"> Seguro que desea dar de baja la convocatoria<b>&nbsp;"' . $_POST["nombConv"] . '"</b></p>
	<p align="center"><input type="submit" value="Aceptar" name="Aceptar" style="font-weight:bold; color:black">&emsp;
	<input type="submit" name="Cancelar" value="Cancelar" style="font-weight:bold; color:black">
	<input type="hidden" name="conv" value="' . $_POST["nombConv"] . '">
	</p></fieldset></p></form>';
}
else{
	$nombre=$_POST["conv"];
	if(isset($_POST["Aceptar"])){
		$sql="SELECT id_conv,nombre FROM convocatorias WHERE nombre='$nombre'";
		$row=mysqli_fetch_assoc(mysqli_query($conexion, $sql));
		//$sql="DELETE FROM convocatorias WHERE NOMBRE='$nombre'";
		//if(mysqli_query($conexion, $sql)){	
			$output= '<p><b>La convocatoria seleccionada se ha borrado satisfactoriamente con:</b></p>
			<p>Identificador&nbsp;<b>' . $row["id_conv"] . '</b></p> 
			<p>Nombre&nbsp;<b>' . $row["nombre"] . '</b></p><br><br>';
			$output=$output . '<p align="center">Si desea eliminar otro ciclo&nbsp;<a href="http://localhost/drupal/oficina/cursos_oficiales/convocatorias/baja_convocatoria">pulse aqu&iacute;</a></p>';		
		//}
		//else{
		//	$output='<p><b>Error al eliminar el registro con el nombre:&nbsp;' . $nombre . '<b></p>';
		//	$output=$output . '<p>'. mysqli_error($conexion) . '</p>';
		//}
	}else{
		$output='<br><br><b><p align="center">Operaci&oacute;n de eliminar convocatoria con el nombre<br>
		<font color="red">"' . $nombre . '"</font><br>ha sido cancelada</b>
		<br>
		<p align="center">Si desea volver al apartado "Baja Convocatoria"&nbsp;<a href="http://localhost/drupal/oficina/cursos_oficiales/convocatorias/baja_convocatoria">pulse aqu&iacute;</a></p>'; 
	}

}
mysqli_close($conexion);
return $output;
}

function modificar_convocatoria(){
$output="";
$error=false;

$conexion=bdexterna();
if (!$_POST){
	$output='<form id="formModConv" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formModConv">
	<legend align="left"><SPAN style="text-align:top">Cambiar una convocatoria</SPAN></legend>
        <br><br>
	<SPAN style="text-align:center">&emsp;&nbsp;Seleccionar una convocatoria:&nbsp;<p align="center"><select name="nombConv" size="5" required>';
	
	$sql="SELECT nombre FROM convocatorias";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result) > 0){
		$cont=0;
		while($row=mysqli_fetch_assoc($result)){
			$output= $output . '<option>' . $row["nombre"] . '</option>';
			//$id=$row["id_ciclo"];$conv=$row["num_conv"];
			$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$lista='Lista sin convocatorias';  $output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}
	$output= $output . '</select></p></SPAN>
	<p>&emsp;&nbsp;Introducir datos a modificar:</p>
	<p>&emsp;&nbsp;Nombre Convocatoria:&nbsp;<input type="text" style="color:blue" name="nuevoNomb"></p>';//945
	$output=$output . '</fieldset>
	</p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&emsp;&nbsp;';
	if ($error){
		$output= $output . '<input type="submit" value="Grabar" style="font-weight:bold; color:black" disabled>';
	}else{
		$output= $output . '<input type="submit" value="Grabar" style="font-weight:bold; color:black">';
	}
	$output= $output . '</p></form>';
} 
else{
	$nombre=$_POST["nombConv"];
	$nombnuevo=$_POST["nuevoNomb"];
	
	//mysqli_select_db($conexion, "colegio");
	$sql="SELECT ID_CONV FROM convocatorias WHERE NOMBRE='$nombre'";
	$result=mysqli_query($conexion, $sql);
	$id=mysqli_fetch_array($result);
	$num=$id[0];

	if ($nombnuevo == ""){
		$output='<br><br><font color="red"><b>Atenci&oacute;n</b></font><br><br><p>No ha introducido ning&uacute;n dato para actualizar el registro seleccionado:&nbsp;<b>' . $nombre . '</b></p>&nbsp;';
		$output=$output . '<br><p align="center">Para volver a intentarlo&nbsp;<a href="http://localhost/drupal/oficina/cursos_oficiales/convocatorias/modificar_convocatoria">pulse aqu&iacute;</a></p>';
	} 
	else{
		$output= '<br><br><p><b>Actualizaci&oacute;n del registro seleccionado.</b></p>'; 
		$sql="UPDATE convocatorias SET NOMBRE='$nombnuevo' WHERE ID_CONV= '$id[0]'";
			if(mysqli_query($conexion, $sql)){	
				$output=$output . '<p>El registro seleccionado, se ha actualizado con el nuevo nombre:&nbsp;<b>' . $nombnuevo . '</b></p>';
				$output=$output . '<br><p align="center">Si desea modificar otra convocatoria&nbsp;<a href="http://localhost/drupal/oficina/cursos_oficiales/convocatorias/modificar_convocatoria">pulse aqu&iacute;</a></p>';
			}
			else{
				$error=true;
			}
	}
	if ($error){
		$output='<p><b>Se ha producido un Error al actualizar el registro con el nombre:&nbsp;' . $nombre . '</b></p>';
		$output=$output . '<p>'. mysqli_error($conexion) . '</p>';
	}

} 
mysqli_close($conexion);
return $output;
}


/******** Ciclos **********/

function listar_ciclos(){
$output="";
$tamano_pagina="2";

if(array_key_exists('pagina', $_GET)){
	$pagina=$_GET["pagina"];
}
else{
	$pagina=1;
}

$conexion=bdexterna();

$sql="SELECT * FROM ciclos";
$result=mysqli_query($conexion, $sql);
$total_filas=mysqli_num_rows($result);
$total_paginas=ceil($total_filas / $tamano_pagina);

$sql="SELECT * FROM ciclos LIMIT " . (($pagina-1) * $tamano_pagina) . "," . $tamano_pagina;
$result=mysqli_query($conexion, $sql);
$output='<p align="center"><b><font size="4">Listado de los Ciclos del centro</font></b></p>';
$output=$output . '<table border="2"><tr><th><font size="3">Identificador</font></th><th><font size="3">Nombre Ciclo</font></th><th><font size="3">N&uacute;mero Convocatorias</font></th></tr>';
if($total_filas > 0){
	while ($row=mysqli_fetch_assoc($result)){
		$output=$output . '<tr><td><font color="blue" size="2">'. $row["ID_CICLO"] . '</font></td><td><font color="blue" size="2">' . $row["NOMBRE"] . '</font></td><td><font color="blue" size="2">' . $row["NUM_CONV"] . '</font></td></tr>';
	}
	$output=$output . '</table><br>';
}

mysqli_close($conexion);

if ($total_paginas > 1){
	for ($i=1;$i<=$total_paginas;$i++){
		if($pagina == $i){
			$output=$output . 'P&aacute;gina ' . $pagina . "&nbsp;&nbsp;";
		}
		else{
			$output=$output . '<a href="http://localhost/drupal/oficina/cursos_oficiales/ciclos/listar_ciclos?pagina=' . $i . '">P&aacute;gina ' . $i . '</a>&nbsp;&nbsp;';
		}

	}
}

return $output;
} 	/** end listar_ciclos **/


function alta_ciclo(){
$output="";//400

if (!$_POST){
	$output='<form id="formAltaCiclo" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formAltaCiclo">
	<legend align="left"><SPAN style="text-align:top">Introducir un nuevo ciclo</SPAN></legend>
        <br><br>
	<p><SPAN style="text-align:center">&emsp;&nbsp;Nombre de Ciclo:&nbsp;<input type="text" style="color:blue" name="nombCiclo" required autofocus></SPAN></p>
	<p><SPAN style="text-align:center">&emsp;&nbsp;N&uacute;mero de Convocatorias:&nbsp;<input type="number" style="color:blue" name="numConv" min="1" max="5" required placeholder="N&uacute;merico entre 1 y 5"></SPAN></p>
	</fieldset>
	</p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="submit" value="Agregar" style="font-weight:bold; color:black"> 
	</p>
	</form>';
 }elseif ($_POST["nombCiclo"] == ""){
		$output='<br><b>Atenci&oacute;n</b><br><br><p>No puede dar de alta un Ciclo sin nombre</p><p>Para volver hacia atr&aacute;s&nbsp;<a href="http://localhost/drupal/oficina/cursos_oficiales/ciclos/alta_ciclo">pulse aqu&iacute;</a></p>'; 

	}
else{
	$conexion=bdexterna();

	$nombre=$_POST["nombCiclo"];
	$Conv=$_POST["numConv"];
	
	mysqli_select_db($conexion, "colegio");
	$sql="INSERT INTO ciclos (ID_CICLO, NOMBRE, NUM_CONV) VALUES (NULL, '$nombre', '$Conv')";
	
	if(mysqli_query($conexion, $sql)){
		$ant_id=mysqli_insert_id($conexion);
		$output= '<p><b>Nuevo ciclo registrado satisfactoriamente con:</b></p>
		<p>Identificador&nbsp;<b>' . $ant_id . '</b></p> 
		<p>Nombre&nbsp; <b>' . $nombre . '</b></p>
		<p>N&uacute;mero de convocatorias&nbsp; <b>' . $Conv . '</b></p>
		<br><br>
		<p align="center">Si desea agregar otro ciclo <a href="http://localhost/drupal/oficina/cursos_oficiales/ciclos/alta_ciclo">pulse aqu&iacute;</a></p>'; 
	}
	
	mysqli_close($conexion);
}

return $output;

} 	/** end alta_ciclo **/


function baja_ciclo(){
$output="";
$conexion=bdexterna();	

if (!$_POST){
	$output='<form id="formBajaCiclo" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formBajaCiclo">
	<legend align="left"><SPAN style="text-align:top">Eliminar un ciclo</SPAN></legend>
        <br><br>
	<p><SPAN style="text-align:top">&emsp;&nbsp;Seleccionar un ciclo:&nbsp;<p align="center"><select name="nombCiclo" size="5" required>';
	$sql="SELECT nombre FROM ciclos";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result) > 0){
		$cont=0;
		while($row=mysqli_fetch_assoc($result)){
			$output= $output . '<option>' . $row["nombre"] . '</option>';
			$cont=$cont+1;
		}//501
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$lista='Lista sin ciclos';$output= $output . '<option selected>'. $lista . '</option>';
		$error=true;
	}
	$output= $output . '</p></select></fieldset>
	</p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&emsp;&nbsp;';
	if ($error){
		$output= $output . '<input type="submit" name="Eliminar" value="Eliminar" style="font-weight:bold; color:black" disabled>';  
	}else{
		$output= $output . '<input type="submit" name="Eliminar" value="Eliminar" style="font-weight:bold; color:black">';
	}
	$output= $output . '</p></form>';
} 
elseif(isset($_POST["Eliminar"])){
	$output='<form id="formConfirmarCiclo" action="" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formConfirmarCiclo">
	<legend align="left"><SPAN style="text-align:top">Confirmar Baja</SPAN></legend>
        <br><br><p align="center"> Seguro que desea dar de baja el ciclo<b>&nbsp;"' . $_POST["nombCiclo"] . '"</b></p>
	<p align="center"><input type="submit" value="Aceptar" name="Aceptar" style="font-weight:bold; color:black">&emsp;
	<input type="submit" name="Cancelar" value="Cancelar" style="font-weight:bold; color:black">
	<input type="hidden" name="ciclo" value="' . $_POST["nombCiclo"] . '">
	</p></fieldset></p></form>';
}
else{
	$nombre=$_POST["ciclo"];
	if(isset($_POST["Aceptar"])){
		$sql="SELECT id_ciclo,nombre FROM ciclos WHERE nombre='$nombre'";
		$row=mysqli_fetch_assoc(mysqli_query($conexion, $sql));
		//$sql="DELETE FROM ciclos WHERE NOMBRE='$nombre'";
		//if(mysqli_query($conexion, $sql)){	
			$output= '<p><b>El ciclo seleccionado se ha borrado satisfactoriamente con:</b></p>
			<p>Identificador&nbsp;<b>' . $row["id_ciclo"] . '</b></p> 
			<p>Nombre&nbsp;<b>' . $row["nombre"] . '</b></p><br><br>';
			$output=$output . '<p align="center">Si desea eliminar otro ciclo&nbsp;<a href="http://localhost/drupal/oficina/cursos_oficiales/ciclos/baja_ciclo">pulse aqu&iacute;</a></p>';		
		//}
		//else{
		//	$output='<p><b>Error al eliminar el registro con el nombre:&nbsp;' . $nombre . '<b></p>';
		//	$output=$output . '<p>'. mysqli_error($conexion) . '</p>';
		//}
	}else{
		$output='<br><br><b><p align="center">Operaci&oacute;n de eliminar ciclo con el nombre<br>
		<font color="red">"' . $nombre . '"</font><br>ha sido cancelada</b>
		<br>
		<p align="center">Si desea volver al apartado "Baja Ciclo"&nbsp;<a href="http://localhost/drupal/oficina/cursos_oficiales/ciclos/baja_ciclo">pulse aqu&iacute;</a></p>'; 
	}
}
mysqli_close($conexion);
return $output;

} 	/** end baja_ciclo **/

	
function modificar_ciclo(){
$output="";
$error=false;

$conexion=bdexterna();
if (!$_POST){
	$output='<form id="formModCiclo" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formModCiclo">
	<legend align="left"><SPAN style="text-align:top">Cambiar un ciclo</SPAN></legend>
        <br><br>
	<SPAN style="text-align:center">&emsp;&nbsp;Seleccionar un ciclo:&nbsp;<p align="center"><select name="nombCiclo" size="5" required>';
	
	$sql="SELECT nombre, num_conv FROM ciclos";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result) > 0){
		$cont=0;
		while($row=mysqli_fetch_assoc($result)){
			$output= $output . '<option>' . $row["nombre"] . '</option>';
			//$id=$row["id_ciclo"];$conv=$row["num_conv"];
			$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$lista='Lista sin ciclos';$output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}
	$output= $output . '</select></p></SPAN>
	<p>&emsp;&nbsp;Introducir datos a modificar:</p>
	<p>&emsp;&nbsp;Nombre:&nbsp;<input type="text" style="color:blue" name="nuevoNomb"></p>
	<p>&emsp;&nbsp;Convocatorias:&nbsp;<input type="number" style="color:blue" name="nuevoConv" min="1" max="5" placeholder="N&uacute;merico entre 1 y 5"></p>';
	$output=$output . '</fieldset>
	</p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&emsp;&nbsp;';
	if ($error){
		$output= $output . '<input type="submit" value="Grabar" style="font-weight:bold; color:black" disabled>';
	}else{
		$output= $output . '<input type="submit" value="Grabar" style="font-weight:bold; color:black">';
	}
	$output= $output . '</p></form>';//732
} 
else{
	$nombre=$_POST["nombCiclo"];
	$nombnuevo=$_POST["nuevoNomb"];
	$convnuevo=$_POST["nuevoConv"];
	
	//mysqli_select_db($conexion, "colegio");
	$sql="SELECT ID_CICLO FROM ciclos WHERE NOMBRE='$nombre'";
	$result=mysqli_query($conexion, $sql);
	$id=mysqli_fetch_array($result);
	$num=$id[0];

	if (($nombnuevo == "") && ($convnuevo == "")){
		$output='<br><br><font color="red"><b>Atenci&oacute;n</b></font><br><br><p>No ha introducido ning&uacute;n dato para actualizar el registro seleccionado:&nbsp;<b>' . $nombre . '</b></p>&nbsp;';
		$output=$output . '<br><p align="center">Para volver a intentarlo&nbsp;<a href="http://localhost/drupal/oficina/cursos_oficiales/ciclos/modificar_ciclo">pulse aqu&iacute;</a></p>';
	} 
	else{
		$output= '<br><br><p><b>Actualizaci&oacute;n del registro seleccionado.</b></p>'; 
		if ($nombnuevo == ""){
			if (($convnuevo < "1") || ($convnuevo >"5")){
				$output= $output . '<p>El rango n&uacute;merico introducido para el campo convocatorias no es correcto</p>';
				$output= $output . '<br><p align="center">Para volver a modificarlo,&nbsp;<a href="http://localhost/drupal/oficina/cursos_oficiales/ciclos/modificar_ciclo">pulse aqu&iacute;</a></p>';
			}else{
				$sql="UPDATE ciclos SET NUM_CONV='$convnuevo' WHERE ID_CICLO= '$id[0]'";
				if(mysqli_query($conexion, $sql)){	
					$output=$output . '<p>El registro seleccionado, se ha actualizado con el n&uacute;mero de convocatorias igual a:&nbsp;<b>' . $convnuevo . '</b></p>';
					$output=$output . '<br><p align="center">Si desea modificar otro departamento&nbsp;<a href="http://localhost/drupal/oficina/cursos_oficiales/ciclos/modificar_ciclo">pulse aqu&iacute;</a></p>';
				}
				else{
					$error=true;
				}
			}
		}elseif ($convnuevo == ""){
			$sql="UPDATE ciclos SET NOMBRE='$nombnuevo' WHERE ID_CICLO= '$id[0]'";
			if(mysqli_query($conexion, $sql)){	
				$output=$output . '<p>El registro seleccionado, se ha actualizado con el nuevo nombre:&nbsp;<b>' . $nombnuevo . '</b></p>';
				$output=$output . '<br><p align="center">Si desea modificar otro departamento&nbsp;<a href="http://localhost/drupal/oficina/cursos_oficiales/ciclos/modificar_ciclo">pulse aqu&iacute;</a></p>';
			}
			else{
				$error=true;
			}
		}else{
			if (($convnuevo < "1") || ($convnuevo >"5")){
				$output= $output . '<p>El rango n&uacute;merico introducido para el campo convocatorias no es correcto</p>';
				$output= $output . '<br><p align="center">Para volver a modificarlo,&nbsp;<a href="http://localhost/drupal/oficina/cursos_oficiales/ciclos/modificar_ciclo">pulse aqu&iacute;</a></p>';
			}else{
				$sql="UPDATE ciclos SET NOMBRE='$nombnuevo', NUM_CONV='$convnuevo' WHERE ID_CICLO= '$id[0]'";
				if(mysqli_query($conexion, $sql)){	
					$output=$output . '<p>El registro seleccionado, se ha actualizado con:</p>'; 
					$output=$output . '<p>Nuevo nombre&nbsp;<b>' . $nombnuevo .'</b></p><p>N&uacute;mero de convocatorias&nbsp;<b>' . $convnuevo . '</b></p>';
					$output=$output . '<br><p align="center">Si desea modificar otro departamento&nbsp;<a href="http://localhost/drupal/oficina/cursos_oficiales/ciclos/modificar_ciclo">pulse aqu&iacute;</a></p>';
				}
				else{
					$error=true;
				}
			}
		}
	}
	if ($error){
		$output='<p><b>Se ha producido un Error al actualizar el registro con el nombre:&nbsp;' . $nombre . '</b></p>';
		$output=$output . '<p>'. mysqli_error($conexion) . '</p>';
	}

} 
mysqli_close($conexion);
return $output;

} 	/** end modificar_ciclo **/


/******** Cursos **********/

function listar_cursos(){
$output="";
$tamano_pagina="10";

if(array_key_exists('pagina', $_GET)){
	$pagina=$_GET["pagina"];
}
else{
	$pagina=1;
}

$conexion=bdexterna();

$sql="SELECT * FROM cursos";
$result=mysqli_query($conexion, $sql);
$total_filas=mysqli_num_rows($result);
$total_paginas=ceil($total_filas / $tamano_pagina);

$sql="SELECT * FROM cursos LIMIT " . (($pagina-1) * $tamano_pagina) . "," . $tamano_pagina;
$result=mysqli_query($conexion, $sql);
$output='<p align="center"><b><font size="4">Listado de los Cursos del centro</font></b></p>';
$output=$output . '<table border="2"><tr><th><font size="3">Identificador</font></th><th><font size="3">Nombre Curso</font></th><th width="15% size="3"><font size="3">Asignaturas</th></font></tr>';
if($total_filas > 0){
	while ($row=mysqli_fetch_assoc($result)){
		$output=$output . '<tr><td><font color="blue" size="2">'. $row["ID_CURSO"] . '</font></td><td><font color="blue" size="2">' . $row["NOMBRE"] . '</font></td><td><font color="blue" size="2">' . $row["MAX_ASIG"] . '</font></td></tr>';
	}
	$output=$output . '</table><br>';
}

mysqli_close($conexion);

if ($total_paginas > 1){
	for ($i=1;$i<=$total_paginas;$i++){
		if($pagina == $i){
			$output=$output . 'P&aacute;gina ' . $pagina . "&nbsp;&nbsp;";
		}
		else{
			$output=$output . '<a href="http://localhost/drupal/oficina/cursos_oficiales/cursos/listar_cursos?pagina=' . $i . '">P&aacute;gina ' . $i . '</a>&nbsp;&nbsp;';
		}

	}
}

return $output;
} 	/** end listar_cursos **/


function alta_curso(){
$output="";

$conexion=bdexterna();

if (!$_POST){
	$output='<form id="formAltaCurso" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formAltaCurso">
	<legend align="left"><SPAN style="text-align:top">Introducir un nuevo curso</SPAN></legend>
        <br><br>
	<p><SPAN style="text-align:center">&emsp;&nbsp;Nombre de Curso:&nbsp;<input type="text" style="color:blue" name="nombCurso" required autofocus>
	&emsp;&emsp;&emsp;&emsp;N&uacute;mero de Asignaturas:&nbsp;<input type="text" style="color:blue" name="maxAsig" size="5%" maxlength="2" required></SPAN></p>
	&emsp;&nbsp;Asignar un Ciclo:&nbsp;<p align="center"><select name="Ciclo" required size="4">';
	$sql="SELECT nombre FROM ciclos";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result) > 0){
		$cont=0;
		while($row=mysqli_fetch_assoc($result)){
			$output= $output . '<option>' . $row["nombre"] . '</option>';
			$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$lista='Lista sin ciclos'; $output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}
	$output=$output . '</select></p>
	</fieldset>
	</p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($error){
		$output=$output . '<input type="submit" value="Agregar" style="font-weight:bold; color:black" disabled>';
	}else{
		$output=$output . '<input type="submit" value="Agregar" style="font-weight:bold; color:black">';
	}
	$output=$output . '</p>
	</form>';
 }elseif ($_POST["nombCurso"] == ""){
		$output='<br><b>Atenci&oacute;n</b><br><br><p>No puede dar de alta un Curso sin nombre</p><p>Para volver hacia atr&aacute;s&nbsp;<a href="http://localhost/drupal/oficina/cursos_oficiales/cursos/alta_curso">pulse aqu&iacute;</a></p>'; 

}
else{
	$nombre=$_POST["nombCurso"];
	$nombCiclo=$_POST["Ciclo"];
	$maxAsig=$_POST["maxAsig"];
	$sql="SELECT ID_CICLO FROM ciclos WHERE NOMBRE='$nombCiclo'";
	$result=mysqli_query($conexion, $sql);
	$idCiclo=mysqli_fetch_array($result);
	$sql="INSERT INTO cursos (ID_CURSO, NOMBRE, ID_CICLO, MAX_ASIG) VALUES (NULL, '$nombre', '$idCiclo[0]', '$maxAsig')";
	if(mysqli_query($conexion, $sql)){
		$ant_id=mysqli_insert_id($conexion);
		$output= '<p><b>Nuevo curso registrado satisfactoriamente con:</b></p>
		<p>Identificador&nbsp;<b>' . $ant_id . '</b></p> 
		<p>Nombre&nbsp; <b>' . $nombre . '</b></p>
		<p>Ciclo del curso&nbsp; <b>' . $nombCiclo . '</b>
		<p>N&uacute;mero de Asingaturas&nbsp; <b>' . $maxAsig . '</b></p>
		<br><br>
		<p align="center">Si desea agregar otro curso <a href="http://localhost/drupal/oficina/cursos_oficiales/cursos/alta_curso">pulse aqu&iacute;</a></p>'; 
	}	
}
mysqli_close($conexion);
return $output;

} 	/** end alta_curso **/


function baja_curso(){
$output="";
$conexion=bdexterna();

if (!$_POST){
	$output='<form id="formBajaCurso" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formBajaCurso">
	<legend align="left"><SPAN style="text-align:top">Eliminar un curso</SPAN></legend>
        <br><br>
	<p><SPAN style="text-align:top">&emsp;&nbsp;Seleccionar un curso:&nbsp;<p align="center"><select name="nombCurso" size="5" required>';
	
	$sql="SELECT nombre FROM cursos";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result) > 0){
		$cont=0;
		while($row=mysqli_fetch_assoc($result)){
			$output= $output . '<option>' . $row["nombre"] . '</option>';
			$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$lista='Lista sin cursos';  $output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}
	$output= $output . '</select></p></SPAN></p></fieldset>
	</p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&emsp;&nbsp;';
	if ($error){
		$output= $output . '<input type="submit" name="Eliminar" value="Eliminar" style="font-weight:bold; color:black" disabled>';
	}else{
		$output= $output . '<input type="submit" name="Eliminar" value="Eliminar" style="font-weight:bold; color:black">';
	}
	$output= $output . '</p>
	</form>';
} 
elseif(isset($_POST["Eliminar"])){
	$output='<form id="formConfirmarCurso" action="" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formConfirmarCurso">
	<legend align="left"><SPAN style="text-align:top">Confirmar Baja</SPAN></legend>
        <br><br><p align="center"> Seguro que desea dar de baja el curso<b>&nbsp;"' . $_POST["nombCurso"] . '"</b></p>
	<p align="center"><input type="submit" value="Aceptar" name="Aceptar" style="font-weight:bold; color:black">&emsp;
	<input type="submit" name="Cancelar" value="Cancelar" style="font-weight:bold; color:black">
	<input type="hidden" name="curso" value="' . $_POST["nombCurso"] . '">
	</p></fieldset></p></form>';
}
else{
	$nombre=$_POST["curso"];
	if(isset($_POST["Aceptar"])){
		$sql="SELECT id_curso,nombre FROM cursos WHERE nombre='$nombre'";
		$row=mysqli_fetch_array(mysqli_query($conexion, $sql));
		//$sql="DELETE FROM cursos WHERE nombre='$nombre'";
		//if(mysqli_query($conexion, $sql)){	
			$output= '<p><b>El curso seleccionado se ha borrado satisfactoriamente con:</b></p>
			<p>Identificador&nbsp;<b>' . $row["id_curso"] . '</b></p> 
			<p>Nombre&nbsp;<b>' . $row["nombre"] . '</b></p><br><br>';
			$output=$output . '<p align="center">Si desea eliminar otro curso&nbsp;<a href="http://localhost/drupal/oficina/cursos_oficiales/cursos/baja_curso">pulse aqu&iacute;</a></p>';		
		//}
		//else{
		//	$output='<p><b>Error al eliminar el registro con el nombre:&nbsp;' . $nombre . '<b></p>';
		//	$output=$output . '<p>'. mysqli_error($conexion) . '</p>';
		//}
	}else{
		$output='<br><br><b><p align="center">Operaci&oacute;n de eliminar curso con el nombre<br>
		<font color="red">"' . $nombre . '"</font><br>ha sido cancelada</b>
		<br>
		<p align="center">Si desea volver al apartado "Baja Curso"&nbsp;<a href="http://localhost/drupal/oficina/cursos_oficiales/cursos/baja_curso">pulse aqu&iacute;</a></p>'; 
	}


}
mysqli_close($conexion);
return $output;

} 	/** end baja_curso **/

	
function modificar_curso(){
$output="";

$conexion=bdexterna();

if (!$_POST){
	$output='<form id="formModCurso" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formModCurso">
	<legend align="left"><SPAN style="text-align:top">Cambiar un curso</SPAN></legend>
        <br><br>
	&emsp;&nbsp;Seleccionar un Curso:&nbsp;<p align="center"><select name="nombCurso" size="5" required>';
	
	$sql="SELECT nombre FROM cursos";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result) > 0){
		$cont=0;
		while($row=mysqli_fetch_assoc($result)){
			$output= $output . '<option>' . $row["nombre"] . '</option>';
			$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$lista='Lista sin cursos';  $output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}
	$output= $output . '</select></p>
	<p>&emsp;&nbsp;Nuevo nombre del curso:&nbsp;<input type="text" style="color:blue" name="nuevoNomb">
	&emsp;&emsp;Modificar el n&uacute;mero Asignaturas:&nbsp;<input type="text" style="color:blue" name="maxAsig" size="5%" maxlength="2"></p>
	</fieldset>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&emsp;&nbsp;';
	if ($error){
	  	$output= $output . '<input type="submit" value="Grabar" style="font-weight:bold; color:black" disabled>';
	}else{
		$output= $output . '<input type="submit" value="Grabar" style="font-weight:bold; color:black">';
	}
	$output= $output . '</p>
	</form>';
} 
else{
	$nombre=$_POST["nombCurso"];
	$nombnuevo=$_POST["nuevoNomb"];
	$maxAsig=$_POST["maxAsig"];
	//mysqli_select_db($conexion, "colegio");
	$sql="SELECT ID_CURSO FROM cursos WHERE NOMBRE='$nombre'";
	$result=mysqli_query($conexion, $sql);
	$id=mysqli_fetch_array($result);
	$num=$id[0];

	if (($nombnuevo == "") AND ($maxAsig == "")){
		$output='<br><br><font color="red"><b>Atenci&oacute;n</b></font><br><br><p>No ha introducido ning&uacute;n dato para actualizar el registro seleccionado:&nbsp;<b>' . $nombre . '</b></p>&nbsp;';
		$output=$output . '<br><p align="center">Para volver a intentarlo&nbsp;<a href="http://localhost/drupal/oficina/cursos_oficiales/cursos/modificar_curso">pulse aqu&iacute;</a></p>';
	} 
	else{
		$output= '<br><br><p><b>Actualizaci&oacute;n del registro seleccionado.</b></p>'; 
		if (($nombnuevo <> "") AND ($maxAsig == "")){
			$sql="UPDATE cursos SET NOMBRE='$nombnuevo' WHERE ID_CURSO= '$id[0]'";
			$output1='<p>El registro seleccionado, se ha actualizado con el nuevo nombre:&nbsp;<b>' . $nombnuevo . '</b></p>';
		}elseif (($nombnuevo == "") AND ($maxAsig <> "")){
			$sql="UPDATE cursos SET MAX_ASIG='$maxAsig' WHERE ID_CURSO= '$id[0]'";
			$output1='<p>El registro seleccionado, se ha actualizado con el n&uacute;mero asignaturas:&nbsp;<b>' . $maxAsig . '</b></p>';
		}else{
			$sql="UPDATE cursos SET NOMBRE='$nombnuevo', MAX_ASIG='$maxAsig' WHERE ID_CURSO= '$id[0]'";
			$output1='<p>El registro seleccionado, se ha actualizado con los datos</p>
				<p> Nuevo nombre:&nbsp;<b>' . $nombnuevo . '</b></p>
				<p> N&uacute;mero asignaturas:&nbsp;<b>' . $maxAsig . '</b></p>';
		}
		if(mysqli_query($conexion, $sql)){	
				$output=$output . $output1;
				$output=$output . '<br><p align="center">Si desea modificar otro Curso&nbsp;<a href="http://localhost/drupal/oficina/cursos_oficiales/cursos/modificar_curso">pulse aqu&iacute;</a></p>';
		}else{
				$output='<p><b>Se ha producido un Error al actualizar el registro con el nombre:&nbsp;' . $nombre . '</b></p>';
				$output=$output . '<p>'. mysqli_error($conexion) . '</p>';
		}
	}
} 
mysqli_close($conexion);
return $output;

} 	/** end modificar_curso **/




/******** Unidades **********/

function listar_unidades(){
$output="";
$tamano_pagina="4";

if(array_key_exists('pagina', $_GET)){
	$pagina=$_GET["pagina"];
}
else{
	$pagina=1;
}

$conexion=bdexterna();

$sql="SELECT nombre FROM grupos_a";
$result=mysqli_query($conexion, $sql); 
$total_filas=mysqli_num_rows($result);  //936
$total_paginas=ceil($total_filas / $tamano_pagina);

$sql="SELECT * FROM grupos_a LIMIT " . (($pagina-1) * $tamano_pagina) . "," . $tamano_pagina;
$result=mysqli_query($conexion, $sql);
$output='<p align="center"><b><font size="4">Listado de las Unidades del centro</font></b></p>';
$output=$output . '<table border="2"><tr><th><font size="3">Identificador</font></th><th><font size="3">Nombre Unidad</font></th><th><font size="3">Aula</font></th><th><font size="3">Dia de Tutoria</font></th><th><font size="3">Hora de Tutoria</font></th></tr>';
if($total_filas > 0){
	while ($row=mysqli_fetch_assoc($result)){
		$output=$output . '<tr><td><font color="blue" size="2">'. $row["ID_GRUPOSA"] . '</font></td><td><font color="blue" size="2">' . $row["NOMBRE"] . '</font></td><td><font color="blue" size="2">' . $row["AULA"] . '</font></td><td><font color="blue" size="2">' . $row["DIA_TUTORIA"] . '</font></td><td><font color="blue" size="2">' . $row["HORA_TUTORIA"] . '</font></td></tr>';
	}
	$output=$output . '</table><br>';
}

/*****Paginar******/
if ($total_paginas > 1){
	for ($i=1;$i<=$total_paginas;$i++){
		if($pagina == $i){
			$output=$output . 'P&aacute;gina ' . $pagina . "&nbsp;&nbsp;";
		}
		else{
			$output=$output . '<a href="http://localhost/drupal/oficina/cursos_oficiales/unidades/listar_unidades?pagina=' . $i . '">P&aacute;gina ' . $i . '</a>&nbsp;&nbsp;';
		}

	}
}

if (!$_POST){

	$output=$output . '<br><br><form id="formBuscarUnidades" action="" method="post" accept-charset=UTF-8" size="100%">
	<p><fieldset form="formBuscarUnidades"><br><legend align="left"><SPAN style="text-align:top">B&uacute;squeda de informaci&oacute;n de Unidades del Centro</SPAN></legend><br>
	<p align="center">Seleccionar el nombre completo de la Unidad:</p>
	<p align="center"><select required name="nombunidad" size="6">';
	$sql="SELECT nombre, id_gruposa FROM grupos_a";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result) > 0){ //971
		while($row=mysqli_fetch_assoc($result)){
			$output=$output . '<option>' . $row["nombre"] . '</option>';
		}
	}
	else{
		$output=$output . '<option></option>';
	} 
	$output=$output . '</select></p>
	<br>
	<p align="center"><input type="submit" value="Buscar Unidad" style="font-weight:bold; color:black">&emsp;&emsp;
	<input type="reset" value="Limpiar" style="font-weight:bold; color:black"></p>
	</fielset></form>';
}
else{
	$unidad=$_POST["nombunidad"];
	//$repetidor='0';
	$sql="SELECT id_curso, nombre, aula, dia_tutoria, hora_tutoria, repetidores FROM grupos_a WHERE nombre='$unidad'";
	$result=mysqli_query($conexion, $sql);
	$filas=mysqli_num_rows($result);
	if (mysqli_num_rows($result) > 0){
			$row=mysqli_fetch_assoc($result);
			$id=$row["id_curso"];
			$sql1="SELECT nombre FROM cursos WHERE id_curso='$id'";  //996
			$result1=mysqli_query($conexion, $sql1);
			if (mysqli_num_rows($result1)>0){
				$row1=mysqli_fetch_assoc($result1);
			}
			if($row["repetidores"]=="0"){
				$Rep="No";
			}else{
				$Rep="S&iacute;";
			}	
			$output='<p align="center"><b><font size="4">Datos de la Unidad seleccionada</font></b></p>
			<table border="2"><tr><th><font size="3">Curso</font></th><th><font size="3">Nombre Unidad</font>
			</th><th><font size="3">Aula</font></th><th><font size="3">Dia de Tutoria</font></th><th><font size="3">Hora de Tutoria</font></th>
			<th><font size="3">Curso de Repetidores</font></th></tr>
			<tr><td><font color="blue" size="2">' . $row1["nombre"] . '</font></td><td><font color="blue" size="2">' . $row["nombre"] . '</font></td>
			<td><font color="blue" size="2">' . $row["aula"] . '</font></td><td><font color="blue" size="2">' . $row["dia_tutoria"] . '</font></td>
			<td><font color="blue" size="2">' . $row["hora_tutoria"] . '</font></td>
			<td><font color="blue" size="2">' . $Rep . '</font></td></tr>
			</table><br>';
		
	}		
	$output=$output . '<br><p align="center"><b>Para volver hacia atr&aacute;s&nbsp;
	<a href="http://localhost/drupal/oficina/cursos_oficiales/unidades/listar_unidades">pulse aqu&iacute;</a></b></p>';
}

mysqli_close($conexion);
return $output;
} 	/** end listar_unidades **/


function alta_unidad(){
$output="";

$conexion=bdexterna();

if (!$_POST){
	$output='<form id="formAltaUnidad" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formAltaUnidad">
	<legend align="left"><SPAN style="text-align:top">Introducir datos de una Unidad nueva</SPAN></legend>
        <br><br>
	<p><SPAN style="text-align:center">&emsp;&nbsp;Nombre de Unidad:&nbsp;<input type="text" style="color:blue" name="nombUnidad" required autofocus size="50"></SPAN></p>
	&emsp;&nbsp;Asignar un Curso:&nbsp;<p align="center"><select name="Curso" required size="4">';
	$sql="SELECT nombre FROM cursos";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result) > 0){
		$cont=0;
		while($row=mysqli_fetch_assoc($result)){
			$output= $output . '<option>' . $row["nombre"] . '</option>';
			$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$lista='Lista sin cursos';  $output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}
	$output=$output . '</select></p>
	<p align="center">Curso de Repetidores:&nbsp;&nbsp;<input type="radio" value="1" name="CurRep">&nbsp;&nbsp;S&iacute;
	&nbsp;&nbsp;<input type="radio" value="0" name="CurRep" checked>&nbsp;&nbsp;No 
	&emsp;&emsp;&emsp;&nbsp;Aula aignada:&nbsp;<input type="text" style="color:blue" name="Aula" required></p>
	<p><SPAN style="text-align:center">&emsp;&nbsp;D&iacute;a de Tutor&iacute;a:&nbsp;<input type="text" style="color:blue" name="diaTutoria" required></SPAN>
	&emsp;&emsp;&emsp;<SPAN style="text-align:center">&emsp;&nbsp;Hora de Tutor&iacute;a:&nbsp;<input type="time" style="color:blue" name="horaTutoria" required></SPAN></p>	
	</fieldset>
	</p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&emsp;&nbsp;';
	if ($error){
		$output=$output . '<input type="submit" value="Agregar" style="font-weight:bold; color:black" disabled>';
	}else{
		$output=$output . '<input type="submit" value="Agregar" style="font-weight:bold; color:black">';
	}
	$output=$output . '</p>
	</form>';
}elseif ($_POST["nombUnidad"] == ""){
		$output='<br><b>Atenci&oacute;n</b><br><br><p>No puede dar de alta una Unidad sin nombre</p><p>Para volver hacia atr&aacute;s&nbsp;<a href="http://localhost/drupal/oficina/cursos_oficiales/unidades/alta_unidad">pulse aqu&iacute;</a></p>'; 
}
else{
	$nombre=$_POST["nombUnidad"];
	$nombCurso=$_POST["Curso"];
	$aula=$_POST["Aula"];
	$diat=$_POST["diaTutoria"];
	$horat=$_POST["horaTutoria"];
	$repCur=$_POST["CurRep"];
	$sql="SELECT ID_CURSO FROM cursos WHERE NOMBRE='$nombCurso'";
	$result=mysqli_query($conexion, $sql);
	$idCurso=mysqli_fetch_array($result);

	$sql="INSERT INTO grupos_a (ID_GRUPOSA, ID_CURSO, NOMBRE, AULA, DIA_TUTORIA, HORA_TUTORIA, REPETIDORES) VALUES (NULL, '$idCurso[0]', '$nombre', '$aula', '$diat', '$horat', '$repCur')";
	if(mysqli_query($conexion, $sql)){
		$ant_id=mysqli_insert_id($conexion);
		$output= '<br><p><b>Nueva unidad registrada satisfactoriamente con:</b></p>
		<p>Identificador:&nbsp;<b>' . $ant_id . '</b></p> 
		<p>Unidad:&nbsp; <b>' . $nombre . '</b></p>
		<p>Curso de la Unidad:&nbsp; <b>' . $nombCurso . '</b></p>
		<p>Aula de la unidad:&nbsp; <b>' . $aula . '</b></p>
		<p>D&iacute;a de la semana de tutor&iacute;a:&nbsp; <b>' . $diat . '</b></p>
		<p>Hora de tutor&iacute;a:&nbsp;<b>' . $horat . '</b></p>';
		if ($repCur==1){
			$output=$output . '<p>Curso de Repetidores:&nbsp;<b>Sí</b></p>';
		}else{
			$output=$output . '<p>Curso de Repetidores:&nbsp;<b>No</b></p>';
		}
		$output=$output . '<br><br>
		<p align="center">Si desea agregar otra unidad <a href="http://localhost/drupal/oficina/cursos_oficiales/unidades/alta_unidad">pulse aqu&iacute;</a></p>'; 
	}		
}
mysqli_close($conexion);
return $output;

} 	/** end alta_unidad **/

function baja_unidad(){
$output="";
$conexion=bdexterna();

if (!$_POST){
	$output='<form id="formBajaUnidad" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formBajaUnidad">
	<legend align="left"><SPAN style="text-align:top">Eliminar una Unidad</SPAN></legend>
        <br><br>
	<p><SPAN style="text-align:top">&emsp;&nbsp;Seleccionar una unidad:&nbsp;<p align="center"><select name="nombUnidad" size="4" required>';
	$sql="SELECT nombre FROM grupos_a";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result) > 0){
		$cont=0;
		while($row=mysqli_fetch_assoc($result)){
			$output= $output . '<option>' . $row["nombre"] . '</option>';
			$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
	  	$lista='Lista sin unidades';$output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}
	$output= $output . '</select></p></p></fieldset>	
	</p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&emsp;&nbsp;';  
	if ($error){
		$output= $output . '<input type="submit" name="Eliminar" value="Eliminar" style="font-weight:bold; color:black" disabled>';
	}else{
		$output= $output . '<input type="submit" name="Eliminar" value="Eliminar" style="font-weight:bold; color:black">';
	}
	$output= $output . '</p></form>'; 
}
elseif(isset($_POST["Eliminar"])){
	$output='<form id="formConfirmarUnidad" action="" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formConfirmarUnidad">
	<legend align="left"><SPAN style="text-align:top">Confirmar Baja</SPAN></legend>
        <br><br><p align="center"> Seguro que desea dar de baja la Unidad<b>&nbsp;"' . $_POST["nombUnidad"] . '"</b></p>
	<p align="center"><input type="submit" value="Aceptar" name="Aceptar" style="font-weight:bold; color:black">&emsp;
	<input type="submit" name="Cancelar" value="Cancelar" style="font-weight:bold; color:black">
	<input type="hidden" name="unidad" value="' . $_POST["nombUnidad"] . '">
	</p></fieldset></p></form>';
}
else{
	$nombre=$_POST["unidad"];
	if(isset($_POST["Aceptar"])){	
		$sql="SELECT id_gruposa,nombre FROM grupos_a WHERE nombre='$nombre'";
		$row=mysqli_fetch_assoc(mysqli_query($conexion, $sql));
		$sql="DELETE FROM grupos_a WHERE nombre='$nombre'";
		if(mysqli_query($conexion, $sql)){	
			$output= '<p><b>La unidad seleccionada se ha borrado satisfactoriamente con:</b></p>
			<p>Identificador&nbsp;<b>' .$row["id_gruposa"] . '</b></p> 
			<p>Nombre&nbsp;<b>' . $row["nombre"] . '</b></p><br><br>';
			$output=$output . '<p align="center">Si desea eliminar otra unidad&nbsp;<a href="http://localhost/drupal/oficina/cursos_oficiales/unidades/baja_unidad">pulse aqu&iacute;</a></p>';		
		}
		else{
			$output='<p><b>Error al eliminar el registro con el nombre:&nbsp;' . $nombre . '<b></p>';
			$output=$output . '<p>'. mysqli_error($conexion) . '</p>';
		}
	}
	else{
		$output='<br><br><b><p align="center">Operaci&oacute;n de eliminar unidad con el nombre<br>
		<font color="red">"' . $nombre . '"</font><br>ha sido cancelada</b>
		<br>
		<p align="center">Si desea volver al apartado "Baja Unidad"&nbsp;<a href="http://localhost/drupal/oficina/cursos_oficiales/unidades/baja_unidad">pulse aqu&iacute;</a></p>'; 
	}
}
mysqli_close($conexion);
return $output;

}        /** end baja_unidad  **/


function modificar_unidad(){
$output="";
$conexion=bdexterna();//1193

if (!$_POST){
	$output='<form id="formModUnidad" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formModUnidad">
	<legend align="left"><SPAN style="text-align:top">Cambiar una unidad</SPAN></legend>
        <br><br>';
	//1194
	$output= $output . '<SPAN style="text-align:center">&emsp;&nbsp;Seleccionar una Unidad:&nbsp;<p><select name="nombUnidad" size="5" required>';
	$sql="SELECT nombre FROM grupos_a";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result) > 0){
		$cont=0;
		while($row=mysqli_fetch_assoc($result)){
			$output= $output . '<option>' . $row["nombre"] . '</option>';
			$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
	 	$lista='Lista sin unidades'; $output= $output . '<option selected>' . $lista . '</option>';//1625
		$error=true;
	}
	$output= $output . '</select></p></SPAN>
	</fieldset></p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&emsp;&nbsp;';
	if ($error){
		$output= $output . '<input type="submit" value="Siguiente" name="Siguiente" style="font-weight:bold; color:black" disabled>';
	}else{
		$output= $output . '<input type="submit" value="Siguiente" name="Siguiente" style="font-weight:bold; color:black">';
	}  
	$output= $output . '</p></form>';
	
}elseif (isset($_POST["Siguiente"])){
	$nombre=$_POST["nombUnidad"];
	$sql="SELECT * FROM grupos_a WHERE nombre='$nombre'";
	$result=mysqli_query($conexion, $sql);
	$row=mysqli_fetch_assoc($result);
	$output='<form id="formModUnidadDatos" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formModUnidadDatos">
	<legend align="left"><SPAN style="text-align:top">Modificar datos de una Unidad</SPAN></legend>
        <br><br>
	<p align="center">&emsp;&nbsp;Unidad seleccionada:&nbsp;&nbsp;<input type="text" name="nombUnidad" value="' . $_POST["nombUnidad"] . '" disabled size="50"></p>
	<p>&emsp;&nbsp;Nuevo Nombre:&nbsp;<input type="text" style="color:blue" name="nuevoNomb" size="50"></p>';
	if ($row["REPETIDORES"]=="0"){
		$output=$output . '<p align="center">Curso de Repetidores:&nbsp;&nbsp;<input type="radio" value="0" name="CurRep">&nbsp;&nbsp;S&iacute;
		&nbsp;&nbsp;<input type="radio" value="1" name="CurRep" checked>&nbsp;&nbsp;No';
	}
	else{
		$output=$output . '<p align="center">Curso de Repetidores:&nbsp;&nbsp;<input type="radio" value="1" name="CurRep">&nbsp;&nbsp;S&iacute;
		&nbsp;&nbsp;<input type="radio" value="0" name="CurRep" checked>&nbsp;&nbsp;No';
	}
	
	$output=$output . '&emsp;&emsp;&emsp;&nbsp;Aula aignada:&nbsp;<input type="text" style="color:blue" name="Aula" value="' . $row["AULA"] . '" size="10"></p>
	<p><SPAN style="text-align:center">&emsp;&nbsp;D&iacute;a de Tutor&iacute;a:&nbsp;<input type="text" style="color:blue" name="diaTutoria" value="' . $row["DIA_TUTORIA"] . '"></SPAN>
	<SPAN style="text-align:center">&emsp;&nbsp;Hora de Tutor&iacute;a:&nbsp;<input type="time" style="color:blue" name="horaTutoria" value="' . $row["HORA_TUTORIA"] . '"></SPAN></p>
	</fieldset></p>
	<p><input type="button" onclick="history.back()" value="Volver Atr&aacute;s" name="Volver Atras" style="font-weight:bold; color:black">
	&emsp;&nbsp;<input type="reset" value="Limpiar" style="font-weight:bold; color:black">
	&emsp;&nbsp;<input type="submit" name="Grabar" value="Grabar" style="font-weight:bold; color:black">
	<input type="hidden" name="idU" value="' . $row["ID_GRUPOSA"] . '"><input type="hidden" name="nombUnidad" value="' . $_POST["nombUnidad"] . '">
	<input type="hidden" name="Rep" value="' . $row["REPETIDORES"] . '">   
	</form>';
}elseif (isset($_POST["Grabar"])){
	$id=$_POST["idU"];
	//$nombre=$_POST["nombUnidad"];
	//$nombnuevo=$_POST["nuevoNomb"];
	$aula=$_POST["Aula"];//1551
	$diat=$_POST["diaTutoria"];
	$horat=$_POST["horaTutoria"];
	$repCur=$_POST["Rep"];//1554
	
	//$sql="SELECT * FROM grupos_a WHERE ID_GRUPOSA='$id'";
	//$result=mysqli_query($conexion, $sql);
	//$row=mysqli_fetch_assoc($result);*/
	if ($_POST["nuevoNomb"]==""){
		$nombnuevo=$_POST["nombUnidad"];
		$sql="UPDATE grupos_a SET AULA='$aula', DIA_TUTORIA='$diat', HORA_TUTORIA='$horat', REPETIDORES='$repCur' WHERE ID_GRUPOSA='$id'";
		$cadenaUnidad='<p>Nombre de la Unidad:&nbsp;<b>' . $nombnuevo . '</b></p>';
	}else{
		$nombnuevo=$_POST["nuevoNomb"];
		$sql="UPDATE grupos_a SET NOMBRE='$nombnuevo', AULA='$aula', DIA_TUTORIA='$diat', HORA_TUTORIA='$horat', REPETIDORES='$repCur' WHERE ID_GRUPOSA='$id'";
		$cadenaUnidad='<p>Nombre de la Unidad:&nbsp;<b>' . $_POST["nombUnidad"] . '</b>&nbsp;&nbsp; cambiada por:&nbsp;<b>' . $_POST["nuevoNomb"] . '</b></p>';
	}
	if(mysqli_query($conexion, $sql)){
		$output=$output . '<p><b>Registro actualizado  satisfactoriamente.</b></p>' 
		. $cadenaUnidad .
		'<p>Aula:&nbsp;<b>' . $aula . '</b></p>
		<p>D&iacute;a de tutor&iacute;a actualizado:&nbsp;<b>' . $diat . '</b></p>
		<p>Hora de tutor&iacute;a actualizado:&nbsp;<b>' . $horat . '</b></p>';
		if($repCur=="0"){
			$output=$output . '<p>Curso de Repetidores:&nbsp;<b>No</b></p>';
		}else{
			$output=$output . '<p>Curso de Repetidores:&nbsp;<b>S&iacute;</b></p>';
		}
		$output=$output . '<br><p align="center">Si desea modificar otra Uniad&nbsp;<a href="http://localhost/drupal/oficina/cursos_oficiales/unidades/modificar_unidad">pulse aqu&iacute;</a></p>';	
	} 
	else{
		$output='<p><b>Se ha producido un Error al actualizar el registro con el nombre:&nbsp;' . $_POST["nombUnidad"] . '</b></p>';
		$output=$output . '<p>'. mysqli_error($conexion) . '</p>';
	}
	//$output=$output . "hola  -" . $_POST["idU"] . "-" .  $_POST["nombUnidad"] . "-" .  $_POST["nuevoNomb"]  . "-" .  $_POST["Aula"] . "-" .  $_POST["CurRep"] . "-" .  $_POST["horaTutoria"]. "-" .  $_POST["diaTutoria"];
}

mysqli_close($conexion);
return $output;

}	/** end modificar_unidad **/

/**********
		*********************** Departamentos ***********************
***********/

function listar_departamentos() {
$output="";
$tamano_pagina="15";

if(array_key_exists('pagina', $_GET)){
	$pagina=$_GET["pagina"];
}
else{
	$pagina=1;
}

$conexion=bdexterna();

$sql="SELECT * FROM departamentos";
$result=mysqli_query($conexion, $sql);
$total_filas=mysqli_num_rows($result);
$total_paginas=ceil($total_filas / $tamano_pagina);

$sql="SELECT * FROM departamentos LIMIT " . (($pagina-1) * $tamano_pagina) . "," . $tamano_pagina;
$result=mysqli_query($conexion, $sql);
$output='<p align="center"><b><font size="4">Listado de los Departamentos activos en el centro</font></b></p>';
$output=$output . '<table border="2"><tr><th><font size="2">Identificador</font></th><th><font size="2">Nombre Departamento</font></th></tr>';
if($total_filas > 0){
	while ($row=mysqli_fetch_assoc($result)){
		$output=$output . '<tr><td><font color="blue" size="2">'. $row["ID_DPTO"] . '</font></td><td><font color="blue" size="2">' . $row["NOMBRE"] . '</font></td></tr>';
	}
	$output=$output . '</table><br>';
}

mysqli_close($conexion);

if ($total_paginas > 1){
	for ($i=1;$i<=$total_paginas;$i++){
		if($pagina == $i){
			$output=$output . 'P&aacute;gina ' . $pagina . "&nbsp;&nbsp;";
		}
		else{
			$output=$output . '<a href="http://localhost/drupal/oficina/departamentos/listar_departamentos?pagina=' . $i . '">P&aacute;gina ' . $i . '</a>&nbsp;&nbsp;';
		}

	}
}

return $output;
}  /** end listar_departamentos **/

function alta_departamento() {
$output="";

if (!$_POST){
$output='<form id="formAltaDpto" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formAltaDpto">
	<legend align="left"><SPAN style="text-align:top">Introducir un nuevo departamento</SPAN></legend>
        <br><br>
	<p><SPAN style="text-align:center">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Nombre Departamento:&nbsp;<input type="text" style="color:blue" name="nombDpto" required autofocus></SPAN></p>
	</fieldset>
	</p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="submit" value="Agregar" style="font-weight:bold; color:black">
	</p>
	</form>';
 }
elseif ($_POST["nombDpto"] == ""){
		$output='<br><b>Atenci&oacute;n</b><br><br><p>No puede dar de alta un Departamento sin nombre</p><p>Para volver hacia atr&aacute;s&nbsp;<a href="http://localhost/drupal/oficina/departamentos/alta_departamento">pulse aqu&iacute;</a></p>'; 
} 
else{
	$conexion=bdexterna();
	$nombre=$_POST["nombDpto"];
	mysqli_select_db($conexion, "colegio");
	$sql="INSERT INTO departamentos (ID_DPTO, NOMBRE) VALUES (NULL, '$nombre')";	
	if(mysqli_query($conexion, $sql)){
		$ant_id=mysqli_insert_id($conexion);
		$output= '<p><b>Nuevo departamento registrado satisfactoriamente</b>.</p><p>Identificador de nuevo registro: <b>' . $ant_id . '</b></p> 
		<p>Nombre del nuevo registro: <b>' . $nombre . '</b></p><br><br>
		<p align="center">Si desea agregar otro departamento <a href="http://localhost/drupal/oficina/departamentos/alta_departamento">pulse aqu&iacute;</a></p>'; 
	}	
	mysqli_close($conexion);
}

return $output;
} /** end alta_departamento **/



function baja_departamento() {
$output="";
$conexion=bdexterna();	

if (!$_POST){
	$output='<form id="formBajaDpto" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formBajaDpto">
	<legend align="left"><SPAN style="text-align:top">Eliminar un departamento</SPAN></legend>
        <br><br>
	<p><SPAN style="text-align:top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Seleccionar un Departamento:&nbsp;<p align="center"><select name="nombDpto" size="5" required>';
	
	$sql="SELECT nombre FROM departamentos";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result) > 0){
		$cont=0;
		while($row=mysqli_fetch_assoc($result)){
			$output= $output . '<option>' . $row["nombre"] . '</option>';
			$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$lista='Lista sin departamentos';  $output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}
	$output= $output . '</p></select></fieldset>
	</p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'; 
	if ($error){
		$output= $output . '<input type="submit" name="Eliminar" value="Eliminar" style="font-weight:bold; color:black" disabled>';
	}else{
		$output= $output . '<input type="submit" name="Eliminar" value="Eliminar" style="font-weight:bold; color:black">';
	} 
	$output= $output . '</p></form>';
} 
elseif(isset($_POST["Eliminar"])){	
	$output='<form id="formConfirmarDpto" action="" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formConfirmarDpto">
	<legend align="left"><SPAN style="text-align:top">Confirmar Baja</SPAN></legend>
        <br><br><p align="center"> Seguro que desea dar de baja el departamento con el nombre<b>&nbsp;"' . $_POST["nombDpto"] . '"</b></p>
	
	<p align="center"><input type="submit" value="Aceptar" name="Aceptar" style="font-weight:bold; color:black">&emsp;
	<input type="submit" name="Cancelar" value="Cancelar" style="font-weight:bold; color:black">
	<input type="hidden" name="dpto" value="' . $_POST["nombDpto"] . '">
	</p></fieldset></p></form>';
}

else{
	$nombre=$_POST["dpto"];
	if(isset($_POST["Aceptar"])){
		//mysqli_select_db($conexion, "colegio");
		$sql="SELECT id_dpto,nombre FROM departamentos WHERE nombre='$nombre'";
		$row=mysqli_fetch_assoc(mysqli_query($conexion, $sql));
		//$sql="DELETE FROM departamentos WHERE nombre='$nombre'";
		//if(mysqli_query($conexion, $sql)){	
			$output= '<p><b>El departamento seleccionado se ha borrado satisfactoriamente</b>.</p>
			<p>Identificador del registro: <b>' .$row["id_dpto"] . '</b></p> 
			<p>Nombre del registro: <b>' . $row["nombre"] . '</b></p><br><br>';
			$output=$output . '<p align="center">Si desea eliminar otro departamento&nbsp;<a href="http://localhost/drupal/oficina/departamentos/baja_departamento">pulse aqu&iacute;</a></p>';		
		//}
		//else{
		//	$output='<p><b>Error al eliminar el registro con el nombre:&nbsp;' . $nombre . '<b></p>';
		//	$output=$output . '<p>'. mysqli_error($conexion) . '</p>';
		//}
	}
	else{
		$output='<br><br><b><p align="center">Operaci&oacute;n de eliminar departamento con el nombre<br>
		<font color="red">"' . $nombre . '"</font>
		<br>ha sido cancelada</b>
		<br>
		<p align="center">Si desea volver al apartado "Baja Departamento"&nbsp;<a href="http://localhost/drupal/oficina/departamentos/baja_departamento">pulse aqu&iacute;</a></p>'; 
	}
}
mysqli_close($conexion);
return $output;
 }  /** end baja_departamento **/


function modificar_departamento() {
$output="";

$conexion=bdexterna();	

if (!$_POST){
	$output='<form id="formModDpto" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formModDpto">
	<legend align="left"><SPAN style="text-align:top">Cambiar un departamento</SPAN></legend>
        <br><br>
	<p><SPAN style="text-align:center">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Seleccionar un Departamento:&nbsp;<p align="center"><select name="nombDpto" size="5" required>';
	
	$sql="SELECT nombre FROM departamentos";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result) > 0){
		$cont=0;
		while($row=mysqli_fetch_assoc($result)){
			$output= $output . '<option>' . $row["nombre"] . '</option>';
			$cont=$cont+1;//1906
			//$id=$row["id_dpto"];
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$lista='Lista sin departamentos';  $output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}
	$output= $output . '</p></select>
	<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Indicar el nuevo nombre de departamento:&nbsp; <input type="text" style="color:blue" name="nuevo" required></p></fieldset>
	</p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($error){
		$output= $output . '<input type="submit" value="Grabar" style="font-weight:bold; color:black" disabled>';
	}else{
		$output= $output . '<input type="submit" value="Grabar" style="font-weight:bold; color:black">';
	}  
	$output= $output . '</p></form>';
} 
else{
	$nombre=$_POST["nombDpto"];
	$nombnuevo=$_POST["nuevo"];
	mysqli_select_db($conexion, "colegio");
	$sql="SELECT ID_DPTO FROM departamentos WHERE NOMBRE='$nombre'";
	$result=mysqli_query($conexion, $sql);
	$id=mysqli_fetch_array($result);
	//$num=$id[0];
	if ($nombnuevo == ""){
		$output='<br><br><font color="red"><b>Atenci&oacute;n</b></font><br><br><p>No ha introducido ning&uacute;n dato para actualizar el registro seleccionado:&nbsp;<b>' . $nombre . '</b></p>&nbsp;';
		$output=$output . '<br><p align="center">Para volver a intentarlo&nbsp;<a href="http://localhost/drupal/oficina/departamentos/modificar_departamento">pulse aqu&iacute;</a></p>';
	} 
	else{
		$sql="UPDATE departamentos SET NOMBRE='$nombnuevo' WHERE ID_DPTO= '$id[0]'";
		if(mysqli_query($conexion, $sql)){
			$output= '<p><b>El departamento seleccionado se ha actualizado satisfactoriamente.</b></p> 
			<p>Nombre anterior del registro: <b>' . $_POST["nombDpto"] . '</b></p><p>Se ha actualizado por el nombre: <b>' . $_POST["nuevo"] . '</b></p>
			<p>Identificador de registro: <b>' . $id[0] . '</b></p><br>';
			$output=$output . '<p align="center">Si desea modificar otro departamento&nbsp;<a href="http://localhost/drupal/oficina/departamentos/modificar_departamento">pulse aqu&iacute;</a></p>'; 
		}
		else{
			$output='<p><b>Error al actualizar el registro con el nombre:&nbsp;' . $nombre . '<b></p>';
			$output=$output . '<p>'. mysqli_error($conexion) . '</p>';
		}
	}
} 
mysqli_close($conexion);
return $output;

}  /** end modificar_departamento  **/



/**********
		*********************** Docentes ***********************
***********/

function listar_docentes() {
$output="";
$tamano_pagina="2";

if(array_key_exists('pagina', $_GET)){
	$pagina=$_GET["pagina"];
}
else{
	$pagina=1;
}

$conexion=bdexterna();

$sql="SELECT * FROM docentes";
$result=mysqli_query($conexion, $sql);
$total_filas=mysqli_num_rows($result);
$total_paginas=ceil($total_filas / $tamano_pagina);

$sql="SELECT * FROM docentes LIMIT " . (($pagina-1) * $tamano_pagina) . "," . $tamano_pagina;
$result=mysqli_query($conexion, $sql);
$output='<p align="center"><b><font size="4">Listado de los Docentes del centro</font></b></p>';
$output=$output . '<table border="2"><tr>
<th><font size="2">Identificador</font></th>
<th><font size="2">DNI</font></th>
<th><font size="2">Nombre</font></th>
<th><font size="2">Apellidos</font></th></tr>';
if($total_filas > 0){
	while ($row=mysqli_fetch_assoc($result)){
		$output=$output . '<tr>
		<td><font color="blue" size="2">'. $row["ID_DOCENTES"] . '</font></td>
		<td><font color="blue" size="2">' . $row["DNI_D"] . '</font></td>
		<td><font color="blue" size="2">'. $row["NOMBRE"] . '</font></td>
		<td><font color="blue" size="2">'. $row["APELLIDOS"] . '</font></td></tr>';
	}
	$output=$output . '</table><br>';
}



if ($total_paginas > 1){
	for ($i=1;$i<=$total_paginas;$i++){
		if($pagina == $i){
			$output=$output . 'P&aacute;gina ' . $pagina . "&nbsp;&nbsp;";
		}
		else{
			$output=$output . '<a href="http://localhost/drupal/oficina/docentes/listar_docentes?pagina=' . $i . '">P&aacute;gina ' . $i . '</a>&nbsp;&nbsp;';
		}

	}
}

if (!$_POST){
	$output=$output . '<form id="formBuscarDocente" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formBuscarEst"><br><legend align="left"><SPAN style="text-align:top">B&uacute;squeda de informaci&oacute;n de docentes</SPAN></legend><br>
	<p>&emsp;&emsp;&emsp;Introducir el DNI/NIF de un docente de la lista:&ensp;&nbsp;<input style="color:blue" type="text" name="buscardni" placeholder="DNI con letra" required>
	<p align="center">&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&ensp;<input type="submit" value="Buscar Datos" style="font-weight:bold; color:black"></p>
	</fieldset></p></form>';
}
else{
	
	$dni=$_POST["buscardni"];
	$output= '<br><p align="center"><b>DATOS DE DOCENTE CON DNI ' . $dni . '</b>.</p>';
	$sql="SELECT * FROM docentes WHERE dni_d='$dni'";
	$result=mysqli_query($conexion, $sql);
	$reg=mysqli_fetch_assoc($result);
	if ($reg["NOMBRE"]==""){ 
		$output=$output . '<p align="center"><b><font color="red">Error:&nbsp;</font></b>el dni&nbsp;<b>' . $dni . '</b>&nbsp;no es de la lista de docentes</p>';
	}else{
		$dpto=$reg["ID_DPTO"];
		if ($result){
			$output=$output . '<p>Nombre:&nbsp;<b>' . $reg["NOMBRE"] . '</b></p>
			<p>Apellidos:&nbsp;<b>' . $reg["APELLIDOS"] . '</b></p>
			<p>Direcci&oacute;n:&nbsp;<b>' . $reg["DIRECCION"] . '</b></p>
			<p>Localidad:&nbsp;<b>' . $reg["LOCALIDAD"] . '</b></p>
			<p>Provincia:&nbsp;<b>' . $reg["PROVINCIA"] . '</b></p>
			<p>C&oacute;digo Postal:&nbsp;<b>' . $reg["CODIGO_P"] . '</b></p>
			<p>Tel&eacute;fono:&nbsp;<b>' . $reg["TELF_FIJO"] . '</b></p>
			<p>M&oacute;vil:&nbsp;<b>' . $reg["MOVIL"] . '</b></p>
			<p>Direcci&oacute;n de correo:&nbsp;<b>' . $reg["EMAIL"] . '</b></p>
			<p>Categor&iacute;a:&nbsp;<b>' . $reg["TIPO_D"] . '</b></p>';
			$jefe=$reg["JEFE_DPTO"];
			
			$sql="SELECT * FROM departamentos WHERE id_dpto='$dpto'";
			$result=mysqli_query($conexion, $sql);
			$nombDpto=mysqli_fetch_assoc($result);
		
			if ($jefe=='1'){
				$output=$output . '<p>Jefe de Departamento:&nbsp;<b>' . $nombDpto["NOMBRE"] . '</b></p>';
			}else{
				$output=$output . '<p>Departamento:&nbsp;<b>' . $nombDpto["NOMBRE"] . '</b></p>';
			}
			$output=$output . '<br><p align="center"><b>Para realizar una nueva b&uacute;squeda,&nbsp;<a href="http://localhost/drupal/oficina/docentes/listar_docentes">pulse aqu&iacute;</a></b></p>';
		 
		}else{
			$output=$output . '<p align="center"><b>Incorrecto el DNI, no se encuentra</b></p>';
		}
	}
	
}

mysqli_close($conexion);

return $output;
}	/** end listar_docentes **/


function alta_docente() {
$output="";
$conexion=bdexterna();
$etiq_Doc=array("Nombre","Apellidos", "DNI/NIF", "Direcci&oacute;n", "Localidad", "Provincia","Categor&iacute;a", "Tel&eacute;fono", "M&oacute;vil",  "Email", "C&oacute;digo Postal", "Departamento", "Jefe de Departamento");

if (!$_POST){
	$output='<form id="formAltaDocente" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formAltaDocente">
	<legend align="left"><SPAN style="text-align:top">Introducir datos personales del nuevo docente</SPAN></legend>
        <br><br>
	<p>&emsp;&emsp;DNI/NIF:&emsp;<input type="text" style="color:blue" name="dniDocente" maxlength="9" required autofocus placeholder="DNI con Letra">
	&emsp;&emsp;&emsp;&emsp;&ensp;Nombre:&emsp;<input type="text" style="color:blue" name="nombDocente" required></p>
	<p>&emsp;&emsp;Apellidos:&emsp;<input type="text" style="color:blue" name="apellidosDocente" required>	
	&emsp;&emsp;&emsp;&emsp;&ensp;Direcci&oacute;n:&emsp;<input type="text" style="color:blue" name="dirDocente"></p>
	<p>&emsp;&emsp;Localidad:&emsp;<input type="text" style="color:blue" name="localidadDocente">
	&emsp;&emsp;&emsp;&emsp;&ensp;Provincia:&emsp;<input type="text" style="color:blue" name="provDocente"></p>
	<p>&emsp;&emsp;C&oacute;digo Postal:&emsp;<input type="num" style="color:blue" name="cpDocente" maxlength="5">		
	&emsp;&emsp;&ensp;Tel&eacute;fono fijo:&emsp;<input type="tel" style="color:blue" name="telDocente" maxlength="9"></p>	
	<p>&emsp;&emsp;M&oacute;vil:&emsp;<input type="tel" style="color:blue" name="movilDocente" maxlength="9">		
	&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;Email:&emsp;<input type="email" style="color:blue" name="emailDocente" required></p>	
	</fieldset>
	</p>
	<p>
	<fieldset form="formAltaDocente">
	<legend align="left"><SPAN style="text-align:top">Introducir datos profesionales del nuevo docente</SPAN></legend>
        <br><br>
	&emsp;&emsp;Seleccionar categor&iacute;a:&nbsp;<p align="center"><select name="categoriaDocente" required size="2">
		<option>Maestro/a</option><option>Profresor/a</option></select></p>
	&emsp;&emsp;Seleccionar Departamento:&nbsp;<p align="center"><select name="dptoDocente" required size="6">';
	
	$sql="SELECT nombre FROM departamentos";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result) > 0){
		$cont=0;
		while($row=mysqli_fetch_assoc($result)){
			$output= $output . '<option>' . $row["nombre"] . '</option>';
			$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$lista='Lista sin departamentos';  $output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}

	$output=$output . '</select></p>
	<p>&emsp;&emsp;Jefe de Departamento:&emsp;
		<input type="radio" name="jefeDptoDocente" value="0" checked>&ensp;&nbspNo&ensp;&nbsp
		<input type="radio" name="jefeDptoDocente" value="1">&ensp;&nbspSi</p>		
	</fieldset>
	</p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&emsp;&nbsp;';
	if ($error){
		$output=$output . '<input type="submit" value="Agregar" style="font-weight:bold; color:black" disabled>';
	}else{
		$output=$output . '<input type="submit" value="Agregar" style="font-weight:bold; color:black">';
	} 
	$output=$output . '</p>
	</form>';
 }
elseif (($_POST['dniDocente'] == "") && ($_POST['nombDocente'] == "") && ($_POST['apellidosDocente'] == "") && ($_POST['emailDocente'] == "")){
		$output='<br><font color="red"><b>Atenci&oacute;n</b></font><br><br><p>No puede dar de alta un Docente sin introducir los datos requeridos (DNI, NOMBRE, APELLIDOS)</p><p align="center">Para volver hacia atr&aacute;s&nbsp;<a href="http://localhost/drupal/oficina/docentes/alta_docente">pulse aqu&iacute;</a></p>'; 

} 
else{
	$reg[0]=$_POST["nombDocente"];		$reg[1]=$_POST["apellidosDocente"];//1595
	$reg[2]=$_POST["dniDocente"];		$reg[3]=$_POST["dirDocente"];
	$reg[4]=$_POST["localidadDocente"];	$reg[5]=$_POST["provDocente"];
	$reg[6]=$_POST["cpDocente"];		$reg[7]=$_POST["telDocente"];
	$reg[8]=$_POST["movilDocente"];		$reg[9]=$_POST["emailDocente"];
	$reg[10]=$_POST["categoriaDocente"];	$reg[11]=$_POST["dptoDocente"];
	$reg[12]=$_POST["jefeDptoDocente"];

	$sql="SELECT id_dpto FROM departamentos WHERE nombre='$reg[11]'";
	$result=mysqli_query($conexion, $sql);
	$idDpto=mysqli_fetch_array($result);
	$sql="INSERT INTO docentes (ID_DOCENTES, ID_DPTO, DNI_D, NOMBRE, APELLIDOS, TIPO_D, JEFE_DPTO, MOVIL, DIRECCION, LOCALIDAD, CODIGO_P, PROVINCIA, EMAIL, TELF_FIJO) 
		VALUES (NULL, '$idDpto[0]', '$reg[2]', '$reg[0]', '$reg[1]', '$reg[10]', '$reg[12]', '$reg[8]', '$reg[3]', '$reg[4]', '$reg[6]', '$reg[5]', '$reg[9]', '$reg[7]')";
	if(mysqli_query($conexion, $sql)){
		$ant_id=mysqli_insert_id($conexion);
		$output= '<p><b>Nuevo Docente registrado satisfactoriamente</b>.</p><p>Identificador de nuevo registro:&nbsp<b>' . $ant_id . '</b></p>'; 
		for($i=0;$i<13;$i++){
			if($reg[$i]<>""){
				$output=$output . '<p><em>' . $etiq_Doc[$i] . ':&nbsp;</em><b>' . $reg[$i] .'</b></p>';	
			}
			
		}
		if($reg[$i]){
			$output= $output . '<p><em>' . $etiq_Doc[$i] . ':&nbsp;</em><b>Si</b></p>';
		}else{
			$output= $output . '<p><em>' . $etiq_Doc[$i] . ':&nbsp;</em><b>No</b></p>';
		}		
		$output= $output . '<br><br>
		<p align="center">Si desea agregar otro departamento <a href="http://localhost/drupal/oficina/docentes/alta_docente">pulse aqu&iacute;</a></p>'; 
	}
	
}

mysqli_close($conexion);

return $output;
}	/** end alta_docente  **/


function baja_docente() {
$output="";
$conexion=bdexterna();

if (!$_POST){
	$output='<form id="formBajaDocente" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formBajaDocente">
	<legend align="left"><SPAN style="text-align:top">Eliminar un docente</SPAN></legend>
        <br><br>
	<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Seleccionar DNI/NIF de docente:&emsp;&ensp;<p align="center">
	<select required name="dniDocente" size="6">';
	$sql="SELECT * FROM docentes";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result) > 0){
		$cont=0;
		while($row=mysqli_fetch_assoc($result)){
			$output= $output . '<option>' . $row["DNI_D"] . '</option>';
			$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$lista='Lista sin dni de docentes';  $output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}
	$output=$output . '</select></p></p>
	</fieldset>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&emsp;&nbsp;'; 
	if ($error){
		$output=$output . '<input type="submit" name="Eliminar" value="Eliminar" style="font-weight:bold; color:black" disabled>';
	}else{
		$output=$output . '<input type="submit" name="Eliminar" value="Eliminar" style="font-weight:bold; color:black">';
	} 
	$output=$output . '</p>
	</form>';
} 
elseif(isset($_POST["Eliminar"])){
	$dni=$_POST["dniDocente"];
	$sql="SELECT nombre, apellidos FROM docentes WHERE dni_d='$dni'";
	$result=mysqli_query($conexion, $sql);
	$reg=mysqli_fetch_array($result);

	$output='<form id="formConfirmarDoc" action="" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formConfirmarDoc">
	<legend align="left"><SPAN style="text-align:top">Confirmar Baja</SPAN></legend>
        <br><br><p align="center"> Seguro que desea dar de baja al docente con:</p>
	<p align="center">DNI/NIF<b>&nbsp;"' . $dni . '"</b></p>
	<p align="center">Apellidos y Nombre<b>&nbsp;"' . $reg[1] . ',&nbsp;' . $reg[0] . '"</b></p>
	<p align="center"><input type="submit" value="Aceptar" name="Aceptar" style="font-weight:bold; color:black">&emsp;
	<input type="submit" name="Cancelar" value="Cancelar" style="font-weight:bold; color:black">
	<input type="hidden" name="dniDoc" value="' . $dni . '"><input type="hidden" name="Doc" value="' . $reg[1] . ',&nbsp;' . $reg[0] . '">
	</p></fieldset></p></form>';

}
else{
	$dni=$_POST["dniDoc"];
	$ApelNomb=$_POST["Doc"];
	if(isset($_POST["Aceptar"])){
		$sql="SELECT * FROM docentes WHERE dni_d='$dni'";
		$result=mysqli_query($conexion, $sql);
		$reg=mysqli_fetch_array($result);
		//$sql="DELETE FROM docentes WHERE ID_DOCENTES='$id[0]'";
			//if(mysqli_query($conexion, $sql)){	
				$output= $output .'<p><b>El docente seleccionado se ha borrado satisfactoriamente</b>.</p>
				<p>Identificador del registro: <b>' .$reg[0] . '</b></p> 
				<p>DNI del docente: <b>' . $reg[2] . '</b></p>
				<p>Nombre del docente: <b>' . $reg[3] . '</b></p>
				<p>Apellidos del docente: <b>' . $reg[4] . '</b></p><br><br>';
				$output=$output . '<p align="center">Si desea eliminar otro docente&nbsp;<a href="http://localhost/drupal/oficina/docentes/baja_docente">pulse aqu&iacute;</a></p>';		
			//}
			//else{
			//	$output='<p><b>Error al eliminar el registro con el D.N.I.:&nbsp;' . $dni . '<b></p>';
			//	$output=$output . '<p>'. mysqli_error($conexion) . '</p>';
			//}
	}else{
		$output='<br><br><b><p align="center">Operaci&oacute;n de eliminar docente con:<br>
		Apellidos y Nombre&nbsp;<font color="red">"' . $ApelNomb . '"</font><br>y DNI/NIF&nbsp;
		<font color="red">"' . $dni . '"</font><br>ha sido cancelada</b>
		<br>
		<p align="center">Si desea volver al apartado "Baja Docente"&nbsp;<a href="http://localhost/drupal/oficina/docentes/baja_docente">pulse aqu&iacute;</a></p>'; 

	}
}

mysqli_close($conexion);
return $output;

}	/** end baja_docente  **/


function modificar_docente() {
$output="";
$conexion=bdexterna();
$etiq_Per=array("Nombre","Apellidos","DNI/NIF","Direcci&oacute;n","Localidad","Provincia","C&oacute;digo Postal","Tel&eacute;fono","M&oacute;vil","Email");
$etiq_Prof=array("Categor&iacute;a","Departamento","Jefe de Departamento");

if ((!$_POST) OR (isset($_POST["Cancelar"]))){
	
	$output='<form id="formModDocente" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formModDocente">
	<legend align="left"><SPAN style="text-align:top">Cambiar datos de un docente</SPAN></legend>
        <br><br>
	&emsp;&nbsp;Seleccionar un DNI/NIF de docente:&nbsp;<p align="center"><select name="dniDocente" size="5" required>';
	
	$sql="SELECT dni_d FROM docentes";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result) > 0){
		$cont=0;
		while($row=mysqli_fetch_assoc($result)){
			$output= $output . '<option>' . $row["dni_d"] . '</option>';
			$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$lista='Lista sin dni de docentes';  $output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}
	$output= $output . '</select></p>
	&emsp;&nbsp;Indicar tipo de datos a modificar:&nbsp;<p align="center"><select name="tipoDatos" size="2" required>
	<option>Personales</option><option>Profesionales</option></select>
	</p>
	</fieldset>
	</p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&emsp;&nbsp;';
	if ($error){
		$output= $output . '<input type="submit" name="Siguiente" value="Siguiente" style="font-weight:bold; color:black" disabled>';
	}else{
		$output= $output . '<input type="submit" name="Siguiente" value="Siguiente" style="font-weight:bold; color:black">';
	}
	$output= $output . '</p></form>';
} 
elseif (isset($_POST["Siguiente"])){
	$dni=$_POST["dniDocente"];
	$tipod=$_POST["tipoDatos"];
	
	$sql="SELECT * FROM docentes WHERE dni_d='$dni'";
	$result=mysqli_query($conexion, $sql);
	$reg=mysqli_fetch_array($result);
	$output='<form id="formModDocS" action="" method="post" accept-charset="UTF-8" size="100%">
	<p><fieldset form="formModDocS">';
	if ($tipod == "Personales"){
		$output=$output . '<legend align="left"><SPAN style="text-align:top">Modificar datos personales del docente</SPAN></legend>
        	<br><br>
		<p>&emsp;&emsp;DNI/NIF:&emsp;<input type="text" style="color:blue" name="dniDocente" maxlength="9" value="' . $reg[2] . '" required autofocus placeholder="DNI con Letra">
		&emsp;&emsp;&emsp;&emsp;&ensp;Nombre:&emsp;<input type="text" style="color:blue" name="nombDocente" value="' . $reg[3] . '"required></p>
		<p>&emsp;&emsp;Apellidos:&emsp;<input type="text" style="color:blue" name="apellidosDocente" value="' . $reg[4] . '"required>	
		&emsp;&emsp;&emsp;&emsp;&ensp;Direcci&oacute;n:&emsp;<input type="text" style="color:blue" name="dirDocente" value="' . $reg[8] . '"></p>
		<p>&emsp;&emsp;Localidad:&emsp;<input type="text" style="color:blue" name="localidadDocente" value="' . $reg[9] . '">
		&emsp;&emsp;&emsp;&emsp;&ensp;Provincia:&emsp;<input type="text" style="color:blue" name="provDocente" value="' . $reg[11] . '"></p>
		<p>&emsp;&emsp;C&oacute;digo Postal:&emsp;<input type="num" style="color:blue" name="cpDocente" maxlength="5" value="' . $reg[10] . '">		
		&emsp;&emsp;&emsp;Tel&eacute;fono fijo:&emsp;<input type="tel" style="color:blue" name="telDocente" maxlength="9" value="' . $reg[13] . '"></p>	
		<p>&emsp;&emsp;M&oacute;vil:&emsp;<input type="tel" style="color:blue" name="movilDocente" maxlength="9" value="' . $reg[7] . '">		
		&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&ensp;Email:&emsp;<input type="email" style="color:blue" name="emailDocente" value="' . $reg[12] . '" required></p>
		<input type="hidden" name="oculto" value="Personales"><input type="hidden" value="' . $reg[0] . '" name="idDocente">';	
	}
	else{
		if($reg[5]=="Maestro/a"){
			$cadena1='<option selected>Maestro/a</option><option>Profresor/a</option></select>';
		}
		else{
			$cadena1='<option>Maestro/a</option><option selected>Profresor/a</option></select>';
		}
		if($reg[6]=='1'){
			$cadena2='<input type="radio" name="jefeDptoDocente" value="0" >&ensp;&nbsp;No&ensp;&nbsp;
				<input type="radio" name="jefeDptoDocente" value="1" checked>&ensp;&nbspSi</p>';
		}
		else{
			$cadena2='<input type="radio" name="jefeDptoDocente" value="0" checked>&ensp;&nbspNo&ensp;&nbsp;
				<input type="radio" name="jefeDptoDocente" value="1">&ensp;&nbspSi</p>';
		}
		$output=$output . '<legend align="left"><SPAN style="text-align:top">Modificar datos profesionales del docente</SPAN></legend>
        	<br><br>
		<p align="center">DNI/NIF:&nbsp;<input type="text" style="color:black" name="dniDocente" value="' . $reg[2] . '" disabled size=10%></p>
		<p align="center">Nombre:&nbsp;<input type="text" style="color:black" name="dniDocente" value="' . $reg[3] . '" disabled size=15%>
		&emsp;&emsp;Apellidos:&nbsp;<input type="text" style="color:black" name="dniDocente" value="' . $reg[4] . '" disabled size=35%></p>
		<hr size="10" width="98%"><br>
		&emsp;&emsp;Categor&iacute;a:&nbsp;<p align="center"><select name="categoriaDocente" required size="2">' . $cadena1 . '</p>
		&emsp;&emsp;Departamento:&nbsp;<p align="center"><select name="dptoDocente" required size="6">';
	
		$sql="SELECT id_dpto, nombre FROM departamentos";
		$result=mysqli_query($conexion, $sql);
		if (mysqli_num_rows($result) > 0){
			while($dpto=mysqli_fetch_assoc($result)){
				if($reg[1]==$dpto["id_dpto"]){
					$output= $output . '<option selected>' . $dpto["nombre"] . '</option>';
				}
				else{
					$output= $output . '<option>' . $dpto["nombre"] . '</option>';
				}
			}
		}
		else{
		  	$output= $output . '<option></option>';
		}

		$output=$output . '</select></p>
		<p>&emsp;&nbsp;&nbsp;&nbsp;Jefe de Departamento:&emsp;' . $cadena2 . '<input type="hidden" name="oculto" value="Profesinales">
		<input type="hidden" name="idDocente" value="' . $reg[0] . '">';		
	}
	$output=$output . '</fieldset></p><input type="submit" value="Grabar" name="Grabar"style="font-weight:bold; color:black">
	&emsp;&nbsp;&nbsp;&nbsp;<input type="submit" value="Cancelar" name="Cancelar"style="font-weight:bold; color:black"></form>';
}elseif (isset($_POST["Grabar"])){
	if ($_POST["oculto"]=="Personales"){//1800
		$id=$_POST["idDocente"];
		$reg[0]=$_POST["nombDocente"];$reg[1]=$_POST["apellidosDocente"];$reg[2]=$_POST["dniDocente"];
		$reg[3]=$_POST["dirDocente"];$reg[4]=$_POST["localidadDocente"];$reg[5]=$_POST["provDocente"];$reg[6]=$_POST["cpDocente"];
		$reg[7]=$_POST["telDocente"];$reg[8]=$_POST["movilDocente"];$reg[9]=$_POST["emailDocente"];
		
//$etiq_Per=array("Nombre","Apellidos","DNI/NIF","Direcci&oacute;n","Localidad","Provincia","C&oacute;digo Postal","Tel&eacute;fono","M&oacute;vil","Email");		

		$sql="UPDATE docentes SET DNI_D='$reg[2]', NOMBRE='$reg[0]', APELLIDOS='$reg[1]', MOVIL='$reg[8]', DIRECCION='$reg[3]', LOCALIDAD='$reg[4]', CODIGO_P='$reg[6]', PROVINCIA='$reg[5]', EMAIL='$reg[9]', TELF_FIJO='$reg[7]' WHERE ID_DOCENTES='$id'";
		if(mysqli_query($conexion, $sql)){
			$output= $output . '<p><b>El docente seleccionado se ha actualizado satisfactoriamente.</b></p>
			<p>Los datos personales grabados son:</p>';
			for ($i=0;$i<10;$i++){
				if($reg[$i]<>""){
					$output= $output . '<p>&nbsp;&nbsp;&nbsp;&nbsp;<em>' . $etiq_Per[$i] . ':</em>&nbsp;<b>' . $reg[$i] . '</b></p>';
				}
			}
			$output= $output . '<br><br>
			<p align="center">Si desea modificar otro docente <a href="http://localhost/drupal/oficina/docentes/modificar_docente">pulse aqu&iacute;</a></p>'; 
		}
		else{
			$output='<p><b>Error al actualizar el registro de docente<b></p>';
			$output=$output . '<p>'. mysqli_error($conexion) . '</p>';
		}
	}
	else{
		$id=$_POST["idDocente"];
		$reg[0]=$_POST["categoriaDocente"];$reg[1]=$_POST["dptoDocente"];$reg[2]=$_POST["jefeDptoDocente"];
//$etiq_Prof=array("Categor&iacute;a","Departamento","Jefe de Departamento");
		
		$sql="SELECT id_dpto FROM departamentos WHERE nombre='$reg[1]'";
		$idDpto=mysqli_fetch_array(mysqli_query($conexion, $sql));
		$sql="SELECT dni_d FROM docentes WHERE id_docentes='$id'";
		$dni=mysqli_fetch_array(mysqli_query($conexion, $sql));

		$sql="UPDATE docentes SET  ID_DPTO='$idDpto[0]', TIPO_D='$reg[0]', JEFE_DPTO='$reg[2]' WHERE ID_DOCENTES='$id'";
		if(mysqli_query($conexion, $sql)){
			$output= $output . '<p><b>El docente seleccionado con D.N.I.&nbsp;' . $dni[0] . '&nbsp;se ha actualizado satisfactoriamente.</b></p>
			<p>Los datos profesionales grabados son:</p>';
			for ($i=0;$i<2;$i++){
				if($reg[$i]<>""){
					$output= $output . '<p>&nbsp;&nbsp;&nbsp;&nbsp;<em>' . $etiq_Prof[$i] . ':</em>&nbsp;<b>' . $reg[$i] . '</b></p>';
				}
			}
			
			if ($reg[$i]){
			 	$output= $output . '<p>&nbsp;&nbsp;&nbsp;&nbsp;<em>' . $etiq_Prof[$i] . ':</em>&nbsp;<b>Si</b></p>';
			}
			else{
				$output= $output . '<p>&nbsp;&nbsp;&nbsp;&nbsp;<em>' . $etiq_Prof[$i] . ':</em>&nbsp;<b>No</b></p>';
			}
			$output= $output . '<br><br>
			<p align="center">Si desea modificar otro docente <a href="http://localhost/drupal/oficina/docentes/modificar_docente">pulse aqu&iacute;</a></p>'; 
		}
		else{
			$output='<p><b>Error al actualizar el registro de docente<b></p>';
			$output=$output . '<p>'. mysqli_error($conexion) . '</p>';
		}
	}
	
} 

mysqli_close($conexion);
return $output;

}	/** end modificar_docente **/


/****************
			******************* Estudiantes *********************
*****************/
function listar_estudiantes(){
$output="";
$tamano_pagina="2";

if(array_key_exists('pagina', $_GET)){
	$pagina=$_GET["pagina"];
}
else{
	$pagina=1;
}

$conexion=bdexterna();

$sql="SELECT * FROM estudiantes";
$result=mysqli_query($conexion, $sql);
$total_filas=mysqli_num_rows($result);
$total_paginas=ceil($total_filas / $tamano_pagina);

$sql="SELECT * FROM estudiantes LIMIT " . (($pagina-1) * $tamano_pagina) . "," . $tamano_pagina;
$result=mysqli_query($conexion, $sql);
$output='<p align="center"><b><font size="4">Listado de los Estudiantes del centro</font></b></p>';
$output=$output . '<table border="2"><tr>
<th><font size="2">Identificador</font></th>
<th><font size="2">DNI</font></th>
<th><font size="2">Nombre</font></th>
<th><font size="2">Apellidos</font></th></tr>';
if($total_filas > 0){
	while ($row=mysqli_fetch_assoc($result)){
		$output=$output . '<tr>
		<td><font color="blue" size="2">'. $row["ID_EST"] . '</font></td>
		<td><font color="blue" size="2">' . $row["DNI"] . '</font></td>
		<td><font color="blue" size="2">'. $row["NOMBRE"] . '</font></td>
		<td><font color="blue" size="2">'. $row["APELLIDOS"] . '</font></td></tr>';
	}
	$output=$output . '</table><br>';
}



if ($total_paginas > 1){
	for ($i=1;$i<=$total_paginas;$i++){
		if($pagina == $i){
			$output=$output . 'P&aacute;gina ' . $pagina . "&nbsp;&nbsp;";
		}
		else{
			$output=$output . '<a href="http://localhost/drupal/oficina/estudiantes/listar_estudiantes?pagina=' . $i . '">P&aacute;gina ' . $i . '</a>&nbsp;&nbsp;';
		}

	}
}

if (!$_POST){
	$output=$output . '<br><br><form id="formBuscarEst" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formBuscarEst"><br><legend align="left"><SPAN style="text-align:top">B&uacute;squeda de informaci&oacute;n de estudiantes</SPAN></legend><br>
	<p>&emsp;&emsp;&emsp;Indroducir identificador de estudiante:&ensp;&nbsp;<input style="color:blue" type="text" name="buscarid" placeholder="Identificador" required></p>
	<p>&emsp;&emsp;&emsp;Seleccionar datos de:&ensp;&nbsp;<select name="datos"><option selected>Estudiante</option><option>Padres</option></select></p>
	<p align="center">&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<input type="submit" value="Buscar Datos" style="font-weight:bold; color:black"></p>
	</fieldset></p></form>';
}
else{
	$id=$_POST["buscarid"];
	$sql="SELECT * FROM estudiantes WHERE id_est='$id'";
	$result=mysqli_query($conexion, $sql);
	$row=mysqli_fetch_assoc($result);

	if ($row["NOMBRE"]==""){ 
		$output='<p align="center"><b><font color="red">Error:&nbsp;</font></b>el identificador&nbsp;<b>' . $id . '</b>&nbsp;no es de la lista de estudiantes</p>';
		$output= $output . '<br>
				<p align="center"><b>Si desea volver al listado de estudiantes&nbsp;<a href="http://localhost/drupal/oficina/estudiantes/listar_estudiantes">pulse aqu&iacute;</a></b></p>'; 
	}
	else{
		if ($_POST["datos"]=="Estudiante"){
			$output= '<br><p align="center"><b>DATOS DE ESTUDIANTE CON IDENTIFICADOR ' . $id . '</b>.</p>';
			if ($result){
				preg_match("/([0-9]{4})\-([0-9]{1,2})\-([0-9]{1,2})/", $row["FECHA_NACIMIENTO"], $fecha);
				$fechaEst=$fecha[3] . "/" . $fecha[2] . "/" . $fecha[1];
				preg_match("/([0-9]{4})\-([0-9]{1,2})\-([0-9]{1,2})/", $row["FECHA_APERTURA"], $fecha);
				$fapertura=$fecha[3] . "/" . $fecha[2] . "/" . $fecha[1];
				preg_match("/([0-9]{4})\-([0-9]{1,2})\-([0-9]{1,2})/", $row["FECHA_CIERRE"], $fecha);
				$fcierre=$fecha[3] . "/" . $fecha[2] . "/" . $fecha[1];	
	
				$output=$output . '<p>Nombre:&nbsp;<b>' . $row["NOMBRE"] . '</b></p>
				<p>Apellidos:&nbsp;<b>' . $row["APELLIDOS"] . '</b></p>
				<p>Direcci&oacute;n:&nbsp;<b>' . $row["DIRECCION"] . '</b></p>
				<p>Localidad:&nbsp;<b>' . $row["LOCALIDAD"] . '</b></p>
				<p>Provincia:&nbsp;<b>' . $row["PROVINCIA"] . '</b></p>
				<p>C&oacute;digo Postal:&nbsp;<b>' . $row["CPOSTAL"] . '</b></p>
				<p>Fecha de Nacimiento:&nbsp;<b>' . $fechaEst . '</b></p>';
				if($row["DNI"]<>""){
					$output=$output . '<p>D.N.I.:&nbsp;<b>' . $row["DNI"] . '</b></p>';
				}
				$output=$output . '<p>Expediente:&nbsp;<b>' . $row["FICHA_EXP"] . '</b></p>
				<p>Fecha Apertura Expediente:&nbsp;<b>' . $fapertura . '</b></p>';
				if($row["FECHA_CIERRE"]<>"0000-00-00"){
					$output=$output . '<p>Fecha Cierre Expediente:&nbsp;<b>' . $fcierre . '</b></p>';
				}
				if ($row["EXTERNO"]<>'0'){
					$output=$output . '<p>Estudiante de otro centro:&nbsp;<b>S&iacute;</b></p>';
				}
				$output= $output . '<br><p align="center"><b>Si desea volver al listado de estudiantes&nbsp;<a href="http://localhost/drupal/oficina/estudiantes/listar_estudiantes">pulse aqu&iacute;</a></b></p>'; 
			}
			else{
				$output=$output . '<p align="center"><b>Fallo del sistema al realizar la consulta, puede intentarlo m&aacute;s tarde</b></p>';
				$output= $output . '<br>
				<p align="center"><b>Si desea volver al listado de estudiantes&nbsp;<a href="http://localhost/drupal/oficina/estudiantes/listar_estudiantes">pulse aqu&iacute;</a></b></p>'; 
			}
		
		}
		else{
			$id_p=$row["ID_PADRES"];
			$output='<br><p align="center"><b>DATOS FAMILIARES DEL ESTUDIANTE ' . $row["NOMBRE"] . ' ' . $row["APELLIDOS"] .'</b>.</p>';
			$sql1="SELECT * FROM padres WHERE id_padres='$id_p'";
			$result1=mysqli_query($conexion, $sql1);
			$row1=mysqli_fetch_assoc($result1);

			preg_match("/([0-9]{4})\-([0-9]{1,2})\-([0-9]{1,2})/", $row1["F_NAC_PADRE"], $fecha);
			$fechaP=$fecha[3] . "/" . $fecha[2] . "/" . $fecha[1];
			preg_match("/([0-9]{4})\-([0-9]{1,2})\-([0-9]{1,2})/", $row1["F_NAC_MADRE"], $fecha);
			$fechaM=$fecha[3] . "/" . $fecha[2] . "/" . $fecha[1];

			if ($result1){
				$output=$output . '<p><u>DATOS DEL PADRE</u></p>
				<p>Nombre:&nbsp;<b>' . $row1["NOMB_PADRE"] . '</b>&emsp;&emsp;Apellidos:&nbsp;<b>' . $row1["APEL_PADRE"] . '</b></p>
				<p>D.N.I.:&nbsp;<b>' . $row1["DNI_P"] . '</b>&emsp;&emsp;Fecha nacimiento:&nbsp;<b>' . $fechaP . '</b></p>
				<p>Profesi&oacute;n:&nbsp;<b>' . $row1["PROF_PADRE"] . '</b>&emsp;&emsp;M&oacute;vil:&nbsp;<b>' . $row1["MOVIL_PADRE"] . '</b></p>
				<p><u>DATOS DE LA MADRE</u></p>
				<p>Nombre:&nbsp;<b>' . $row1["NOMB_MADRE"] . '</b>&emsp;&emsp;Apellidos:&nbsp;<b>' . $row1["APEL_MADRE"] . '</b></p>
				<p>D.N.I.:&nbsp;<b>' . $row1["DNI_M"] . '</b>&emsp;&emsp;Fecha nacimiento:&nbsp;<b>' . $fechaM . '</b></p>
				<p>Profesi&oacute;n:&nbsp;<b>' . $row1["PROF_MADRE"] . '</b>&emsp;&emsp;M&oacute;vil:&nbsp;<b>' . $row1["MOVIL_MADRE"] . '</b></p>';
				$output= $output . '<br>
				<p align="center"><b>Si desea volver al listado de estudiantes&nbsp;<a href="http://localhost/drupal/oficina/estudiantes/listar_estudiantes">pulse aqu&iacute;</a></b></p>'; 
			}
			else{
				$output=$output . '<p align="center"><b>Fallo del sistema al realizar la consulta, puede intentarlo m&aacute;s tarde</b></p>';
				$output= $output . '<br>
				<p align="center"><b>Si desea volver al listado de estudiantes&nbsp;<a href="http://localhost/drupal/oficina/estudiantes/listar_estudiantes">pulse aqu&iacute;</a></b></p>'; 
			}
		

		}


	}
}

mysqli_close($conexion);

return $output;
}	/** end listar_estudiantes **/


/***************************** Alta estudiante *************************/
function alta_estudiante() {
$output="";$padres=[];$est=[];
$conexion=bdexterna();
$etiq_Est= array("Nombre", "Apellidos", "Direcci&oacute;n", "Localidad", "Provincia", "C&oacute;digo Postal", "Tel&eacute;fono", "DNI/NIF", "Fecha de Nacimiento", "N&uacute;mero Expediente", "Fecha Apertura");
$etiq_P= array("Nombre", "Apellidos",  "Fecha de Nacimiento",  "DNI/NIF", "Profesi&oacute;n", "M&oacute;vil", "OBSERVACIONES");


if (!$_POST){
	$output='<form id="formInicioEstudiante" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formInicioEstudiante">
	<legend align="left"><SPAN style="text-align:top">Informaci&oacute;n de tutores para alta estudiante</SPAN></legend>
        <br><br>
	<p>&emsp;&emsp;DNI/NIF Tutor1:&emsp;<input type="text" style="color:blue" name="dniT1" required maxlength="9" placeholder="DNI con Letra">
	&emsp;&emsp;&ensp;DNI/NIF Tutor2:&emsp;<input type="text" style="color:blue" name="dniT2" required maxlength="9" placeholder="DNI con Letra"></p>
	<p align="center">Hijos/as matriculados/as en el centro:&ensp;<input type="radio" name="nuevoEst" value="0" required checked>&ensp;S&iacute;&ensp;
	<input type="radio" name="nuevoEst" value="1" required>&ensp;No</p>
	</fieldset>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="submit" value="Siguiente" name="Siguiente" style="font-weight:bold; color:black"></p>  
	</p>
	</form>';
	
}
elseif (isset($_POST["Siguiente"])){
	$nuevo=$_POST['nuevoEst'];
	if(($_POST['dniT1'] == "") || ($_POST['dniT2'] == "")){
		$output='<br><font color="red"><b>Atenci&oacute;n</b></font><br><br><p>No se ha introducido todos los datos requeridos:</p>
		<p>DNI/NIF de Tutor1 y de Tutor2</p><br>
		<p><input type="button" onclick="history.back()" value="Volver Atr&aacute;s" name="Volver Atras" style="font-weight:bold; color:black"></p>'; 
	}
	else{
		if ($nuevo=='1'){   	//Introducir datos de familia  
			$dniP=$_POST['dniT1'];	$dniM=$_POST['dniT2'];
			$sql1="SELECT * FROM padres WHERE DNI_P='$dniP' AND DNI_M='$dniM'";
			$result1=mysqli_query($conexion, $sql1);//1954
			if($result1){
				if(mysqli_num_rows($result1) == 0){
					$output='<form id="formAlta1Est" action="" method="post" accept-charset="UTF-8" size="100%">
					<p>
					<fieldset form="formAltaAlta1Est">
					<legend align="left"><SPAN style="text-align:top">Introducir datos del nuevo estudiante</SPAN></legend>
        				<br><br>
					<p>&emsp;&emsp;Fecha Apertura Exp:&emsp;<input type="text" style="color:blue" name="fechaApertura" required size="15" placeholder="dd/mm/aaaa" autofocus>
					&emsp;&emsp;N&uacute;mero de Expediente:&emsp;<input type="text" style="color:blue" name="Exp" required size="15"></p>
					<p>&emsp;&emsp;Nombre:&emsp;<input type="text" style="color:blue" name="nombEst" required>
					&emsp;&emsp;&emsp;&emsp;&ensp;Apellidos:&emsp;<input type="text" style="color:blue" name="apellidosEst" required></p>
					<p>&emsp;&emsp;Fecha Nacimiento:&emsp;<input type="date" style="color:blue" name="fechaNacEst" required placeholder="dd/mm/aaaa" maxlength="10">
					&emsp;&emsp;DNI/NIF&emsp;<input type="text" style="color:blue" name="dniEst" maxlength="9" placeholder="DNI con Letra"></p>
					<p>&emsp;&emsp;Direcci&oacute;n:&emsp;<input type="text" style="color:blue" name="dirEst">
					&emsp;&emsp;&emsp;&emsp;&ensp;Localidad:&emsp;<input type="text" style="color:blue" name="localidadEst"></p>
					<p>&emsp;&emsp;Provincia:&emsp;<input type="text" style="color:blue" name="provEst">
					&emsp;&emsp;&emsp;&emsp;&ensp;C&oacute;digo Postal:&emsp;<input type="num" style="color:blue" name="cpEst" maxlength="5"></p>
					<p>&emsp;&emsp;Tel&eacute;fono fijo:&emsp;<input type="tel" style="color:blue" name="telEst" maxlength="9"></p>			
					</fieldset></p>
					<p>
					<fieldset form="formAltaAlta1Est">
					<legend align="left"><SPAN style="text-align:top">Introducir datos del padre<SPAN></legend>
        				<br><br>
					<p>&emsp;&emsp;DNI/NIF:&emsp;<input type="text" style="color:blue" name="dniP" value="' . $dniP . '" maxlength="9" required>
					&emsp;&emsp;&emsp;&emsp;&ensp;Fecha Nacimiento:&emsp;<input type="date" style="color:blue" name="fechaNacP" required placeholder="dd/mm/aaaa" maxlength="10" size="15"></p>
					<p>&emsp;&emsp;Nombre:&emsp;<input type="text" style="color:blue" name="nombP" required>
					&emsp;&emsp;&emsp;&emsp;&ensp;Apellidos:&emsp;<input type="text" style="color:blue" name="apellidosP" required></p>
					<p>&emsp;&emsp;Profesi&oacute;n:&emsp;<input type="text" style="color:blue" name="profP">			
					&emsp;&emsp;&emsp;&emsp;&ensp;M&oacute;vil:&emsp;<input type="tel" style="color:blue" name="movilP" maxlength="9"></p>			
					</fieldset></p>
					<p>
					<fieldset form="formAltaAlta1Est">
					<legend align="left"><SPAN style="text-align:top">Introducir datos de la madre<SPAN></legend>
        				<br><br>
					<p>&emsp;&emsp;DNI/NIF:&emsp;<input type="text" style="color:blue" name="dniM" value="' . $dniM . '" maxlength="9" required>
					&emsp;&emsp;&emsp;&emsp;&ensp;Fecha Nacimiento:&emsp;<input type="date" style="color:blue" name="fechaNacM" required placeholder="dd/mm/aaaa" maxlength="10" size="15"></p>
					<p>&emsp;&emsp;Nombre:&emsp;<input type="text" style="color:blue" name="nombM" required>
					&emsp;&emsp;&emsp;&emsp;&ensp;Apellidos:&emsp;<input type="text" style="color:blue" name="apellidosM" required></p>
					<p>&emsp;&emsp;Profesi&oacute;n:&emsp;<input type="text" style="color:blue" name="profM">			
					&emsp;&emsp;&emsp;&emsp;&ensp;M&oacute;vil:&emsp;<input type="tel" style="color:blue" name="movilM" maxlength="9"></p>			
					</fieldset></p>
					<p>&nbsp;<b>Observaciones:</b><textarea name="observaciones" style="color:blue" rows="4" cols="103"></textarea></p>  
					<p><input type="submit" value="Grabar" name="Grabar" style="font-weight:bold; color:black"></p>  
					<input type="hidden" value="' . $nuevo . '" name="nuevoE">
					</form>';//2029
				}elseif(mysqli_num_rows($result1) == 1){
					$output='<br><p><font color="red"><b>Error de estudiantes matriculados:</b></font></p><p>Tiene hijos/as matriculados/as anteriormente</p><br>
					<p><input type="button" onclick="history.back()" value="Volver Atr&aacute;s" name="Volver Atras" style="font-weight:bold; color:black"></p>';
				}
				
			}
			else{
				$output='<br><p><font color="red"><b>Atenci&oacute;n</b></font></p><p>Error en consulta de datos padres</p>
					<p align="center">Para volver a intentarlo&nbsp;<a href="http://localhost/drupal/oficina/estudiantes/alta_estudiante">pulse aqu&iacute;</a></p>';
			}
		}elseif ($nuevo=='0'){		//Actualizar datos familia 
			$dniP = $_POST['dniT1']; $dniM = $_POST['dniT2'];
			$sqlP ="SELECT * FROM padres WHERE DNI_P='$dniP' AND DNI_M='$dniM'";
			$resultP = mysqli_query($conexion, $sqlP);
			if ($resultP){
				if(mysqli_num_rows($resultP) == 0){         
					$output='<br><p><font color="red"><b>Error al buscar datos</b></font></p><p>No ha matriculado ning&uacute;n estudiante anteriormente</p><br>
					<input type="button" onclick="history.back()" value="Volver Atr&aacute;s" name="Volver Atras" style="font-weight:bold; color:black">';
				}elseif (mysqli_num_rows($resultP) == 1){
					$rowP =mysqli_fetch_assoc($resultP);
					preg_match("/([0-9]{4})\-([0-9]{1,2})\-([0-9]{1,2})/", $rowP['F_NAC_PADRE'], $nfechaP);
					$fechaP=$nfechaP[3] . "/" . $nfechaP[2] . "/" . $nfechaP[1];
					preg_match("/([0-9]{4})\-([0-9]{1,2})\-([0-9]{1,2})/", $rowP['F_NAC_MADRE'], $nfechaM);
					$fechaM=$nfechaM[3] . "/" . $nfechaM[2] . "/" . $nfechaM[1];
					$output='<form id="formAlta2Est" action="" method="post" accept-charset="UTF-8" size="100%">
					<p>
					<fieldset form="formAltaAlta2Est">
					<legend align="left"><SPAN style="text-align:top">Datos obtenidos del padre:</SPAN></legend>
        				<br><br>
					<p>&emsp;&emsp;DNI/NIF:&emsp;<input type="text" style="color:blue" name="dniP" value="' . $rowP['DNI_P'] . '" maxlength="9">
					&emsp;&emsp;&emsp;&emsp;&ensp;Fecha Nacimiento:&emsp;<input type="date" style="color:blue" name="fechaNacP" value="' . $fechaP . '" maxlength="10" size="15"></p>
					<p>&emsp;&emsp;Nombre:&emsp;<input type="text" style="color:blue" name="nombP"  value="' . $rowP['NOMB_PADRE'] . '" >
					&emsp;&emsp;&emsp;&emsp;&ensp;Apellidos:&emsp;<input type="text" style="color:blue" name="apellidosP"  value="' . $rowP['APEL_PADRE'] . '" ></p>
					<p>&emsp;&emsp;Profesi&oacute;n:&emsp;<input type="text" style="color:blue" name="profP" value="' . $rowP['PROF_PADRE'] . '" >			
					&emsp;&emsp;&emsp;&emsp;&ensp;M&oacute;vil:&emsp;<input type="tel" style="color:blue" name="movilP" maxlength="9" value="' . $rowP['MOVIL_PADRE'] . '" ></p>
					</fieldset></p>
					<p>
					<fieldset form="formAltaAlta2Est">
					<legend align="left"><SPAN style="text-align:top">Datos obtenidos de la madre:</SPAN></legend>
        				<br><br>
					<p>&emsp;&emsp;DNI/NIF:&emsp;<input type="text" style="color:blue" name="dniM" value="' . $rowP['DNI_M'] . '" maxlength="9">
					&emsp;&emsp;&emsp;&emsp;&ensp;Fecha Nacimiento:&emsp;<input type="date" style="color:blue" name="fechaNacM" value="' . $fechaM . '" maxlength="10" size="15"></p>
					<p>&emsp;&emsp;Nombre:&emsp;<input type="text" style="color:blue" name="nombM"  value="' . $rowP['NOMB_MADRE'] . '" >
					&emsp;&emsp;&emsp;&emsp;&ensp;Apellidos:&emsp;<input type="text" style="color:blue" name="apellidosM"  value="' . $rowP['APEL_MADRE'] . '" ></p>
					<p>&emsp;&emsp;Profesi&oacute;n:&emsp;<input type="text" style="color:blue" name="profM" value="' . $rowP['PROF_MADRE'] . '" >			
					&emsp;&emsp;&emsp;&emsp;&ensp;M&oacute;vil:&emsp;<input type="tel" style="color:blue" name="movilM" maxlength="9" value="' . $rowP['MOVIL_MADRE'] . '" ></p>
					</fieldset></p>
					<p>
					<fieldset form="formAltaAlta2Est">
					<legend align="left"><SPAN style="text-align:top">Introducir datos del nuevo estudiante</SPAN></legend>
        				<br><br>
					<p>&emsp;&emsp;Fecha Apertura Exp:&emsp;<input type="text" style="color:blue" name="fechaApertura" required size="15" placeholder="dd/mm/aaaa" autofocus>
					&emsp;&emsp;N&uacute;mero de Expediente:&emsp;<input type="text" style="color:blue" name="Exp" required size="15"></p>
					<p>&emsp;&emsp;Nombre:&emsp;<input type="text" style="color:blue" name="nombEst" required autofocus>
					&emsp;&emsp;&emsp;&emsp;&ensp;Apellidos:&emsp;<input type="text" style="color:blue" name="apellidosEst" required></p>
					<p>&emsp;&emsp;Fecha Nacimiento:&emsp;<input type="date" style="color:blue" name="fechaNacEst" required placeholder="dd/mm/aaaa" maxlength="10" size="15">
					&emsp;&emsp;DNI/NIF&emsp;<input type="text" style="color:blue" name="dniEst" maxlength="9" placeholder="DNI con Letra"></p>
					<p>&emsp;&emsp;Direcci&oacute;n:&emsp;<input type="text" style="color:blue" name="dirEst">	
					&emsp;&emsp;&emsp;&emsp;&ensp;Localidad:&emsp;<input type="text" style="color:blue" name="localidadEst"></p>
					<p>&emsp;&emsp;Provincia:&emsp;<input type="text" style="color:blue" name="provEst">
					&emsp;&emsp;&emsp;&emsp;&ensp;C&oacute;digo Postal:&emsp;<input type="num" style="color:blue" name="cpEst" maxlength="5"></p>
					<p>&emsp;&emsp;Tel&eacute;fono fijo:&emsp;<input type="tel" style="color:blue" name="telEst" maxlength="9"></p>			
					</fieldset>
					<p>&nbsp;<b>Observaciones:</b><textarea name="observaciones" style="color:blue" rows="4" cols="103">' . $rowP['OBSERVACIONES'] . '</textarea></p> 
					<p><input type="submit" value="Grabar" name="Grabar" style="font-weight:bold; color:black"></p>  
					<input type="hidden" value="' . $rowP['ID_PADRES'] . '" name="idP"><input type="hidden" value="' . $nuevo . '" name="nuevoE">
					</form>' . $rowP['ID_PADRES'];
				}
			}else{
				$output='<br><p><font color="red"><b>Atenci&oacute;n</b></font></p><p>Error en consulta de datos padres</p>
					<p align="center">Para volver a intentarlo&nbsp;<a href="http://localhost/drupal/oficina/estudiantes/alta_estudiante">pulse aqu&iacute;</a></p>';
			}

			
		}
	}
	
}
elseif (isset($_POST["Grabar"])){		

	$padres[0]=$_POST["nombP"];$padres[1]=$_POST["apellidosP"];$padres[2]=$_POST["fechaNacP"];$padres[3]=$_POST["dniP"];
	$padres[4]=$_POST["profP"];$padres[5]=$_POST["movilP"];$padres[6]=$_POST["nombM"];$padres[7]=$_POST["apellidosM"];
	$padres[8]=$_POST["fechaNacM"];$padres[9]=$_POST["dniM"];$padres[10]=$_POST["profM"];$padres[11]=$_POST["movilM"];
	$padres[12]=$_POST["observaciones"];
		
	preg_match("/([0-9]{1,2})\/([0-9]{1,2})\/([0-9]{4})/", $padres[2], $nfecha);
	$fechaP=$nfecha[3] . "-" . $nfecha[2] . "-" . $nfecha[1];
	preg_match("/([0-9]{1,2})\/([0-9]{1,2})\/([0-9]{4})/", $padres[8], $nfecha);
	$fechaM=$nfecha[3] . "-" . $nfecha[2] . "-" . $nfecha[1];//2055

	
	$est[0]=$_POST["nombEst"];$est[1]=$_POST["apellidosEst"];$est[2]=$_POST["dirEst"];$est[3]=$_POST["localidadEst"];$est[4]=$_POST["provEst"];
	$est[5]=$_POST["cpEst"];$est[6]=$_POST["telEst"];$est[7]=$_POST["dniEst"];$est[8]=$_POST["fechaNacEst"];$est[9]=$_POST["Exp"];$est[10]=$_POST["fechaApertura"];

	preg_match("/([0-9]{1,2})\/([0-9]{1,2})\/([0-9]{4})/", $est[8], $nfecha);
	$fechaE=$nfecha[3] . "-" . $nfecha[2] . "-" . $nfecha[1];
	preg_match("/([0-9]{1,2})\/([0-9]{1,2})\/([0-9]{4})/", $est[8], $nfecha);
	$fechaA=$nfecha[3] . "-" . $nfecha[2] . "-" . $nfecha[1];
	// Actualizar tabla Padres o crearla

	if($_POST["nuevoE"]==1){
		$sqlP="INSERT INTO padres (ID_PADRES, NOMB_PADRE, APEL_PADRE, F_NAC_PADRE, DNI_P, PROF_PADRE, MOVIL_PADRE, NOMB_MADRE, APEL_MADRE, F_NAC_MADRE, DNI_M, PROF_MADRE, MOVIL_MADRE, OBSERVACIONES) VALUES (NULL, '$padres[0]', '$padres[1]', '$fechaP', '$padres[3]', '$padres[4]', '$padres[5]', '$padres[6]', '$padres[7]', '$fechaM', '$padres[9]', '$padres[10]', '$padres[11]', '$padres[12]' )";
		$resultP=mysqli_query($conexion, $sqlP);
		$id_P=mysqli_insert_id($conexion);
	}else{
		$id_P=$_POST["idP"];
		$sqlP="UPDATE padres SET NOMB_PADRE='$padres[0]', APEL_PADRE='$padres[1]', F_NAC_PADRE='$fechaP', DNI_P='$padres[3]', PROF_PADRE='$padres[4]', MOVIL_PADRE='$padres[5]', NOMB_MADRE= '$padres[6]', APEL_MADRE='$padres[7]', F_NAC_MADRE='$fechaM', DNI_M='$padres[9]', PROF_MADRE='$padres[10]', MOVIL_MADRE='$padres[11]', OBSERVACIONES='$padres[12]' WHERE ID_PADRES='$id_P'";
		$resultP=mysqli_query($conexion, $sqlP);//2596
	}		
	$sqlE="INSERT INTO estudiantes (ID_EST, ID_PADRES, NOMBRE, APELLIDOS, DIRECCION, LOCALIDAD, PROVINCIA, CPOSTAL, TELF, FECHA_NACIMIENTO, DNI, FICHA_EXP, FECHA_APERTURA) 
	VALUES (NULL, '$id_P', '$est[0]', '$est[1]', '$est[2]', '$est[3]', '$est[4]', '$est[5]', '$est[6]', '$fechaE', '$est[7]', '$est[9]', '$fechaA')";

	if(($resultP) && (mysqli_query($conexion, $sqlE))){//2603
		$id_est=mysqli_insert_id($conexion);
		$output='<p><b>Estudiante registrado satisfactoriamente</b>.</p><p><em>Identificador de nuevo registro:</em>&nbsp<b>' . $id_est . '</b></p> 
		<p><b><ins>Datos del estudiante:</ins></b></p>';
		for ($i=0;$i<11;$i++){
			if($est[$i]<>""){
				$output= $output . '<p>&nbsp;&nbsp;&nbsp;&nbsp;<em>' . $etiq_Est[$i] . ':</em>&nbsp;<b>' . $est[$i] . '</b></p>';	
			}
		}
					
		$output= $output . '<p><b>Padres registrados satisfactoriamente</b>.</p><p><em>Identificador de nuevo registro:</em>&nbsp<b>' . $id_P . '</b></p> 
		<p><b><u>Datos del padre:</u></b></p>';
		for ($i=0;$i<6;$i++){
			if($padres[$i]<>""){
				$output= $output . '<p>&nbsp;&nbsp;&nbsp;&nbsp;<em>' . $etiq_P[$i] . ':</em>&nbsp;<b>' . $padres[$i] . '</b></p>';	
			}
		}
		$output= $output . '<p><b><u>Datos de la madre:</u></b></p>';
		for ($i=6;$i<12;$i++){
			if($padres[$i]<>""){
				$output= $output . '<p>&nbsp;&nbsp;&nbsp;&nbsp;<em>' . $etiq_P[$i-6] . ':</em>&nbsp;<b>' . $padres[$i] . '</b></p>';	
			}
		}
		if ($_POST["observaciones"]<>""){
			$output= $output . '<p><b>' . $etiq_P[6] . ':&nbsp;&nbsp;</b>' . $padres[12] . '</p>';
		}
		$output= $output . '<br>
		<p align="center">Si desea agregar otro estudiante <a href="http://localhost/drupal/oficina/estudiantes/alta_estudiante">pulse aqu&iacute;</a></p>'; 
	}else{

		$output='<br><br><p><font color="red"><b>Atenci&oacute;n</b></font></p>
			<p>Error al dar de alta los datos del estudiante: ' . $est[0] . ' ' . $est[1] . '</p>';
		$output=$output . '<p>'. mysqli_error($conexion) . '</p>';
	}	
}

mysqli_close($conexion);

return $output;
}	/** end alta_estudiante  **/


function baja_estudiante() {
$output="";
$conexion=bdexterna();

if (!$_POST){
	$output='<form id="formBajaEst" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formBajaEst">
	<legend align="left"><SPAN style="text-align:top">Eliminar un estudiante</SPAN></legend>
        <br><br>
	<p>&emsp;&emsp;&nbsp;Seleccionar Nombre completo del Estudiante:&emsp;&emsp;&emsp;<p align="center">
	<select required name="Estudiante" size="6">';
	$sql="SELECT * FROM estudiantes";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result) > 0){
		$cont=0;
		while($row=mysqli_fetch_assoc($result)){
			$output= $output . '<option>' . $row["APELLIDOS"] . ', ' . $row["NOMBRE"] . '</option>';
			$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$lista='Lista sin estudiantes';  $output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}

	$output=$output . '</select></p></p>
	<p>&emsp;&emsp;&nbsp;Datos a eliminar del estudiante:&emsp;&emsp;&emsp;<p align="center">
	<select required name="datos" size="2"><option selected value="Parciales">Parciales:solo datos del estudiante</option>
	<option value="Totales">Totales:datos del estudiante y familiares</option></select></p>
	</fieldset>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&emsp;&nbsp;';
	if ($error){
		$output=$output . '<input type="submit" value="Eliminar" name="Eliminar" style="font-weight:bold; color:black" disabled>';
	}else{
		$output=$output . '<input type="submit" value="Eliminar" name="Eliminar" style="font-weight:bold; color:black">';
	}  
	$output=$output . '</p>
	</form>';
} 
elseif(isset($_POST["Eliminar"])){
	$est=$_POST["Estudiante"];
	if($_POST["datos"]=="Totales"){
		$datos=$_POST["datos"] . ": Datos de estudiante y familiares";
	}else{
		$datos=$_POST["datos"] . ": Datos de estudiante";
	}
	
	$output='<form id="formConfirmar" action="" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formConfirma">
	<legend align="left"><SPAN style="text-align:top">Confirmar Baja</SPAN></legend>
        <br><br><p align="center"> Seguro que desea dar de baja al estudiante<b>&nbsp;"' . $est . '"</b></p>
	<p align="center">A eliminar con los siguiente datos<b>&nbsp;"' . $datos . '"</b></p>
	<p align="center"><input type="submit" value="Aceptar" name="Aceptar" style="font-weight:bold; color:black">&emsp;
	<input type="submit" name="Cancelar" value="Cancelar" style="font-weight:bold; color:black">
	<input type="hidden" name="est" value="' . $est . '"><input type="hidden" name="datos" value="' . $_POST["datos"] . '">
	</p></fieldset></p></form>';
}else{
	$est=$_POST["est"];
	$datos=$_POST["datos"];
	if(isset($_POST["Aceptar"])){
		$nombre=substr($est, (strpos($est, ",")+1));
		$long=strlen($nombre);
		$nombre=ltrim($nombre);
		$apellidos=substr($est, 0, -($long+1));
		$apellidos=ltrim($apellidos);

		$sql="SELECT * FROM estudiantes WHERE apellidos='$apellidos' AND nombre='$nombre'";
		$result=mysqli_query($conexion, $sql);
		$regEst=mysqli_fetch_array($result);
		
		if($datos=="Parciales"){
			$sql1="SELECT id_padres FROM estudiantes WHERE id_padres='$regEst[1]'";
			$result1=mysqli_query($conexion, $sql1);
			$total_filas=mysqli_num_rows($result1);
			if($total_filas==1){
				$output='<br><p align="center"><font color="red"><b>Atenci&oacute;n:</b>&nbsp;El estudiante seleccionado no tiene hermanos/as en este centro.</font></p>
				<p align="center">Debe seleccionar la opci&oacute;n de elimniar estudiante con datos <b>TOTALES</b></p>
				<p align="center"> Para volver atr&aacute;s&nbsp;<a href="http://localhost/drupal/oficina/estudiantes/baja_estudiante">pulse aqu&iacute;</a></p>';
			}
			else{
				$sql2="DELETE FROM estudiantes WHERE ID_EST='$regEst[0]'";
				if(mysqli_query($conexion, $sql2)){//2114
					$output='<p><b>El estudiante seleccionado se ha borrado satisfactoriamente</b>.</p>
					<p>Identificador del registro: <b>' . $regEst[0] . '</b></p> 
					<p>Nombre:<b>' . $regEst[2] . '</b></p>
					<p>Apellidos del docente:<b>' . $regEst[3] . '</b></p><br><br>
					<p align="center">Si desea eliminar otro estudiante&nbsp;<a href="http://localhost/drupal/oficina/estudiantes/baja_estudiante">pulse aqu&iacute;</a></p>';		
				}
				else{
					$output='<p><b>Error al eliminar el registro con el nombre:&nbsp;' . $regEst[2] . '<b>&nbsp;y apellido:&nbsp;<b>' . $regEst[3] . '</b></p>';
					$output=$output . '<p>'. mysqli_error($conexion) . '</p>';
				}
			}
		}
		if($datos=="Totales"){
			$sql1="SELECT id_padres FROM estudiantes WHERE id_padres='$regEst[1]'";
			$result1=mysqli_query($conexion, $sql1);
			$total_filas=mysqli_num_rows($result1);

			if($total_filas > 1){
				$output='<br><p align="cener"><font color="red"><b>Atenci&oacute;n:</b>&nbsp;El estudiante seleccionado tiene hermanos/as en este centro.</font></p>
				<p align="center">Debe seleccionar la opci&oacute;n de elimniar con datos PARCIALES</p>
				<p align="center"> Para volver atr&aacute;s&nbsp;<a href="http://localhost/drupal/oficina/estudiantes/baja_estudiante">pulse aqu&iacute;</a></p>';
			}
			else{
				//$output='<p>'. $regEst[1] . ' y ' . $regEst[0];
				$sql2="DELETE FROM estudiantes WHERE ID_EST='$regEst[0]'"; $result2=mysqli_query($conexion, $sql2);
				$sql1="DELETE FROM padres WHERE ID_PADRES='$regEst[1]'"; $result1=mysqli_query($conexion, $sql1);
				if(($result1)&&($result2)){
					$output=$output . '<p><b>El estudiante seleccionado se ha eliminado satisfactoriamente con los datos familiares</b></p>
					<p>Identificador del registro: <b>' . $regEst[0] . '</b></p> 
					<p>Identificador familiar:<b>' . $regEst[1] . '</b></p>
					<p>Nombre:<b>' . $regEst[2] . '</b></p>
					<p>Apellidos del docente:<b>' . $regEst[3] . '</b></p><br><br>
					<p align="center">Si desea eliminar otro estudiante&nbsp;<a href="http://localhost/drupal/oficina/estudiantes/baja_estudiante">pulse aqu&iacute;</a></p>';
				}
				else{
					$output= $output . '<p><b>Error al eliminar el registro con el nombre:&nbsp;' . $regEst[2] . '<b>&nbsp;y apellido:&nbsp;<b>' . $regEst[3] . '</b></p>';//2148
					$output=$output . '<p>'. mysqli_error($conexion) . '</p>';
				}
			}	
		}
	}else{
		$output='<br><br><b><p align="center">Operaci&oacute;n de eliminar estudiante con apellidos y nombre
		<br><font color="red">"' . $est . '"</font><br>ha sido cancelada</b>
		<br>
		<p align="center">Si desea volver al apartado "Baja Estudiante"&nbsp;<a href="http://localhost/drupal/oficina/estudiantes/baja_estudiante">pulse aqu&iacute;</a></p>'; 
	}

}

mysqli_close($conexion);
return $output;
}	/** end baja_estudiante  **/


function modificar_estudiante() {
$output="";
$conexion=bdexterna();
$etiq_Est= array("Identificador", "Nombre", "Apellidos", "Direcci&oacute;n", "Localidad", "Provincia", "C&oacute;digo Postal", "Tel&eacute;fono", "DNI/NIF", "Fecha de Nacimiento", "N&uacute;mero de Expediente", "Fecha de Apertura", "Fecha de Cierre");
$etiq_P= array("Identificador", "Nombre", "Apellidos",  "Fecha de Nacimiento",  "DNI/NIF", "Profesi&oacute;n", "M&oacute;vil", "OBSERVACIONES");

if (!$_POST){
	$output='<form id="formModEst" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formModEst">
	<legend align="left"><SPAN style="text-align:top">Cambiar datos de un estudiante</SPAN></legend>
        <br><br>
	&emsp;&emsp;&nbsp;Seleccionar Nombre completo del estudiante:&nbsp;<p align="center"><select name="Est" size="6" required>';
	
	$sql="SELECT * FROM estudiantes";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result) > 0){
		$cont=0;
		while($row=mysqli_fetch_assoc($result)){
			$output= $output . '<option>' . $row["APELLIDOS"] . ', ' . $row["NOMBRE"] . '</option>';
			$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$lista='Lista sin estudiantes';  $output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}
	$output= $output . '</select></p>
	&emsp;&emsp;&nbsp;Indicar datos a modificar:&nbsp;<p align="center"><select name="datos" size="2" required>
	<option selected>Estudiante</option><option>Padres</option></select>
	</p>
	</fieldset>
	</p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&emsp;&nbsp;';//3018
	if ($error){
		$output= $output . '<input type="submit" name="Siguiente" value="Siguiente" style="font-weight:bold; color:black" disabled>';
	}else{
		$output= $output . '<input type="submit" name="Siguiente" value="Siguiente" style="font-weight:bold; color:black">';
	}
	$output= $output . '</p></form>';
} 
elseif (isset($_POST["Siguiente"])){
	$est=$_POST["Est"];
	$tipodatos=$_POST["datos"];
	$long1=strpos($est, ",")+1;
	$nombre=substr($est, (strpos($est, ",")+1));
	$long=strlen($nombre);
	$nombre=ltrim($nombre);$long2=strlen($nombre);
	$apellidos=substr($est, 0, -($long+1));
	$apellidos=ltrim($apellidos);$long3=strlen($apellidos);

	$sqlE="SELECT * FROM estudiantes WHERE APELLIDOS='$apellidos' AND NOMBRE='$nombre'";
	$resultE=mysqli_query($conexion, $sqlE);
	$regEst=mysqli_fetch_array($resultE);
	$idP=$regEst[1];

	$output=$long1 . '<br>' . $long2 . '<br>' . $long3 . '<br>' .'<form id="formModEstS" action="" method="post" accept-charset="UTF-8" size="100%">
	<p><fieldset form="formModEstS">';

	if ($tipodatos == "Estudiante"){
		preg_match("/([0-9]{4})\-([0-9]{1,2})\-([0-9]{1,2})/", $regEst[9], $nfechaP);
		$fechaE=$nfechaP[3] . "/" . $nfechaP[2] . "/" . $nfechaP[1]; //*2412
		preg_match("/([0-9]{4})\-([0-9]{1,2})\-([0-9]{1,2})/", $regEst[12], $nfechaP);
		$fechaA=$nfechaP[3] . "/" . $nfechaP[2] . "/" . $nfechaP[1];
		preg_match("/([0-9]{4})\-([0-9]{1,2})\-([0-9]{1,2})/", $regEst[13], $nfechaP);
		$fechaC=$nfechaP[3] . "/" . $nfechaP[2] . "/" . $nfechaP[1];

		$output=$output . '<legend align="left"><SPAN style="text-align:top">Modificar datos del Estudiante</SPAN></legend>
        	<br><br>
		<p>&emsp;&emsp;&emsp;&emsp;N&uacute;mero Expediente:&emsp;<input type="text" style="color:blue" name="Exp" value="' . $regEst[11] . '"required></p>
		<p>&emsp;&emsp;&emsp;&emsp;Fecha de Apertura:&emsp;<input type="text" style="color:blue" name="fApertura" maxlength="10" value="' . $fechaA . '" required size="15">
		&emsp;&emsp;Fecha de Cierre:&emsp;<input type="text" style="color:blue" name="fCierre" value="' . $fechaC . '" maxlength="10" required size="15"></p>
		<p>&emsp;&emsp;&emsp;&emsp;Nombre:&emsp;<input type="text" style="color:blue" name="nombEst" maxlength="9" value="' . $regEst[2] . '" required>
		&emsp;&emsp;&emsp;&emsp;Apellidos:&emsp;<input type="text" style="color:blue" name="apelEst" value="' . $regEst[3] . '"required></p>
		<p>&emsp;&emsp;&emsp;&emsp;Direcci&oacute;n:&emsp;<input type="text" style="color:blue" name="dirEst" value="' . $regEst[4] . '">	
		&emsp;&emsp;&emsp;&emsp;Localidad:&emsp;<input type="text" style="color:blue" name="localEst" value="' . $regEst[5] . '"></p>
		<p>&emsp;&emsp;&emsp;&emsp;Provincia:&emsp;<input type="text" style="color:blue" name="provEst" value="' . $regEst[6] . '">
		&emsp;&emsp;&emsp;&emsp;C&oacute;digo Postal:&emsp;<input type="text" style="color:blue" name="cpEst" maxlength="5" value="' . $regEst[7] . '"></p>
		<p>&emsp;&emsp;&emsp;&emsp;Tel&eacute;fono :&emsp;<input type="tel" style="color:blue" name="telfEst" maxlength="9" value="' . $regEst[8] . '">		
		&emsp;&emsp;&emsp;&emsp;DNI/NIF:&emsp;<input type="text" style="color:blue" name="dniEst" maxlength="9" placeholder="DNI con Letra" value="' . $regEst[10] . '"></p>	
		<p>&emsp;&emsp;&emsp;&emsp;Fecha de Nacimiento:&emsp;<input type="date" style="color:blue" name="fechaNacEst" value="' . $fechaE . '" required maxlength="10" size="15"></p>
		<input type="hidden" name="datos" value="0"><input type="hidden" value="' . $regEst[0] . '" name="idEst">
		</fieldset></p>';	
	}
	else{
		$sqlP="SELECT * FROM padres WHERE ID_PADRES='$regEst[1]'";
		$resultP=mysqli_query($conexion, $sqlP);		
		$regP=mysqli_fetch_array($resultP);
		
		preg_match("/([0-9]{4})\-([0-9]{1,2})\-([0-9]{1,2})/", $regP[3], $nfechaP);
		$fechaP=$nfechaP[3] . "/" . $nfechaP[2] . "/" . $nfechaP[1];
		preg_match("/([0-9]{4})\-([0-9]{1,2})\-([0-9]{1,2})/", $regP[9], $nfechaP);
		$fechaM=$nfechaP[3] . "/" . $nfechaP[2] . "/" . $nfechaP[1];

		$output=$output . '<legend align="left"><SPAN style="text-align:top">Modificar datos Familiares</SPAN></legend>
        	<br><br>
		<p align="center"><label><b>DATOS DEL PADRE</b></p>
		<p>&emsp;&emsp;&emsp;&emsp;DNI/NIF:&emsp;<input type="text" style="color:blue" name="dniP" maxlength="9" value="' . $regP[4] . '"required>	
		&emsp;&emsp;&emsp;&emsp;&emsp;Fecha Nacimiento:&emsp;<input type="text" style="color:blue" name="fechaNacP" value="' . $fechaP . '" maxlength="10" size="15"></p>
		<p>&emsp;&emsp;&emsp;&emsp;Nombre:&emsp;<input type="text" style="color:blue" name="nombP" value="' . $regP[1] . '" required>
		&emsp;&emsp;&emsp;&emsp;&emsp;Apellidos:&emsp;<input type="text" style="color:blue" name="apelP" value="' . $regP[2] . '"required></p>
		<p>&emsp;&emsp;&emsp;&emsp;Profesi&oacute;n:&emsp;<input type="text" style="color:blue" name="profP" value="' . $regP[5] . '">
		&emsp;&emsp;&emsp;&emsp;&emsp;M&oacute;vil:&emsp;<input type="tel" style="color:blue" name="movilP" value="' . $regP[6] . '"></p>
		<br><p align="center"><label><b>DATOS DE LA MADRE</b></P>
		<p>&emsp;&emsp;&emsp;&emsp;DNI/NIF:&emsp;<input type="text" style="color:blue" name="dniM" maxlength="9" value="' . $regP[10] . '"required>	
		&emsp;&emsp;&emsp;&emsp;&emsp;Fecha Nacimiento:&emsp;<input type="text" style="color:blue" name="fechaNacM" value="' . $fechaM . '" maxlength="10" size="15"></p>
		<p>&emsp;&emsp;&emsp;&emsp;Nombre:&emsp;<input type="text" style="color:blue" name="nombM" value="' . $regP[7] . '" required>
		&emsp;&emsp;&emsp;&emsp;&emsp;Apellidos:&emsp;<input type="text" style="color:blue" name="apelM" value="' . $regP[8] . '"required></p>
		<p>&emsp;&emsp;&emsp;&emsp;Profesi&oacute;n:&emsp;<input type="text" style="color:blue" name="profM" value="' . $regP[11] . '">
		&emsp;&emsp;&emsp;&emsp;&emsp;M&oacute;vil:&emsp;<input type="tel" style="color:blue" name="movilM" value="' . $regP[12] . '"></p>
		<input type="hidden" name="datos" value="1"><input type="hidden" value="' . $regP[0] . '" name="idP"><input type="hidden" value="' . $est . '" name="Est">		
		</fieldset></p>
		<p>&nbsp;<b>Observaciones:</b><textarea name="observaciones" style="color:blue" rows="4" cols="103">' . $regP[13] . '</textarea></p>';//2369
						
	}
	$output=$output . '<p><input type="button" onclick="history.back()" value="Volver Atr&aacute;s" name="Volver Atras" style="font-weight:bold; color:black">emsp;&nbsp;
	<input type="submit" value="Grabar" name="Grabar"style="font-weight:bold; color:black">&</p></form>';
}elseif (isset($_POST["Grabar"])){
	if ($_POST["datos"]=="0"){
		$reg[0]=$_POST["idEst"];
		$reg[1]=$_POST["nombEst"];
		$reg[2]=$_POST["apelEst"];
		$reg[3]=$_POST["dirEst"];
		$reg[4]=$_POST["localEst"];
		$reg[5]=$_POST["provEst"];
		$reg[6]=$_POST["cpEst"];
		$reg[7]=$_POST["telfEst"];
		$reg[8]=$_POST["dniEst"];
		$reg[9]=$_POST["fechaNacEst"];
		$reg[10]=$_POST["Exp"];
		$reg[11]=$_POST["fApertura"];
		$reg[12]=$_POST["fCierre"];
		preg_match("/([0-9]{1,2})\/([0-9]{1,2})\/([0-9]{4})/", $reg[9], $nfecha);
		$fechaE=$nfecha[3] . "-" . $nfecha[2] . "-" . $nfecha[1];
		preg_match("/([0-9]{1,2})\/([0-9]{1,2})\/([0-9]{4})/", $reg[11], $nfecha);
		$fechaA=$nfecha[3] . "-" . $nfecha[2] . "-" . $nfecha[1];
		preg_match("/([0-9]{1,2})\/([0-9]{1,2})\/([0-9]{4})/", $reg[12], $nfecha);
		$fechaC=$nfecha[3] . "-" . $nfecha[2] . "-" . $nfecha[1];

		$sql="UPDATE estudiantes SET NOMBRE='$reg[1]', APELLIDOS='$reg[2]', DIRECCION='$reg[3]', LOCALIDAD='$reg[4]', PROVINCIA='$reg[5]', CPOSTAL='$reg[6]', TELF='$reg[7]', FECHA_NACIMIENTO='$fechaE', DNI='$reg[8]', FICHA_EXP='$reg[10]', FECHA_APERTURA='$fechaA', FECHA_CIERRE='$fechaC' WHERE ID_EST='$reg[0]'";
		if(mysqli_query($conexion, $sql)){//2388
			$output= $output . '<p><b>El estudiante seleccionado se ha actualizado satisfactoriamente.</b></p>
			<p>Los datos grabados son:</p>';
			for($i=1;$i<13;$i++){
				if ($reg[$i] <> ""){
					$output=$output . '<p><em>' . $etiq_Est[$i] . ':</em>&nbsp;' . '<b>' . $reg[$i] . '</b></p>';//2393
				}

			}
			$output=$output . '<br><br>
			<p align="center">Si desea modificar otro estudiante <a href="http://localhost/drupal/oficina/estudiantes/modificar_estudiante">pulse aqu&iacute;</a></p>'; 
		}
		else{
			$output='<p><b>Error al actualizar el registro de estudiante<b></p>';
			$output=$output . '<p>'. mysqli_error($conexion) . '</p>';
		}
	}
	else{
		$reg[0]=$_POST["idP"];
		$reg[1]=$_POST["nombP"];
		$reg[2]=$_POST["apelP"];
		$reg[3]=$_POST["fechaNacP"];
		$reg[4]=$_POST["dniP"];
		$reg[5]=$_POST["profP"];
		$reg[6]=$_POST["movilP"];
		$reg[7]=$_POST["nombM"];
		$reg[8]=$_POST["apelM"];
		$reg[9]=$_POST["fechaNacM"];
		$reg[10]=$_POST["dniM"];
		$reg[11]=$_POST["profM"];
		$reg[12]=$_POST["movilM"];
		$reg[13]=$_POST["observaciones"];
		
		preg_match("/([0-9]{1,2})\/([0-9]{1,2})\/([0-9]{4})/", $reg[3], $nfecha);
		$fechaP=$nfecha[3] . "-" . $nfecha[2] . "-" . $nfecha[1];
		preg_match("/([0-9]{1,2})\/([0-9]{1,2})\/([0-9]{4})/", $reg[9], $nfecha);
		$fechaM=$nfecha[3] . "-" . $nfecha[2] . "-" . $nfecha[1];

		$est=$_POST["Est"];

	      //$sql="UPDATE padres SET NOMB_PADRE='$padres[0]', APEL_PADRE='$padres[1]', F_NAC_PADRE='$fechaP', DNI_P='$padres[3]', PROF_PADRE='$padres[4]', MOVIL_PADRE='$padres[5]', NOMB_MADRE= '$padres[6]', APEL_MADRE='$padres[7]', F_NAC_MADRE='$fechaM', DNI_M='$padres[9]', PROF_MADRE='$padres[10]', MOVIL_MADRE='$padres[11]', OBSERVACIONES='$padres[12]' WHERE ID_PADRES='$id_P'";
		$sql="UPDATE padres SET NOMB_PADRE='$reg[1]', APEL_PADRE='$reg[2]', F_NAC_PADRE='$fechaP', DNI_P='$reg[4]', PROF_PADRE='$reg[5]', MOVIL_PADRE='$reg[6]', NOMB_MADRE='$reg[7]', APEL_MADRE='$reg[8]', F_NAC_MADRE='$fechaM', DNI_M='$reg[10]', PROF_MADRE='$reg[11]', MOVIL_MADRE='$reg[12]', OBSERVACIONES='$reg[13]' WHERE ID_PADRES='$reg[0]'";
		if(mysqli_query($conexion, $sql)){  //2423
			$output= '<p><b>Los datos familiares del estudiante seleccionado&nbsp;"' . $est . '"&nbsp;se han actualizado satisfactoriamente.</b></p>
			<p><b>DATOS DEL PADRE:</b></p>';
			for($i=1;$i<7;$i++){
				if($reg[$i]<>""){
					$output=$output . '<p><em>' . $etiq_P[$i] . ':</em>&nbsp;' . '<b>' . $reg[$i] . '</b></p>';
				}
			}
			$output= $output . '<p><b>DATOS DE LA MADRE:</b></p>';
			for($i=7;$i<13;$i++){
				if($reg[$i]<>""){
					$output=$output . '<p><em>' . $etiq_P[$i-6] . ':</em>&nbsp;' . '<b>' . $reg[$i] . '</b></p>';
				}
			}
			if($reg[13]<>""){
				$output= $output . '<p><b>' . $etiq_P[7] . ':</b>&nbsp;' . '<br>' . $reg[$i] . '</p>';
			}
			
			$output= $output . '<br><br>
			<p align="center">Si desea modificar otro estudiante <a href="http://localhost/drupal/oficina/estudiantes/modificar_estudiante">pulse aqu&iacute;</a></p>'; 
		}
		else{
			$output=$output .'<p><b>Error al actualizar el registro padres del estudiante<b></p>';
			$output=$output . '<p>'. mysqli_error($conexion) . '</p>';
		}
	}
	
} 

mysqli_close($conexion);

return $output;
}	/** end modificar_estudiante  **/


/**********
		************************** Materias *************************
***********/

function listar_materias(){
$output="";
$tamano_pagina="5";

if(array_key_exists('pagina', $_GET)){
	$pagina=$_GET["pagina"];
}
else{
	$pagina=1;
}

$conexion=bdexterna();

$sql="SELECT * FROM materias";
$result=mysqli_query($conexion, $sql);
$total_filas=mysqli_num_rows($result);
$total_paginas=ceil($total_filas / $tamano_pagina);

$sql="SELECT * FROM materias LIMIT " . (($pagina-1) * $tamano_pagina) . "," . $tamano_pagina;
$result=mysqli_query($conexion, $sql);
$output='<p align="center"><b><font size="4">Listado de las Materias que se imparten en el centro</font></b></p>';
$output=$output . '<table border="2"><tr><th><font size="3">Identificador</font></th><th><font size="3">Nombre Materia</font></th><th><font size="3">Abreviatura</font></th></tr>';
if($total_filas > 0){
	while ($row=mysqli_fetch_assoc($result)){
		$output=$output . '<tr><td><font color="blue" size="2">'. $row["ID_MATERIA"] . '</font></td><td><font color="blue" size="2">' . $row["NOMBRE"] . '</font></td><td><font color="blue" size="2">' . $row["ABREVIATURA"] . '</font></td></tr>';
	}
	$output=$output . '</table><br>';
}



if ($total_paginas > 1){
	for ($i=1;$i<=$total_paginas;$i++){
		if($pagina == $i){
			$output=$output . 'P&aacute;gina ' . $pagina . "&nbsp;&nbsp;";
		}
		else{
			$output=$output . '<a href="http://localhost/drupal/oficina/materias/listar_materias?pagina=' . $i . '">P&aacute;gina ' . $i . '</a>&nbsp;&nbsp;';
		}

	}
}
if (!$_POST){
	$output=$output . '<form id="formBuscarMat" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formBuscarMat"><br><legend align="left"><SPAN style="text-align:top">B&uacute;squeda de materias por departamento</SPAN></legend><br>
	<p>&emsp;&emsp;&emsp;Seleccionar de la lista un departamento:</p>
	<p align="center"><select name="nombDpto" size="6" required>';

	$sql="SELECT * FROM departamentos";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result) > 0){
		$cont=0;
		while($row=mysqli_fetch_assoc($result)){
			$output= $output . '<option>' . $row["NOMBRE"] . '</option>';
			$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$lista='Lista sin departamentos';  $output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}
	$output=$output . '</select></p><p align="center">';
	if ($error){
		$output= $output . '<input type="submit" value="Buscar Datos" style="font-weight:bold; color:black"disabled>'; 
	}else{
		$output= $output . '<input type="submit" value="Buscar Datos" style="font-weight:bold; color:black">';
	}
	$output=$output . '</p>
	</fieldset></p></form>';
}else{
	$dptoNomb=$_POST["nombDpto"];
	$output='<p align="center"><font size="4"><b>Listado de Materias por "' . $dptoNomb . '"</b></font></p>
	<table border="2"><tr><th><font size="3">Identificador</font></th><th><font size="3">Nombre Materia</font></th><th><font size="3">Abreviatura</font></th></tr>';
	$sql="SELECT * FROM materias WHERE id_dpto IN (SELECT id_dpto FROM departamentos WHERE nombre='$dptoNomb')";//3287
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result)>0){
		$cont=0;
		while($reg=mysqli_fetch_assoc($result)){
			$output=$output . '<tr><td><font color="blue" size="2">'. $reg["ID_MATERIA"] . '</font></td><td><font color="blue" size="2">' . $reg["NOMBRE"] . '</font></td><td><font color="blue" size="2">' . $reg["ABREVIATURA"] . '</font></td></tr>';
			$cont=$cont+1;
		}
		$output=$output . '</table><br>';
		if ($cont>0){
			$error=false;
		}
	}else{
		$error=true;
	}
	if ($error){
		$output='<br><b>Atenci&oacute;n</b><br><br><p>No se puedo realizar el listado de materias.</p>
		<p>El departamento seleccionado,&nbsp;<b>' . $dptoNomb .',</b>&nbsp;no tiene materias aisgnadas.</p>
		<br><p align="center"><b>Para volver hacia atr&aacute;s&nbsp;<a href="http://localhost/drupal/oficina/materias/listar_materias">pulse aqu&iacute;</a></b></p>'; 
	}else{
		$output=$output . '<p align="center"><b>Para realizar una nueva b&uacute;squeda,&nbsp;<a href="http://localhost/drupal/oficina/materias/listar_materias">pulse aqu&iacute;</a></b></p>';
	}
}

return $output;
mysqli_close($conexion);

}   /** end listar_materias **/


function alta_materia() {
$output="";

$conexion=bdexterna();

if (!$_POST){
	$output='<form id="formAltaMateria" action="" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formAltaMateria">
	<legend align="left"><SPAN style="text-align:top">Introducir una materia nueva</SPAN></legend>
        <br><br>
	<p><SPAN style="text-align:center">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Nombre:&nbsp;<input type="text" name="nombMateria" required autofocus size="60%"></SPAN></p>
	<p><SPAN style="text-align:center">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Abreviatura:&nbsp;<input type="text" name="abrMateria" required maxlength="5" size="20%"></SPAN></p>
	<p><SPAN style="text-align:top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Seleccionar un Departamento:</p><p align="center"><select name="nombDpto" size="6" required>';
	
	$sql="SELECT nombre FROM departamentos";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result) > 0){
		$cont=0;
		while($row=mysqli_fetch_assoc($result)){
			$output= $output . '<option>' . $row["nombre"] . '</option>';
			$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$lista='Lista sin departamentos';  $output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}

	 $output= $output . '</select></p>
	</fieldset>
	</p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($error){
		$output= $output . '<input type="submit" value="Agregar" style="font-weight:bold; color:black" disabled>'; 
	}else{
		$output= $output . '<input type="submit" value="Agregar" style="font-weight:bold; color:black">';
	}
	$output= $output . '</p></form>';
}elseif (($_POST["nombMateria"] == "") OR ($_POST["abrMateria"] == "")){
		$output='<br><b>Atenci&oacute;n</b><br><br><p>No puede dar de alta una Materia sin nombre y/o abrevitura</p><p>Para volver hacia atr&aacute;s&nbsp;<a href="http://localhost/drupal/oficina/materias/alta_materia">pulse aqu&iacute;</a></p>'; 
}
else{
	$nombre=$_POST["nombMateria"];
	$nom_dpto=$_POST["nombDpto"];
	$abreviatura=strtoupper($_POST["abrMateria"]);
	$sql="SELECT ID_DPTO FROM departamentos WHERE NOMBRE='$nom_dpto'";	
	$result=mysqli_query($conexion, $sql);
	$id_dpto=mysqli_fetch_array($result);
	$sql="INSERT INTO materias (ID_MATERIA, ID_DPTO, NOMBRE, ABREVIATURA) VALUES (NULL, '$id_dpto[0]', '$nombre', '$abreviatura')";
		
	if(mysqli_query($conexion, $sql)){
		$ant_id=mysqli_insert_id($conexion);
		$output= '<p><b>Nueva materia registrada satisfactoriamente</b>.</p><p>Identificador de nuevo registro:&nbsp;<b>' . $ant_id . '</b></p> 
		<p>Nombre materia:&nbsp;<b>' . $nombre . '</b></p>
		<p>Abreviatura materia:&nbsp;<b>' . $abreviatura . '</b></p>
		<p>Identificador de departamento&nbsp;<b>' . $id_dpto[0] . '</b></p>
		<p>Nombre del departamento:&nbsp;<b>' . $nom_dpto . '</b></p><br><br>
		<p align="center">Si desea agregar otra materia&nbsp;<a href="http://localhost/drupal/oficina/materias/alta_materia">pulse aqu&iacute;</a></p>'; 
	}
	
	
}
	
mysqli_close($conexion);	
return $output;

}   /** end alta_materia **/

function baja_materia() {
$output="";
$conexion=bdexterna();	

if (!$_POST){
	$output='<form id="formBajaMateria" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formBajaMateria">
	<legend align="left"><SPAN style="text-align:top">Eliminar una materia</SPAN></legend>
        <br><br>
	<p><SPAN style="text-align:top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Seleccionar una Materia:&nbsp;<p align="center"><select name="nombMateria" size="8" required>';
	
	$sql="SELECT nombre FROM materias";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result) > 0){
		$cont=0;
		while($row=mysqli_fetch_assoc($result)){
			$output= $output . '<option>' . $row["nombre"] . '</option>';
			$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$lista='Lista sin materias';  $output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}
	$output= $output . '</p></select></fieldset>
	</p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($error){
		$output= $output . '<input type="submit" name="Eliminar" value="Eliminar" style="font-weight:bold; color:black" disabled>';
	}else{
		$output= $output . '<input type="submit" name="Eliminar" value="Eliminar" style="font-weight:bold; color:black">';
	}  
	$output= $output . '</p></form>';
} 
elseif(isset($_POST["Eliminar"])){	
	$output='<form id="formConfirmarMat" action="" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formConfirmarMat">
	<legend align="left"><SPAN style="text-align:top">Confirmar Baja</SPAN></legend>
        <br><br><p align="center"> Seguro que desea dar de baja la materia con el nombre<b>&nbsp;' . $_POST["nombMateria"] . '</b></p>
	
	<p align="center"><input type="submit" value="Aceptar" name="Aceptar" style="font-weight:bold; color:black">&emsp;
	<input type="submit" name="Cancelar" value="Cancelar" style="font-weight:bold; color:black">
	<input type="hidden" name="materia" value="' . $_POST["nombMateria"] . '">
	</p></fieldset></p></form>';
}
else{
	$nombre=$_POST["materia"];
	if(isset($_POST["Aceptar"])){
		//mysqli_select_db($conexion, "colegio");
		$sql="SELECT id_materia, nombre, abreviatura FROM materias WHERE nombre='$nombre'";
		$row=mysqli_fetch_assoc(mysqli_query($conexion, $sql));
		//$sql="DELETE FROM materias WHERE NOMBRE='$nombre'";
		//if(mysqli_query($conexion, $sql)){
			$output= '<p><b>La materia seleccionada se ha borrado satisfactoriamente</b>.</p>
			<p>Identificador del registro: <b>' . $row["id_materia"] . '</b></p> 
			<p>Nombre materia: <b>' . $row["nombre"] . '</b></p>
			<p>Nombre materia: <b>' . $row["abreviatura"] . '</b></p><br><br>';
			$output=$output . '<p align="center">Si desea eliminar otra materia&nbsp;<a href="http://localhost/drupal/oficina/materias/baja_materia">pulse aqu&iacute;</a></p>';		
		//}
		//else{
		//	$output='<p><b>Error al eliminar el registro con el nombre:&nbsp;' . $nombre . '<b></p>';
		//	$output=$output . '<p>'. mysqli_error($conexion) . '</p>';
		//}
	}else{
		$output='<br><br><b><p align="center">Operaci&oacute;n de eliminar materia con el nombre<br>
		<font color="red">"' . $nombre . '"</font><br>ha sido cancelada</b>
		<br>
		<p align="center">Si desea volver al apartado "Baja Materia"&nbsp;<a href="http://localhost/drupal/oficina/materias/baja_materia">pulse aqu&iacute;</a></p>'; 
	}
}
mysqli_close($conexion);
return $output;

}   /** end baja_materia **/


function modificar_materia() {
$output="";

$conexion=bdexterna();

if (!$_POST){
	$output='<form id="formModMateria" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formModMateria">
	<legend align="left"><SPAN style="text-align:top">Cambiar nombre de una materia</SPAN></legend>
        <br><br>
	<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Seleccionar una Materia:&nbsp;<p align="center"><select name="nombMateria" size="5" required>';
	
	$sql="SELECT nombre FROM materias";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result) > 0){
		$cont=0;
		while($row=mysqli_fetch_assoc($result)){
			$output= $output . '<option>' . $row["nombre"] . '</option>';
			$cont=$cont+1;
			//$id=$row["id_dpto"];
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$lista='Lista sin materias';  $output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}
	$output= $output . '</p></select></p>
	<br><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Indicar el nuevo nombre de materia:&nbsp; <input type="text" style="color:blue" name="nuevoNomb" required></p>
	<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Indicar nueva abreviatura de materia:&nbsp; <input type="text" style="color:blue" name="nuevaAbr" required></p>
	</fieldset>
	</p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($error){
		$output= $output . '<input type="submit" value="Grabar" style="font-weight:bold; color:black" disabled>';
	}else{
		$output= $output . '<input type="submit" value="Grabar" style="font-weight:bold; color:black">';
	}  
	$output= $output . '</p></form>';
} 
else{
	$nombre=$_POST["nombMateria"];
	$nombnuevo=$_POST["nuevoNomb"];
	$abrnueva=strtoupper($_POST["nuevaAbr"]);
	mysqli_select_db($conexion, "colegio");
	$sql="SELECT ID_MATERIA, ABREVIATURA FROM materias WHERE NOMBRE='$nombre'";
	$result=mysqli_query($conexion, $sql);
	$row=mysqli_fetch_array($result);
	//$num=$id[0];
	if (($nombnuevo == "") OR ($abrnueva == "")){
		$output='<br><br><font color="red"><b>Atenci&oacute;n</b></font><br><br><p>Faltan datos (nombre y/o abreviatura) para actualizar el registro seleccionado:&nbsp;<b>' . $nombre . '</b></p>&nbsp;';
		$output=$output . '<br><p align="center">Para volver a intentarlo&nbsp;<a href="http://localhost/drupal/oficina/materias/modificar_materia">pulse aqu&iacute;</a></p>';
	} 
	else{
		$sql="UPDATE materias SET NOMBRE='$nombnuevo', ABREVIATURA='$abrnueva' WHERE ID_MATERIA= '$row[0]'";
		if(mysqli_query($conexion, $sql)){
			$output= '<p><b>La materia seleccionada se ha actualizado satisfactoriamente.</b></p> 
			<p>Nombre anterior de materia: <b>' . $_POST["nombMateria"] . '</b></p><p>Se ha actualizado por el nombre: <b>' . $nombnuevo . '</b></p>
			<p>Nombre anterior de materia: <b>' . $row[1] . '</b></p><p>Se ha actualizado por la abreviatura: <b>' . $abrnueva . '</b></p>
			<p>Identificador de registro: <b>' . $row[0] . '</b></p><br>';
			$output=$output . '<p align="center">Si desea modificar otra materia&nbsp;<a href="http://localhost/drupal/oficina/materias/modificar_materia">pulse aqu&iacute;</a></p>'; 
		}
		else{
			$output='<p><b>Error al actualizar el registro con el nombre:&nbsp;' . $nombre . '<b></p>';
			$output=$output . '<p>'. mysqli_error($conexion) . '</p>';
		}
	}
} 
mysqli_close($conexion);
return $output;

}  /** end modificar_materia **/


/**********Asingar materias del curso**************/

function asignar_materia(){
$output=" ";
$conexion=bdexterna();

//Listar cursos y seleccionar uno
if ((!$_POST) || isset($_POST["Cancelar"])){
	$output='<form id="formCurso" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formCurso">
	<legend align="left"><SPAN style="text-align:top">Selecci&oacuten de Curso</SPAN></legend>
        <br><br>
	<p><SPAN style="text-align:top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Seleccionar un Curso de la lista para asignar materias:&nbsp;<p align="center"><select name="nombCurso" size="5" required>';
	
	$sql="SELECT nombre, max_asig FROM cursos";  //contar asignaturas menores al max asignaturas
	$result=mysqli_query($conexion, $sql);  //3189
	if (mysqli_num_rows($result) > 0){
		$cont=0;
		while($row=mysqli_fetch_assoc($result)){//contar asignaturas del curso
			$nomb=$row["nombre"];
			$sqlC="SELECT COUNT(*) AS 'count' FROM asignar_materia WHERE id_curso=(SELECT id_curso FROM cursos WHERE nombre='$nomb')";
			$resultC=mysqli_query($conexion, $sqlC);
			$rowC=mysqli_fetch_assoc($resultC);
			if ($rowC["count"]<$row["max_asig"]){
				//$output= $output . '<option>' . $row["nombre"] . '</option>';
				$cont=$cont+1;
				$output= $output . '<option>' . $row["nombre"] . '-' . $rowC["count"] .'</option>';
			}
		}
		if ($cont>0){
			$error=false;
		}else{
			$error=true;
			$lista='Lista sin cursos incompletos de materias';$output= $output . '<option selected>' . $lista . '</option>';
		}
	}
	else{
		$lista='Lista sin cursos incompletos de materias';  $output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}
	$output= $output . '</p></select></fieldset></p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($error){
		$output= $output . '<input type="submit" name="Siguiente" value="Siguiente" style="font-weight:bold; color:black" disabled>';
	}else{
		$output= $output . '<input type="submit" name="Siguiente" value="Siguiente" style="font-weight:bold; color:black">';
	}
	$output= $output . '<input type="hidden" name="maxA" value="' . $rowC["count"] . '">  
	</p>
	</form>';
}
//Seleccionar Asignaturas
elseif (isset($_POST["Siguiente"])){
	$nombC=$_POST["nombCurso"];
	$sqlC="SELECT max_asig FROM cursos WHERE nombre='$nombC'";
	$rowC=mysqli_fetch_assoc(mysqli_query($conexion, $sqlC));
	$output='<form id="formAsig" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formAsig">
	<legend align="left"><SPAN style="text-align:top">Selecci&oacuten de Materias</SPAN></legend>
        <br><br>
	<p align="center">Curso:&nbsp;&nbsp;<input type="text" name="nombCurso" value="' . $_POST["nombCurso"] . '" disabled>
	&nbsp;&nbsp;&nbsp;&nbspN&uacute;mero m&aacute;ximo asignaturas:&nbsp;<input type="text" name="maxA" value="' . $rowC["max_asig"] . '" disabled size="5%"></p>
	<div align="left"><p><SPAN style="text-align:top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Seleccionar materias de la lista:
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<SPAN style="text-align:top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Materias asignadas al curso:</p></div>
	<div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<select style="width: 230px;" name="origen[]" size="5" multiple autofocus>';
	
	$sql="SELECT id_materia, nombre FROM materias WHERE id_materia NOT IN (SELECT id_materia FROM asignar_materia WHERE id_curso=(SELECT id_curso FROM cursos WHERE nombre='$nombC'))"; //menos asignaturas asignadas al grupo 
	$result=mysqli_query($conexion, $sql); 
	$primero=0; //3189
	$destino=false;
	if (mysqli_num_rows($result) > 0){
		$i=0;
		while($row=mysqli_fetch_assoc($result)){
			if ($primero==0){
				$output= $output . '<option selected>' . $row["nombre"] . '</option>';
			}else{			
				$output= $output . '<option>' . $row["nombre"] . '</option>';
			}
			$primero=1;$materia1[$i]=$row["nombre"];
			$i=$i+1;
		}$aux1=implode("','", $materia1);
	}
	else{
		$output= $output . '<option></option>';
		$aux1="";
	}
	$output= $output . '</select>
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<SPAN style="text-align:top"><select style="width: 230px;" name="destino[]" size="5" multiple>';
  	// Si grupo tiene asignaturas o no
	$sql="SELECT id_materia, nombre FROM materias WHERE id_materia IN (SELECT id_materia FROM asignar_materia WHERE id_curso=(SELECT id_curso FROM cursos WHERE nombre='$nombC'))"; //menos asignaturas asignadas al grupo 
	$result=mysqli_query($conexion, $sql);$longDest=mysqli_num_rows($result);
	if (mysqli_num_rows($result) > 0){
		$destino=true;$i=0;
		while($row=mysqli_fetch_assoc($result)){
			if ($i==($longDest-1)){
				$output= $output . '<option selected>' . $row["nombre"] . '</option>';
			}else{			
				$output= $output . '<option>' . $row["nombre"] . '</option>';
			}
			$primero=1;$materia2[$i]=$row["nombre"];
			$i=$i+1;
		}$aux2=implode("','", $materia2);
	}
	else{
		$output= $output . '<option></option>';
		$aux2="";//3362
	}	
	//$output= $output . '<option></option> 
	$output= $output . '</select></div>
	<br>
	<p align="center"><input type="submit" name="pasarizq" value="A&ntilde;adir" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($destino){
		$output= $output . '<input type="submit" name="pasarder" value="Quitar" style="font-weight:bold; color:black"></p>
		<input type="hidden" name="ldest" value="1">';
	}else{
		$output= $output . '<input type="submit" name="pasarder" value="Quitar" style="font-weight:bold; color:black" disabled>
		<input type="hidden" name="ldest" value="0">';
	}
	$output= $output . '</fieldset></p>
	<p><input type="submit" name="Grabar" value="Grabar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<input type="submit" name="Cancelar" value="Cancelar" style="font-weight:bold; color:black"></p><input type="hidden" name="aux1" value="' . $aux1 . '"> 
	<input type="hidden" name="nombCurso" value="' . $_POST["nombCurso"] . '"><input type="hidden" name="aux2" value="' . $aux2 . '"> 
	<input type="hidden" name="maxA" value="' . $rowC["max_asig"] . '">
	</form>';//3341
//
} elseif ((isset($_POST["pasarizq"])) AND (!empty($_POST["origen"]))){
	$destmat= $_POST["ldest"];
	
	if ($destmat=="0"){ //Lista destino materia vacía
		$materia2=$_POST["origen"];
		$p="primero";$contAsig=count($materia2);
		//$contAsig=0;
	}
	else{
		$materia=explode("','", $_POST["aux2"]);
		$materia2=array_merge($materia, $_POST["origen"]);//3268
		$contAsig=count($materia2);	
		$p="segundo";
	}	

	$output= $p . '-' . $_POST["aux2"] . '<form id="formAsig" action="" method="post" accept-charset="UTF-8" size="100%">
	<fieldset form="formAsig">
	<legend align="left"><SPAN style="text-align:top">Selecci&oacuten de Materias</SPAN></legend>
        <br><br>
	<p align="center">Curso:&nbsp;&nbsp;<input type="text" name="nombCurso" value="' . $_POST["nombCurso"] . '" disabled>
	&nbsp;&nbsp;&nbsp;&nbspN&uacute;mero m&aacute;ximo asignaturas:&nbsp;<input type="text" name="maxA" value="' . $_POST["maxA"] . '" disabled size="5%"></p>
	<div align="left"><p><SPAN style="text-align:top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Seleccionar materias de la lista:
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<SPAN style="text-align:top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Materias asignadas al curso:</p></div>
	<div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<select style="width: 230px;" name="origen[]" size="5" multiple autofocus>';
	
	$lista=implode("','", $materia2); //convierte en string las materias que estan en destino
	
	$sql1="CREATE TABLE origen SELECT nombre FROM materias WHERE nombre IN ('" . $lista . "')";//3281	
	$result1=mysqli_query($conexion, $sql1);
	
	$sql="SELECT nombre FROM materias WHERE nombre NOT IN (SELECT nombre FROM origen)";  
	$result=mysqli_query($conexion, $sql); 
	if (mysqli_num_rows($result) > 0){
		$i=0;
		while($row=mysqli_fetch_assoc($result)){
			if ($i==0){
				$output= $output . '<option selected>' . $row["nombre"] . '</option>';
			}else{
				$output= $output . '<option>' . $row["nombre"] . '</option>';
			}
			$materia1[$i]=$row["nombre"];
			$orig="1";$i=$i+1;
		}//while
		if ($contAsig == $_POST["maxA"]){
			$orig="0";
		}				
	}else{
		$output= $output . '<option></option>'; 
		$orig="0";
	}
	$sql2="DROP TABLE origen";
	$result2=mysqli_query($conexion, $sql2);
	
	$output= $output . '</select>
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<SPAN style="text-align:top"><select style="width: 230px;" name="destino[]" size="5" multiple>';
	$long=count($materia2);
	for ($i=0;$i<$long;$i++){
		if($i==($long-1)){
			$output= $output . '<option selected>' . $materia2[$i] . '</option>';
		}else{
			$output= $output . '<option>' . $materia2[$i] . '</option>';
		}
		//3317
	}
	$aux2=implode("','", $materia2);//3323
	
	$output= $output . '</select></div>
	<br>';
	//disable botón Añadir o no
	if ($orig == "0"){
		$output=$output . '<p align="center"><input type="submit" name="pasarizq" value="A&ntilde;adir" disabled style="font-weight:bold; color:black">';
		if (empty($materia1)){
			$aux1="";
		}else{
			$aux1=implode("','", $materia1);	 
		}
	}else{
		$output=$output . '<p align="center"><input type="submit" name="pasarizq" value="A&ntilde;adir" style="font-weight:bold; color:black">';
		$aux1=implode("','", $materia1);
	}
	
	$output=$output . '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="submit" name="pasarder" value="Quitar" style="font-weight:bold; color:black"></p>
	
	</fieldset>
	</p>
	<p><input type="submit" name="Grabar" value="Grabar" style="font-weight:bold; color:black">
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<input type="submit" name="Cancelar" value="Cancelar" style="font-weight:bold; color:black"></p>
	<input type="hidden" name="ldest" value="1"><input type="hidden" name="aux2" value="' . $aux2 . '"><input type="hidden" name="lorig" value="' . $orig . '">
	<input type="hidden" name="nombCurso" value="' . $_POST["nombCurso"]. '"> <input type="hidden" name="aux1" value="' . $aux1 . '">
	<input type="hidden" name="maxA" value="' . $_POST["maxA"] . '">
	</form>';
	
	$output= $output . $sql1 . " " . $orig; //3466
	
}elseif ((isset($_POST["pasarder"])) AND (!empty($_POST["destino"]))){			
	//convierte array
	$materia=explode("','", $_POST["aux1"]);	
	//$materia2=explode("','", $_POST["aux2"]);
	$materia1=array_merge($materia, $_POST["destino"]);
	
	$output= '<form id="formAsig" action="" method="post" accept-charset="UTF-8" size="100%">
	<fieldset form="formAsig">
	<legend align="left"><SPAN style="text-align:top">Selecci&oacuten de Materias</SPAN></legend>
        <br><br>
	<p align="center">Curso:&nbsp;&nbsp;<input type="text" name="nombCurso" value="' . $_POST["nombCurso"] . '" disabled>
	&nbsp;&nbsp;&nbsp;&nbspN&uacute;mero m&aacute;ximo asignaturas:&nbsp;<input type="text" name="maxA" value="' . $_POST["maxA"] . '" disabled size="5%"></p>
	<div align="left"><p><SPAN style="text-align:top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Seleccionar materias de la lista:
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<SPAN style="text-align:top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Materias asignadas al curso:</p></div>
	<div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<select style="width: 230px;" name="origen[]" size="5" multiple>';
	
	$lista=implode("','", $materia1);
	$sql="SELECT id_materia, nombre FROM materias WHERE nombre IN ('" . $lista . "')";  
	$result=mysqli_query($conexion, $sql); 
	$i=0;//3189
	if (mysqli_num_rows($result) > 0){
		$i=0;
		while($row=mysqli_fetch_assoc($result)){
			if($i==0){
				$output= $output . '<option selected>' . $row["nombre"] . '</option>';
			}else{
				$output= $output . '<option>' . $row["nombre"] . '</option>';
			}
			$materia1[$i]=$row["nombre"];
			$orig="1";$i=$i+1;
		}//while			
	}else{
		$output= $output . '<option></option>'; 
		$orig="0";
	}
	$aux1=implode("','", $materia1);
	$output= $output . '</select>
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<SPAN style="text-align:top"><select style="width: 230px;" name="destino[]" size="5" multiple autofocus>';
	//CREAR TABLA Y ELIMINARLA//3383
	
	$cadena=implode("','", $_POST["destino"]); //string
	//$nuevodestino=trim((str_replace($cadena, "*", $_POST["aux2"])), "*");
	$sql1="CREATE TABLE destino SELECT nombre FROM materias WHERE nombre IN ('" . $_POST["aux2"] . "')";
	$result1=mysqli_query($conexion, $sql1); 
	
	$sql2="SELECT nombre FROM destino WHERE nombre NOT IN ('" . $cadena . "')";
	$result2=mysqli_query($conexion, $sql2);
	$i=0; $reg=mysqli_num_rows($result2);//3406
	if ($reg > 0){
		while($row=mysqli_fetch_assoc($result2)){
			if($i==($reg-1)){
				$output= $output . '<option selected>' . $row["nombre"] . '</option>';
			}else{
				$output= $output . '<option>' . $row["nombre"] . '</option>';
			}
			$materia2[$i]=$row["nombre"];
			$dest="1";$i=$i+1;
		}//while			
	}else{
		$output= $output . '<option></option>'; 
		$dest="0";
	}

	$sql3="DROP TABLE destino";
	$result3=mysqli_query($conexion, $sql3);
	
	$output= $output . '</select></div>
	<br>
	<p align="center"><input type="submit" name="pasarizq" value="A&ntilde;adir" style="font-weight:bold; color:black">
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	//disable botón Quitar o no
	if ($dest == "0"){
		$output=$output . '<input type="submit" name="pasarder" value="Quitar" disabled style="font-weight:bold; color:black">';
		$aux2="";	 
	}else{
		$output=$output . '<input type="submit" name="pasarder" value="Quitar" style="font-weight:bold; color:black">';
		$aux2=implode("','", $materia2);
	}
	$output=$output . '</p>
	</fieldset>
	</p>
	<p><input type="submit" name="Grabar" value="Grabar" style="font-weight:bold; color:black">
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<input type="submit" name="Cancelar" value="Cancelar" style="font-weight:bold; color:black"></p>
	<input type="hidden" name="nombCurso" value="' . $_POST["nombCurso"]. '"><input type="hidden" name="lorig" value="1">
	<input type="hidden" name="ldest" value="' . $dest .'"><input type="hidden" name="aux2" value="' . $aux2 . '">
	<input type="hidden" name="aux1" value="' . $aux1 . '"><input type="hidden" name="maxA" value="' . $_POST["maxA"] . '"> 
	</form>';
	$output=$output . '***' . $_POST["aux2"] . '***' . $cadena . '***' . $aux2;

}elseif ($_POST["Grabar"]){	
	$curso=$_POST["nombCurso"]; 
	//Lista destino vacía
  if ($_POST["aux2"]==""){
  	$output='<p align="center"><font color="red"><b>Atenci&oacuten</font></b></p><br><p>Error al grabar datos de materias para el curso:&nbsp;<b>' . $curso . '</b></p>
	<p><b>No ha seleccionado materia o materias</b></p>';
	$output=$output . '<br><br><p align="center">Para volver asignar materias a un curso&nbsp;<a href="http://localhost/drupal/oficina/materias/asignar_materia">pulse aqu&iacute;</a></p>';
  }else{
	//Buscar id de Curso
	$sql="SELECT id_curso, nombre FROM cursos WHERE nombre='$curso'";
	$result=(mysqli_query($conexion, $sql));
	$idCurso=mysqli_fetch_array($result);
	//Buscar id materias
	$sql1="SELECT id_materia, nombre FROM materias WHERE nombre IN ('" . $_POST["aux2"] . "')";
	$result1=(mysqli_query($conexion, $sql1));
	//Grabar asignaturas
	if (mysqli_num_rows($result1) > 0){
		$output= '<p align="center"><b>Datos registrados satisfactoriamente.</b></p><p>Materias asignadas al curso:&nbsp;<b>' . $curso . '</b></p>';
		$i=1;
		while($row=mysqli_fetch_array($result1)){
			$sql2="INSERT INTO asignar_materia (ID_CURSO, ID_MATERIA) VALUES ('$idCurso[0]', '$row[0]')";
			if(mysqli_query($conexion, $sql2)){
				//$output=$output . "hola" . $idCurso[0] . "-" . $row[0] . "-" . $row[1];
				$output=$output . '<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Asignatura&nbsp;' . $i . '&nbsp;-&nbsp;<b>' . $row[1] . '</b></p>';//3477
				$i=$i+1;
			}
		}
		$output=$output . '<br><br><p align="center">Si desea asignar materias a otro curso&nbsp;<a href="http://localhost/drupal/oficina/materias/asignar_materia">pulse aqu&iacute;</a></p>';
	}
  }
}
mysqli_close($conexion);
return $output;
} /**** end asignar_materia ****/

/**********Anular materias del curso**************/

function anular_materia(){
$output=" ";
$conexion=bdexterna();

//Listar cursos y seleccionar uno
if (!$_POST){
	$output='<form id="formCurso" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formCurso">
	<legend align="left"><SPAN style="text-align:top">Selecci&oacuten de Curso</SPAN></legend>
        <br><br>
	<p><SPAN style="text-align:top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Seleccionar un Curso de la lista para suprimir materias:&nbsp;<p align="center">
	<select name="nombCurso" size="5" required>';
	
	$sql="SELECT nombre, id_curso, max_asig FROM cursos WHERE id_curso IN (SELECT id_curso FROM asignar_materia)";  
	$result=mysqli_query($conexion, $sql);  
	if (mysqli_num_rows($result) > 0){
		$cont=0;
		while($row=mysqli_fetch_assoc($result)){
			$id=$row["id_curso"];
			$sqlA="SELECT COUNT(id_curso) AS count FROM asignar_materia WHERE id_curso='$id'";
			$rowA=mysqli_fetch_assoc(mysqli_query($conexion, $sqlA));
			if ($row["max_asig"] == $rowA["count"]){
				$output= $output . '<option>' . $row["nombre"] . '</option>';
				$cont=$cont+1;
			}
		}
		if ($cont>0){
			$error=false;
		}else{
			$lista='Sin cursos completos de materias';$output= $output . '<option selected>' . $lista . '</option>';
			$error=true;
		}
	}
	else{
		$lista='Sin cursos completos de materias';$output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}
	$output= $output . '</p></select></fieldset></p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($error){
		$output= $output . '<input type="submit" name="Siguiente" value="Siguiente" style="font-weight:bold; color:black" disabled>';
	}else{
		$output= $output . '<input type="submit" name="Siguiente" value="Siguiente" style="font-weight:bold; color:black">';
	}
	$output= $output . '</p>
	</form>';
}elseif (isset($_POST["Siguiente"])){
	$curso=$_POST["nombCurso"]; //3524
	$sql="SELECT id_curso, max_asig FROM cursos WHERE nombre='$curso'"; 
	$result=mysqli_query($conexion, $sql);
	$row=mysqli_fetch_assoc($result);
	$id=$row["id_curso"];
	$output='<form id="formAnular" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formAnular">
	<legend align="left"><SPAN style="text-align:top">Selecci&oacuten de Materias</SPAN></legend>
        <br><br>
	<p align="center">Curso:&nbsp;&nbsp;<input type="text" name="nombCurso" value="' . $_POST["nombCurso"] . '" disabled>
	&nbsp;&nbsp;&nbsp;&nbspN&uacute;mero m&aacute;ximo asignaturas:&nbsp;<input type="text" name="maxA" value="' . $row["max_asig"] . '" disabled size="5%"></p>
	<div align="left"><p><SPAN style="text-align:top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Seleccionar materias de la lista:</p></div>
	<div align="center"><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<select style="width: 230px;" name="materias[]" size="5" multiple autofocus required>';

	$sql1="SELECT id_materia, nombre FROM materias WHERE id_materia IN (SELECT id_materia FROM asignar_materia WHERE id_curso='$id')";  
	$result1=mysqli_query($conexion, $sql1); 
	if (mysqli_num_rows($result1) > 0){
		$cont=0;
		while($row=mysqli_fetch_assoc($result1)){
			$output=$output . '<option>' . $row["nombre"] .'</option>';
			$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}		
	}else{
		$lista='Lista sin materias';$output=$output . '<option selected>' . $lista . '</option>';
		$error=true;
	}
	$output= $output . '</p></select></fieldset></p>
	<p><input type="button" onclick="history.back()" value="Volver Atr&aacute;s" name="Volver Atras"style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($error){
		$output= $output . '<input type="submit" name="Suprimir" value="Suprimir" style="font-weight:bold; color:black" disabled>';
	}else{
		$output= $output . '<input type="submit" name="Suprimir" value="Suprimir" style="font-weight:bold; color:black">';
	} 
	$output= $output . '</p><input type="hidden" name="nombCurso" value="' . $_POST["nombCurso"] . '"><input type="hidden" name="idCurso" value="' . $id . '">
	</form>';

}elseif(isset($_POST["Suprimir"])){
	$listamat=$_POST["materias"];
	$materias=implode("','", $_POST["materias"]);
	$output='<form id="formConfirmarSuprimir" action="" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formConfirmarSuprimir">
	<legend align="left"><SPAN style="text-align:top">Confirmar Eliminar</SPAN></legend>
        <br><br><p>&nbsp;&nbsp;&nbsp;&nbsp;Seguro que desea eliminar las siguientes materias:</p><p align="center"><b>';
	
	for($i=0;$i<count($listamat);$i++){//3574
		$output=$output . $listamat[$i] . '<br>';
		//$i=$i+1;
	} //3564
	$output=$output . '</b></p><p>&nbsp;&nbsp;&nbsp;&nbsp;asignadas al curso&nbsp;<b>' . $_POST["nombCurso"] . '</b></p>
	<p align="center"><input type="submit" value="Aceptar" name="Aceptar" style="font-weight:bold; color:black">&emsp;
	<input type="submit" name="Cancelar" value="Cancelar" style="font-weight:bold; color:black">
	</p></fieldset></p>
	<input type="hidden" name="nombCurso" value="' . $_POST["nombCurso"] . '"><input type="hidden" name="idCurso" value="' . $_POST["idCurso"] . '">
	<input type="hidden" name="materias" value="' . $materias . '">
	</form>';
}else{
	$curso= $_POST["nombCurso"];
	$materias=explode("','", $_POST["materias"]);
	$cont=count($materias);
	$lista=$_POST["materias"];
	$id=$_POST["idCurso"];
	if(isset($_POST["Aceptar"])){		
		$sql4="DELETE FROM asignar_materia WHERE id_curso='$id' AND id_materia IN (SELECT id_materia FROM materias WHERE nombre IN ('" . $lista . "'))";
		if(mysqli_query($conexion, $sql4)){
			$output='<p><b>Las materias seleccionadas del curso <font color="red">' . $curso . '</font> se han borrado satisfactoriamente</b>.</p>
			<p>Materias eliminadas:&nbsp;';
			for($i=0;$i<$cont;$i++){
				if($i==$cont-1){
					$output=$output . '<b>' . $materias[$i] . '</b>';
				}else{
					$output=$output . '<b>' . $materias[$i] . ',&nbsp;</b>';
				}
			} 
			$output=$output . '</p><br><br><p align="center">Si desea volver al apartado "Anular Materias del Curso"&nbsp;&nbsp;<a href="http://localhost/drupal/oficina/materias/anular_materia">pulse aqu&iacute;</a></p>';		
		}
		else{
			$output='<p><b>Error al eliminar las materias del curso:&nbsp;' . $curso . '<b></p>';
			$output=$output . '<p>'. mysqli_error($conexion) . '</p>';
		}
	}else{
		$output='<br><br><b><p align="center">Operaci&oacute;n de eliminar materias asignadas al curso<br>
		<font color="red">"' . $curso . '"</font><br>ha sido cancelada.</b>
		<br>
		<p align="center">Si desea volver al apartado "Anular Materias del Curso"&nbsp;<a href="http://localhost/drupal/oficina/materias/anular_materia">pulse aqu&iacute;</a></p>';
	}
}

mysqli_close($conexion);
return $output;
} /**** end anular_materia ****/


/****************
		***Registros (matrículas)***
					***********************/

/********Listar Registros *******/
function listar_registros() {
$output="";
$conexion=bdexterna();
$tamano_pagina="20";

if(array_key_exists('pagina', $_GET)){
	$pagina=$_GET["pagina"];
}
else{
	$pagina=1;
}

$sql="SELECT * FROM matriculas";
$result=mysqli_query($conexion, $sql);
$total_filas=mysqli_num_rows($result);
$total_paginas=ceil($total_filas / $tamano_pagina);

$sql="SELECT * FROM matriculas ORDER BY fecha DESC LIMIT " . (($pagina-1) * $tamano_pagina) . "," . $tamano_pagina;
$result=mysqli_query($conexion, $sql);
$output='<p align="center"><b><font size="4">Listado de Matr&iacute;culas</font></b></p>';
$output=$output . '<table border="2"><tr><th><font size="3">Identificador</font></th><th><font size="3">C&oacute;digo</font></th><th><font size="3">Fecha</font></th></tr>';
if($total_filas > 0){
	while ($row=mysqli_fetch_assoc($result)){
		preg_match("/([0-9]{4})\-([0-9]{2})\-([0-9]{2})/", $row["FECHA"], $fechaS);
		$fechaL=$fechaS[3] . "/" . $fechaS[2] . "/" . $fechaS[1];
		$output=$output . '<tr><td><font color="blue" size="2">'. $row["ID_MATRICULAS"] . '</font></td><td><font color="blue" size="2">' . $row["CODIGO"] . '</font></td>
				<td><font color="blue" size="2">' . $fechaL . '</font></td></tr>';
	}
	$output=$output . '</table><br>';
}

if ($total_paginas > 1){
	for ($i=1;$i<=$total_paginas;$i++){
		if($pagina == $i){
			$output=$output . 'P&aacute;gina ' . $pagina . "&nbsp;&nbsp;";
		}
		else{
			$output=$output . '<a href="http://localhost/drupal/oficina/registro_de_estudiantes/listar_registros?pagina=' . $i . '">P&aacute;gina ' . $i . '</a>&nbsp;&nbsp;';
		}

	}
}


if (!$_POST){
	$output=$output . '<br><br><form id="formListarMat" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formListarMat"><br><legend align="left"><SPAN style="text-align:top">B&uacute;squeda de informaci&oacute;n de matr&iacute;culas</SPAN></legend><br>
	<p>&emsp;&emsp;&emsp;Seleccionar datos para la b&uacute;squeda:&ensp;&nbsp;<select name="datos">
	<option selected>Fecha</option>
	<option>Estudiante</option>
	<option>Unidad</option>
	</select>
	&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<input type="submit" name="buscarDatos" value="Buscar Datos" style="font-weight:bold; color:black">
	</p>
	</fieldset></p></form>';
}
elseif (isset($_POST["buscarDatos"])){

	switch($_POST["datos"]){
	case "Fecha":
		$output= '<form id="formListarMatFecha" action="" method="post" accept-charset="UTF-8" size="100%">
		<p>
		<fieldset form="formListarMatFecha"><br><legend align="left"><SPAN style="text-align:top">Matr&iacute;culas por Intervalo de Fechas</SPAN></legend><br>
		<p align="left">&emsp;&emsp;&emsp;Introducir las fechas para realizar la b&uacute;queda:</p>
		<p align="center">Fecha Inicio:&nbsp;<input type="date" style="color:blue" name="finicio" required size=10 placeholder="dd/mm/aaaa" maxlength="10">
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Fecha Fin:&nbsp;<input type="date" style="color:blue" name="ffin" required size=10 placeholder="dd/mm/aaaa" maxlength="10"></p>
		<p align="center"><input type="button" onclick="history.back()" value="Volver Atr&aacute;s" name="Volver Atras" style="font-weight:bold; color:black">
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<input type="submit" type="submit" name="BuscarFecha" value="Buscar" style="font-weight:bold; color:black">
		</p>
		</fieldset></p></form>';
		break;
	case "Estudiante":
		$output= '<form id="formListarMatEst" action="" method="post" accept-charset="UTF-8" size="100%">
		<p>
		<fieldset form="formListarMatEst"><br><legend align="left"><SPAN style="text-align:top">Matr&iacute;culas por Estudiante</SPAN></legend><br>
		<p align="left">&emsp;&emsp;&emsp;Seleccionar un estudiante de la lista:</p>
		<p align="center"><select name="Est" autofocus required size=15>';
		$sql="SELECT nombre, apellidos FROM estudiantes WHERE id_est IN (SELECT id_est FROM matriculas)";
		$result=mysqli_query($conexion, $sql);
		if (mysqli_num_rows($result)>0){
			$cont=0;
			while ($row=mysqli_fetch_assoc($result)){
				$output=$output . '<option>' . $row["apellidos"] . ', ' . $row["nombre"] . '</option>';
				$cont=$cont+1;
			}
			if ($cont>0){
				$error=false;
			}	
		}
		else{
			$lista='Lista sin estudiantes';$output=$output . '<option selected>' . $lista . '</option>';
			$error=true;
		}
		$output=$output . '</select></p>
		<p align="center"><input type="button" onclick="history.back()" value="Volver Atr&aacute;s" name="Volver Atras" style="font-weight:bold; color:black">
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
		if ($error){
			$output=$output . '<input type="submit" name="BuscarEst" value="Buscar" style="font-weight:bold; color:black" disabled>';
		}else{
			$output=$output . '<input type="submit" name="BuscarEst" value="Buscar" style="font-weight:bold; color:black">';//4091
		}
		$output=$output . '</p></fieldset></p></form>';
		break;
	case "Unidad":
		$output= '<form id="formListarMatUni" action="" method="post" accept-charset="UTF-8" size="100%">
		<p>
		<fieldset form="formListarMatUni"><br><legend align="left"><SPAN style="text-align:top">Matr&iacute;culas por Unidad</SPAN></legend><br>
		<p align="left">&emsp;&emsp;&emsp;Seleccionar una unidad de la lista:</p>
		<p align="center"><select name="nombUni" autofocus required size=7>';
		$sql="SELECT nombre FROM grupos_a WHERE id_gruposa IN (SELECT id_gruposa FROM detalle_matricula)";
		$result=mysqli_query($conexion, $sql);
		if (mysqli_num_rows($result)>0){
			$cont=0;
			while ($row=mysqli_fetch_assoc($result)){
				$output=$output . '<option>' . $row["nombre"] . '</option>';
				$cont=$cont+1;
			}	
			if ($cont>0){
				$error=false;
			}
		}
		else{
			$lista='Lista sin unidades';$output=$output . '<option selected>' . $lista . '</option>';
			$error=true;
		}
		$output=$output . '</select></p>
		<p align="center"><input type="button" onclick="history.back()" value="Volver Atr&aacute;s" name="Volver Atras" style="font-weight:bold; color:black">
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
		if ($error){
			$output=$output . '<input type="submit" name="BuscarUni" value="Buscar" style="font-weight:bold; color:black" disabled>';
		}else{
			$output=$output . '<input type="submit" name="BuscarUni" value="Buscar" style="font-weight:bold; color:black">';
		}
		$output=$output . '</p></fieldset></p></form>';
		break;
	}
}
elseif (isset($_POST["BuscarFecha"])){

	preg_match("/([0-9]{2})\/([0-9]{2})\/([0-9]{4})/", $_POST["finicio"], $fechaS);
	$fechai=$fechaS[3] . "-" . $fechaS[2] . "-" . $fechaS[1];//3771
	preg_match("/([0-9]{2})\/([0-9]{2})\/([0-9]{4})/", $_POST["ffin"], $fechaS);
	$fechaf=$fechaS[3] . "-" . $fechaS[2] . "-" . $fechaS[1];
	$sql="SELECT * FROM matriculas WHERE fecha BETWEEN '$fechai' AND '$fechaf' ORDER BY fecha ASC";//3767
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result)>0){
		$output = '<p align="center"><font size="4"><b><em>Listado de matr&iacute;culas para intervalo de fecha</font></em></b></p>
		<p align="center"><font color="red" size="4"><b><em>"' . $_POST["finicio"] . '"</font><font size="4">&nbsp;a&nbsp;</font><font color="red" size="4">"' . $_POST["ffin"] .   '"</font></em></b></p>';  
		$output=$output . '<table border="2"><tr><th><font size="3">Identificador</font></th><th><font size="3">C&oacute;digo</font></th><th><font size="3">Fecha</font></th></tr>';  
		while ($row=mysqli_fetch_assoc($result)){
				preg_match("/([0-9]{4})\-([0-9]{2})\-([0-9]{2})/", $row["FECHA"], $fechaS);
				$fechaL=$fechaS[3] . "/" . $fechaS[2] . "/" . $fechaS[1];
				$output=$output . '<tr><td><font color="blue" size="2">' . $row["ID_MATRICULAS"] . '</font></td><td><font color="blue" size="2">' . $row["CODIGO"]  . '</font></td><td><font color="blue" size="2">' . $fechaL . '</font></td></tr>';
			}
	$output=$output . '</table><br><p align="center"><b>Para realizar una nueva b&uacute;squeda,&nbsp;<a href="http://localhost/drupal/oficina/registro_de_estudiantes/listar_registros">pulse aqu&iacute;</a></b></p>';	
	}else{
		$output='<br><br><p><font color="red"><b>Atenci&oacute;n</b></font></p>
		<p>Error en la b&uacute;squeda de las matr&iacute;culas por intervalo de fecha "' . $_POST["finicio"] . '"&nbsp;a&nbsp;"' . $_POST["ffin"] .   '"</p>';
		$output=$output . '<p>' . mysqli_error($conexion) . '</p>
		<br><p align="center"><b>Para volver al apartado "Listar Registros",&nbsp;<a href="http://localhost/drupal/oficina/registro_de_estudiantes/listar_registros">pulse aqu&iacute;</a></b></p>';
	}
}
elseif (isset($_POST["BuscarEst"])){

	$nombre=substr($_POST["Est"], (strpos($_POST["Est"], ",")+1));
	$long=strlen($nombre);
	$nombre=ltrim($nombre);
	$apellidos=substr($_POST["Est"], 0, -($long+1));
	$apellidos=ltrim($apellidos);

	//Identificador de estudiante
	$sqlE="SELECT id_est FROM estudiantes WHERE apellidos='$apellidos' AND nombre='$nombre'";
	$resultE=mysqli_query($conexion, $sqlE);
	$rowE=mysqli_fetch_assoc($resultE);
	$idEst=$rowE["id_est"];	
	
	//buscar matriculas del estudiante
	$sqlM="SELECT * FROM matriculas WHERE ID_EST='$idEst' AND id_matriculas IN (SELECT id_matriculas FROM detalle_matricula)";
	$resultM=mysqli_query($conexion, $sqlM);
	if (mysqli_num_rows($resultM) > 0){
		$output = '<p align="center"><font size="4"><b><em>Listado de matr&iacute;culas para el estudiante seleccionado</font></em></b></p>  
		<p align="center"><font color="red" size="4"><b><em>"' . $_POST["Est"] . '"</font></em></b></p>'; 
		$output=$output . '<table border="2"><tr><th><font size="3">Identificador</font></th><th><font size="3">C&oacute;digo</font></th><th><font size="3">Fecha</font></th><th><font size="3">Unidad</font></th></tr>';
		while ($rowM=mysqli_fetch_assoc($resultM)){
			$mat=$rowM["ID_MATRICULAS"];
			$sqlD="SELECT nombre FROM grupos_a WHERE id_gruposa IN (SELECT DISTINCT id_gruposa FROM detalle_matricula WHERE id_matriculas='$mat')";
			$resultD=mysqli_query($conexion, $sqlD);    //3796
			if (mysqli_num_rows($resultD)>0){
				preg_match("/([0-9]{4})\-([0-9]{2})\-([0-9]{2})/", $rowM["FECHA"], $fechaS);
				$fechaL=$fechaS[3] . "/" . $fechaS[2] . "/" . $fechaS[1];
				if(mysqli_num_rows($resultD)==1){
					$fila=1;
				}else{
					$fila=2;
				}
				$output=$output . '<tr><td rowspan=' . $fila . '><font color="blue" size="2">' . $rowM["ID_MATRICULAS"] . '</font></td><td rowspan=' . $fila . '><font color="blue" size="2">' . $rowM["CODIGO"]  . '</font></td><td rowspan=' . $fila . '><font color="blue" size="2">' . $fechaL . '</font></td>';
				while ($rowD=mysqli_fetch_assoc($resultD)){
					$output=$output . '<td><font color="blue" size="2">' . $rowD["nombre"] . '</font></td></tr>'; 
				}
			}
		}
		$output=$output . '</table><br><p align="center"><b>Para realizar una nueva b&uacute;squeda,&nbsp;<a href="http://localhost/drupal/oficina/registro_de_estudiantes/listar_registros">pulse aqu&iacute;</a></b></p>';
	}else{
		$output='<br><br><p><font color="red"><b>Atenci&oacute;n</b></font></p>
		<p>Error en la b&uacute;squeda de las matr&iacute;culas para el estudiante "' . $_POST["Est"] . '"</p>';
		$output=$output . '<p>' . mysqli_error($conexion) . '</p>
		<br><p align="center"><b>Para volver al apartado "Listar Registros",&nbsp;<a href="http://localhost/drupal/oficina/registro_de_estudiantes/listar_registros">pulse aqu&iacute;</a></b></p>';
	}
}
elseif (isset($_POST["BuscarUni"])){
	
	$nombreUni=$_POST["nombUni"];
	$sql0="SELECT id_gruposa, nombre FROM grupos_a WHERE nombre='$nombreUni'";
	$result0=mysqli_query($conexion, $sql0);
	$row0=mysqli_fetch_assoc($result0);
	$idG=$row0["id_gruposa"];
	$output = '<p align="center"><font size="4"><b><em>Listado de matr&iacute;culas para la unidad seleccionada</font></em></b></p>  
		<p align="center"><font color="red" size="4"><b><em>"' . $_POST["nombUni"] . '"</font></em></b></p>';  
	$sql1="SELECT DISTINCT id_matriculas FROM detalle_matricula WHERE id_gruposa='$idG' ";
	$result1=mysqli_query($conexion, $sql1);//3783
	if (mysqli_num_rows($result1) > 0 ){
		$output=$output . '<table border="2"><tr><th><font size="3">Identificador</font></th><th><font size="3">C&oacute;digo</font></th><th><font size="3">Fecha</font></th><th><font size="3">Estudiante</font></th></tr>';
		while ($row1=mysqli_fetch_assoc($result1)){
			$mat=$row1["id_matriculas"];
			$sql2="SELECT id_matriculas, codigo, fecha, id_est FROM matriculas WHERE id_matriculas='$mat'";
			$result2=mysqli_query($conexion, $sql2);
			$row2=mysqli_fetch_assoc($result2);$idEst=$row2["id_est"];
			$output=$output . '<tr><td><font color="blue" size="2">' . $row1["id_matriculas"] . '</font></td><td><font color="blue" size="2">' . $row2["codigo"]  . '</font></td>';
			$sql3="SELECT apellidos, nombre FROM estudiantes WHERE id_est='$idEst'";
			$result3=mysqli_query($conexion, $sql3);
			$row3=mysqli_fetch_assoc($result3);
			preg_match("/([0-9]{4})\-([0-9]{2})\-([0-9]{2})/", $row2["fecha"], $fechaS);
				$fechaL=$fechaS[3] . "/" . $fechaS[2] . "/" . $fechaS[1];
			$output=$output . '<td><font color="blue" size="2">' . $fechaL . '</font></td><td><font color="blue" size="2">' . $row3["apellidos"] . ',&nbsp;' . $row3["nombre"] . '</font></td></tr>'; 
		}
		$output=$output . '</table><br><p align="center"><b>Para realizar una nueva b&uacute;squeda,&nbsp;<a href="http://localhost/drupal/oficina/registro_de_estudiantes/listar_registros">pulse aqu&iacute;</a></b></p>';
	}else{
		$output='<br><br><p><font color="red"><b>Atenci&oacute;n</b></font></p>
		<p>Error en la b&uacute;squeda de las matr&iacute;culas para la unidad seleccionada "' . $_POST["nombUni"] . '"</p>';
		$output=$output . '<p>' . mysqli_error($conexion) . '</p>
		<br><p align="center"><b>Para volver al apartado "Listar Registros",&nbsp;<a href="http://localhost/drupal/oficina/registro_de_estudiantes/listar_registros">pulse aqu&iacute;</a></b></p>';
	}
}



mysqli_close($conexion);
return $output;
} /**** listar_registros *****/


/*****Alta Registro **********/
function nuevo_alumno ($alumno){
$output="";
if ($alumno=='1'){
			$output = $output . '<form id="formAltaRegistroRepH" action="" method="post" accept-charset="UTF-8">
			<p>
			<fieldset form="formAltaRegistroRepH">
			<legend align="left"><SPAN style="text-align:top">Estudiante desplazado de otro centro</SPAN></legend>
       			<br><br>
			<b><em><p align="center">Para registrar matr&iacute;cula del nuevo estudiante, debe agregar los</p>
			<p align="center">expedientes anteriores al curso que iniciar&aacute; en este centro.</p></em></b>
			<em><p align="center">Para ir al Hist&oacute;rico, hacer clic &nbsp;<a href="http://localhost/drupal/oficina/historial_de_expedientes/alta_historial">AQU&Iacute;.</a>&nbsp;</p></em>
			</fieldset></p>
			</form>';
}else{
	$output=$output . '<p align="center"><b>Para realizar otra matr&iacute;cula, <a href="http://localhost/drupal/oficina/registro_de_estudiantes/alta_registro">Pulse aqu&iacute;</a></b></p>';
}

return $output;
}

function alta_registro(){
$output="";
$conexion=bdexterna();

if (!$_POST){
	$output='<form id="formAltaRegistro" action="" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formAltaRegistro">
	<legend align="left"><SPAN style="text-align:top">Crear una nueva matr&iacute;cula de estudiante</SPAN></legend>
        <br><br>
	<p><SPAN style="text-align:top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Buscar un estudiante de la lista:&nbsp;</SPAN></p>
	<p align="center"><select name="Estudiante" size="8" required autofocus>';
	
	$sql="SELECT nombre, apellidos FROM estudiantes";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result) > 0){
		$cont=0;
		while($row=mysqli_fetch_assoc($result)){
			$output= $output . '<option>' . $row["apellidos"] . ', ' . $row["nombre"] . '</option>';
			$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$lista='Lista sin estudiantes';  $output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}
	$output= $output . '</select></p>
	<p align="center">Nuevo Alumno:&nbsp;&nbsp;<input type="radio" value="1" name="nuevoAlum">&nbsp;&nbsp;S&iacute;
	&nbsp;&nbsp;<input type="radio" value="0" name="nuevoAlum" checked>&nbsp;&nbsp;No&emsp;&emsp;&emsp;&emsp;
	Primera Matr&iacutecula:&nbsp;&nbsp;<input type="radio" value="1" name="pMat" checked>&nbsp;&nbsp;S&iacute;
	&nbsp;&nbsp;<input type="radio" value="0" name="pMat" >&nbsp;&nbsp;No</p>
	<p>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;Asignaturas Pendientes:&ensp;<input type="radio" name="asigPend" value="0" >&nbsp;&nbsp;S&iacute;
	&nbsp;&nbsp;<input type="radio" name="asigPend" value="1" checked>&nbsp;&nbsp;No</p>
	<p><SPAN style="text-align:top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Seleccionar Unidad del Curso Acad&eacute;mico:&nbsp;</SPAN></p>
	<p align="center"><select name="Unidad" size="4" required>';
	
	$sql="SELECT nombre FROM grupos_a WHERE repetidores=0";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result) > 0){
		$cont=0;
		while($row=mysqli_fetch_assoc($result)){
			$output= $output . '<option>' . $row["nombre"] . '</option>';
			$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$lista='Lista sin unidades';  $output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}
	$output= $output . '</select></p>
	<p align="center">C&oacute;digo Matr&iacute;cula:&nbsp;&nbsp;<input type="text" style="color:blue" name="codigoMat" required maxlength="9">
	&nbsp;&nbsp;&nbsp;&nbsp;Fecha Matr&iacute;cula:&nbsp;&nbsp;<input type="date" style="color:blue" name="fecha" required maxlength="10"></p>
	</p></fieldset></p>
	<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($error){
		$output= $output . '<input type="submit" value="Siguiente" name="Siguiente" style="font-weight:bold; color:black" disabled>';
	}else{
		$output= $output . '<input type="submit" value="Siguiente" name="Siguiente" style="font-weight:bold; color:black">';
	}
	$output= $output . '</p></form>';
}
elseif (isset($_POST["Siguiente"]) AND ($_POST["asigPend"]=='0') AND ($_POST["pMat"]=='1')){
	
	$output='<form id="formAltaRegistroRep" action="" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formAltaRegistroRep">
	<legend align="left"><SPAN style="text-align:top">Datos de unidad para asignaturas pendientes</SPAN></legend>
        <br><br>
	<p><SPAN style="text-align:top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Seleccionar Unidad de Curso Anterior:</SPAN></p>
	<p align="center"><select name="UnidadRep" size="4" required>';
	$sql="SELECT nombre, id_curso FROM grupos_a WHERE repetidores=1";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result) > 0){
		$cont=0;
		while($row=mysqli_fetch_assoc($result)){
			$output= $output . '<option>' . $row["nombre"] . '</option>';
			$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$lista='Lista sin cursos';  $output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}
	$nombEst=substr($_POST["Estudiante"], (strpos($_POST["Estudiante"], ",")+1));
	$long=strlen($nombEst);$nombEst=ltrim($nombEst);
	$apelEst=substr($_POST["Estudiante"], 0, -($long+1));
	$apelEst=ltrim($apelEst);
	$sql="SELECT id_est FROM estudiantes WHERE nombre='$nombEst' AND apellidos='$apelEst'";
	$result=mysqli_query($conexion, $sql);
	$idEst=mysqli_fetch_assoc($result);
	//preg_match("/([0-9]{1,2})\/([0-9]{1,2})\/([0-9]{4})/", $_POST["fecha"], $fechaM);
	//$fechaMat=$fechaM[3] . "-" . $fechaM[2] . "-" . $fechaM[1];
	
	$output= $output . '</select></p></fieldset></p>
	<p><input type="button" onclick="history.back()" value="Volver Atr&aacute;s" name="Volver Atras" style="font-weight:bold; color:black">
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($error){
		$output= $output . '<input type="submit" value="Siguiente" name="Siguiente2" style="font-weight:bold; color:black" disabled>';
	}else{
		$output= $output . '<input type="submit" value="Siguiente" name="Siguiente2" style="font-weight:bold; color:black">';
	}
	$output= $output . '<input type="hidden" name="Est" value="' . $_POST["Estudiante"] . '"><input type="hidden" name="UnidadA" value="' . $_POST["Unidad"] .'">
	<input type="hidden" name="Cod" value="' . $_POST["codigoMat"] . '"><input type="hidden" name="FechaM" value="' . $_POST["fecha"] .'">
	<input type="hidden" name="AsigP" value="1">
	<input type="hidden" name="NuevoAlu" value="' . $_POST["nuevoAlum"] . '"><input type="hidden" name="Primat" value="1">
	<input type="hidden" name="IdEst" value="' . $idEst["id_est"] . '">
	</p></form>';//3744
}
elseif (isset($_POST["Siguiente2"])){
	$URep=$_POST["UnidadRep"];
	$sql="SELECT id_curso FROM grupos_a WHERE nombre='$URep'";
	$result=mysqli_query($conexion, $sql);
	$id=mysqli_fetch_assoc($result);
	$idCurso=$id["id_curso"];

	$output='<form id="formAltaRegistroAsig" action="" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formAltaRegistroAsig">
	<legend align="left"><SPAN style="text-align:top">Datos de asignaturas pendientes</SPAN></legend>
        <br><br>
	<p><SPAN style="text-align:top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Seleccionar Asignaturas Pendientes (m&aacute;ximo 3):</SPAN></p>
	<p align="center"><select name="Asig[]" size="4" required multiple>';
	$i=0;
	$sql="SELECT nombre, id_materia FROM materias WHERE id_materia IN (SELECT id_materia FROM asignar_materia WHERE id_curso='$idCurso')";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result) > 0){//3762
		$cont=0;
		while($row=mysqli_fetch_assoc($result)){
			$output= $output . '<option>' . $row["nombre"] . '</option>';
			$materia[$i]=$row["id_materia"];
			$i=$i+1;$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$lista='Lista sin materias';  $output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}

	$output= $output . '</select></p></fieldset></p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($error){
		$output= $output . '<input type="submit" value="Grabar" name="GrabarR" style="font-weight:bold; color:black" disabled>';
	}else{
		$output= $output . '<input type="submit" value="Grabar" name="GrabarR" style="font-weight:bold; color:black">';
	}
	$output= $output . '</p><input type="hidden" name="Est" value="' . $_POST["Est"] . '"><input type="hidden" name="UnidadA" value="' . $_POST["UnidadA"] .'">
	<input type="hidden" name="Cod" value="' . $_POST["Cod"] . '"><input type="hidden" name="FechaM" value="' . $_POST["FechaM"] .'">
	<input type="hidden" name="AsigP" value="' . $_POST["AsigP"] .'"><input type="hidden" name="UnidadR" value="' . $_POST["UnidadRep"] .'">
	<input type="hidden" name="NuevoAlu" value="' . $_POST["NuevoAlu"] . '"><input type="hidden" name="Primat" value="' . $_POST["Primat"] . '">
	<input type="hidden" name="IdEst" value="' . $_POST["IdEst"] . '">
	</form>';	
}
elseif (isset($_POST["GrabarR"])){
	$nombre=$_POST["UnidadA"];
	$sql="SELECT id_gruposa, id_curso FROM grupos_a WHERE nombre='$nombre'";
	$result=mysqli_query($conexion, $sql);
	$rowA=mysqli_fetch_assoc($result);
	$idA=$rowA["id_curso"];
	
	$nombre=$_POST["UnidadR"];
	$sql0="SELECT id_gruposa, id_curso FROM grupos_a WHERE nombre='$nombre'";
	$result0=mysqli_query($conexion, $sql0);
	$rowR=mysqli_fetch_assoc($result0);
	$idR=$rowR["id_curso"];

	//Grabar Matriculas
	preg_match("/([0-9]{1,2})\/([0-9]{1,2})\/([0-9]{4})/", $_POST["FechaM"], $fechaM);
	$fechaMat=$fechaM[3] . "-" . $fechaM[2] . "-" . $fechaM[1];
	$id_ga=$rowA["id_gruposa"];$id_gr=$rowR["id_gruposa"];
	$idE=$_POST["IdEst"];$codigo=$_POST["Cod"];$asigP=$_POST["AsigP"];$pmat=$_POST["Primat"];$nuevo=$_POST["NuevoAlu"];//3800
	
	$sql="INSERT INTO matriculas (ID_MATRICULAS, ID_EST, CODIGO, FECHA, ASIG_PEND, PRIMERA_MAT, NUEVO_ALUMNO) VALUES 
	(NULL, '$idE', '$codigo' , '$fechaMat', '$asigP', '$pmat', '$nuevo')";
	
	$result=mysqli_query($conexion, $sql);
	if($result){ 
		$idMat=mysqli_insert_id($conexion); 
		$output='<p><b>Matr&iacute;cula registrada satisfactoriamente</b></p>
		<p><em>Identificador de matr&iacute;cula de estudiante:</em>&nbsp;<b>' . $idMat . '</b></p>
		<p><em>Estudiante:</em>&nbsp;<b>' . $_POST["Est"] . '</b></p>
		<p><em>C&oacute;digo:</em>&nbsp;<b>' . $_POST["Cod"]. '</b></p>
		<p><em>Fecha Matr&iacute;cula:</em>&nbsp;<b>' . $_POST["FechaM"] . '</b></p>
		<p><em>Unidad:</em>&nbsp;<b>' . $_POST["UnidadA"] . '</b></p>';

		//Registrar Detalle matricula unidadA
		$sql1="SELECT id_materia FROM asignar_materia WHERE id_curso='$idA'";   //"SELECT id_materia FROM materias WHERE id_materia IN (SELECT id_materia FROM asignar_materia WHERE id_curso='$idA')";
		$result1=mysqli_query($conexion, $sql1);
		$i=mysqli_num_rows($result1); $rep=0;
		if (mysqli_num_rows($result1) > 0){//3762
			while($row1=mysqli_fetch_assoc($result1)){ 
				$idmateria=$row1["id_materia"];
				$sql3="INSERT INTO detalle_matricula (ID_DETALLE_MAT, ID_MATRICULAS, ID_GRUPOSA, ID_MATERIA, REPETIDOR) VALUES (NULL, '$idMat', '$id_ga', '$idmateria', '$rep')";
				$res1=mysqli_query($conexion, $sql3);
			}				
		}
		
		//Registrar Detalle matricula unidadR
		
		$listaMat=implode("','", $_POST["Asig"]);//3831
		$sql2="SELECT nombre, id_materia FROM materias WHERE nombre IN ('" . $listaMat . "')";
		$result2=mysqli_query($conexion, $sql2);
		$long=mysqli_num_rows($result2); $rep=1;
		if (mysqli_num_rows($result2) > 0){//3762
			while($row2=mysqli_fetch_assoc($result2)){
				$idmateria=$row2["id_materia"];//3837
				$sql4="INSERT INTO detalle_matricula (ID_DETALLE_MAT, ID_MATRICULAS, ID_GRUPOSA, ID_MATERIA, REPETIDOR) VALUES 
				(NULL, '$idMat', '$id_gr', '$idmateria', '$rep')";
				$res2=mysqli_query($conexion, $sql4);
			}
		}
		$long=count($_POST["Asig"]); 
		$output=$output . '<p><em>Unidad con Asignaturas Pendientes:</em>&nbsp;<b>' . $_POST["UnidadR"] . '</b></p>
		<p><em>N&uacute;mero Asignaturas Pendientes:</em>&nbsp;<b>';
		for($i=0;$i<$long;$i++){
			if($i==($long-1)){
				$output=$output . " " . $_POST["Asig"][$i];
			}else{
				$output=$output . " " . $_POST["Asig"][$i] . ",";
			}
		}
		$output=$output . '</b></p>';
	}
	else{
		$output='<br><br><p><font color="red"><b>Atenci&oacute;n</b></font></p>
		<p>Error al dar de alta los datos de la nueva matr&iacute;cula para el estudiante ' . $_POST["Est"] . '</p>';
		$output=$output . '<p>' . mysqli_error($conexion) . '</p>';
	}
	$mialum=$_POST["NuevoAlu"];//3882
	$output2=nuevo_alumno($mialum);
	$output=$output . $output2;	
}
elseif (isset($_POST["Siguiente"]) AND ($_POST["asigPend"]=='1') AND ($_POST["pMat"]=='0')){
	//3887
	$output='<form id="formAltaRegistroRepComp" action="" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formAltaRegistroRepComp">
	<legend align="left"><SPAN style="text-align:top">Matr&iacute;cula del Estudiante Repetidor</SPAN></legend>
        <br><br>
	<p><SPAN style="text-align:top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Datos del nuevo registro:&nbsp;</SPAN></p>
	<p>&emsp;&emsp;&emsp;&emsp;&emsp;<em>Estudiante:</em>&nbsp<b>' . $_POST["Estudiante"] . '</b></p>		
	<p>&emsp;&emsp;&emsp;&emsp;&emsp;<em>C&oacute;digo Matr&iacute;cula:</em>&nbsp;<b>' . $_POST["codigoMat"]. '</b></p>
	<p>&emsp;&emsp;&emsp;&emsp;&emsp;<em>Fecha Matr&iacute;cula:</em>&nbsp;<b>' . $_POST["fecha"] . '</b></p>
	<p>&emsp;&emsp;&emsp;&emsp;&emsp;<em>Unidad:</em>&nbsp;<b>' . $_POST["Unidad"] . '</b></p>
	</fieldset>	
	<p><input type="submit" value="Grabar" name="Grabar" style="font-weight:bold; color:black"></p>
	</p>
	<input type="hidden" value="' . $_POST["Estudiante"] . '" name="Est"><input type="hidden" value="' . $_POST["Unidad"] . '" name="Unidad">
	<input type="hidden" value="' . $_POST["codigoMat"] . '" name="Cod"><input type="hidden" value="' . $_POST["fecha"] . '" name="fechaM">
	<input type="hidden" value="' . $_POST["nuevoAlum"] . '" name="nuevoAlum"><input type="hidden" value="0" name="asigPend">
	<input type="hidden" value="' . $_POST["pMat"] . '" name="Primat">
	</form>'; 
}
elseif (isset($_POST["Siguiente"]) AND ($_POST["asigPend"]=='1') AND ($_POST["pMat"]=='1')){

	$output='<form id="formAltaRegistroNoRep" action="" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formAltaRegistroNoRep">
	<legend align="left"><SPAN style="text-align:top">Primera Matr&iacute;cula del Estudiante</SPAN></legend>
        <br><br>
	<p><SPAN style="text-align:top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Datos del nuevo registro:&nbsp;</SPAN></p>
	<p>&emsp;&emsp;&emsp;&emsp;&emsp;<em>Estudiante:</em>&nbsp<b>' . $_POST["Estudiante"] . '</b></p>		
	<p>&emsp;&emsp;&emsp;&emsp;&emsp;<em>C&oacute;digo Matr&iacute;cula:</em>&nbsp;<b>' . $_POST["codigoMat"]. '</b></p>
	<p>&emsp;&emsp;&emsp;&emsp;&emsp;<em>Fecha Matr&iacute;cula:</em>&nbsp;<b>' . $_POST["fecha"] . '</b></p>
	<p>&emsp;&emsp;&emsp;&emsp;&emsp;<em>Unidad:</em>&nbsp;<b>' . $_POST["Unidad"] . '</b></p>
	</fieldset>	
	<p><input type="submit" value="Grabar" name="Grabar" style="font-weight:bold; color:black"></p>
	</p>
	<input type="hidden" value="' . $_POST["Estudiante"] . '" name="Est"><input type="hidden" value="' . $_POST["Unidad"] . '" name="Unidad">
	<input type="hidden" value="' . $_POST["codigoMat"] . '" name="Cod"><input type="hidden" value="' . $_POST["fecha"] . '" name="fechaM">
	<input type="hidden" value="' . $_POST["nuevoAlum"] . '" name="nuevoAlum"><input type="hidden" value="0" name="asigPend">
	<input type="hidden" value="' . $_POST["pMat"] . '" name="Primat">
	</form>'; 
}
elseif (isset($_POST["Grabar"])){
	$mialum=$_POST["nuevoAlum"];
	$nombre=$_POST["Unidad"];
	$sql="SELECT id_gruposa, id_curso FROM grupos_a WHERE nombre='$nombre'";
	$result=mysqli_query($conexion, $sql);
	$row=mysqli_fetch_assoc($result);
	$idA=$row["id_curso"];
	$id_ga=$row["id_gruposa"];

	$nombEst=substr($_POST["Est"], (strpos($_POST["Est"], ",")+1));
	$long=strlen($nombEst);$nombEst=ltrim($nombEst);
	$apelEst=substr($_POST["Est"], 0, -($long+1));
	$apelEst=ltrim($apelEst);
	$sql="SELECT id_est FROM estudiantes WHERE nombre='$nombEst' AND apellidos='$apelEst'";
	$result=mysqli_query($conexion, $sql);
	$idEst=mysqli_fetch_assoc($result);

	preg_match("/([0-9]{1,2})\/([0-9]{1,2})\/([0-9]{4})/", $_POST["fechaM"], $fecha);
	$fechaMat=$fecha[3] . "-" . $fecha[2] . "-" . $fecha[1];

	$idE=$idEst["id_est"];$codigo=$_POST["Cod"];$asigP=$_POST["asigPend"];$pmat=$_POST["Primat"];
	//Registrar matricula
	$sql="INSERT INTO matriculas (ID_MATRICULAS, ID_EST, CODIGO, FECHA, ASIG_PEND, PRIMERA_MAT, NUEVO_ALUMNO) VALUES 
	(NULL, '$idE', '$codigo' , '$fechaMat', '$asigP', '$pmat', '$mialum')";
	$result=mysqli_query($conexion, $sql);
	if($result){ 
		$idMat=mysqli_insert_id($conexion); 
		$output='<p><b>Matr&iacute;cula registrada satisfactoriamente</b></p>
		<p><em>Identificador de matr&iacute;cula de estudiante:</em>&nbsp;<b>' . $idMat . '</b></p>
		<p><em>para estudiante:</em>&nbsp;<b>' . $_POST["Est"] . '</b></p>
		<p><em>con el C&oacute;digo de Matr&iacute;cula:</em>&nbsp;<b>' . $_POST["Cod"]. '</b></p>';//3938

		//Registrar Detalle matricula unidad
		$sql1="SELECT id_materia FROM asignar_materia WHERE id_curso='$idA'";   //"SELECT id_materia FROM materias WHERE id_materia IN (SELECT id_materia FROM asignar_materia WHERE id_curso='$idA')";
		$result1=mysqli_query($conexion, $sql1);
		if ($pmat=='1')	{
			$rep=0;
		}else{	
			$rep=1;
		}
		if (mysqli_num_rows($result1) > 0){//3762
			while($row1=mysqli_fetch_assoc($result1)){ 
				$idmateria=$row1["id_materia"];
				$sql3="INSERT INTO detalle_matricula (ID_DETALLE_MAT, ID_MATRICULAS, ID_GRUPOSA, ID_MATERIA, REPETIDOR) VALUES (NULL, '$idMat', '$id_ga', '$idmateria', '$rep')";
				$res1=mysqli_query($conexion, $sql3);
			}				
		}
	}
	else{
		$output='<br><br><p><font color="red"><b>Atenci&oacute;n</b></font></p>
		<p>Error al dar de alta los datos de la nueva matr&iacute;cula para el estudiante ' . $_POST["Est"] . '</p>';
		$output=$output . '<p>' . mysqli_error($conexion) . '</p>';
	}
	$output2=nuevo_alumno($mialum);
	$output=$output . $output2;

}
else{
	$output='<br><br><p><font color="red"><b>Atenci&oacute;n</b></font></p>
	<p>Error inesperado al dar de alta los datos de la nueva matr&iacute;cula</p>
	<br>
	<p align="center"><b>Para volver a realizar una matr&iacute;cula, en el apartado "Alta Registro"&nbsp;<a href="http://localhost/drupal/oficina/registro_de_estudiantes/alta_registro">Pulse aqu&iacute;</a></b></p>'; 
}

mysqli_close($conexion);
return $output;
} /**** alta_registro ****/


/**** baja_registro ****/
function baja_registro() {
$output="";
$conexion=bdexterna();

if (!$_POST){
	$output='<form id="formBajaRegistro" action="" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formBajaRegistro">
	<legend align="left"><SPAN style="text-align:top">Eliminar una o varias matr&iacute;cula/as de estudiante/es</SPAN></legend>
        <br><br>
	<p><SPAN style="text-align:top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Seleccionar de la lista la/as matr&iacute;cula/as:&nbsp;</SPAN></p>
	<p align="center"><select name="matriculas[]" size="8" required autofocus multiple>';
	
	$sql="SELECT codigo FROM matriculas ORDER BY codigo";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result) > 0){
		$cont=0;
		while($row=mysqli_fetch_assoc($result)){
			$output= $output . '<option>' . $row["codigo"] . '</option>';
			$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$lista='Lista sin c&oacute;digos de matr&iacute;culas';  $output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}
	$output= $output . '</select></p>
	
	</fieldset></p>
	<p>&nbsp;&nbsp;<input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($error){
		$output= $output . '<input type="submit" value="Eliminar" name="Eliminar" style="font-weight:bold; color:black" disabled>';
	}else{
		$output= $output . '<input type="submit" value="Eliminar" name="Eliminar" style="font-weight:bold; color:black">';
	}
	$output= $output . '</p>
	</form>';
}
elseif(isset($_POST["Eliminar"])){	
	$listarcodigos=implode(", ", $_POST["matriculas"]);//visualizar códigos
	$codigos=implode("','", $_POST["matriculas"]);//string codigos
	$output='<form id="formConfirmarBajaMat" action="" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formConfirmarBajaMat"">
	<legend align="left"><SPAN style="text-align:top">Confirmar Baja</SPAN></legend>
        <br><br><p align="center"> Seguro que desea dar de baja la/as matr&iacute;cula/as con c&oacute;digo/s:</p>
	<p align="center"><b>' . $listarcodigos . '</b></p>
	<p align="center"><input type="submit" value="Aceptar" name="Aceptar" style="font-weight:bold; color:black">&emsp;
	<input type="submit" name="Cancelar" value="Cancelar" style="font-weight:bold; color:black">
	<input type="hidden" name="listaMatriculas" value="' . $listarcodigos . '"><input type="hidden" name="codMatriculas" value="' . $codigos . '">
	</p></fieldset></p></form>';
}
else{
	$lista=$_POST["listaMatriculas"];//4045
	if(isset($_POST["Aceptar"])){
		$sql1="DELETE FROM detalle_matricula WHERE id_matriculas IN (SELECT id_matriculas FROM matriculas WHERE codigo IN ('" . $_POST["codMatriculas"]  . "'))";
		$sql2="DELETE FROM matriculas WHERE codigo IN ('" . $_POST["codMatriculas"] . "')";
		if((mysqli_query($conexion, $sql1)) AND (mysqli_query($conexion, $sql2))){//4054
			$output= '<p><b>La/s matr&iacute;cula/as seleccionada/s se ha/n borrado satisfactoriamente</b>.</p> 
			<p>C&oacute;digos de matr&iacute;culas: <b>' . $lista. '</b></p><br><br>';
			$output=$output . '<p align="center">Si desea eliminar m&aacute;s matr&iacute;culas&nbsp;<a href="http://localhost/drupal/oficina/registro_de_estudiantes/baja_registro">pulse aqu&iacute;</a></p>';		
		}
		else{
			$output='<p><b>Error al eliminar el/los registro/s con c&oacute;digos:&nbsp;' . $_POST["listaMatriculas"] . '<b></p>';
			$output=$output . '<p>'. mysqli_error($conexion) . '</p>';
		}	
	}else{
		$output='<br><br><b><p align="center">Operaci&oacute;n de eliminar matr&iacute;culas con los c&oacute;digos<br>
		<font color="red">' . $_POST["listaMatriculas"] . '</font><br>ha sido cancelada</b>
		<br>
		<p align="center">Si desea volver al apartado "Baja Registro"&nbsp;<a href="http://localhost/drupal/oficina/registro_de_estudiantes/baja_registro">pulse aqu&iacute;</a></p>'; 
	}
}

mysqli_close($conexion);
return $output;
} /**** baja_registro *****/

/**** modificar_registro ****/
function modificar_registro() {
$output="";
$conexion=bdexterna();

if (!$_POST){
	$output='<form id="formModRegistro" action="" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formModRegistro">
	<legend align="left"><SPAN style="text-align:top">Cambiar una matr&iacute;cula de estudiante</SPAN></legend>
        <br><br>
	<p><SPAN style="text-align:top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Seleccionar de la lista la matr&iacute;cula:&nbsp;</SPAN></p>
	<p align="center"><select name="matriculas" size="8" required autofocus>';
	
	$sql="SELECT codigo FROM matriculas ORDER BY codigo";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result) > 0){
		$cont=0;
		while($row=mysqli_fetch_assoc($result)){
			$output= $output . '<option>' . $row["codigo"] . '</option>';
			$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$lista='Lista sin c&oacute;digos de matr&iacute;culas'; $output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}
	$output= $output . '</select></p><br>
	<p align="center"><em><b>Nota:&nbsp;</b>En la siguiente pantalla solo puede modificar los datos de los campos activos,</p>
	<p align="center">en caso contrario, tendr&aacute; que volver a realizar dicha matr&iacute;cula.</em></p>
	</fieldset></p>
	<p>&nbsp;&nbsp;<input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($error){
		$output= $output . '<input type="submit" value="Siguiente" name="Siguiente" style="font-weight:bold; color:black" disabled>';
	}else{
		$output= $output . '<input type="submit" value="Siguiente" name="Siguiente" style="font-weight:bold; color:black">';
	}
	$output= $output . '</p>
	</form>';
}
elseif (isset($_POST["Siguiente"])){
	$codMat=$_POST["matriculas"];
	$sql0="SELECT nombre, apellidos FROM estudiantes WHERE id_est=(SELECT id_est FROM matriculas WHERE codigo='$codMat')";
	$row0=mysqli_fetch_assoc(mysqli_query($conexion, $sql0));
	$sql1="SELECT * FROM matriculas WHERE codigo='$codMat'";
	$row1=mysqli_fetch_assoc(mysqli_query($conexion, $sql1));
	$output='<form id="formModReg" action="" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formModReg">
	<legend align="left"><SPAN style="text-align:top">Datos de matr&iacute;cula de un estudiante</SPAN></legend>
        <br><br>
	<p><SPAN style="text-align:top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Nombre de estudiante:&nbsp;</SPAN>
	<input type="text" style="color:blue" name="Est" value="' . $row0["apellidos"] . ', ' . $row0["nombre"] . '" disabled size="30"></p>';
	if($row1["NUEVO_ALUMNO"]==0){ //4116
		$output= $output . '<p align="center">Nuevo Alumno:&nbsp;&nbsp;<input type="radio" value="0" name="nuevoAlum" disabled>&nbsp;&nbsp;S&iacute;
		&nbsp;&nbsp;<input type="radio" value="1" name="nuevoAlum" checked disabled>&nbsp;&nbsp;No&emsp;&emsp;&emsp;&emsp;';
	}else{
		$output= $output . '<p align="center">Nuevo Alumno:&nbsp;&nbsp;<input type="radio" value="1" name="nuevoAlum"  checked disabled>&nbsp;&nbsp;S&iacute;
		&nbsp;&nbsp;<input type="radio" value="0" name="nuevoAlum" disabled>&nbsp;&nbsp;No&emsp;&emsp;&emsp;&emsp;';
	}
	if($row1["PRIMERA_MAT"]==0){ //4123
		$output= $output . 'Primera Matr&iacutecula:&nbsp;&nbsp;<input type="radio" value="0" name="pMat" disabled>&nbsp;&nbsp;S&iacute;
		&nbsp;&nbsp;<input type="radio" value="1" name="pMat" checked disabled>&nbsp;&nbsp;No</p>';
	}else{
		$output= $output . 'Primera Matr&iacutecula:&nbsp;&nbsp;<input type="radio" value="1" name="pMat" checked disabled>&nbsp;&nbsp;S&iacute;
		&nbsp;&nbsp;<input type="radio" value="0" name="pMat" disabled>&nbsp;&nbsp;No</p>';
	}
	
	$output= $output . '<p><SPAN style="text-align:top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Seleccionar otra Unidad para el curso actual:&nbsp;</SPAN></p>
	<p align="center"><select name="Unidad" size="4" required>';
	$id=$row1["ID_MATRICULAS"];

	$sql2="SELECT id_gruposa FROM detalle_matricula WHERE id_matriculas='$id' AND repetidor=0";
	$row2=mysqli_fetch_assoc(mysqli_query($conexion, $sql2));
	$sql="SELECT nombre, id_gruposa FROM grupos_a WHERE repetidores=0";
	$result=mysqli_query($conexion, $sql);
	
	if (mysqli_num_rows($result) > 0){
		$cont=0;
		while($row=mysqli_fetch_assoc($result)){
			if($row["id_gruposa"]==$row2["id_gruposa"]){ //4147
				$output= $output . '<option selected>' . $row["nombre"] . '</option>';
			}else{
				$output= $output . '<option>' . $row["nombre"] . '</option>';
			}
			$cont=$cont+1;
		}
		if ($cont>0){
			$error1=false;
		}
	}
	else{
		$lista='Lista sin grupos';  $output= $output . '<option selected>' . $lista . '</option>';
		$error1=true;
	}
	$output= $output . '</select></p>';
	if($row1["ASIG_PEND"]==0){ //4123
		$error2=false;
		$output= $output . '<p>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;Asignaturas Pendientes:&ensp;<input type="radio" name="asigPend" value="0" disabled>&nbsp;&nbsp;S&iacute;
		&nbsp;&nbsp;<input type="radio" name="asigPend" value="1" checked disabled>&nbsp;&nbsp;No</p>
		<input type="hidden" name="SinAsig" value="true">';//4157
	}else{
		$output= $output . '<p>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;Asignaturas Pendientes:&ensp;<input type="radio" name="asigPend" value="1" checked disabled>&nbsp;&nbsp;S&iacute;
		&nbsp;&nbsp;<input type="radio" name="asigPend" value="0" disabled>&nbsp;&nbsp;No</p>';
		$output= $output . '<p><SPAN style="text-align:top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Seleccionar otra Unidad para asignaturas pendientes del curso anterior:&nbsp;</SPAN></p>
		<p align="center"><select name="UnidadR" size="4" required>';
		$sql2="SELECT id_gruposa FROM detalle_matricula WHERE id_matriculas='$id' AND repetidor=1";
		$row2=mysqli_fetch_assoc(mysqli_query($conexion, $sql2));
		$sql="SELECT nombre, id_gruposa FROM grupos_a WHERE repetidores=1";
		$result=mysqli_query($conexion, $sql);
	
		if (mysqli_num_rows($result) > 0){
			$cont=0;
			while($row=mysqli_fetch_assoc($result)){
				if($row["id_gruposa"]==$row2["id_gruposa"]){ //4147
					$output= $output . '<option selected>' . $row["nombre"] . '</option>';
				}else{
					$output= $output . '<option>' . $row["nombre"] . '</option>';
				}
				$cont=$cont+1;
			}
			if ($cont>0){
				$error2=false;
			}
		}
		else{
		  	$lista='Lista sin grupos';$output= $output . '<option selected>' . $lista . '</option>';	
			$error2=true;
		}
		$output= $output . '</select></p><input type="hidden" name="SinAsig" value="false">';
	}

	preg_match("/([0-9]{4})\-([0-9]{1,2})\-([0-9]{1,2})/", $row1["FECHA"], $fecha);
	$fechaMat=$fecha[3] . "/" . $fecha[2] . "/" . $fecha[1];
	$output= $output . '<p align="center">C&oacute;digo Matr&iacute;cula:&nbsp;&nbsp;<input type="text" style="color:blue" name="codigoMat" required maxlength="9" value="' .$row1["CODIGO"] . '">
	&nbsp;&nbsp;&nbsp;&nbsp;Fecha Matr&iacute;cula:&nbsp;&nbsp;<input type="date" style="color:blue" name="fecha" required maxlength="10" value="' .$fechaMat . '"></p>
	</p></fieldset></p>
	<p><input type="button" onclick="history.back()" value="Volver Atr&aacute;s" name="Volver Atras" style="font-weight:bold; color:black">
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($error1 || $error2){//4843
		$output= $output . '<input type="submit" value="Grabar" name="Grabar" style="font-weight:bold; color:black" disabled>';
	}else{
		$output= $output . '<input type="submit" value="Grabar" name="Grabar" style="font-weight:bold; color:black">';
	}
	$output= $output . '</p>
	<input type="hidden" name="idMat" value="' . $id .'"><input type="hidden" name="Estu" value="' . $row0["apellidos"] . ', ' . $row0["nombre"] . '">
	</form>';
}
elseif (isset($_POST["Grabar"])){
	$result3=$result4=$result5=$result6="false";
	//Asignar variables
	$idMat=$_POST["idMat"];$codigo=$_POST["codigoMat"];
	if ($_POST["SinAsig"]=="false"){  //4199
		$unidad=$_POST["Unidad"];$unidadR=$_POST["UnidadR"];
		$sql2="SELECT id_gruposa FROM  grupos_a WHERE nombre='$unidadR'";
		$idR=mysqli_fetch_assoc(mysqli_query($conexion, $sql2));
		$idGR=$idR["id_gruposa"];
	}else{
		$unidad=$_POST["Unidad"];
	}
	preg_match("/([0-9]{1,2})\/([0-9]{1,2})\/([0-9]{4})/", $_POST["fecha"], $fechaM);
	$fechaMat=$fechaM[3] . "-" . $fechaM[2] . "-" . $fechaM[1];
	//Seleccionar id de unidades
	$sql1="SELECT id_gruposa FROM  grupos_a WHERE nombre='$unidad'";
	$idA=mysqli_fetch_assoc(mysqli_query($conexion, $sql1));
	$idGA=$idA["id_gruposa"];
	
	//Grabar datos
	
	$sql3="UPDATE matriculas SET CODIGO='$codigo', FECHA='$fechaMat' WHERE ID_MATRICULAS='$idMat'";
	$result3=mysqli_query($conexion, $sql3);
	$sql4="SELECT * FROM detalle_matricula WHERE ID_MATRICULAS='$idMat'";
	$result4=mysqli_query($conexion, $sql4); $long= mysqli_num_rows($result4);
	if (mysqli_num_rows($result4) > 0){
		while($fila=mysqli_fetch_array($result4)){
			if (($fila[4]==1) AND ($_POST["SinAsig"]=="false")){   
				$sql5="UPDATE detalle_matricula SET ID_GRUPOSA='$idGR' WHERE ID_MATRICULAS='$idMat' AND REPETIDOR=1";
				$result5=mysqli_query($conexion, $sql5);
				
			}
			else{
				$sql6="UPDATE detalle_matricula SET ID_GRUPOSA='$idGA' WHERE ID_MATRICULAS='$idMat' AND REPETIDOR=0";
				$result6=mysqli_query($conexion, $sql6);
			}
		}
		$Error="false";
	}else{
		$Error="true";
	}

	if(($result6) AND ($result3) AND ($Error=="false")){
		$output='<p><b>La matr&iacute;cula seleccionada del estudiante&nbsp;<font color="red">' . $_POST["Estu"] . '</font>&nbsp;se ha modificado satisfactoriamente</b>.</p> 
		<p>Identificador de registro:&nbsp;<b>' . $_POST["idMat"] . '</b></p>
		<p>C&oacute;digo de matr&iacute;cula:&nbsp;<b>' . $_POST["codigoMat"] . '</b></p>
		<p>Fecha de matr&iacute;cula:&nbsp;<b>' . $_POST["fecha"] . '</b></p>
		<p>Unidad de Curso Actual:&nbsp;<b>' . $_POST["Unidad"] . '</b></p>';
		if(($result5) AND ($_POST["SinAsig"]=="false")){ //4239
			$output=$output . '<p>Unidad con Asignaturas Pendientes del Curso Anterior:&nbsp;<b>' . $_POST["UnidadR"] . '</b></p>';
		}
		$output=$output . '<br>
		<p align="center">Si desea volver al apartado "Modificar Registro"&nbsp;<a href="http://localhost/drupal/oficina/registro_de_estudiantes/modificar_registro">pulse aqu&iacute;</a></p>'; 
	}else{
		$output='<p><b>Error al modificar el registro con c&oacute;digo de matr&iacute;cula:&nbsp;' . $_POST["codigoMat"] . '<b></p>';
			$output=$output . '<p>'. mysqli_error($conexion) . '</p><br>
			<p align="center">Si desea volver a modificar la matr&iacute;cula"&nbsp;<a href="http://localhost/drupal/oficina/registro_de_estudiantes/modificar_registro">pulse aqu&iacute;</a></p>'; 
	}
}

mysqli_close($conexion);
return $output;
} /**** modificar_registro *****/



/****************
		***Historial de Expedientes***
					     ***********************/

/************************* listar de historial ************************/
function listar_historial() {
$output="";
$conexion=bdexterna();
$tamano_pagina="10";

if(array_key_exists('pagina', $_GET)){
	$pagina=$_GET["pagina"];
}
else{
	$pagina=1;
}

$sql="SELECT * FROM historico";
$result=mysqli_query($conexion, $sql);
$total_filas=mysqli_num_rows($result);
$total_paginas=ceil($total_filas / $tamano_pagina);

$sql="SELECT * FROM historico ORDER BY fecha_hist DESC LIMIT " . (($pagina-1) * $tamano_pagina) . "," . $tamano_pagina;
$result=mysqli_query($conexion, $sql);
$output='<p align="center"><b><font size="4">Listado de Hist&oacute;rico de Expedientes</font></b></p>';
$output=$output . '<table border="2"><tr><th><font size="3">Identificador</font></th><th><font size="3">Estudiante</font></th><th><font size="3">Expediente</font></th><th><font size="3">Fecha</font></th></tr>';
if($total_filas > 0){
	while ($row=mysqli_fetch_assoc($result)){
		$ide=$row["ID_EST"];
		$sqle="SELECT nombre, apellidos FROM estudiantes WHERE id_est='$ide'";
		$resulte=mysqli_query($conexion, $sqle);
		$rowe=mysqli_fetch_assoc($resulte);
		preg_match("/([0-9]{4})\-([0-9]{2})\-([0-9]{2})/", $row["FECHA_HIST"], $fechaT);
		$fechaH=$fechaT[3] . "/" . $fechaT[2] . "/" . $fechaT[1];
		$output=$output . '<tr><td><font color="blue" size="2">'. $row["ID_HIST"] . '</font></td><td><font color="blue" size="2">' . $rowe["apellidos"] . ', ' . $rowe["nombre"] . '</font></td>
				<td><font color="blue" size="2">' . $row["FICHA_EXP"] . '</font></td><td><font color="blue" size="2">' . $fechaH . '</font></td></tr>';
	}
	$output=$output . '</table><br>';
}

if ($total_paginas > 1){
	for ($i=1;$i<=$total_paginas;$i++){
		if($pagina == $i){
			$output=$output . 'P&aacute;gina ' . $pagina . "&nbsp;&nbsp;";
		}
		else{
			$output=$output . '<a href="http://localhost/drupal/oficina/historial_de_expedientes/listar_historial?pagina=' . $i . '">P&aacute;gina ' . $i . '</a>&nbsp;&nbsp;';
		}

	}
}
if (!$_POST){
	$output=$output . '<br><br><form id="formListarHist" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formListarHist"><br><legend align="left"><SPAN style="text-align:top">B&uacute;squeda de informaci&oacute;n de Hist&oacute;rico de Expedientes</SPAN></legend><br>
	<p>&emsp;&emsp;&emsp;Seleccionar datos para la b&uacute;squeda:&ensp;&nbsp;<select name="datos">
	<option selected>Fecha</option>
	<option>Estudiante</option>
	<option>Expediente</option>
	</select>
	&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<input type="submit" name="buscarDatos" value="Buscar Datos" style="font-weight:bold; color:black">
	</p>
	</fieldset></p></form>';
}
elseif (isset($_POST["buscarDatos"])){
	switch($_POST["datos"]){
		case "Fecha":
			$output= '<form id="formListarHistFecha" action="" method="post" accept-charset="UTF-8" size="100%">
			<p>
			<fieldset form="formListarHistFecha"><br><legend align="left"><SPAN style="text-align:top">Hist&oacute;rico de Expedientes por Intervalo de Fechas</SPAN></legend><br>
			<p align="left">&emsp;&emsp;&emsp;Introducir las fechas para realizar la b&uacute;queda:</p>
			<p align="center">Fecha Inicio:&nbsp;<input type="date" style="color:blue" name="finicio" required size=10 placeholder="dd/mm/aaaa" maxlength="10">
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Fecha Fin:&nbsp;<input type="date" style="color:blue" name="ffin" required size=10 placeholder="dd/mm/aaaa" maxlength="10"></p>
			<p align="center"><input  type="button" onclick="history.back()" value="Volver Atr&aacute;s" name="Volver Atras"  style="font-weight:bold; color:black">
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			<input type="submit" type="submit" name="BuscarFecha" value="Buscar" style="font-weight:bold; color:black"></p>
			</fieldset></p></form>';
			break;
		case "Estudiante":
			$output= '<form id="formListarHistEst" action="" method="post" accept-charset="UTF-8" size="100%">
			<p>
			<fieldset form="formListarHistEst"><br><legend align="left"><SPAN style="text-align:top">Hist&oacute;rico de Expedientes por Estudiante</SPAN></legend><br>
			<p align="left">&emsp;&emsp;&emsp;Seleccionar un estudiante de la lista:</p>
			<p align="center"><select name="Est" autofocus required size=15>';
			$sql="SELECT nombre, apellidos FROM estudiantes WHERE id_est IN (SELECT id_est FROM matriculas)";
			$result=mysqli_query($conexion, $sql);
			if (mysqli_num_rows($result)>0){
				$cont=0;
				while ($row=mysqli_fetch_assoc($result)){
					$output=$output . '<option>' . $row["apellidos"] . ', ' . $row["nombre"] . '</option>';
					$cont=$cont+1;
				}
				if ($cont>0){
					$error=false;
				}	
			}
			else{
				$lista='Lista sin estudiantes matriculados'; $output=$output . '<option selected>' . $lista . '</option>';
				$error=true;
			}
			$output=$output . '</select></p>
			<p align="center"><input  type="button" onclick="history.back()" value="Volver Atr&aacute;s" name="Volver Atras"  style="font-weight:bold; color:black">
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
			if ($error){
				$output=$output . '<input type="submit" name="BuscarEst" value="Buscar" style="font-weight:bold; color:black" disabled></p>';
			}else{
				$output=$output . '<input type="submit" name="BuscarEst" value="Buscar" style="font-weight:bold; color:black"></p>';
			}
			$output=$output . '</fieldset></p></form>';
			break;
		case "Expediente":
			$output='<form id="formListarHistExp" action="" method="post" accept-charset="UTF-8" size="100%">
			<p>
			<fieldset form="formListarHistExp"><br><legend align="left"><SPAN style="text-align:top">Hist&oacute;rico de Expedientes por Unidad</SPAN></legend><br>
			<p align="left">&emsp;&emsp;&emsp;Seleccionar un expediente de la lista:</p>
			<p align="center"><select name="numExp" autofocus required size=7>';
			$sql="SELECT ficha_exp FROM estudiantes WHERE id_est IN (SELECT id_est FROM matriculas)";
			$result=mysqli_query($conexion, $sql);
			if (mysqli_num_rows($result)>0){
				$cont=0;
				while ($row=mysqli_fetch_assoc($result)){
					$output=$output . '<option>' . $row["ficha_exp"] . '</option>';
					$cont=$cont+1;
				}
				if ($cont>0){
					$error=false;
				}	
			}
			else{
				$lista='Lista sin expedientes';$output=$output . '<option selected>' . $lista . '</option>';
				$error=true;
			}
			$output=$output . '</select></p>
			<p align="center"><input type="button" onclick="history.back()" value="Volver Atr&aacute;s" name="Volver Atras" style="font-weight:bold; color:black">
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
			if ($error){
				$output=$output . '<input type="submit" name="BuscarExp" value="Buscar" style="font-weight:bold; color:black" disabled></p>';
			}else{
				$output=$output . '<input type="submit" name="BuscarExp" value="Buscar" style="font-weight:bold; color:black"></p>';
			}
			$output=$output . '</fieldset></p></form>';
			break;
		
	}//switch
}
elseif (isset($_POST["BuscarFecha"])){
	preg_match("/([0-9]{2})\/([0-9]{2})\/([0-9]{4})/", $_POST["finicio"], $fechaS);
	$fechai=$fechaS[3] . "-" . $fechaS[2] . "-" . $fechaS[1];//3771
	preg_match("/([0-9]{2})\/([0-9]{2})\/([0-9]{4})/", $_POST["ffin"], $fechaS);
	$fechaf=$fechaS[3] . "-" . $fechaS[2] . "-" . $fechaS[1];
	$sql="SELECT * FROM historico WHERE fecha_hist BETWEEN '$fechai' AND '$fechaf' ORDER BY fecha_hist ASC";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result)>0){
		$output = '<p align="center"><font size="4"><b><em>Listado de Hist&oacute;rico de Expedientes para intervalo de fecha</font></em></b></p>
		<p align="center"><font color="red" size="4"><b><em>"' . $_POST["finicio"] . '"</font><font size="4">&nbsp;a&nbsp;</font><font color="red" size="4">"' . $_POST["ffin"] .   '"</font></em></b></p>';  
		$output=$output . '<table border="2"><tr><th><font size="3">Identificador</font></th><th><font size="3">Expediente</font></th><th><font size="3">Fecha</font></th><th><font size="3">Estudiante</font></th></tr>';  
		while ($row=mysqli_fetch_assoc($result)){
			$ide=$row["ID_EST"];
			$sqle="SELECT nombre, apellidos FROM estudiantes WHERE id_est='$ide'";
			$resulte=mysqli_query($conexion, $sqle);
			$rowe=mysqli_fetch_assoc($resulte);
			preg_match("/([0-9]{4})\-([0-9]{2})\-([0-9]{2})/", $row["FECHA_HIST"], $fechaS);
			$fechaL=$fechaS[3] . "/" . $fechaS[2] . "/" . $fechaS[1];
			$output=$output . '<tr><td><font color="blue" size="2">' . $row["ID_HIST"] . '</font></td><td><font color="blue" size="2">' . $row["FICHA_EXP"]  . '</font></td><td><font color="blue" size="2">' . $fechaL . '</font></td><td><font color="blue" size="2">' . $rowe["apellidos"]  . ', ' . $rowe["nombre"] . '</font></td></tr>';
		}
		$output=$output . '</table><br><p align="center"><b>Para realizar una nueva b&uacute;squeda,&nbsp;<a href="http://localhost/drupal/oficina/historial_de_expedientes/listar_historial">pulse aqu&iacute;</a></b></p>';	
	}else{
		$output='<br><br><p><font color="red"><b>Atenci&oacute;n</b></font></p>
		<p>Error en la b&uacute;squeda de los hist&oacute;ricos de expedientes por intervalo de fecha "' . $_POST["finicio"] . '"&nbsp;a&nbsp;"' . $_POST["ffin"] .   '"</p>';
		$output=$output . '<p>' . mysqli_error($conexion) . '</p>
		<br><p align="center"><b>Para volver al apartado "Listar Historial de Expedientes",&nbsp;<a href="http://localhost/drupal/oficina/historial_de_expedientes/listar_historial">pulse aqu&iacute;</a></b></p>';
	}
}
elseif (isset($_POST["BuscarEst"]) || isset($_POST["Volver"]) || isset($_POST["BuscarExp"])){
	if (isset($_POST["BuscarEst"])){
		$nombre=substr($_POST["Est"], (strpos($_POST["Est"], ",")+1));
		$long=strlen($nombre);
		$nombre=ltrim($nombre);
		$apellidos=substr($_POST["Est"], 0, -($long+1));
		$apellidos=ltrim($apellidos);
		//Identificador de estudiante
		$sqlE="SELECT id_est, ficha_exp FROM estudiantes WHERE apellidos='$apellidos' AND nombre='$nombre'";
		$resultE=mysqli_query($conexion, $sqlE);
		$rowE=mysqli_fetch_assoc($resultE);
		$idEst=$rowE["id_est"];	$fexp=$rowE["ficha_exp"];
	}elseif (isset($_POST["BuscarExp"])){
		$fexp=$_POST["numExp"];
		$sqlE="SELECT nombre, apellidos, id_est FROM estudiantes WHERE ficha_exp='$fexp'";
		$resultE=mysqli_query($conexion, $sqlE);
		$rowE=mysqli_fetch_assoc($resultE);
		$apellidos=$rowE["apellidos"]; $nombre=$rowE["nombre"]; $idEst=$rowE["id_est"];
	}else{
		$idEst=$_POST["idEst"];
		$sqlE="SELECT nombre, apellidos, ficha_exp FROM estudiantes WHERE id_est='$idEst'";
		$resultE=mysqli_query($conexion, $sqlE);
		$rowE=mysqli_fetch_assoc($resultE);
		$apellidos=$rowE["apellidos"]; $nombre=$rowE["nombre"];$fexp=$rowE["ficha_exp"];
	}
	//$output='<b>N&uacute;mero de Expediente:&nbsp;' .  . '</b><br>' . $idEst;
//buscar historico del estudiante
	$sqlH="SELECT * FROM detalle_historico WHERE id_hist IN (SELECT id_hist FROM historico WHERE id_est='$idEst')";
	$resultH=mysqli_query($conexion, $sqlH);
	if (mysqli_num_rows($resultH) > 0){
		$rowH=mysqli_fetch_assoc($resultH);$idh=$rowH["ID_HIST"];
		$output ='<form id="formListarHistEst2" action="" method="post" accept-charset="UTF-8" size="100%">
		<p>
		<fieldset form="formListarHistEst2"><br><legend align="left"><SPAN style="text-align:top">Listado de Unidades de un Expediente</SPAN></legend><br>
		<p align="center"><font size="3"><b><em>Estudiante:&nbsp;"' . $apellidos . ', ' . $nombre .'" &nbsp;- &nbsp; "Exp:&nbsp;' . $fexp . '"</font></em></b></p>';//4679  
		
		$output=$output . '<table border="2" style="color:black" width="50%"><tr valign="middle"><th><font size="3">Nombre de Unidad</font></th><th><font size="3">A&ntildeo</font></th><th><font size="3">Tipo Matr&iacute;cula</font></th><th><font size="3">S</font></th></tr>';
		$sqlD="SELECT * FROM detalle_historico WHERE id_hist='$idh'";
		$resultD=mysqli_query($conexion, $sqlD);$i=1;
		if (mysqli_num_rows($resultD)>0){
			while ($rowD=mysqli_fetch_assoc($resultD)){
				//preg_match("/([0-9]{4})\-([0-9]{2})\-([0-9]{2})/", $rowM["FECHA"], $fechaS);
				//$fechaL=$fechaS[3] . "/" . $fechaS[2] . "/" . $fechaS[1];
				switch( $rowD["MATRICULA"]){
					case "1":
						$mat="Primera";
						break;
					case "2":
						$mat="Segunda";
						break;
					case "3":
						$mat="Tercera o sucesivas";
						break;
				}//switch
				$output=$output . '<tr><td><font color="blue" size="2">' . $rowD["NOMB_GRUPO"] . '</font></td><td><font color="blue" size="2">' . $rowD["AÑO_A"]  . '</font></td><td><font color="blue" size="2">' . $mat . '</font></td>';
				if ($i==1){
					$output=$output . '<td><font color="blue" size="2"><input type="radio" value="' . $rowD["ID_DETALLE_HIST"] . '-' . $rowD["NOMB_GRUPO"] . '" name="Unidad" required checked></font></td></tr>';
				}
				else{
					$output=$output . '<td><font color="blue" size="2"><input type="radio" value="' . $rowD["ID_DETALLE_HIST"] . '-' . $rowD["NOMB_GRUPO"] . '" name="Unidad" required></font></td></tr>';
				}
				$i=$i+1; 
				//4704
			}
		}
		$output=$output . '</table><br><p align="center">Seleccionar una unidad del listado para visualizar bolet&iacute;n de notas</p>
			<p align="center"><input type="submit" value="Ver Notas" name="Notas" style="font-weight:bold; color:black">
			</p>
			<input type="hidden" value="' . $idEst . '" name="idEst"><input type="hidden" value="' . $idh . '" name="idh">
			</p></fieldset></form>	
			<p align="center"><b>Para realizar una nueva b&uacute;squeda,&nbsp;<a href="http://localhost/drupal/oficina/historial_de_expedientes/listar_historial">pulse aqu&iacute;</a></b></p>';//5161
	//}if (mysqli_num_rows($resultH) == 0){
		//estudiante sin historico
	}
	else{//no historico
		$output='<br><br><p><font color="red"><b>Atenci&oacute;n</b></font></p>';
		if (isset($_POST["Est"])){
			$output=$output . '<p>Error en la b&uacute;squeda del hist&oacute;rico de expediente para el estudiante "' . $_POST["Est"] . '"</p>';
		}else{
			$output=$output . '<p>Error en la b&uacute;squeda del hist&oacute;rico de expediente para el n&uacute;mero de expediente "' . $_POST["numExp"] . '"</p>';
		}
		$output=$output . '<p>' . mysqli_error($conexion) . '</p>
		<br><p align="center"><b>Para volver al apartado "Listar Historial de Expedientes",&nbsp;<a href="http://localhost/drupal/oficina/historial_de_expedientes/listar_historial">pulse aqu&iacute;</a></b></p>';
	}

}elseif (isset($_POST["Notas"])){
	$nombre=substr($_POST["Unidad"], (strpos($_POST["Unidad"], "-")+1));
	$long=strlen($nombre);
	$nombre=ltrim($nombre);
	$idDH=substr($_POST["Unidad"], 0, -($long+1));
	$idDH=ltrim($idDH);
	$idEst=$_POST["idEst"];
	$sqlE="SELECT * FROM estudiantes WHERE id_est='$idEst'";
	$resultE=mysqli_query($conexion, $sqlE);
	$rowE=mysqli_fetch_assoc($resultE);
	$sqlD="SELECT * FROM detalle_historico WHERE id_detalle_hist='$idDH'";
	$rowD=mysqli_fetch_assoc(mysqli_query($conexion, $sqlD));
	$idCur=$rowD["ID_CURSO"];
	switch( $rowD["MATRICULA"]){
		case "1":
			$mat="Primera";
			break;
		case "2":
			$mat="Segunda";
			break;
		case "3":
			$mat="Tercera o sucesivas";
			break;
	}//switch
	//$sqlC="SELECT num_conv FROM ciclos WHERE id_ciclo IN (SELECT id_ciclo FROM cursos WHERE id_curso IN (SELECT id_curso FROM detalle_historico WHERE id_detalle_hist='$idDH'))";
	$sqlC="SELECT num_conv FROM ciclos WHERE id_ciclo IN (SELECT id_ciclo FROM cursos WHERE id_curso='$idCur')";
	$rowC=mysqli_fetch_assoc(mysqli_query($conexion, $sqlC));

        //$output=$_POST["Unidad"] . '++++++' . $nombre . '++++' . $idDH . 'NumConv' . $rowC["num_conv"];//4732
	$output='<form id="formListarHistEst3" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formListarHistEst3"><br><legend align="left"><SPAN style="text-align:top">Calificaciones de Unidad </SPAN></legend><br>
	<p align="center"><font size="3"><b><em>Estudiante:&nbsp;"' . $rowE["APELLIDOS"] . ', ' . $rowE["NOMBRE"] . '" &nbsp;- &nbsp; "Exp:&nbsp;' . $rowE["FICHA_EXP"] . '"</font></em></b></p> 
	<table border="2" style="color:black" width="50%">
	<caption align="top"><font size="4" color="blue">Bolet&iacute;n de Unidad&nbsp;<b>' . $nombre . '</b>&nbsp;<br>Curso Acad&eacute;mico&nbsp;<b>' . $rowD["AÑO_A"] . '</b>&nbsp;-&nbsp;Matr&iacute;cula de&nbsp;<b>' . $mat . '</b></font></caption>
	<tr valign="middle"><th><font size="3">Asignaturas</font></th><th><font size="3">1T</font></th><th><font size="3">2T</font></th><th><font size="3">3T</font></th><th><font size="3">Ord</font></th></tr>';
	//$i=1;$cont1=$rowC["num_conv"];
	//while ($cont1 > 0){	
		$sqlM="SELECT nombre, id_materia FROM materias WHERE id_materia IN (SELECT id_materia FROM asignar_materia WHERE id_curso IN (SELECT id_curso FROM detalle_historico WHERE id_detalle_hist='$idDH'))";
		$resultM=mysqli_query($conexion, $sqlM);
		while ($rowM=mysqli_fetch_assoc($resultM)){
			$idm=$rowM["id_materia"];
			$output=$output . '<tr valign="middle"><td><font color="blue" size="2">' . $rowM["nombre"] . '</font></td>';
			$j=1;$cont2=$rowC["num_conv"];
			while ($cont2 > 0){
				$sqlN="SELECT * FROM notas_hist WHERE id_materia='$idm' AND id_conv='$j' AND id_detalle_hist IN (SELECT id_detalle_hist FROM detalle_historico WHERE id_detalle_hist='$idDH')";
				$resultN=mysqli_query($conexion, $sqlN);
				while ($rowN=mysqli_fetch_assoc($resultN)){
					$output=$output . '<td><font color:blue" size="2">' . $rowN["NOTAN"] . '</td>';				
				}
				$j=$j+1;$cont2=$cont2-1;
			}//while cont
			$output=$output . '</tr>';
		}//while Materias
		//$i=$i+1;$cont1 =$cont1-1;
	//}//while conv
	$output=$output . '</table><p align="center">
	<input type="submit" value="Volver atr&aacute;s" name="Volver" style="font-weight:bold; color:black">
	</p>
	<input type="hidden" value="' . $idEst . '" name="idEst">
	</p></fieldset>
	</form>
	<p align="center"><b>Para realizar una nueva b&uacute;squeda,&nbsp;<a href="http://localhost/drupal/oficina/historial_de_expedientes/listar_historial">pulse aqu&iacute;</a></b></p>';
}
mysqli_close($conexion);
return $output;
}/********** end listar historial ********/



/************************* alta de historial ************************/
function alta_historial() {
$output="";
$conexion=bdexterna();

if ((!$_POST) || isset($_POST["Cancelar"])){
	$output='<form id="formAltaHistorial" action="" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formAltaHistorial">
	<legend align="left"><SPAN style="text-align:top">Crear historial de un nuevo estudiante</SPAN></legend>
        <br><br>
	<p align="center">Fecha de creaci&oacute;n:&nbsp;<input type="date" style="color:blue" name="FHist" maxlength="10" required size= "16%" placeholder="dd/mm/aaaa" autofocus></p>
	<p><SPAN style="text-align:top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Seleccionar un estudiante de la lista:&nbsp;</SPAN></p>
	<p align="center"><select name="Estudiante" size="8" required>';
	
	$sql="SELECT * FROM estudiantes WHERE externo=1 AND id_est NOT IN (SELECT id_est FROM historico)";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result) > 0){
		$cont=0;
		while($row=mysqli_fetch_assoc($result)){
			$output= $output . '<option>' . $row["APELLIDOS"] . ', ' . $row["NOMBRE"] . '</option>';
			$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$lista='Lista sin estudiantes';  $output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}
	$output= $output . '</select></p>
	</fieldset></p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($error){
		$output= $output . '<input type="submit" value="Siguiente" name="Siguiente1" style="font-weight:bold; color:black" disabled>';
	}else{
		$output= $output . '<input type="submit" value="Siguiente" name="Siguiente1" style="font-weight:bold; color:black">';
	}
	$output= $output . '</p></form>';
}elseif (isset($_POST["Siguiente1"])){
	$nombEst=substr($_POST["Estudiante"], (strpos($_POST["Estudiante"], ",")+1));
	$long=strlen($nombEst);$nombEst=ltrim($nombEst);
	$apelEst=substr($_POST["Estudiante"], 0, -($long+1));
	$apelEst=ltrim($apelEst);
	$sql="SELECT * FROM estudiantes WHERE nombre='$nombEst' AND apellidos='$apelEst'";
	$row=mysqli_fetch_assoc(mysqli_query($conexion, $sql));

	$ide=$row["ID_EST"];$ficha=$row["FICHA_EXP"];
	preg_match("/([0-9]{1,2})\/([0-9]{1,2})\/([0-9]{4})/", $_POST["FHist"], $nfecha);
	$fecha=$nfecha[3] . "-" . $nfecha[2] . "-" . $nfecha[1];
	$sqlh="INSERT INTO historico (ID_HIST, ID_EST, FICHA_EXP, FECHA_HIST) VALUES (NULL, '$ide', '$ficha', '$fecha')";		
	
	if (mysqli_query($conexion, $sqlh)){
		//mensaje alta de historico correcto
		$output='<form id="AltaHistRealizado action="" method="post" accept-charset="UTF-8">
			<p>
			<fieldset form="AltaHistRealizado">
			<legend align="left"><SPAN style="text-align:top">Mensaje de Alta de Hist&oacute;rico</SPAN></legend>
			<br><br>
			<p align="center">Realizado satisfactoriamente la apertura de Hist&oacute;rico para el estudiante&nbsp;</p>
			<p align="center"><b>' . $_POST["Estudiante"] . '</b></p>
			<p align="center"><input type="submit" name="Continuar" value="Continuar" style="font-weight:bold; color:black"></p>
			<input type="hidden" name="Estudiante" value="' . $_POST["Estudiante"] . ' "><input type="hidden" name="Ide" value="' . $ide . ' ">
			</fieldset></p></form>';
	}else{
		//mensaje de fallo en alta de historico
		$output='<br><br><b><p align="center">La operaci&oacute;n de Alta de Hist&oacute;rico para el estudiante<br>
			<font color="red">"' . $_POST["Estudiante"] . '"</font><br>no se ha podido efectuar.</b>
			<p align="center">Para volver al apartado "Alta Historial de Expediente"&nbsp;
			<a href="http://localhost/drupal/oficina/historial_de_expedientes/alta_historial">pulse aqu&iacute;</a></p>';
	}
}elseif (isset($_POST["Continuar"])){
	$ide=$_POST["Ide"];//4583
	$sql="SELECT * FROM estudiantes WHERE id_est='$ide'";
	$result=mysqli_query($conexion, $sql);
	$rowE=mysqli_fetch_assoc($result);

	$output='<form id="formAltaHistCurso" action="" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formAltaHistCurso">
	<legend align="left"><SPAN style="text-align:top">Datos de Curso Acad&eacute;mico realizado por el Estudiante</SPAN></legend>
        <br><br>
	<p align="center"><SPAN style="text-align:top">Estudiante:&nbsp;</SPAN>
	<input type="text" name="Estudiante" value="' . $rowE["APELLIDOS"] . ', ' . $rowE["NOMBRE"] . '" disabled size="60%"></p>
	<p align="center"><SPAN style="text-align:top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Expediente:&nbsp;</SPAN>
	<input type="number" name="Exp" value="' . $rowE["FICHA_EXP"] . '" disabled></p>
	<hr size="10" width="98%"><br>
	<p align="center">Nombre de Unidad:&nbsp;<input type="text" style="color:blue" name="Unidad" size="50%" required autofocus></p>
	<p>&emsp;&emsp;&emsp;&emsp;&emsp;Seleccionar el curso acad&eacutemico de la lista:</p>
	<p align="center"><select name="CursoA" size="5" required>';

	$sql="SELECT * FROM cursos";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result) > 0){
		$cont=0;
		while($rowC=mysqli_fetch_assoc($result)){
			$output= $output . '<option>' . $rowC["NOMBRE"] . '</option>';
			$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$lista='Lista sin cursos';  $output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}
	
	$output=$output . '</select></p>
	<p align="center">A&ntildeo acad&eacute;mico:&nbsp;<input type="text" style="color:blue" name="AnoA" size="10%" maxlength="4" required>
	&emsp;&emsp;&emsp;&emsp;Tipo matr&iacute;cula:&nbsp;<select style="color:blue" name="Mat" required>
	<option selected>Primera</option><option>Segunda</option><option>Tercera o sucesivas</option></select></p>
	<p align="center">Centro de estudios:&nbsp;<input type="text" style="color:blue" name="Centro" size="65%" required></p>
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Observaciones:&nbsp;<p align="center"><textarea name="Observaciones" style="color:blue" rows="4" cols="95"></textarea></p>
	</fieldset></p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($error){
		$output=$output . '<input type="submit" value="Siguiente" name="Siguiente2" style="font-weight:bold; color:black" disabled>';
	}else{
		$output=$output . '<input type="submit" value="Siguiente" name="Siguiente2" style="font-weight:bold; color:black">';
	}
	$output=$output . '</p><input type="hidden" name="Estudiante" value="' . $rowE["APELLIDOS"] . ', ' . $rowE["NOMBRE"]  . '"><input type="hidden" name="Ide" value="' . $ide . '">
	</form>';
}elseif (isset($_POST["Siguiente2"]) || isset($_POST["Grabar"]) || isset($_POST["Finalizar"]) || isset($_POST["Continuar1"])){
$error=false;
	if(!(isset($_POST["Finalizar"]))){
		$finalizar=false;
		$curso=$_POST["CursoA"];	
	}
	if (isset($_POST["Siguiente2"])){//4636
	//GRABAR DATOS detalle_historico
		switch($_POST["Mat"]){
			case "Primera":
				$mat=1;
				break;
			case "Segunda":
				$mat=2;
				break;
			case "Tercera o sucesivas":
				$mat=3;
				break;
		}
		$ide=$_POST["Ide"];$unidad=$_POST["Unidad"];$anno=$_POST["AnoA"];$centro=$_POST["Centro"];$observ=$_POST["Observaciones"];
		$sqlh="SELECT id_hist FROM historico WHERE id_est='$ide'";
		$rowh=mysqli_fetch_assoc(mysqli_query($conexion, $sqlh));
		$idh=$rowh["id_hist"];//4642
		$sqlc="SELECT id_curso FROM cursos WHERE nombre='$curso'";
		$rowc=mysqli_fetch_assoc(mysqli_query($conexion, $sqlc));
		$idc=$rowc["id_curso"];
		$sqli="INSERT INTO  detalle_historico (ID_DETALLE_HIST, ID_HIST, ID_CURSO, NOMB_GRUPO, AÑO_A, MATRICULA, CENTRO, OBSERVACIONES) 
		VALUES (NULL, '$idh', '$idc', '$unidad', '$anno', '$mat', '$centro', '$observ')";
		if (!(mysqli_query($conexion, $sqli))){
			$output='<br><br><b><p align="center"><font color="red">Atenci&oacute;n</font></p><br>
			<p align="center">No se ha podido continuar con la grabaci&oacute;n del historial del estudiante</p>
			<p align="center"><b><font color="red">"' . $_POST["Estudiante"] . '"</font></b></p>//4680
			<p align="center>Error:&nbsp;' .  mysqli_error($conexion) . '</p><br>
			<p align="center">Crear de nuevo el ata, para volver al apartado de "Alta Historial de Expediente"&nbsp;
			<a href="http://localhost/drupal/oficina/historial_de_expedientes/alta_historial">pulse aqu&iacute;</a></p>';
			$sqld="DELETE FROM historico WHERE id_hist='$idh'";
			$result=mysqli_query($conexion, $sqld);
			
		}
		$id_det_h=mysqli_insert_id($conexion);
	}else{
		$id_det_h=$_POST["IdDetH"];
		//$sqlh="SELECT id_detalle_hist FROM detalle_historico WHERE id_detalle_hist='$id'";
		//$rowh=mysqli_fetch_assoc(mysqli_query($conexion, $sqlh));
		//$id_det_h=$rowh["id_detalle_hist"];//4951
	}

	if (isset($_POST["Siguiente2"]) || isset($_POST["Grabar"]) || isset($_POST["Continuar1"])){
		$sql="SELECT num_conv FROM ciclos WHERE id_ciclo IN (SELECT id_ciclo FROM cursos WHERE nombre='$curso')";
		$result=mysqli_query($conexion, $sql);
		$conv=mysqli_fetch_assoc($result);
		$output=$error . '<form id="formAltaHistMaterias" action="" method="post" accept-charset="UTF-8">
		<p>
		<fieldset form="formAltaHistMaterias">
		<legend align="left"><SPAN style="text-align:top">Calificaciones de las Asignaturas impartidas</SPAN></legend>
       		<br><br>
		<p align="center">Estudiante:&nbsp;<input type="text" name="Estudiante" value="' . $_POST["Estudiante"] . '" disabled size="60%"></p>
		<hr size="10" width="98%"><br>
		<p align="center">Unidad:&nbsp;<input type="text" name="Unidad" value="' . $_POST["Unidad"] . '" size="50%" disabled></p>
		<p align="center">Curso:&nbsp;<input type="text" name="CursoA" value="' . $_POST["CursoA"] . '" size="20%" disabled></p>
		<hr size="10" width="98%"><br>';
		if ($conv["num_conv"]==4){
			$cadena='Extraordinaria';
		}else{
			$cadena="";
		}
	}//end if   
	if (((isset($_POST["Conv"]) AND isset($_POST["cadena"]))) || (isset($_POST["Finalizar"])) || (isset($_POST["Continuar1"]))){
	  	if (!(isset($_POST["Finalizar"])) || !(isset($_POST["Continuar1"]))){
			$cadena= $_POST["cadena"] . "','" . $_POST["Conv"];
	  	}
		if (isset($_POST["Continuar1"])){
			$long=strlen($_POST["Conv"]);
			$cadena=substr($cadena, 0, -($long+3));
		
		}
		if (!(isset($_POST["Continuar1"]))){//5516
			$nomb=$_POST["Conv"];
			$sql="SELECT id_conv FROM convocatorias WHERE nombre='$nomb'";
			$row=mysqli_fetch_assoc(mysqli_query($conexion, $sql));		
			$idconv=$row["id_conv"];
			//GRABAR DATOS notas  AND $mat<>0 AND $notn<>0 AND $notv<>''
			for ($i=1;$i<=$_POST["contMat"];$i++){
				$mat=$_POST["idmat$i"];
				$notn=$_POST["notan$i"];
				$notv=$_POST["notav$i"];
				$sql="INSERT INTO notas_hist (ID_NOTA_HIST, ID_DETALLE_HIST, ID_MATERIA, ID_CONV, NOTAN, NOTAV) 
					VALUES (NULL, '$id_det_h', '$mat', '$idconv', '$notn', '$notv')";
				$result=mysqli_query($conexion, $sql);
				if ($result){//5529
					$error=false;
				}else{
					$error=true;
					break;
				}
			}//for
		}//if
	}//end_if
	if (isset($_POST["Siguiente2"]) || isset($_POST["Grabar"]) || isset($_POST["Continuar1"])){
		$output=$output . '<p align="center">Seleccionar una convocatoria:&nbsp;<select name="Conv" required autofocus>';
		$sql="SELECT nombre FROM convocatorias WHERE nombre NOT IN ('" . $cadena . "')";
		$result=mysqli_query($conexion, $sql);
		if (mysqli_num_rows($result) > 0){
			while($row=mysqli_fetch_assoc($result)){
				$output= $output . '<option>' . $row["nombre"] . '</option>';
			}
			if (mysqli_num_rows($result) == 1){
				$finalizar=true;
			}
		}
		else{
		  	$output= $output . '<option></option>';
		}
		$output=$output . '</select></p>
		<table border="2" style="color:black" width="50%">
		<tr valign="middle" ><th><font size="3">Asignaturas</font></th><th><font size="3">Nota Num&eacute;rica</font></th><th><font size="3">Nota Valorativa</font></th></tr>';
	
		$nombCurso=$_POST["CursoA"];
		$sql="SELECT nombre, id_materia FROM materias WHERE id_materia IN (SELECT id_materia FROM asignar_materia WHERE id_curso IN (SELECT id_curso FROM cursos WHERE nombre='$nombCurso'))";
		$result=mysqli_query($conexion, $sql);
		$contMat=mysqli_num_rows($result);
		if ($contMat > 0){
			$i=0;
			while($row=mysqli_fetch_assoc($result)){
				$j=0;
				$materia[$i][$j]=$row["id_materia"]; $materia[$i][$j+1]=$row["nombre"];
				$i=$i+1;
				$output= $output . '<tr valign="middle"><td><font color="blue" size="2">' . $row["nombre"] . '</font>
				<input type="hidden" name="idmat' . $i . '" value="' . $row["id_materia"] . '"></td>
				<td><input type="number" onkeypress="if (event.keyConde < 45 || event.keyCode > 57) event.returnValue = false;" style="color:blue" name="notan' . $i .'" size="5%" required></td>
				<td><input type="text" style="color:blue" name="notav' . $i .'" required></td></tr>';
			}
		}
		$output=$output . '</table>	
		</fieldset></p>
		<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
		if ($finalizar == false){
			$output=$output . '<input type="submit" value="Grabar" name="Grabar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			<input type="submit" value="Finalizar" name="Finalizar" style="font-weight:bold; color:black" disabled>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
		}else{
			$output=$output . '<input type="submit" value="Grabar" name="Grabar" style="font-weight:bold; color:black" disabled>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			<input type="submit" value="Finalizar" name="Finalizar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
		}
		$output=$output . '</p>
		<input type="hidden" name="cadena" value="' . $cadena . '"><input type="hidden" name="Estudiante" value="' . $_POST["Estudiante"] . '">
		<input type="hidden" name="Unidad" value="' . $_POST["Unidad"] . '"><input type="hidden" name="CursoA" value="' . $_POST["CursoA"] . '">
		<input type="hidden" name="IdDetH" value="' . $id_det_h . '"><input type="hidden" name="contMat" value="' . $contMat . '">
		<input type="hidden" name="Ide" value="' . $_POST["Ide"] . '">
		</form>';
	}//end_if
	if (isset($_POST["Finalizar"])){//5650
		$output='<form id="AltaHistFinalizar action="" method="post" accept-charset="UTF-8">
		<p>
		<fieldset form="AltaHistFinalizar">
		<legend align="left"><SPAN style="text-align:top">Confirmar Hist&oacute;rico de Estudiante completado</SPAN></legend>
		<br><br>
		<p align="center">Si tiene otra unidad para dar de alta en el hist&oacute;rico del estudiante&nbsp;</p>
		<p align="center"><b>' . $_POST["Estudiante"] . '</b></p>
		<p align="center">Pulsar el bot&oacute;n de "Aceptar" para continuar y para terminar pulsar el bot&oacute;n "Cancelar".</p>
		<p align="center"><input type="submit" name="Continuar" value="Aceptar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<input type="submit" name="Cancelar" value="Cancelar" style="font-weight:bold; color:black"></p>
		<input type="hidden" name="Estudiante" value="' . $_POST["Estudiante"] . ' "><input type="hidden" name="Ide" value="' . $_POST["Ide"] . '">
		</fieldset></p></form>';
	}
	if ($error){
		$error=false;
		$output='<form id="formErrorAltaHist1" action="" method="post" accept-charset="UTF-8" size="100%">
		<fieldset form="formErrorAltaHist1"><p>
		<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend><br>
		<p align="center"><b>Error en el alta de evaluaciones del historial</b></p>
		<p align="center"><em>Estudiante:&nbsp;</em><b>' . $_POST["Estudiante"] . '</b></p>
		<p align="center"><input type="submit" value="Continuar" name="Continuar1" style="font-weight:bold; color:black">
		<input type="hidden" name="Estudiante" value="' . $_POST["Estudiante"] . ' "><input type="hidden" name="Ide" value="' . $_POST["Ide"] . '">
		<input type="hidden" name="Unidad" value="' . $_POST["Unidad"] . '"><input type="hidden" name="CursoA" value="' . $_POST["CursoA"] . '">
		<input type="hidden" name="IdDetH" value="' . $id_det_h . '"><input type="hidden" name="contMat" value="' . $contMat . '">
		<input type="hidden" name="cadena" value="' . $_POST["cadena"] . '"><input type="hidden" name="Conv" value="' . $_POST["Conv"] . '">
		</p></fieldset></form>';
		$output=$output . '<br><p><font color="red">'. mysqli_error($conexion) . '</font></p>';
		for ($i=1;$i<=$contMat;$i++){
			$sqlb="DELETE FROM notas_hist WHERE id_detalle_hist='$id_det_h' AND (id_materia=0 OR id_conv=0 OR (notan=0 AND notav=''))";
			$resultb=mysqli_query($conexion, $sqlb);
		}
	}//$error
}

mysqli_close($conexion);
return $output;
}  /*** end alta_historial ***/


/************************* baja de historial ************************/
function baja_historial(){
$output="";
$conexion=bdexterna();

		
if (!$_POST){
	$output='<form id="formBajaHistorial" action="" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formBajaHistorial">
	<legend align="left"><SPAN style="text-align:top">Eliminar historial de expedientes</SPAN></legend>
        <br><br>
	<b><p align="center">
	Para dar de baja un historial de expedientes, se puede realizar seleccionando<br>
	el n&uacute;mero de historial con el n&uacute;mero de expediente o el nombre del estudiante.</p></b><br>
	<p align="center">Seleccionar una opci&oacute;n de la lista:&nbsp;<select name="opcion" required>
	<option></option><option>Historial</option><option>Estudiante</option></select></p>
	
	</fieldset></p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<input type="submit" value="Siguiente" name="Siguiente" style="font-weight:bold; color:black"></p>
	</form>';
}elseif (isset($_POST["Siguiente"])){
	$output='<form id="formBajaHistOpcion" action="" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formBajaHistOpcion">
	<legend align="left"><SPAN style="text-align:top">Registro a eliminar</SPAN></legend>
        <br><br>';
	
	if ($_POST["opcion"]=="Historial"){
		$sqlh="SELECT * FROM historico WHERE id_est IN (SELECT id_est FROM estudiantes WHERE externo='1')";
		$resulth=mysqli_query($conexion, $sqlh);//4866
		$output=$output . '<p align="center">Seleccionar de la lista un n&uacute;mero de historial de expedientes para eliminar.</p>
		<p align="center"><label>N&uacute;mero de historial y de expediente:</label>
		<select name="hist" required size="8">';
		if (mysqli_num_rows($resulth) > 0){
			$cont=0;
			while($rowh=mysqli_fetch_assoc($resulth)){
				$output= $output . '<option>' . $rowh["ID_HIST"] . ' - expd:' . $rowh["FICHA_EXP"] . '</option>';
				$cont=$cont+1;
			}
			if ($cont>0){
				$error=false;
			}
		}else{
			$lista='Lista sin hisorial de estudiantes';$output=$output . '<option selected>' . $lista . '</option>';
			$error=true;
		}
		$output=$output . '</select></p>';
	}elseif ($_POST["opcion"]=="Estudiante"){
		$sqle="SELECT * FROM estudiantes WHERE externo='1' AND id_est IN (SELECT id_est FROM historico)";
		$resulte=mysqli_query($conexion, $sqle);//4880
		$output=$output . '<p align="center">Seleccionar de la lista un estudiante para eliminar su historial de expedientes.</p>
		<p align="center"><label>Nombre de estudiante:</label>
		<select name="est" required size="8">';
		if (mysqli_num_rows($resulte) > 0){
			$cont=0;
			while($rowe=mysqli_fetch_assoc($resulte)){
				$output= $output . '<option>' . $rowe["APELLIDOS"] . ', ' . $rowe["NOMBRE"]  . '</option>';
				$cont=$cont+1;
			}
			if ($cont>0){
				$error=false;
			}
		}else{
			$lista='Lista sin historial de estudiantes';$output=$output . '<option selected>' . $lista . '</option>';
			$error=true;
		}//4890
		$output=$output . '</select></p>';
	}

	$output=$output . '</fieldset></p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<input type="button" onclick="history.back()" value="Volver Atr&aacute;s" name="Volver Atras" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($error){
		$output=$output . '<input type="submit" value="Eliminar" name="Eliminar" style="font-weight:bold; color:black" disabled>';
	}else{
		$output=$output . '<input type="submit" value="Eliminar" name="Eliminar" style="font-weight:bold; color:black">';
	}
	$output=$output . '</p><input type="hidden" value="' . $_POST["opcion"] . '" name="opcion">
	</form>';
}elseif (isset($_POST["Eliminar"])){
	$output='<form id="formConfirmarHist" action="" method="post" accept-charset="UTF-8">
	<p>line 4900
	<fieldset form="formConfirmarHist">
	<legend align="left"><SPAN style="text-align:top">Confirmar Baja de Historial de Expedientes</SPAN></legend>
        <br><br><p align="center">Seguro que desea dar de baja el historial correspondiente al</p>';
	if ($_POST["opcion"]=="Historial"){
		$output=$output . '<p align="center">n&uacute;mero de historial y expediente de estudiante</p>
				<p align="center"><font color="red"><b>"' . $_POST["hist"] . '"</font></b></p>';
		$clave=$_POST["hist"];
	}else{	
		$output=$output . '<p align="center">nombre de estudiante</p>
				<p align="center"><font color="red"><b>"' . $_POST["est"] . '"</font></b></p>';
		$clave=$_POST["est"];
	}
	$output=$output . '<p align="center"><input type="submit" value="Aceptar" name="Aceptar" style="font-weight:bold; color:black">&emsp;
	<input type="submit" name="Cancelar" value="Cancelar" style="font-weight:bold; color:black">
	<input type="hidden" name="clave" value="' . $clave . '"><input type="hidden" value="' . $_POST["opcion"] . '" name="opcion">
	</p></fieldset></p></form>';
}
else{
	$nombre=$_POST["clave"];//4911
	if(isset($_POST["Aceptar"])){
		if($_POST["opcion"]=="Historial"){
			$exp=substr($_POST["clave"], (strpos($_POST["clave"], ":")+1));
			$nexo=substr($_POST["clave"], (strpos($_POST["clave"], "-")+1));
			$long=strlen($nexo);$exp=ltrim($exp);
			$idh=substr($_POST["clave"], 0, -($long+2));
			$idh=ltrim($idh);
			$sqln="DELETE FROM notas_hist WHERE id_detalle_hist IN (SELECT id_detalle_hist FROM detalle_historico WHERE id_hist='$idh')";
			$sqld="DELETE FROM detalle_historico WHERE id_hist='$idh'";
			$sqlh="DELETE FROM historico WHERE id_hist='$idh' AND ficha_exp='$exp'";
			if ((mysqli_query($conexion, $sqln)) AND (mysqli_query($conexion, $sqld)) AND (mysqli_query($conexion, $sqlh))){
				$output= '<p><b>El historial de expedientes seleccionado se ha borrado satisfactoriamente</b>.</p> 
					<p>N&uacute;mero de historial:&nbsp;<b>' . $idh . '</b></p>
					<p>N&uacute;mero de expediente:&nbsp;<b>' . $exp . '</b></p><br><br>';
				$output=$output . '<p align="center">Si desea eliminar otro historial de expedientes&nbsp;<a href="http://localhost/drupal/oficina/historial_de_expedientes/baja_historial">pulse aqu&iacute;</a></p>';		
			}else{
				$output='<p><b>Error al eliminar el registro con N&uacute;mero de historial:&nbsp;<font color="red>' . $idh . 
					'</font> y de expediente:&nbsp;<font color="red>"' . $exp . '</font></b></p>';
				$output=$output . '<p>'. mysqli_error($conexion) . '</p>';
			}
		}else{//ESTUDIANTE
			$nombEst=substr($_POST["clave"], (strpos($_POST["clave"], ",")+1));
			$long=strlen($nombEst);$nombEst=ltrim($nombEst);
			$apelEst=substr($_POST["clave"], 0, -($long+1));
			$apelEst=ltrim($apelEst);
			$sqle="SELECT id_hist, id_est FROM historico WHERE id_est IN (SELECT id_est FROM estudiantes WHERE nombre='$nombEst' AND apellidos='$apelEst')";
			$rowe=mysqli_fetch_assoc(mysqli_query($conexion, $sqle));
			$idh=$rowe["id_hist"];$ide=$rowe["id_est"];
			$sqln="DELETE FROM notas_hist WHERE id_detalle_hist IN (SELECT id_detalle_hist FROM detalle_historico WHERE id_hist='$idh')";
			$sqld="DELETE FROM detalle_historico WHERE id_hist='$idh'";
			$sqlh="DELETE FROM historico WHERE id_hist='$idh' AND id_est='$ide'";
			if ((mysqli_query($conexion, $sqln)) AND (mysqli_query($conexion, $sqld)) AND (mysqli_query($conexion, $sqlh))){
				$output= '<p><b>El historial de expedientes seleccionado se ha borrado satisfactoriamente</b>.</p> 
					<p>Nombre de estudiante:&nbsp;<b>' . $nombEst . '</b></p>
					<p>Apellidos de estudiante:&nbsp;<b>' . $apelEst . '</b></p><br><br>';
				$output=$output . '<p align="center">Si desea eliminar otro historial de expedientes&nbsp;<a href="http://localhost/drupal/oficina/historial_de_expedientes/baja_historial">pulse aqu&iacute;</a></p>';		
			}else{
				$output='<p><b>Error al eliminar el registro con N&uacute;mero de historial:&nbsp;<font color="red>' . $idh . 
					'</font> para el estudiante:&nbsp;<font color="red>"' . $_POST["clave"] . '</font></b></p>';
				$output=$output . '<p>'. mysqli_error($conexion) . '</p>';
			}
		}
	}else{//CANCELAR
		$output='<br><br><b><p align="center">Operaci&oacute;n de eliminar un historial de expediente<br>';
		if ($_POST["opcion"]=="Historial"){
			$output=$output . 'con n&uacute;mero de historial y de expediente:<br>
						<font color="red">"' . $nombre . '"</font><br>ha sido cancelada</b>';
		}else{
			$output=$output . 'con nombre de estudiante:<br>
						<font color="red">"' . $nombre . '"</font><br>ha sido cancelada</b>';
		}

		$output=$output . '</p><br>
		<p align="center">Si desea volver al apartado "Baja Historial de Expediente"&nbsp;<a href="http://localhost/drupal/oficina/historial_de_expedientes/baja_historial">pulse aqu&iacute;</a></p>'; 
	}
	 
}

mysqli_close($conexion);
return $output;
}/************ end baja_historial **********/

/****************** modificar historial **************************/
function modificar_historial(){
$output="";
$conexion=bdexterna();
		
if (!$_POST || isset($_POST["Cancelar"])){
	$output='<form id="formModificarHistorial" action="" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formModificarHistorial">
	<legend align="left"><SPAN style="text-align:top">Modificar historial de expedientes</SPAN></legend>
        <br><br>
	<b><p align="center">
	Para modificar un historial de expedientes, se puede realizar seleccionando<br>
	el n&uacute;mero de historial con el n&uacute;mero de expediente o el nombre del estudiante.</p></b><br>
	<p align="center">Seleccionar una opci&oacute;n de la lista:&nbsp;<select name="opcion" required>
	<option></option><option>Historial</option><option>Estudiante</option></select></p>
	
	</fieldset></p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<input type="submit" value="Siguiente" name="Siguiente1" style="font-weight:bold; color:black"></p>
	</form>';
}elseif (isset($_POST["Siguiente1"])){
	$output='<form id="formModHistOpcion" action="" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formModHistOpcion">
	<legend align="left"><SPAN style="text-align:top">Registro a modificar</SPAN></legend>
        <br><br>';
	
	if ($_POST["opcion"]=="Historial"){
		$sqlh="SELECT * FROM historico WHERE id_est IN (SELECT id_est FROM estudiantes WHERE externo='1')";
		$resulth=mysqli_query($conexion, $sqlh);//4866
		$output=$output . '<p align="center">Seleccionar de la lista un n&uacute;mero de historial de expedientes para cambiar sus datos.</p>
		<p align="center"><label>N&uacute;mero de historial y de expediente:</label>
		<select name="hist" required size="8">';
		if (mysqli_num_rows($resulth) > 0){
			$cont=0;
			while($rowh=mysqli_fetch_assoc($resulth)){
				$output= $output . '<option>' . $rowh["ID_HIST"] . ' - expd:' . $rowh["FICHA_EXP"] . '</option>';
				$cont=$cont+1;
			}
			if ($cont>0){
				$error=false;
			}
		}else{
			$lista='Lista sin historial de estudiantes';$output=$output . '<option selected>' . $lista . '</option>';
			$error=true;
		}
		$output=$output . '</select></p>';
	}elseif ($_POST["opcion"]=="Estudiante"){
		$sqle="SELECT * FROM estudiantes WHERE externo='1' AND id_est IN (SELECT id_est FROM historico)";
		$resulte=mysqli_query($conexion, $sqle);//4880
		$output=$output . '<p align="center">Seleccionar de la lista un estudiante para cambiar los datos de su historial de expedientes.</p>
		<p align="center"><label>Nombre de estudiante:</label>
		<select name="est" required size="8">';
		if (mysqli_num_rows($resulte) > 0){
			$cont=0;
			while($rowe=mysqli_fetch_assoc($resulte)){
				$output= $output . '<option>' . $rowe["APELLIDOS"] . ', ' . $rowe["NOMBRE"]  . '</option>';
				$cont=$cont+1;
			}
			if ($cont>0){
				$error=false;
			}
		}else{
			$lista='Lista sin historial de estudiantes';$output=$output . '<option selected>' . $lista . '</option>';
			$error=true;
		}//4890
		$output=$output . '</select></p>';
	}

	$output=$output . '</fieldset></p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<input type="button" onclick="history.back()" value="Volver Atr&aacute;s" name="Volver Atras" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($error){
		$output=$output . '<input type="submit" value="Cambiar" name="Cambiar" style="font-weight:bold; color:black" disabled>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<input type="submit" value="Agregar" name="Agregar" style="font-weight:bold; color:black" disabled>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<input type="submit" value="Suprimir" name="Suprimir" style="font-weight:bold; color:black" disabled>';
	}else{
		$output=$output . '<input type="submit" value="Cambiar" name="Cambiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<input type="submit" value="Agregar" name="Agregar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<input type="submit" value="Suprimir" name="Suprimir" style="font-weight:bold; color:black">';
	}
	$output=$output . '</p><input type="hidden" value="' . $_POST["opcion"] . '" name="opcion">
	</form>';
}elseif (isset($_POST["Cambiar"]) || isset($_POST["Aceptar1"])){
	$output='<form id="formModHistCurso" action="" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formModHistCurso">
	<legend align="left"><SPAN style="text-align:top">Modificar Curso Acad&eacute;mico realizado por el Estudiante</SPAN></legend>
        <br><br>
	<p align="center"><SPAN style="text-align:top">Estudiante:&nbsp;</SPAN>';
	if ($_POST["opcion"]=="Historial"){
		if (isset($_POST["Aceptar1"])){//5060
			$clave=$_POST["clave"];
		}else{
			$clave=$_POST["hist"];
		}
		$exp=substr($clave, (strpos($clave, ":")+1));
		$nexo=substr($clave, (strpos($clave, "-")+1));
		$long=strlen($nexo);$exp=ltrim($exp);
		$idh=substr($clave, 0, -($long+2));
		$idh=ltrim($idh);
		$sqle="SELECT nombre, apellidos, id_est FROM estudiantes WHERE id_est IN (SELECT id_est FROM historico WHERE id_hist='$idh' AND ficha_exp='$exp')";
		$rowe=mysqli_fetch_assoc(mysqli_query($conexion, $sqle));
		$sqlu="SELECT * FROM detalle_historico WHERE id_hist='$idh'";
		//$resultu=mysqli_query($conexion, $sqlu);
		$nombEst= $rowe["nombre"];$apelEst=$rowe["apellidos"];$ide=$rowe["id_est"];	
	}else{
		if (isset($_POST["Aceptar1"])){//5060
			$clave=$_POST["clave"];
		}else{
			$clave=$_POST["est"];
		}
		$nombEst=substr($clave, (strpos($clave, ",")+1));
		$long=strlen($nombEst);$nombEst=ltrim($nombEst);
		$apelEst=substr($clave, 0, -($long+1));
		$apelEst=ltrim($apelEst);
		//$output=$nombEst . '*' . $apelEst . '*';
		$sqle="SELECT ficha_exp, id_est FROM estudiantes WHERE nombre='$nombEst' AND apellidos='$apelEst'";
		$rowe=mysqli_fetch_assoc(mysqli_query($conexion, $sqle));
		$exp= $rowe["ficha_exp"]; $ide=$rowe["id_est"];
		$sqlu="SELECT * FROM detalle_historico WHERE id_hist IN (SELECT id_hist FROM historico WHERE id_est='$ide')";
		//$resultu=mysqli_query($conexion, $sqlu);	
	}
	$output=$output . '<input type="text" name="Estudiante" value="' . $apelEst . ', ' . $nombEst . '" disabled size="60%"></p>
	<p align="center"><SPAN style="text-align:top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Expediente:&nbsp;</SPAN>
	<input type="number" name="Exp" value="' . $exp . '" disabled></p>
	<hr size="10" width="98%"><br>
	<p align="center"><label>Seleccionar de la lista una Unidad:</label><select name="Unidad" required size="4">';
	$resultu=mysqli_query($conexion, $sqlu);	
	if (mysqli_num_rows($resultu) > 0){
			$cont=0;
			while($rowu=mysqli_fetch_assoc($resultu)){
				$output= $output . '<option>' . $rowu["NOMB_GRUPO"] . ' - ' . $rowu["MATRICULA"] . '</option>';
				$cont=$cont+1;
			}
			if ($cont>0){
				$error=false;
			}
		}else{
			$lista='Lista sin unidades en historial';$output=$output . '<option selected>' . $lista . '</option>';
			$error=true;
		}//4890
	$output=$output . '</select></p>
	</fieldset></p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($error){
		$output=$output . '<input type="submit" value="Siguiente" name="Siguiente2" style="font-weight:bold; color:black" disabled>';
	}else{
		$output=$output . '<input type="submit" value="Siguiente" name="Siguiente2" style="font-weight:bold; color:black">';
	}
	$output=$output . '</p>
	<input type="hidden" value="' . $_POST["opcion"] . '" name="opcion"><input type="hidden" value="' . $ide . '" name="Ide">
	<input type="hidden" name="est" value="' . $apelEst . ', ' . $nombEst . '"><input type="hidden" value="' . $exp . '" name="Exp">
	<input type="hidden" value="' . $clave . '" name="clave">
	</form>';
}elseif (isset($_POST["Siguiente2"])){
	$Mat=substr($_POST["Unidad"], (strpos($_POST["Unidad"], "-")+1));
	$nexo=substr($_POST["Unidad"], (strpos($_POST["Unidad"], "-")+1));
	$long=strlen($nexo);$Mat=ltrim($Mat);
	$Unidad=substr($_POST["Unidad"], 0, -($long+2));
	$Unidad=ltrim($Unidad);
	
	$ide=$_POST["Ide"];$nombG=$Unidad;
	$output='<form id="formModHistCurso2" action="" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formModHistCurso2">
	<legend align="left"><SPAN style="text-align:top">Modificar Datos de Curso Acad&eacute;mico seleccionado</SPAN></legend>
        <br><br>
	<p align="center"><SPAN style="text-align:top">Estudiante:&nbsp;</SPAN>
	<input type="text" name="est" value="' . $_POST["est"] . '" disabled size="60%"></p>
	<p align="center"><SPAN style="text-align:top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Expediente:&nbsp;</SPAN>
	<input type="number" name="Exp" value="' . $_POST["Exp"] . '" disabled></p>
	<hr size="10" width="98%"><br>
	<p align="center"><b>Nombre de Unidad:&nbsp;</b>
	<input type="text" style="color:blue" name="Unidad" value="' . $Unidad . '" size="50%"></p>
	<p align="center"><label>Seleccionar curso:</label><select name="Curso" style="color:blue" size="4">';
	$sqlu="SELECT * FROM detalle_historico WHERE nomb_grupo='$nombG' AND matricula='$Mat' AND id_hist IN (SELECT id_hist FROM historico WHERE id_est='$ide')";
	$rowu=mysqli_fetch_assoc(mysqli_query($conexion, $sqlu));
	$idG=$rowu["ID_CURSO"];
	
	$sqlc="SELECT * FROM cursos";
	$resultc=mysqli_query($conexion, $sqlc);	
	if (mysqli_num_rows($resultc) > 0){
		while($rowc=mysqli_fetch_assoc($resultc)){
			$cont=0;
			if ($rowc["ID_CURSO"]==$rowu["ID_CURSO"]){
				$output= $output . '<option selected>' . $rowc["NOMBRE"] . '</option>';
			}else{
				$output= $output . '<option>' . $rowc["NOMBRE"] . '</option>';
			}
			$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}else{
		$lista='Lista sin cursos';$output=$output . '<option selected>' . $lista . '</option>';
		$error=true;
	}
	$output=$output . '</select><br><br>
	<label>Tipo de Matr&iacute;cula:</label><select name="mat" style="color:blue" size="3">';
	switch($rowu["MATRICULA"]){
		case "1":
			$output=$output . '<option selected>Primera</option><option>Segunda</option><option>Tercera o sucesivas</option>';
			break;
		case "2":
			$output=$output . '<option>Primera</option><option selected>Segunda</option><option>Tercera o sucesivas</option>';
			break;
		case "3":
			$output=$output . '<option>Primera</option><option>Segunda</option><option selected>Tercera o sucesivas</option>';
			break;
	}
	
	$output=$output . '</select></p>
	<p align="center"><b>A&ntildeo acad&eacutemico:</b>&nbsp;
	<input type="text" style="color:blue" name="AnoA" size="10%" maxlength="4" value="' . $rowu["AÑO_A"] . '">
	<p align="center"><b>Centro:&nbsp;</b>
	<input type="text" name="Centro" style="color:blue" value="' . $rowu["CENTRO"] . '" size="50%"></p>
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>Observaciones:</b>
	&nbsp;<p align="center"><textarea name="Observ" style="color:blue" rows="4" cols="95">' . $rowu["OBSERVACIONES"] . '</textarea></p>
	<p align="center"><b>Modificar Notas de Unidad:</b>&ensp;<input type="radio" name="notasMod" value="1">&ensp;S&iacute;&ensp;
	<input type="radio" name="notasMod" value="0" checked>&ensp;No</p>
	</fieldset></p>';
	if ($error){
		$output=$output . '<input type="submit" value="Grabar" name="Grabar" style="font-weight:bold; color:black" disabled>';
	}else{
		$output=$output . '<input type="submit" value="Grabar" name="Grabar" style="font-weight:bold; color:black">';
	}
	$output=$output . '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<input type="submit" value="Cancelar" name="Cancelar" style="font-weight:bold; color:black"></p>
	<input type="hidden" value="' . $_POST["Ide"] . '" name="Ide"><input type="hidden" value="' . $rowu["ID_DETALLE_HIST"] . '" name="IdDetH">
	<input type="hidden" name="est" value="' . $_POST["est"] . '"><input type="hidden" value="' . $_POST["Exp"] . '" name="Exp">
	<input type="hidden" value="' . $_POST["opcion"] . '" name="opcion"><input type="hidden" value="' . $_POST["clave"] . '" name="clave">
	</form>';
	
}elseif ((isset($_POST["Grabar"])) || (isset($_POST["Continuar"])) || (isset($_POST["Terminar"]))){	
	$nombEst=substr($_POST["est"], (strpos($_POST["est"], ",")+1));
	$long=strlen($nombEst);$nombEst=ltrim($nombEst);
	$apelEst=substr($_POST["est"], 0, -($long+1));
	$apelEst=ltrim($apelEst);
$existeNotas="true"; $error=false;
	$IdDetH=$_POST["IdDetH"];
	$nombreC=$_POST["Curso"];
	if (isset($_POST["Grabar"])) {
		$sqlc="SELECT id_curso FROM cursos WHERE nombre='$nombreC'";
		$rowc=mysqli_fetch_assoc(mysqli_query($conexion, $sqlc));
		switch($_POST["mat"]){
			case "Primera":
				$mat=1;
				break;
			case "Segunda":
				$mat=2;
				break;
			case "Tercera o sucesivas":
				$mat=3;
				break;
		}
		$Ide= $_POST["Ide"];$Exp=$_POST["Exp"];$tipoMat=$_POST["mat"];//5205
		$nombreG=$_POST["Unidad"];$idC=$rowc["id_curso"];$ano=$_POST["AnoA"];$centro=$_POST["Centro"];$obs=$_POST["Observ"];
		//Grabar unidad
		$sqlu="UPDATE detalle_historico SET ID_CURSO='$idC', NOMB_GRUPO='$nombreG', AÑO_A='$ano', MATRICULA='$mat', CENTRO='$centro', OBSERVACIONES='$obs' 
		WHERE ID_DETALLE_HIST='$IdDetH'";
		$resultu=mysqli_query($conexion, $sqlu);
		//COMPROBAR QUE EXISTEN NOTAS
		$sqln="SELECT id_detalle_hist FROM notas_hist WHERE id_detalle_hist='$IdDetH'";
		$resultn=mysqli_query($conexion, $sqln);
		$contNotas=mysqli_num_rows($resultn);//5215
		if ($contNotas==0){
			$existeNotas="false";	
		}
	}else{
		$resultu=1;
		$_POST["notasMod"]="1";
		$tipoMat=$_POST["tipoMat"];//5222
	}
	if (($resultu) AND ($existeNotas=="true")){
		if ($_POST["notasMod"]=="0"){
			$output='<form id="formModHistConfirm1" action="" method="post" accept-charset="UTF-8">
			<p>
			<fieldset form="formModHistConfirm1">
			<legend align="left"><SPAN style="text-align:top">Actualizaci&oacute;n del Historial de Expediente</SPAN></legend>
        		<br><br>
			<p align="center">Los datos del curso acad&eacute;mico <b>"' . $_POST["Unidad"] . '"</b></p>
			<p align="center">con grado de matr&iacute;cula de <b>"' . $_POST["mat"] . '"</b></p> 
			<p align="center">para del estudiante <b>"' . $_POST["est"] . '"</b> se han actualizado correctamente.</p><br>
			<p align="center">Para actualizar otro curso acad&eacute;mico, pulsar bot&oacute;n "Aceptar",</p> 
			<p align="center">en caso contrario, pulsar el bot&oacute;n "Cancelar".</p><br>
			<p align="center"><input type="submit" value="Aceptar" name="Aceptar1" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			<input type="submit" value="Cancelar" name="Cancelar" style="font-weight:bold; color:black"></p>
			</fieldset>
			<input type="hidden" value="' . $_POST["opcion"] . '" name="opcion"><input type="hidden" value="' . $_POST["clave"] . '" name="clave">
			</p>
			</form>';
		}
		if ((isset($_POST["Continuar"])) || (isset($_POST["Terminar"]))){
				$nomb=$_POST["Conv"];
				$sqlc="SELECT id_conv FROM convocatorias WHERE nombre='$nomb'";
				$rowc=mysqli_fetch_assoc(mysqli_query($conexion, $sqlc));		
				$idconv=$rowc["id_conv"];$output=$_POST["ContMat"] . '+++' . $idconv . '+++' . $nomb . '++++' . $_POST["Conv"] . '<BR>';
				//GRABAR DATOS notas
				$contMat=$_POST["ContMat"];
				for ($i=1;$i<=$contMat;$i++){
					$mat=$_POST["idmat$i"];
					$notn=$_POST["notan$i"];
					$notv=$_POST["notav$i"];
					$_POST["notav4"];				
					$sql="UPDATE notas_hist SET NOTAN='$notn', NOTAV='$notv' WHERE ID_DETALLE_HIST='$IdDetH' AND ID_CONV='$idconv' AND ID_MATERIA='$mat'";
					$result=mysqli_query($conexion, $sql);
					if ($result){//6105
						$error=false;
					}else{
						$error=true;
						$output='<form id="formModHistError2" action="" method="post" accept-cahrset="UFT-8">
						<p>
						<fieldset form="formModHistError2">
						<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend>
        					<br><br>
						<p align="center">Se ha producido un error al grabar las calificaciones </p>
						<p align="center">del curso acad&eacute;mico <b>"' . $_POST["Unidad"] . '"</b></p> 
						<p align="center">de grado de matr&iacute;cula de <b>"' . $tipoMat . '"</b></p>
						<p align="center">para el estudiante <b>"' . $_POST["est"] . '"</b> n.</p><br>
						<p align="center">Para volver actualizar, pulsar bot&oacute;n "Aceptar",</p> 
						<p align="center">en caso contrario, pulsar el bot&oacute;n "Cancelar".</p><br>
						<p align="center"><input type="submit" value="Aceptar" name="Aceptar1" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
						<input type="submit" value="Cancelar" name="Cancelar" style="font-weight:bold; color:black"></p>
						<input type="hidden" value="' . $_POST["opcion"] . '" name="opcion"><input type="hidden" value="' . $_POST["clave"] . '" name="clave">
						</p>
						</form>';
					}//if	
				}//for
				if (isset($_POST["Terminar"])){//5268
					$output='<form id="formModHistConfirm2" action="" method="post" accept-cahrset="UFT-8">
					<p>
					<fieldset form="formModHistConfirm2">
					<legend align="left"><SPAN style="text-align:top">Actualizadas las Calificaciones de las Asignaturas</SPAN></legend>
        				<br><br>
					<p align="center">Las calificaciones del curso acad&eacute;mico <b>"' . $_POST["Unidad"] . '"</b></p> 
					<p align="center">de grado de matr&iacute;cula de <b>"' . $tipoMat . '"</b></p>
					<p align="center">para el estudiante <b>"' . $_POST["est"] . '"</b> se han actualizado correctamente.</p><br>
					<p align="center">Para actualizar otro curso acad&eacute;mico, pulsar bot&oacute;n "Aceptar",</p> 
					<p align="center">en caso contrario, pulsar el bot&oacute;n "Cancelar".</p><br>
					<p align="center"><input type="submit" value="Aceptar" name="Aceptar1" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
					<input type="submit" value="Cancelar" name="Cancelar" style="font-weight:bold; color:black"></p>
					<input type="hidden" value="' . $_POST["opcion"] . '" name="opcion"><input type="hidden" value="' . $_POST["clave"] . '" name="clave">
					</p>
					</form>';
				}
				
		}//end_if $contNotas .
		if (((isset($_POST["Continuar"])) || ($_POST["notasMod"]=="1")) && !(isset($_POST["Terminar"])) && ($error==0)){
			$sql="SELECT num_conv FROM ciclos WHERE id_ciclo IN (SELECT id_ciclo FROM cursos WHERE nombre='$nombreC')";
			$result=mysqli_query($conexion, $sql);
			$conv=mysqli_fetch_assoc($result);//5305
			$output= $error . '<form id="formModHistMaterias" action="" method="post" accept-charset="UTF-8">
			<p>
			<fieldset form="formModHistMaterias">
			<legend align="left"><SPAN style="text-align:top">Modificar Calificaciones de las Asignaturas impartidas</SPAN></legend>
        		<br><br>
			<p align="center">Estudiante:&nbsp;<input type="text" name="est" value="' . $_POST["est"] . '" disabled size="60%"></p>
			<hr size="10" width="98%"><br>
			<p align="center">Unidad:&nbsp;<input type="text" name="Unidad" value="' . $_POST["Unidad"] . '" size="50%" disabled></p>
			<p align="center">Curso:&nbsp;<input type="text" name="Curso" value="' . $_POST["Curso"] . '" size="20%" disabled></p>
			<hr size="10" width="98%"><br>';
			
			//LEER DATOS ID_DET_HIST
			if (isset($_POST["Conv"]) AND isset($_POST["cadena"])){
				$cadena= $_POST["cadena"] . "','" . $_POST["Conv"];
				$nomb=$_POST["Conv"];
			}elseif ($conv["num_conv"]==4){
				$cadena='Extraordinaria';
			}else{
				$cadena="";
			}
			//$sqlc="SELECT TOP 1 * FROM convocatorias WHERE NOT IN ('" . $cadena . "')";
			$sqlc="SELECT * FROM convocatorias WHERE nombre NOT IN ('" . $cadena . "')";	
			$resultc=mysqli_query($conexion, $sqlc);
			$rowc=mysqli_fetch_assoc($resultc);	
			$output=$output . '<p align="center">Convocatoria:&nbsp;<input type="text" name="Convo" value="' . $rowc["NOMBRE"] . '" disabled><input type="hidden" name="Conv" value="' . $rowc["NOMBRE"] . '"></p>';
			$i=$rowc["ID_CONV"];//5261
			$sqln="SELECT * FROM notas_hist WHERE ID_DETALLE_HIST='$IdDetH' AND ID_CONV='$i'";
			$resultn=mysqli_query($conexion, $sqln);
			
			$output=$output . '<table border="2" style="color:black" width="50%">
			<tr valign="middle" ><th><font size="3">Asignaturas</font></th><th><font size="3">Nota Num&eacute;rica</font></th><th><font size="3">Nota Valorativa</font></th></tr>';
			$sqlm="SELECT nombre, id_materia FROM materias WHERE id_materia IN (SELECT id_materia FROM asignar_materia WHERE id_curso IN (SELECT id_curso FROM cursos WHERE nombre='$nombreC'))";
			$resultm=mysqli_query($conexion, $sqlm);
			$contMat=mysqli_num_rows($resultm);
			if ($contMat > 0){
				$k=0;
				while(($rowm=mysqli_fetch_assoc($resultm)) AND ($rown=mysqli_fetch_assoc($resultn))){
					$j=0;
					$k=$k+1;
					$output= $output . '<tr valign="middle"><td><font color="blue" size="2">' . $rowm["nombre"] . '</font>
					<input type="hidden" name="idmat' . $k . '" value="' . $rowm["id_materia"] . '"></td>
					<td><input type="number" onkeypress="if (event.keyConde < 45 || event.keyCode > 57) event.returnValue = false;" style="color:blue" name="notan' . $k .'" size="5%" value="' . $rown["NOTAN"] . '"></td>
					<td><input type="text" style="color:blue" name="notav' . $k .'" value="' . $rown["NOTAV"] . '"></td></tr>';
				}
			}
			$output=$output . '</table><br>
			</fieldset></p>';
			if (mysqli_num_rows($resultc) == 1){
				$output=$output . '<p><input type="submit" value="Continuar" name="Continuar" style="font-weight:bold; color:black" disabled>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
				<input type="submit" value="Terminar" name="Terminar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
			}else{
				$output=$output . '<p><input type="submit" value="Continuar" name="Continuar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
				<input type="submit" value="Terminar" name="Terminar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
			}
			$output=$output . '<input type="submit" value="Cancelar" name="Cancelar" style="font-weight:bold; color:black"></p>
			<input type="hidden" value="' . $_POST["opcion"] . '" name="opcion"><input type="hidden" value="' . $_POST["clave"] . '" name="clave">
			<input type="hidden" value="' . $IdDetH . '" name="IdDetH"><input type="hidden" value="' . $_POST["Unidad"] . '" name="Unidad">
			<input type="hidden" value="' . $_POST["Curso"] . '" name="Curso"><input type="hidden" value="' . $contMat . '" name="ContMat">
			<input type="hidden" value="' . $_POST["est"] . '" name="est"><input type="hidden" value="' . $cadena . '" name="cadena">
			<input type="hidden" value="' . $tipoMat . '" name="tipoMat"></p>
			</form>';
		}
	}elseif ($existeNotas=="false"){//5365
		$output='<form id="formModHistSinNotas" action="" method="post" accept-charset="UTF-8">
			<p>
			<fieldset form="formModHistSinNotas">
			<legend align="left"><SPAN style="text-align:top">Error en Modificar Asignaturas</SPAN></legend>
        		<br><br>
			<p align="center">El curso acad&eacute;mico seleccionado&nbsp;<b>' . $_POST["Unidad"] . '</b></p>
			<p align="center">con grado de matr&iacute;cula de <b>"' . $_POST["mat"] . '"</b></p>
			<p align="center">para el estudiante&nbsp;<b>' . $_POST["est"] . '</b></p>
			<p align="center">no tiene asingado asignaturas para realizar modificaciones.</p><br>
			<p align="center">Pulsar el bot&oacute;n Aceptar, para seleccionar otra curso, o pulsar Cancelar para salir.</p>
			<p align="center"><input type="submit" value="Aceptar" name="Aceptar1" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			<input type="submit" value="Cancelar" name="Cancelar" style="font-weight:bold; color:black"></p>
			</fieldset></p>
			<input type="hidden" value="' . $_POST["opcion"] . '" name="opcion"><input type="hidden" value="' . $_POST["clave"] . '" name="clave">
			</form>';
	}else{
		$output='<p align="center"><b>Error al realizar la actualizaci&oacute;n de los datos del historial de expediente
			para el estudiante&nbsp;<font color="red">"' . $_POST["est"] . '"</font></b></p>
			<br>
			<p align="center">'. mysqli_error($conexion) . '</p>
			<br>
			<p align="center">Si desea volver a modificar el historial de expediente&nbsp;<a href="http://localhost/drupal/oficina/historial_de_expedientes/modificar_historial">pulse aqu&iacute;</a></p>';	
	}
}elseif ((isset($_POST["Suprimir"])) || (isset($_POST["Aceptar3"]))){
	$output='<form id="formModHistSuprimir" action="" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formModHistSuprimir">
	<legend align="left"><SPAN style="text-align:top">Eliminar un Curso Acad&eacute;mico</SPAN></legend>
        <br><br>
	<p align="center"><SPAN style="text-align:top">Estudiante:&nbsp;</SPAN>';
	if ($_POST["opcion"]=="Historial"){
		if (isset($_POST["Aceptar3"])){//5060
			$clave=$_POST["clave"];
		}else{
			$clave=$_POST["hist"];
		}
		$exp=substr($clave, (strpos($clave, ":")+1));
		$nexo=substr($clave, (strpos($clave, "-")+1));
		$long=strlen($nexo);$exp=ltrim($exp);
		$idh=substr($clave, 0, -($long+2));
		$idh=ltrim($idh);
		$sqle="SELECT nombre, apellidos, id_est FROM estudiantes WHERE id_est IN (SELECT id_est FROM historico WHERE id_hist='$idh' AND ficha_exp='$exp')";
		$rowe=mysqli_fetch_assoc(mysqli_query($conexion, $sqle));
		$sqlu="SELECT * FROM detalle_historico WHERE id_hist='$idh'";
		//$resultu=mysqli_query($conexion, $sqlu);
		$nombEst= $rowe["nombre"];$apelEst=$rowe["apellidos"];$ide=$rowe["id_est"];	
	}else{
		if (isset($_POST["Aceptar3"])){//5060
			$clave=$_POST["clave"];
		}else{
			$clave=$_POST["est"];
		}
		$nombEst=substr($clave, (strpos($clave, ",")+1));
		$long=strlen($nombEst);$nombEst=ltrim($nombEst);
		$apelEst=substr($clave, 0, -($long+1));
		$apelEst=ltrim($apelEst);
		//$output=$nombEst . '*' . $apelEst . '*';
		$sqle="SELECT ficha_exp, id_est FROM estudiantes WHERE nombre='$nombEst' AND apellidos='$apelEst'";
		$rowe=mysqli_fetch_assoc(mysqli_query($conexion, $sqle));
		$exp= $rowe["ficha_exp"]; $ide=$rowe["id_est"];
		$sqlu="SELECT * FROM detalle_historico WHERE id_hist IN (SELECT id_hist FROM historico WHERE id_est='$ide')";	
	}
	$output=$output . '<input type="text" name="Estudiante" value="' . $apelEst . ', ' . $nombEst . '" disabled size="60%"></p>
	<p align="center"><SPAN style="text-align:top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Expediente:&nbsp;</SPAN>
	<input type="number" name="Exp" value="' . $exp . '" disabled></p>
	<hr size="10" width="98%"><br>
	<p align="center"><label>Seleccionar de la lista una Unidad:</label><select name="Unidad" required size="4">';
	$resultu=mysqli_query($conexion, $sqlu);	
	if (mysqli_num_rows($resultu) > 0){
			$cont=0;
			while($rowu=mysqli_fetch_assoc($resultu)){
				$output= $output . '<option>' . $rowu["NOMB_GRUPO"] . ' - ' . $rowu["MATRICULA"] . '</option>';
				$cont=$cont+1;
			}
			if ($cont>0){
				$error=false;
			}
		}else{
			$lista='Lista sin unidades en historial';$output=$output . '<option selected>' . $lista . '</option>';
			$error=true;
		}//4890
	$output=$output . '</select></p>
	</fieldset></p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($error){
		$output=$output . '<input type="submit" value="Siguiente" name="Siguiente4" style="font-weight:bold; color:black" disabled>';
	}else{
		$output=$output . '<input type="submit" value="Siguiente" name="Siguiente4" style="font-weight:bold; color:black">';
	}
	$output=$output . '</p>
	<input type="hidden" value="' . $_POST["opcion"] . '" name="opcion"><input type="hidden" value="' . $ide . '" name="Ide">
	<input type="hidden" name="est" value="' . $apelEst . ', ' . $nombEst . '"><input type="hidden" value="' . $exp . '" name="Exp">
	<input type="hidden" value="' . $clave . '" name="clave">
	</form>';

}elseif ((isset($_POST["Siguiente4"]))){
	$Mat=substr($_POST["Unidad"], (strpos($_POST["Unidad"], "-")+1));
	$nexo=substr($_POST["Unidad"], (strpos($_POST["Unidad"], "-")+1));
	$long=strlen($nexo);$Mat=ltrim($Mat);
	$Unidad=substr($_POST["Unidad"], 0, -($long+2));
	$Unidad=ltrim($Unidad);//5425
	switch($Mat){
			case "1":
				$mat="Primera";//5459
				break;
			case "2":
				$mat="Segunda";//5462
				break;
			case "3":
				$mat="Tercera o sucesivas";
				break;
		} 
	$output='<form id="formModHistSupConfirmar" action="" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formModHistSupConfirmar">
	<legend align="left"><SPAN style="text-align:top">Confirmar Suprimir Curso Acad&eacute;mico</SPAN></legend>
        <br><br><p align="center">Seguro que desea eliminar la Unidad seleccionada</p>
	<p align="center"><font color="red"><b>"' . $Unidad . '"</font></b></p>
	<p align="center">correspondiente al grado de matr&iacute;cula de &nbsp;<font color="red"><b>"' . $mat . '"</font></b></p>
	<p align="center">&nbsp;con las calificaciones del estudiante</p>
	<p align="center"><font color="red"><b>"' . $_POST["est"] . '"</font></b></p>
	<p align="center"><input type="submit" value="Aceptar" name="Aceptar4" style="font-weight:bold; color:black">&emsp;
	<input type="submit" name="Aceptar3" value="Cancelar" style="font-weight:bold; color:black">
	<input type="hidden" name="clave" value="' . $_POST["clave"]. '"><input type="hidden" value="' . $_POST["opcion"] . '" name="opcion">
	<input type="hidden" name="Unidad" value="' . $Unidad . '"><input type="hidden" name="Mat" value="' . $Mat . '">
	<input type="hidden" name="mat" value="' . $mat . '">
	</p>
	</fieldset></p></form>';
}elseif (isset($_POST["Aceptar4"])){
	$output='<form id="formModHistSupConf" action="" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formModHistSupConf">
	<legend align="left"><SPAN style="text-align:top">Actualizado Historial de Expedientes</SPAN></legend>
        <br><br>';
	$nombU=$_POST["Unidad"];$tipoMat=$_POST["Mat"];
	if($_POST["opcion"]=="Historial"){
		$exp=substr($_POST["clave"], (strpos($_POST["clave"], ":")+1));
		$nexo=substr($_POST["clave"], (strpos($_POST["clave"], "-")+1));
		$long=strlen($nexo);$exp=ltrim($exp);
		$idh=substr($_POST["clave"], 0, -($long+2));
		$idh=ltrim($idh);
		$sql="SELECT  id_detalle_hist FROM detalle_historico WHERE id_hist='$idh' AND nomb_grupo='$nombU'";
		$row=mysqli_fetch_assoc(mysqli_query($conexion, $sql));
		$id_det_h=$row["id_detalle_hist"];
		$sqln="DELETE FROM notas_hist WHERE id_detalle_hist IN (SELECT id_detalle_hist FROM detalle_historico WHERE id_hist='$idh' AND nomb_grupo='$nombU' AND matricula='$tipoMat')";
		$sqld="DELETE FROM detalle_historico WHERE id_hist='$idh' AND nomb_grupo='$nombU' AND matricula='$tipoMat'";
		
		if ((mysqli_query($conexion, $sqln)) AND (mysqli_query($conexion, $sqld))){
			$output= $output . '<p align="center"><b>La unidad &nbsp;"' . $nombU . '"</p>
				<p align="center">con el grado de matr&iacute;cula de&nbsp;"' . $_POST["mat"] . '</p>
				<p align="center">se ha borrado del historial</b>.</p> 
				<p align="center">N&uacute;mero de historial:&nbsp;<b>' . $idh . '</b></p>
				<p align="center">N&uacute;mero de expediente:&nbsp;<b>' . $exp . '</b></p><br>';
			//$output=$output . '<p align="center">Si desea eliminar otra unidad&nbsp;<a href="http://localhost/drupal/oficina/historial_de_expedientes/modificar_historial">pulse aqu&iacute;</a></p>';		
		}else{
			$output=$id_det_h . '<p><b>Error al eliminar el registro con N&uacute;mero de historial:&nbsp;<font color="red">' . $idh . '</font>
				 y de expediente:&nbsp;<font color="red">' . $exp . '</font></b></p>';
			$output=$output . '<p>'. mysqli_error($conexion) . '</p>';
		}
	}else{//ESTUDIANTE
		$nombEst=substr($_POST["clave"], (strpos($_POST["clave"], ",")+1));
		$long=strlen($nombEst);$nombEst=ltrim($nombEst);
		$apelEst=substr($_POST["clave"], 0, -($long+1));
		$apelEst=ltrim($apelEst);
		$sqle="SELECT id_hist, id_est FROM historico WHERE id_est IN (SELECT id_est FROM estudiantes WHERE nombre='$nombEst' AND apellidos='$apelEst')";
		$rowe=mysqli_fetch_assoc(mysqli_query($conexion, $sqle));
		$idh=$rowe["id_hist"];$ide=$rowe["id_est"];
		$sqln="DELETE FROM notas_hist WHERE id_detalle_hist IN (SELECT id_detalle_hist FROM detalle_historico WHERE id_hist='$idh' AND nomb_grupo='$nombU' AND matricula='$tipoMat')";
		$sqld="DELETE FROM detalle_historico WHERE id_hist='$idh' AND nomb_grupo='$nombU' AND matricula='$tipoMat'";
		
		if ((mysqli_query($conexion, $sqln)) AND (mysqli_query($conexion, $sqld))){
			$output=$output . '<p align="center"><b>La unidad &nbsp;"' . $nombU . '"&nbsp;con el grado </p>
				<p align="center">de matr&iacute;cula de&nbsp;"' . $_POST["mat"] . '"&nbsp;se ha borrado del historial</b>.</p> 
				<p align="center">Nombre de estudiante:&nbsp;<b>' . $nombEst . '</b></p>
				<p align="center">Apellidos de estudiante:&nbsp;<b>' . $apelEst . '</b></p><br>';
			//$output=$output . '<p align="center">Si desea eliminar otra unidad&nbsp;<a href="http://localhost/drupal/oficina/historial_de_expedientes/modificar_historial">pulse aqu&iacute;</a></p>';		
		}else{
			$output='<p><b>Error al eliminar el registro con N&uacute;mero de historial:&nbsp;<font color="red">' . $idh . 
				'</font> para el estudiante:&nbsp;<font color="red">' . $_POST["clave"] . '</font></b></p>';
			$output=$output . '<p>'. mysqli_error($conexion) . '</p>';
		}
	}
	$output=$output . '<p align="center">Para volver a eliminar otra unidad del historial de expedientes,</p>
	<p align="center">pulsar el bot&oacute;n Aceptar, en caso contrario, el bot&oacute;n Cancelar.</p>
	<p align="center"><input type="submit" value="Aceptar" name="Aceptar3" style="font-weight:bold; color:black">&emsp;
	<input type="submit" name="Cancelar" value="Cancelar" style="font-weight:bold; color:black">
	<input type="hidden" name="clave" value="' . $_POST["clave"]. '"><input type="hidden" value="' . $_POST["opcion"] . '" name="opcion">
	</p>
	</fieldset></p></form>';

}elseif ((isset($_POST["Agregar"])) || (isset($_POST["Aceptar2"]))){
	$output='<form id="formModHistAgregar" action="" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formModHistAgregar">
	<legend align="left"><SPAN style="text-align:top">Agregar un Curso Acad&eacute;mico realizado por el Estudiante</SPAN></legend>
        <br><br>
	<p align="center"><SPAN style="text-align:top">Estudiante:&nbsp;</SPAN>';
	if ($_POST["opcion"]=="Historial"){
		if (isset($_POST["Aceptar2"])){//5060
			$clave=$_POST["clave"];
		}else{
			$clave=$_POST["hist"];
		}
		$exp=substr($clave, (strpos($clave, ":")+1));
		$nexo=substr($clave, (strpos($clave, "-")+1));
		$long=strlen($nexo);$exp=ltrim($exp);
		$idh=substr($clave, 0, -($long+2));
		$idh=ltrim($idh);
		$sqle="SELECT nombre, apellidos, id_est FROM estudiantes WHERE id_est IN (SELECT id_est FROM historico WHERE id_hist='$idh' AND ficha_exp='$exp')";
		$rowe=mysqli_fetch_assoc(mysqli_query($conexion, $sqle));
		$sqlu="SELECT * FROM detalle_historico WHERE id_hist='$idh'";
		$nombEst= $rowe["nombre"];$apelEst=$rowe["apellidos"];$ide=$rowe["id_est"];	
	}else{
		if (isset($_POST["Aceptar2"])){//5060
			$clave=$_POST["clave"];
		}else{
			$clave=$_POST["est"];
		}
		$nombEst=substr($clave, (strpos($clave, ",")+1));
		$long=strlen($nombEst);$nombEst=ltrim($nombEst);
		$apelEst=substr($clave, 0, -($long+1));
		$apelEst=ltrim($apelEst);
		//$output=$nombEst . '*' . $apelEst . '*';
		$sqle="SELECT ficha_exp, id_est FROM estudiantes WHERE nombre='$nombEst' AND apellidos='$apelEst'";
		$rowe=mysqli_fetch_assoc(mysqli_query($conexion, $sqle));
		$exp= $rowe["ficha_exp"]; $ide=$rowe["id_est"];
		$sqlu="SELECT * FROM detalle_historico WHERE id_hist IN (SELECT id_hist FROM historico WHERE id_est='$ide')";	
	}
	$output=$output . '<input type="text" name="Estudiante" value="' . $apelEst . ', ' . $nombEst . '" disabled size="60%"></p>
	<p align="center"><SPAN style="text-align:top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Expediente:&nbsp;</SPAN>
	<input type="number" name="Exp" value="' . $exp . '" disabled></p>
	<hr size="10" width="98%"><br>
	<p align="center">Nombre de Unidad:&nbsp;<input type="text" name="Unidad"  style="color:blue" size="50%"required></p>
	<p>&emsp;&emsp;&emsp;&emsp;&emsp;Seleccionar el curso acad&eacutemico de la lista:</p>
	<p align="center"><select name="CursoA" size="5" required>';

	$sql="SELECT * FROM cursos";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result) > 0){
		$cont=0;
		while($rowC=mysqli_fetch_assoc($result)){
			$output= $output . '<option>' . $rowC["NOMBRE"] . '</option>';
			$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$lista='Lista sin cursos'; $output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}
	
	$output=$output . '</select></p>
	<p align="center">A&ntildeo acad&eacutemico:&nbsp;<input type="text" style="color:blue" name="AnoA" size="10%" maxlength="4" required>
	&emsp;&emsp;&emsp;&emsp;Tipo matr&iacute;cula:&nbsp;<select style="color:blue" name="Mat" required>
	<option selected>Primera</option><option>Segunda</option><option>Tercera o sucesivas</option></select></p>
	<p align="center">Centro de estudios:&nbsp;<input type="text" style="color:blue" name="Centro" size="65%" required></p>
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Observaciones:&nbsp;<p align="center"><textarea name="Observaciones" style="color:blue" rows="4" cols="95"></textarea></p>
	</fieldset></p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($error){
		$output=$output . '<input type="submit" value="Siguiente" name="Siguiente3" style="font-weight:bold; color:black" disabled>';
	}else{
		$output=$output . '<input type="submit" value="Siguiente" name="Siguiente3" style="font-weight:bold; color:black">';
	}
	$output=$output . '</p>
	<input type="hidden" value="' . $_POST["opcion"] . '" name="opcion"><input type="hidden" value="' . $ide . '" name="Ide">
	<input type="hidden" name="Estudiante" value="' . $apelEst . ', ' . $nombEst . '"><input type="hidden" value="' . $exp . '" name="Exp">
	<input type="hidden" value="' . $clave . '" name="clave">
	</form>';//5436
}elseif ((isset($_POST["Siguiente3"])) || (isset($_POST["GrabarA"])) || (isset($_POST["Finalizar"])) || isset($_POST["Continuar1"])){
	if (!(isset($_POST["Finalizar"]))){
		$finalizar=false;
		$curso=$_POST["CursoA"];//NOMBRE CURSO
		
	}
	$error=false;$errorn=false;
	if (isset($_POST["Siguiente3"])){
		switch($_POST["Mat"]){//6487
			case "Primera":
				$mat=1;
				break;
			case "Segunda":
				$mat=2;
				break;
			case "Tercera o sucesivas":
				$mat=3;
				break;
		} 
		$ide=$_POST["Ide"];$unidad=$_POST["Unidad"];$anno=$_POST["AnoA"];$centro=$_POST["Centro"];$observ=$_POST["Observaciones"];
	//BUSCAR UNIDAD QUE NO EXISTA
		$sqlc="SELECT id_curso FROM cursos WHERE nombre='$curso'";
		$rowc=mysqli_fetch_assoc(mysqli_query($conexion, $sqlc));
		$idc=$rowc["id_curso"];
		$sqlb="SELECT matricula, año_a, nomb_grupo FROM detalle_historico WHERE id_curso='$idc' AND matricula='$mat' AND id_hist IN (SELECT id_hist FROM historico WHERE id_est='$ide')";
		$resultb=mysqli_query($conexion, $sqlb); $contador=mysqli_num_rows($resultb);  
		if (mysqli_num_rows($resultb)>0){
			$output="hola<br>";
			while ($rowb=mysqli_fetch_assoc($resultb)){
			  $output=$output . $rowb["matricula"] . "hola2" . $rowb["año_a"] . '++' . $error . '<br>' . $mat . '++' . $anno . '<br>' ;
			 	if ($rowb["matricula"]==$mat){
					$error=true;
					$output=$output . $contador . '<form id="formModHistErrA" action="" method="post" accept-charset="UTF-8">
					<p>
					<fieldset form="formModHistErrA">
					<legend align="left"><SPAN style="text-align:top">Error al Modificar Historial</SPAN></legend>
       					<br><br>
					<p align="center">El curso acad&eacute;mico&nbsp;<b>' . $_POST["Unidad"] . '&nbsp;</b>que se quiere agregar ya existe en el historial.</p>
					<p align="center">Para agregar otro curso, pulse el bot&oacute;n Aceptar, y para salir, pulsar el bot&oacute;n Cancelar.</p>
					<p align="center"><input type="submit" value="Aceptar" name="Aceptar2" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
					<input type="submit" value="Cancelar" name="Cancelar" style="font-weight:bold; color:black"></p>
					</fieldset></p>
					<input type="hidden" value="' . $_POST["opcion"] . '" name="opcion"><input type="hidden" value="' . $_POST["clave"] . '" name="clave">
					</form>';
			  	}else{
			 		$error=false;
				}
			}//while 5664
		}else{// contador
	//GRABAR DATOS detalle_historico
			$sqlh="SELECT id_hist FROM historico WHERE id_est='$ide'";
			$rowh=mysqli_fetch_assoc(mysqli_query($conexion, $sqlh));
			$idh=$rowh["id_hist"];
			$sqlc="SELECT id_curso FROM cursos WHERE nombre='$curso'";
			$rowc=mysqli_fetch_assoc(mysqli_query($conexion, $sqlc));
			$idc=$rowc["id_curso"];$rowb=mysqli_fetch_assoc($resultb);
			if ($rowb["nomb_grupo"]==""){//6538
				$sqli="INSERT INTO  detalle_historico (ID_DETALLE_HIST, ID_HIST, ID_CURSO, NOMB_GRUPO, AÑO_A, MATRICULA, CENTRO, OBSERVACIONES) 
				VALUES (NULL, '$idh', '$idc', '$unidad', '$anno', '$mat', '$centro', '$observ')";
			}else{
				$sqli="";
			}
		
			if (!(mysqli_query($conexion, $sqli))){
				$error=true;
				$output='<br><br><b><p align="center"><font color="red">Atenci&oacute;n</font></p><br>
				<p align="center">No se ha podido continuar con la grabaci&oacute;n del nuevo curso para el estudiante</p>
				<p align="center"><b><font color="red">"' . $_POST["Estudiante"] . '"</font></b></p>//4680
				<p align="center>Error:&nbsp;' .  mysqli_error($conexion) . '</p><br>
				<p align="center">Para volver agregar el nuevo curso, para ir al apartado "Modificar Historial de Expediente"&nbsp;
				<a href="http://localhost/drupal/oficina/historial_de_expedientes/modificar_historial">pulse aqu&iacute;</a></p>';
			}
			$id_det_h=mysqli_insert_id($conexion);
		}//buscar unidad
	}else{
		$id_det_h=$_POST["IdDetH"];
	}
	if (isset($_POST["Siguiente3"]) || isset($_POST["GrabarA"]) || isset($_POST["Continuar1"]) AND (!$error)){
		$sql="SELECT num_conv FROM ciclos WHERE id_ciclo IN (SELECT id_ciclo FROM cursos WHERE nombre='$curso')";
		$result=mysqli_query($conexion, $sql);
		$conv=mysqli_fetch_assoc($result);
		$output=$output . '<form id="formAgrgarHistMaterias" action="" method="post" accept-charset="UTF-8">
		<p>
		<fieldset form="formAgregarHistMaterias">
		<legend align="left"><SPAN style="text-align:top">Calificaciones de las Asignaturas impartidas</SPAN></legend>
        	<br><br>
		<p align="center">Estudiante:&nbsp;<input type="text" name="Estudiante" value="' . $_POST["Estudiante"] . '" disabled size="60%"></p>
		<hr size="10" width="98%"><br>
		<p align="center">Unidad:&nbsp;<input type="text" name="Unidad" value="' . $_POST["Unidad"] . '" size="50%" disabled></p>
		<p align="center">Curso:&nbsp;<input type="text" name="CursoA" value="' . $_POST["CursoA"] . '" size="20%" disabled></p>
		<hr size="10" width="98%"><br>';
		if ($conv["num_conv"]==4){
			$cadena='Extraordinaria';
		}else{
			$cadena="";
		}
	}//end_if
	if (((isset($_POST["Conv"]) AND isset($_POST["cadena"]))) || (isset($_POST["Finalizar"])) || isset($_POST["Continuar1"])){//5500
		if (!(isset($_POST["Finalizar"])) || !(isset($_POST["Continuar1"]))){//5700
			$cadena= $_POST["cadena"] . "','" . $_POST["Conv"];
		}
		if (isset($_POST["Continuar1"])){
			$long=strlen($_POST["Conv"]);
			$cadena=substr($cadena, 0, -($long+3));
		
		}
		if (!(isset($_POST["Continuar1"]))){
		$nomb=$_POST["Conv"];
		$sql="SELECT id_conv FROM convocatorias WHERE nombre='$nomb'";
		$row=mysqli_fetch_assoc(mysqli_query($conexion, $sql));		
		$idconv=$row["id_conv"];
		//GRABAR DATOS notas
		$contMat=$_POST["contMat"];
		for($i=1;$i<=$contMat;$i++){
			$mat=$_POST["idmat$i"];
			$notn=$_POST["notan$i"];
			$notv=$_POST["notav$i"];
			$sql="INSERT INTO notas_hist (ID_NOTA_HIST, ID_DETALLE_HIST, ID_MATERIA, ID_CONV, NOTAN, NOTAV) 
			VALUES (NULL, '$id_det_h', '$mat', '$idconv', '$notn', '$notv')";
			$result=mysqli_query($conexion, $sql);
			if ($result){
				$errorn=false;
			}else{
				$errorn=true;
				break;
			}
		}//end_for
		}//end_if
	}//end_if
	if (isset($_POST["Siguiente3"]) || isset($_POST["GrabarA"]) || isset($_POST["Continuar1"]) AND ($error == false)){//5545
		$output=$output . '<p align="center">Seleccionar una convocatoria:&nbsp;<select name="Conv" required autofocus>';
		$sql="SELECT nombre FROM convocatorias WHERE nombre NOT IN ('" . $cadena . "')";
		$result=mysqli_query($conexion, $sql);
		if (mysqli_num_rows($result) > 0){
			while($row=mysqli_fetch_assoc($result)){
				$output= $output . '<option>' . $row["nombre"] . '</option>';
			}
			if (mysqli_num_rows($result) == 1){
				$finalizar=true;
			}
		}
		else{
		 	 $output= $output . '<option></option>';
		}
		$output=$output . '</select></p>
		<table border="2" style="color:black" width="50%">
		<tr valign="middle" ><th><font size="3">Asignaturas</font></th><th><font size="3">Nota Num&eacute;rica</font></th><th><font size="3">Nota Valorativa</font></th></tr>';
	
		$nombCurso=$_POST["CursoA"];//6628
		$sql="SELECT nombre, id_materia FROM materias WHERE id_materia IN (SELECT id_materia FROM asignar_materia WHERE id_curso IN (SELECT id_curso FROM cursos WHERE nombre='$nombCurso'))";
		$result=mysqli_query($conexion, $sql);
		$contMat=mysqli_num_rows($result);
		if ($contMat > 0){
			$i=0;
			while($row=mysqli_fetch_assoc($result)){
				$j=0;
				$materia[$i][$j]=$row["id_materia"]; $materia[$i][$j+1]=$row["nombre"];
				$i=$i+1;
				$output= $output . '<tr valign="middle"><td><font color="blue" size="2">' . $row["nombre"] . '</font>
				<input type="hidden" name="idmat' . $i . '" value="' . $row["id_materia"] . '"></td>
				<td><input type="number" onkeypress="if (event.keyConde < 45 || event.keyCode > 57) event.returnValue = false;" style="color:blue" name="notan' . $i .'" size="5%" required></td>
				<td><input type="text" style="color:blue" name="notav' . $i .'" required></td></tr>';
			}
		}
		$output=$output . '</table>	
		</fieldset></p>
		<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
		if ($finalizar == false){
			$output=$output . '<input type="submit" value="Grabar" name="GrabarA" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			<input type="submit" value="Finalizar" name="Finalizar" style="font-weight:bold; color:black" disabled>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
		}else{
			$output=$output . '<input type="submit" value="Grabar" name="GrabarA" style="font-weight:bold; color:black" disabled>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			<input type="submit" value="Finalizar" name="Finalizar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
		}
		$output=$output . '</p>
		<input type="hidden" value="' . $_POST["opcion"] . '" name="opcion"><input type="hidden" value="' . $_POST["clave"] . '" name="clave">
		<input type="hidden" name="cadena" value="' . $cadena . '"><input type="hidden" name="Estudiante" value="' . $_POST["Estudiante"] . '">
		<input type="hidden" name="Unidad" value="' . $_POST["Unidad"] . '"><input type="hidden" name="CursoA" value="' . $_POST["CursoA"] . '">
		<input type="hidden" name="IdDetH" value="' . $id_det_h . '"><input type="hidden" name="contMat" value="' . $contMat . '">
		<input type="hidden" name="Ide" value="' . $_POST["Ide"] . '">
		</form>';
	}//end_if
	if (isset($_POST["Finalizar"])){
		$output='<form id="AltaHistFinalizar action="" method="post" accept-charset="UTF-8">
		<p>
		<fieldset form="AltaHistFinalizar">
		<legend align="left"><SPAN style="text-align:top">Confirmar Hist&oacute;rico de Estudiante completado</SPAN></legend>
		<br><br>
		<p align="center">Si tiene otra unidad para dar de alta en el hist&oacute;rico del estudiante&nbsp;</p>
		<p align="center"><b>' . $_POST["Estudiante"] . '</b></p>
		<p align="center">Pulsar el bot&oacute;n de "Aceptar" para continuar y para terminar pulsar el bot&oacute;n "Cancelar".</p>
		<p align="center"><input type="submit" name="Aceptar2" value="Aceptar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<input type="submit" name="Cancelar" value="Cancelar" style="font-weight:bold; color:black"></p>
		<input type="hidden" name="Estudiante" value="' . $_POST["Estudiante"] . ' "><input type="hidden" name="Ide" value="' . $_POST["Ide"] . '">
		<input type="hidden" value="' . $_POST["opcion"] . '" name="opcion"><input type="hidden" value="' . $_POST["clave"] . '" name="clave">
		</fieldset></p></form>';
	}
	if ($errorn){
		$errorn=false;
		$output='<form id="formErrorAltaHist1" action="" method="post" accept-charset="UTF-8" size="100%">
		<fieldset form="formErrorAltaHist1"><p>
		<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend><br>
		<p align="center"><b>Error en el alta de evaluaciones del historial</b></p>
		<p align="center"><em>Estudiante:&nbsp;</em><b>' . $_POST["Estudiante"] . '</b></p>
		<p align="center"><input type="submit" value="Continuar" name="Continuar1" style="font-weight:bold; color:black">
		<input type="hidden" value="' . $_POST["opcion"] . '" name="opcion"><input type="hidden" value="' . $_POST["clave"] . '" name="clave">
		<input type="hidden" name="Estudiante" value="' . $_POST["Estudiante"] . ' "><input type="hidden" name="Ide" value="' . $_POST["Ide"] . '">
		<input type="hidden" name="Unidad" value="' . $_POST["Unidad"] . '"><input type="hidden" name="CursoA" value="' . $_POST["CursoA"] . '">
		<input type="hidden" name="IdDetH" value="' . $id_det_h . '"><input type="hidden" name="contMat" value="' . $contMat . '">
		<input type="hidden" name="cadena" value="' . $_POST["cadena"] . '"><input type="hidden" name="Conv" value="' . $_POST["Conv"] . '">
		</p></fieldset></form>';
		$output=$output . '<br><p><font color="red">'. mysqli_error($conexion) . '</font></p>';
		for ($i=1;$i<=$contMat;$i++){
			$sqlb="DELETE FROM notas_hist WHERE id_detalle_hist='$id_det_h' AND (id_materia=0 OR id_conv=0 OR (notan=0 AND notav=''))";
			$resultb=mysqli_query($conexion, $sqlb);
		}
	}//$errorn
}

mysqli_close($conexion);
return $output;
}/********** end modificar_historial **************/




