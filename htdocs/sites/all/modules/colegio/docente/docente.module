<?php


/**
 * Implementation hook_menu()
**/


function docente_menu(){
$items=array();

/****************Asistencia ********************/
$items['docente/asistencias'] = array(
	'title' =>'ASISTENCIA ALUMNADO',
	'page callback' => 'listar_por_unidad',
 	'page arguments' => array ('Listados Asistencia'),
	'access callback' => TRUE,
	'type' => MENU_NORMAL_ITEM,
	'weight' => -1,
);
$items['docente/asistencias/listados_asistencia'] = array(
	'title' => 'Listados de Asistencia',
	'access arguments' => array('Listados Asistencia'),
	'type' => MENU_DEFAULT_LOCAL_TASK,
	'weight' => 0,
);

$items['docente/asistencias/alta_asistencia'] = array(
	'title' => 'Alta Asistencia',
	'access arguments' => array('Alta Asistencia'),
	'access callback' => TRUE,
	'page callback' =>'alta_asistencia',
	'type' => MENU_LOCAL_TASK,
	'weight' => 1,
);
	
$items['docente/asistencias/baja_asistencia'] = array(
	'title' => 'Baja Asistencia',
	'access arguments' => array('Baja Asistencia'),
	'access callback' => TRUE,
	'page callback' =>'baja_asistencia',
	'type' => MENU_LOCAL_TASK,
	'weight' => 3,
);

$items['docente/asistencias/modificar_asistencia'] = array(
	'title' => 'Modificar Asistencia',
	'access arguments' => array('Modificar Asistencia'),
	'access callback' => TRUE,
	'page callback' =>'modificar_asistencia',
	'type' => MENU_LOCAL_TASK,
	'weight' => 2,
);

$items['docente/asistencias/listados_asistencia/listar_por_unidad'] = array(
	'title' => 'Listar por Unidad',
	'access arguments' => array('Listar por Unidad'),
	'access callback' => TRUE,
	'page callback' =>'listar_por_unidad',
	'type' => MENU_LOCAL_TASK,
	'weight' => 0,
);

$items['docente/asistencias/listados_asistencia/listar_por_dias'] = array(
	'title' => 'Listar por Dias Completo',
	'access arguments' => array('Listar por Dias Completo'),
	'access callback' => TRUE,
	'page callback' =>'listar_por_dias_completo',
	'type' => MENU_LOCAL_TASK,
	'weight' => 1,
);

/******************* Calendario ***********************/

//array('!link' => url('docente/file/calendario_huelva.pdf'),),
$items['docente/calendario'] = array(
	'title' => 'CALENDARIO DOCENTE',
	'page callback' => 'calendario',
	'page arguments' => array('Calendario'),
	'access callback' => TRUE,
	'type' => MENU_NORMAL_ITEM,
	'weight' => -1,
);//83

/******************* Disciplina Alumnado **********************/
$items['docente/disciplina'] = array(
	'title' => 'DISCIPLINA ALUMNADO',
	'page callback' => 'listados_disciplina',
	'page arguments' => array('Listados Disciplina'),
	'access callback' => TRUE,
	'type' => MENU_NORMAL_ITEM,
	'weight' => -1,
);

$items['docente/disciplina/listados_disciplina'] = array(
	'title' => 'Listados de Disciplina',
	'access arguments' => array('Listados Disciplina'),
	'type' => MENU_DEFAULT_LOCAL_TASK,
	'weight' => 0,
);

$items['docente/disciplina/alta_disciplina'] = array(
	'title' => 'Alta Disciplina',
	'access arguments' => array('Alta Disciplina'),
	'access callback' => TRUE,
	'page callback' =>'alta_disciplina',
	'type' => MENU_LOCAL_TASK,
	'weight' => 1,
);

$items['docente/disciplina/modificar_disciplina'] = array(
	'title' =>'Modificar Disciplina',
	'access arguments' => array('Modificar Disciplina'),
	'access callback' => TRUE,
	'page callback' => 'modificar_disciplina',
	'type' => MENU_LOCAL_TASK,
	'weight' => 2,
);

$items['docente/disciplina/baja_disciplina'] = array(
	'title' => 'Baja Disciplina',
	'access arguments' => array('Baja Disciplina'),
	'access callback' => TRUE,
	'page callback' => 'baja_disciplina',
	'type' => MENU_LOCAL_TASK,
	'weight' => 3,
);

/********************* Equipo Educativo **********************/

$items['docente/comunicacion'] = array(
	'title' => 'EQUIPO EDUCATIVO',
	'page callback' => 'listados_comunicacion',
	'page arguments' => array('Listados Comunicacion'),
	'access callback' => TRUE,
	'type' => MENU_NORMAL_ITEM,
	'weight' => -1,
);

$items['docente/comunicacion/listados_comunicacion'] = array(
	'title' => 'Listados de Comunicacion',			
	'access arguments' => array('Listados Comunicacion'),
	'type' => MENU_DEFAULT_LOCAL_TASK,
	'weight' => 0,
);
$items['docente/comunicacion/alta_comunicacion'] = array(
	'title' => 'Alta Comunicacion',
	'access arguments' => array('Alta Comunicacion'),
	'access callback' => TRUE,
	'page callback' => 'alta_comunicacion',
	'type' => MENU_LOCAL_TASK,
	'weight' => 1,
);

$items['docente/comunicacion/modificar_comunicacion'] = array(
	'title' => 'Modificar Comunicacion',
	'access arguments' => array('Baja Comunicacion'),
	'access callback' => TRUE,
	'page callback' => 'modificar_comunicacion',
	'type' => MENU_LOCAL_TASK,
	'weight' => 2,
);
$items['docente/comunicacion/baja_comunicacion'] = array(
	'title' => 'Baja Comunicacion',
	'access arguments' => array('Baja Comunicacion'),
	'acces callback' => TRUE,
	'page callback' => 'baja_comunicacion',
	'type' => MENU_LOCAL_TASK,
	'weight' => 3,
);


/*********************** Evaluaciones ****************************/
$items['docente/evaluaciones'] = array(
	'title' => 'EVALUACIONES',
	'page callback' => 'listados_evaluaciones',
	'page arguments' => array('Listados Evaluaciones'),
	'access callback' => TRUE,
	'type' => MENU_NORMAL_ITEM,
	'weight' => -1,
);

$items['docente/evaluaciones/listados_evaluaciones'] = array(
	'title' => 'Listados de Evaluaciones',
	'access arguments' => array('Listados Evaluaciones'),
	'type' => MENU_DEFAULT_LOCAL_TASK,
	'weight' => 0,
);

$items['docente/evaluaciones/alta_evaluaciones'] = array(
	'title' => 'Alta Evaluaciones',
	'access arguments' => array('Alta Evaluaciones'),
	'access callback' => TRUE,
	'page callback' =>'alta_evaluaciones',
	'type' => MENU_LOCAL_TASK,
	'weight' => 1,
);

$items['docente/evaluaciones/modificar_evaluaciones'] = array(
	'title' =>'Modificar Evaluaciones',
	'access arguments' => array('Modificar Evaluaciones'),
	'access callback' => TRUE,
	'page callback' => 'modificar_evaluaciones',
	'type' => MENU_LOCAL_TASK,
	'weight' => 2,
);

$items['docente/evaluaciones/baja_evaluaciones'] = array(
	'title' => 'Baja Evaluaciones',
	'access arguments' => array('Baja Evaluaciones'),
	'access callback' => TRUE,
	'page callback' => 'baja_evaluaciones',
	'type' => MENU_LOCAL_TASK,
	'weight' => 3,
);

/******************* Faltas Académicas ****************************/

$items['docente/faltas_academicas'] = array(
	'title' => 'FALTAS ACADEMICAS',
	'page callback' => 'listados_academicos',
	'page arguments' => array('Listados Academicos'),
	'access callback' => TRUE,
	'type' => MENU_NORMAL_ITEM,
	'weight' => -1,
);

$items['docente/faltas_academicas/listados_academicos'] = array(
	'title' => 'Listados de Faltas Academicas',			
	'access arguments' => array('Listados Academicos'),
	'type' => MENU_DEFAULT_LOCAL_TASK,
	'weight' => 0,
);
$items['docente/faltas_academicas/alta_academicas'] = array(
	'title' => 'Alta Faltas Academicas',
	'access arguments' => array('Alta Academicas'),
	'access callback' => TRUE,
	'page callback' => 'alta_academicas',
	'type' => MENU_LOCAL_TASK,
	'weight' => 1,
);

$items['docente/faltas_academicas/modificar_academicas'] = array(
	'title' => 'Modificar Faltas Academicas',
	'access arguments' => array('Modificar Academicas'),
	'access callback' => TRUE,
	'page callback' => 'modificar_academicas',
	'type' => MENU_LOCAL_TASK,
	'weight' => 2,
);

$items['docente/faltas_academicas/baja_academicas'] = array(
	'title' => 'Baja Faltas Academicas',
	'access arguments' => array('Baja Academicas'),
	'access callback' => TRUE,
	'page callback' => 'baja_academicas',
	'type' => MENU_LOCAL_TASK,
	'weight' => 3,
);

/********************* Programa Asignaturas ************************/
$items['docente/programa'] = array(
	'title' => 'PROGRAMA ASIGNATURAS',
	'page callback' => 'listados_programa',
	'page arguments' => array('Listados Programa Asignaturas'),
	'access callback' => TRUE,
	'type' => MENU_NORMAL_ITEM,
	'weight' => -1,
);

$items['docente/programa/listados_programa'] = array(
	'title' => 'Listados de Programa Asignaturas',			
	'access arguments' => array('Listados Programa Asignaturas'),
	'type' => MENU_DEFAULT_LOCAL_TASK,
	'weight' => 0,
);

$items['docente/programa/alta_programa'] = array(
	'title' => 'Alta Programa Asignaturas',
	'access arguments' => array('Alta  Programa Asignaturas'),
	'access callback' => TRUE,
	'page callback' => 'alta_programa',
	'type' => MENU_LOCAL_TASK,
	'weight' => 1,
);

$items['docente/programa/modificar_programa'] = array(
	'title' => 'Modificar Programa Asignaturas',
	'access arguments' => array('Modificar Programa Asignaturas'),
	'access callback' => TRUE,
	'page callback' => 'modificar_programa',
	'type' => MENU_LOCAL_TASK,
	'weight' => 2,
);

$items['docente/programa/baja_programa'] = array(
	'title' => 'Baja Programa Asignaturas',
	'access arguments' => array('Baja Programa Asignaturas'),
	'access callback' => TRUE,
	'page callback' => 'baja_programa',
	'type' => MENU_LOCAL_TASK,
	'weight' => 3,
);

/****************** TABLÓN Guardias ***********************/
$items['docente/guardias'] = array(
	'title' => 'TABLON DE GUARDIAS',
	'page callback' => 'guardias',
	'page arguments' => array('Guardias'),
	'access callback' => TRUE,
	'type' => MENU_NORMAL_ITEM,
	'weight' => -1,
);
	
/******************* Tutorías ****************************/
$items['docente/tutorias'] = array(
	'title' => 'TUTORIAS',
	'page callback' => 'listados_tutorias',
	'page arguments' => array('Listados de Tutorias'),
	'access callback' => TRUE,
	'type' => MENU_NORMAL_ITEM,
	'weight' => -1,
);

$items['docente/tutorias/listados_tutorias'] = array(
	'title' => 'Listados de Tutorias',
	'access arguments' => array('Listados de Tutorias'),
	'type' => MENU_DEFAULT_LOCAL_TASK,
	'weight' => 0,
);

$items['docente/tutorias/alta_tutorias'] = array(
	'title' => 'Alta Tutorias',    //336
	'access arguments' => array('Alta Tutorias'),
	'access callback' => TRUE,
	'page callback' => 'alta_tutorias',
	'type' => MENU_LOCAL_TASK,
	'weight' => 1,
);
$items['docente/tutorias/modificar_tutorias'] = array(
	'title' => 'Modificar Tutorias',
	'access arguments' => array('Modificar Tutorias'),
	'access callback' => TRUE,
	'page callback' => 'modificar_tutorias',
	'type' => MENU_LOCAL_TASK,
	'weight' => 2,
);
$items['docente/tutorias/baja_tutorias'] = array(
	'title' => 'Baja Tutorias',
	'access arguments' => array('Baja Tutorias'),
	'access callback' => TRUE,
	'page callback' => 'baja_tutorias',
	'type' => MENU_LOCAL_TASK,
	'weight' => 3,
);
	


return $items;
}





/*********************
		**** Base de Datos Externa *****
						*******************************/
function bdexternaD(){
$conn=mysqli_connect("localhost", "colegio", "colegio", "colegio");
	if (!$conn){
		die("Conexión ha fallado:" . mysqli_connect_error());
	}
mysqli_select_db($conn, "colegio");	
return($conn);
}



/****************************** Identificación de Docente *******************************/
function identificacion($texto){
	if ($texto=="evaluaciones"){
		$entrada="Introducir email de docente";
		$salida="SiguienteE";
	}elseif ($texto=="asistencia"){
		$entrada="Introducir email de docente tutor";
		$salida="SiguienteA";
	}elseif ($texto=="disciplina"){
		$entrada="Introducir email de docente tutor";
		$salida="SiguienteD";
	}
	$salida='<form id="formIdentificacion" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formIdentificacion">
	<legend align="left"><SPAN style="text-align:top">Identificaci&oacute;n de docente</SPAN></legend>
        <br><br>
	<p align="left"><b>&emsp;&emsp;&nbsp;' . $entrada . '</b></p>
	<p align="center">Email:&nbsp;&nbsp;<input type="email" style="color:blue" name="email" placeholder="userdocente@colegio.es" size="25%"required></p>
	
	</fieldset>
	</p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<input type="submit" value="Siguiente" name="' . $salida . '" style="font-weight:bold; color:black">  
	</p>
	</form>';
//<p align="center">Password:&nbsp;&nbsp;<input type="password" style="color:blue" name="password" pattern="[A-Za-z0-9]{6,10}" maxlength="10" required></p>
return($salida);
}/****************** end_identificacion docente *************************/


/****************************************************************/
/********************* Faltas Asistencia ************************/
/****************************************************************/


/********************* seleccion_asistencia **********************/
function seleccion_asistencia($cadena, $doc){
$output="";
$conexion=bdexternaD();
	$idDoc=$doc;
	$output='<form id="' . $cadena . '" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="' . $cadena . '" >
	<legend align="left"><SPAN style="text-align:top">Selecci&oacute;n de datos para Faltas de Asistencia</SPAN></legend>
	<br><br>
	<p align=left><label>&emsp;&emsp;A&ntilde;o Acad&eacute;mico:</label>';
	if ($cadena=="formAltaAsist1"){
		$A="2014-2015";//año actual
		$output=$output . '&emsp;&emsp;<select name="annoa" required size="1">';
		$sqla="SELECT DISTINCT año_a FROM matriculas WHERE año_a='$A'";//año actual de estudios
	}elseif (($cadena=="formBajaAsist1") || ($cadena=="formModAsist1")){
		$output=$output . '&emsp;&emsp;<select name="annoa" required size="4">';
		$sqla="SELECT DISTINCT año_a FROM matriculas ORDER BY año_a DESC";
	}
	$resulta=mysqli_query($conexion, $sqla);
	if (mysqli_num_rows($resulta) > 0){
		while($rowa=mysqli_fetch_assoc($resulta)){
			$output= $output . '<option>' . $rowa["año_a"] . '</option>';
		}
	}
	else{
		$output= $output . '<option></option>';
	}
	$output=$output . '</select></p><br><hr><br>
	<p align="center"><label>Unidad para asistencia:</label><select name="unidad" required size="6">';
	//SELECCIONAR CURSO 
	if ($cadena=="formAltaAsist1"){
		$sqlu="SELECT nombre FROM grupos_a WHERE id_gruposa IN (SELECT id_gruposa FROM detalle_matricula WHERE id_gruposa IN (SELECT id_gruposa FROM asignaturas WHERE id_docente='$idDoc' AND tutor=1) AND id_matriculas IN (SELECT id_matriculas FROM matriculas WHERE año_a='$A'))";
	}elseif (($cadena=="formBajaAsist1") || ($cadena=="formModAsist1")){
		$sqlu="SELECT nombre FROM grupos_a WHERE id_gruposa IN (SELECT id_gruposa FROM notas WHERE id_gruposa IN (SELECT id_gruposa FROM asignaturas WHERE id_docente='$idDoc' AND tutor=1))";
	}
	$resultu=mysqli_query($conexion, $sqlu);
	if (mysqli_num_rows($resultu) > 0){
		$cont=0;
		while($rowu=mysqli_fetch_assoc($resultu)){
			$output= $output . '<option>' . $rowu["nombre"] . '</option>';
			$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$error=true;
		$lista="Lista sin unidades";$output= $output . '<option selected>' . $lista . '</option>';
	}
	$output=$output . '</select></p>';
	$fechaA=date("Y");$fechaM=date("m");
	if ($fechaM==09 || $fechaM==10 || $fechaM==11 || $fechaM==12){
		$a1=$fechaA;$a2=$fechaA+1;
		$aa=$a1 . '-' . $a2;
	}else{
		$a1=$fechaA-1;$a2=$fechaA;
		$aa=$a1 . '-' . $a2;
	}
	//SELECCION FECHA
	$output=$output . '<p align="center"><label>Entrada de Fecha:</label>
	<table width="50" bordercolor="blue" solid="1px" border="1"cellspacing="0" cellpadding="1"><tr><td  style="text-align:center" bgcolor="#FFFFFF">
	<b>D&iacute;a</b>
       	 <select name="dia" required>';
	for ($i=1;$i<=31;$i++){
		$output=$output . '<option>' . $i . '</option>';
	}
	$output=$output . '</select>&emsp;&emsp;
	<b>Mes</b>
        <select name="mes" required>
          	<option selected>Enero</option>
          	<option>Febrero</option>
         	<option>Marzo</option>
         	<option>Abril</option>
         	<option>Mayo</option>
         	<option>Junio</option>
         	<option>Julio</option>
         	<option>Agosto</option>
         	<option>Septiembre</option>
         	<option>Octubre</option>
        	<option>Noviembre</option>
        	<option>Diciembre</option>
       	</select>&emsp;&emsp;
	<b>A&ntilde;o</b>
	<select name="ano" required>
		 <option>' . $a1 . '</option>
	 	 <option>' . $a2 . '</option>
	</select></td></tr></table>';
	$output=$output . '</p><br></fieldset></p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($error){
		$output=$output . '<input type="submit" value="Siguiente" name="Siguiente2" style="font-weight:bold; color:black" disabled>';
	}else{
		$output=$output . '<input type="submit" value="Siguiente" name="Siguiente2" style="font-weight:bold; color:black">'; 
	}
	$output=$output . '</p><input type="hidden" value="' . $idDoc . '" name="idDoc"></form>';

return($output);
}
/********************** end_seleccion_asistencia ***********************/


/******************* montar_fecha ************************/
function montar_fecha($m, $d, $a){
switch ($m){
		case "Enero":
			$mes="01";
			break;
		case "Febrero":
			$mes="02";
			break;
		case "Marzo":
			$mes="03";
			break;
		case "Abril":
			$mes="04";
			break;
		case "Mayo":
			$mes="05";
			break;
		case "Junio":
			$mes="06";
			break;
		case "Julio":
			$mes="07";
			break;
		case "Agosto":
			$mes="08";
			break;
		case "Septiembre":
			$mes="09";
			break;
		case "Octubre":
			$mes="10";
			break;
		case "Noviembre":
			$mes="11";
			break;
		case "Diciembre":
			$mes="12";
			break;
	}
	switch ($d){
		case "1":
			$dia="01";
			break;
		case "2":
			$dia="02";
			break;
		case "3":
			$dia="03";
			break;
		case "4":
			$dia="04";
			break;
		case "5":
			$dia="05";
			break;
		case "6":
			$dia="06";
			break;
		case "7":
			$dia="07";
			break;
		case "8":
			$dia="08";
			break;
		case "9":			

			$dia="09";
			break;
		default:
			$dia=$_POST["dia"];
	} 
	//VALIDAR FECHA
	if (($a % 4)==0 && (($a % 100) != 0 || ($a % 400) ==0)){
		if ($mes=="02" && $dia>="29"){//BISIESTO
			$dia="29";
		}
	}else{
		if ($mes=="02" && $dia>="28"){//NO BISIESTO
			$dia="28";
		}
	}
	if ($mes=="04" || $mes=="06" || $mes=="09" || $mes=="11"){
		if ($dia>="30"){
			$dia="30";
		}
	}
	$fecha=$dia . '/' . $mes . '/' . $a;

return($fecha);
}
/******************** end montar_fecha **************************/

function listados_asistencia(){
$A=date("Y");
$output='listados';

return($output);
}

/************************ Listar_por_unidad ***********************/
function listar_por_unidad (){
$output="";
$conexion=bdexternaD();
GLOBAL $user, $emailDoc;

if (!$_POST || isset($_POST["Cancelar"])){
	$output='<form id="formListarAsistUni" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formListarAsistUni"><br><legend align="left"><SPAN style="text-align:top">B&uacute;squeda de informaci&oacute;n de Faltas de Asistencias</SPAN></legend><br>';
	$fechaA=date("Y");$fechaM=date("m");
	if ($fechaM==09 || $fechaM==10 || $fechaM==11 || $fechaM==12){
		$a1=$fechaA;$a2=$fechaA+1;
		$aa=$a1 . '-' . $a2;
	}else{
		$a1=$fechaA-1;$a2=$fechaA;
		$aa=$a1 . '-' . $a2;
	}
	$output=$output . '<p align="center"><label>Seleccionar Fecha:</label>
	<table width="50" bordercolor="blue" solid="1px" border="1"cellspacing="0" cellpadding="1"><tr><td  style="text-align:center" bgcolor="#FFFFFF">
	<b>D&iacute;a</b>
       	 <select name="dia" required>';
	for ($i=1;$i<=31;$i++){
		$output=$output . '<option>' . $i . '</option>';
	}
	$output=$output . '</select>&emsp;&emsp;
	<b>Mes</b>
        <select name="mes" required>
          	<option selected>Enero</option>
          	<option>Febrero</option>
         	<option>Marzo</option>
         	<option>Abril</option>
         	<option>Mayo</option>
         	<option>Junio</option>
         	<option>Julio</option>
         	<option>Agosto</option>
         	<option>Septiembre</option>
         	<option>Octubre</option>
        	<option>Noviembre</option>
        	<option>Diciembre</option>
       	</select>&emsp;&emsp;
	<b>A&ntilde;o</b>
	<select name="ano" required>
		 <option>' . $a1 . '</option>
	 	 <option>' . $a2 . '</option>
	</select></td></tr></table></p>
	<p align="center"><label>Seleccionar A&ntilde;o Acad&eacute;mico:</label></p>
	<p align="center"><select name="annoa" required size="4">';
	$sqla="SELECT DISTINCT año_a FROM matriculas ORDER BY año_a DESC";
	$resulta=mysqli_query($conexion, $sqla);
	if (mysqli_num_rows($resulta) > 0){
		while($rowa=mysqli_fetch_assoc($resulta)){
			$output= $output . '<option>' . $rowa["año_a"] . '</option>';
		}
	}
	else{
		$output= $output . '<option></option>';
	}
	$output=$output . '</select></p><p align="center"><label>Seleccionar una Unidad:</label></p>
	<p align="center"><select name="unidad" required size="6">';
	if ($user->name == "alillo"){//ADMINISTRADOR
		$sqlu="SELECT nombre FROM grupos_a";
		$email=$user->mail;
	}else{//DOCENTE
		$email=$user->mail;
		$sqlu="SELECT nombre FROM grupos_a WHERE id_gruposa IN (SELECT id_gruposa FROM asignaturas WHERE id_docente IN (SELECT id_docentes FROM docentes WHERE email='$email'))";
	}
	$resultu=mysqli_query($conexion, $sqlu);
	if (mysqli_num_rows($resultu) > 0){
		while($rowu=mysqli_fetch_assoc($resultu)){
			$output= $output . '<option>' . $rowu["nombre"] . '</option>';
		}
	}
	else{
		$output= $output . '<option></option>';
	}
	$output=$output . '</select></p>
	</fieldset>
	<p align="left"><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<input type="submit" name="buscarDatos" value="Buscar Datos" style="font-weight:bold; color:black"></p>
	<input type="hidden" name="email" value="' . $email . '">
	</p></form>';
}elseif (isset($_POST["buscarDatos"])){
$error=false;
//BUSCAR TABLA ASISTENCIAS SEGUN ID UNIDAD
	$nombU=$_POST["unidad"];$annoa=$_POST["annoa"];$email=$_POST["email"];
	$fecha=montar_fecha($_POST["mes"], $_POST["dia"], $_POST["ano"]);
	$sqlu="SELECT id_gruposa FROM grupos_a WHERE nombre='$nombU'";
	$resulu=mysqli_query($conexion, $sqlu);$rowu=mysqli_fetch_assoc($resulu);
	$id_U=$rowu["id_gruposa"];
	$sqlc="SELECT id_ciclo FROM ciclos WHERE id_ciclo IN (SELECT id_ciclo FROM cursos WHERE id_curso IN (SELECT id_curso FROM grupos_a WHERE id_gruposa='$id_U'))";
	$resulc=mysqli_query($conexion, $sqlc);$rowc=mysqli_fetch_assoc($resulc);
	switch($rowc["id_ciclo"]){
		case 3:
			$col=7;
			$tabla="f_asistencias";
			$tr[1]="9:15 10:00";$tr[2]="10:00 10:45";$tr[3]="10:45 11:30";$tr[4]="11:30 12:00";
			$tr[5]="12:00 12:45";$tr[6]="12:45 13:30";$tr[7]="13:30 14:15";
			break;
		case 4:
			$col=7;
			$tabla="f_asistencias";
			$tr[1]="9:15 10:00";$tr[2]="10:00 10:45";$tr[3]="10:45 11:30";$tr[4]="11:30 12:00";
			$tr[5]="12:00 12:45";$tr[6]="12:45 13:30";$tr[7]="13:30 14:15";
			break;
		case 5:
			$col=7;
			$tabla="f_asistencias_eso";
			$tr[1]="8:00 9:00";$tr[2]="9:00 10:00";$tr[3]="10:00 11:00";$tr[4]="11:00 11:30";
			$tr[5]="11:30 12:30";$tr[6]="12:30 13:30";$tr[7]="13:30 14:30";
			break;
		case 6:
			$col=7;
			$tabla="f_asistencias_eso";
			$tr[1]="8:00 9:00";$tr[2]="9:00 10:00";$tr[3]="10:00 11:00";$tr[4]="11:00 11:30";
			$tr[5]="11:30 12:30";$tr[6]="12:30 13:30";$tr[7]="13:30 14:30";
			break;
		case 7:
			$col=8;
			$tabla="f_asistencias_b_c";
			$tr[1]="8:00 9:00";$tr[2]="9:00 10:00";$tr[3]="10:00 11:00";$tr[4]="11:00 11:30";
			$tr[5]="11:30 12:30";$tr[6]="12:30 13:30";$tr[7]="13:30 14:30";$tr[8]="14:30 15:30";
			break;
		case 8:
			$col=8;
			$tabla="f_asistencias_b_c";
			$tr[1]="8:00 9:00";$tr[2]="9:00 10:00";$tr[3]="10:00 11:00";$tr[4]="11:00 11:30";
			$tr[5]="11:30 12:30";$tr[6]="12:30 13:30";$tr[7]="13:30 14:30";$tr[8]="14:30 15:30";
			break;
	}
//CAMBIAR FECHAS
	preg_match("/([0-9]{1,2})\/([0-9]{1,2})\/([0-9]{4})/", $fecha, $nfecha);
	$fechab=$nfecha[3] . "-" . $nfecha[2] . "-" . $nfecha[1];
//FECHA EXISTE FALTAS DE ASISTENCIAS EN ESE AÑO ACADEMICO Y UNIDAD
	$sqla="SELECT * FROM " . $tabla . " WHERE id_gruposa='$id_U' AND fecha='$fechab'";
	$resulta=mysqli_query($conexion, $sqla);$conta=mysqli_num_rows($resulta);
	if ($conta>0){
		//LISTAR DATOS
		$output='<form id="formListarUniAsist1" action="" method="post" accept-charset="UTF-8" size="100%">
		<p>
		<fieldset form="formListarUniAsist1">
		<legend align="left"><SPAN style="text-align:top">Listado de Faltas de Asistencias</SPAN></legend>
        	<br><br>
		<p align="left">&emsp;&emsp;<b>A&ntilde;o Acad&eacute;mico:&nbsp;</b><input type="text" style="color:black; background:#BDBDBD" name="annoa" value="' . $_POST["annoa"] .'" size="12%" disabled>
		&emsp;&emsp;<b>Fecha inicio:&nbsp;</b><input type="date" style="color:black; background:#BDBDBD" name="fecha" value="' . $fecha . '" disabled></p>
		<p align="left"><b>&emsp;&emsp;Unidad de Tutor:&nbsp;</b><input type="text" style="color:black; background:#BDBDBD" name="unidad" value="' . $_POST["unidad"] .'" size="50%" disabled></p>
		<hr>
		<p align="center"><b><em><font size="3">Faltas de Asistencia de una Unidad</font></em></b></p>
		<p align="center"><table border="2"><tr><th rowspan=2  width="30%" style="text-align:center"><font size="3">Estudiante</font></th><th rowspan=2 width="5%" style="text-align:center"><font size="3">D&iacute;a Entero</font></th>
			<th colspan='. $col .' width="75%"style="text-align:center"><font size="3">Tramo Horario de ' . $fecha . '</font></th></tr><tr>';
			for ($i=1;$i<=$col;$i++){
				$output=$output . '<th style="text-align:center"><font size="2">' . $tr[$i] . '</font></th>';
			}//for
		$output=$output . '</tr>';
		 while($rowa=mysqli_fetch_assoc($resulta)){//739
			$idMat=$rowa["ID_MATRICULA"];//741
			$sqle="SELECT nombre, apellidos FROM estudiantes WHERE id_est IN (SELECT id_est FROM matriculas WHERE id_matriculas='$idMat' AND año_a='$annoa')";// AND id_matriculas IN (SELECT DISTINCT id_matriculas FROM detalle_matricula WHERE id_gruposa='$id_U'))";
			$resulte=mysqli_query($conexion, $sqle);
			$rowe=mysqli_fetch_assoc($resulte);
			$output=$output . '<tr><td style="text-align:center"><font size="2" color="blue">' . $rowe["apellidos"] . ', ' . $rowe["nombre"] . '</font></td>';
			if ($rowa["DIA_C"] != "0"){
				$output=$output . '<td style="text-align:center"><input type="text" style="color:blue; background:white" name="fc" size="2%" disabled value="' . $rowa["DIA_C"] . '"></td>';
			}else{
				$output=$output . '<td style="text-align:center"><input type="text" style="color:blue; background:white" name="fc" size="2%" disabled></td>';
			}
			for($j=1;$j<=$col;$j++){
				if ($rowa["TR$j"] != "0"){
					$output=$output . '<td style="text-align:center"><input type="text" style="color:blue; background:white" name="ftr' . $j . '" size="2%" disabled value="' . $rowa["TR$j"] . '"></td>';
				}else{
					$output=$output . '<td style="text-align:center"><input type="text" style="color:blue; background:white" name="ftr' . $j . '" size="2%" disabled></td>';
				}
			}
			$output=$output . '</tr>';
		}      

		$output=$output . '</table></fieldset></p>
		</p><p align="center"><input type="submit" value="Volver Atr&aacute;s" name="Cancelar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<input type="button" name="imprimir" value="Imprimir"  onClick="window.print();" style="font-weight:bold; color:black"></p>
		</fieldset></p>
		<input type="hidden" name="email" value="' . $_POST["email"] . '">
		</form>';
	}else{
		$error=true;
	}
	
	if ($error){
		$output='<form id="formErrorListarUniAsist1" action="" method="post" accept-charset="UTF-8" size="100%">
		<fieldset form="formErrorListarUniAsist1"><p>
		<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend>
		<br>
		<p align="center">Error en la b&uacute;squeda de datos para las faltas de asistencia por unidad.</p>
		<p align="center"><em>Unidad:&nbsp;</em><b>' . $_POST["unidad"] . '</b></p>
		<p align="center"><em>A&ntilde;o Acad&eacute;mico:&nbsp;</em><b>' . $_POST["annoa"] . '</b></p>
		<p align="center"><em>Fecha:&nbsp;</em><b>' . $fecha . '</b></p>
		<p align="center"><input type="submit" value="Aceptar" name="Cancelar" style="font-weight:bold; color:black"></p>
		<input type="hidden" value="' . $_POST["email"] . '" name="email"></p></fieldset></form>';
		$output=$output . '<br><p><font color="red">'. mysqli_error($conexion) . '</font></p>';
	}
}

mysqli_close($conexion);
return ($output);
}
/******************** end listar_por_unidad ***********************/


/********************* listar_por_dias_completo ********************/
function listar_por_dias_completo(){
$output="";
$conexion=bdexternaD();
GLOBAL $user, $emailDoc;

if (!$_POST || isset($_POST["Cancelar"])){
	$output='<form id="formListarAsistUni" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formListarAsistUni"><br><legend align="left"><SPAN style="text-align:top">B&uacute;squeda de informaci&oacute;n de Faltas de Asistencias</SPAN></legend><br>
	<p align="center"><label>Seleccionar intervalo de Fechas:</label></p>
	<p>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;Fecha inicio:&nbsp;<input type="date" style="color:blue" name="finicio" required size="12" maxlength="10" placeholder="dd/mm/aaaa" pattern="[0-9]{2}/[0-9]{2}/[0-9]{4}" title="Fecha:dd/mm/aaaa">
	&emsp;&emsp;&emsp;Fecha final:&nbsp;<input type="date" style="color:blue" name="ffinal" required size="12" maxlength="10" placeholder="dd/mm/aaaa" pattern="[0-9]{2}/[0-9]{2}/[0-9]{4}" title="Fecha:dd/mm/aaaa"></p>
	<p align="center"><label>Seleccionar A&ntilde;o Acad&eacute;mico:</label></p>
	<p align="center"><select name="annoa" required size="4">';
	$sqla="SELECT DISTINCT año_a FROM matriculas ORDER BY año_a DESC";
	$resulta=mysqli_query($conexion, $sqla);
	if (mysqli_num_rows($resulta) > 0){
		while($rowa=mysqli_fetch_assoc($resulta)){
			$output= $output . '<option>' . $rowa["año_a"] . '</option>';
		}
	}
	else{
		$output= $output . '<option></option>';
	}
	$output=$output . '</select></p><p align="center"><label>Seleccionar una Unidad:</label></p>
	<p align="center"><select name="unidad" required size="6">';
	if ($user->name == "alillo"){//ADMINISTRADOR
		$sqlu="SELECT nombre FROM grupos_a";
		$email=$user->mail;
	}else{//DOCENTE
		$email=$user->mail;
		$sqlu="SELECT nombre FROM grupos_a WHERE id_gruposa IN (SELECT id_gruposa FROM asignaturas WHERE id_docente IN (SELECT id_docentes FROM docentes WHERE email='$email'))";
	}
	$resultu=mysqli_query($conexion, $sqlu);
	if (mysqli_num_rows($resultu) > 0){
		while($rowu=mysqli_fetch_assoc($resultu)){
			$output= $output . '<option>' . $rowu["nombre"] . '</option>';
		}
	}
	else{
		$output= $output . '<option></option>';
	}
	$output=$output . '</select></p>
	</fieldset>
	<p align="left"><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<input type="submit" name="buscarDatos" value="Buscar Datos" style="font-weight:bold; color:black"></p>
	<input type="hidden" name="email" value="' . $email . '">
	</p></form>';
}elseif (isset($_POST["buscarDatos"])){
$error=false;
//BUSCAR TABLA ASISTENCIAS SEGUN ID UNIDAD
	$nombU=$_POST["unidad"];$annoa=$_POST["annoa"];$email=$_POST["email"];
	
	$sqlu="SELECT id_gruposa FROM grupos_a WHERE nombre='$nombU'";
	$resulu=mysqli_query($conexion, $sqlu);$rowu=mysqli_fetch_assoc($resulu);
	$id_U=$rowu["id_gruposa"];
	$sqlc="SELECT id_ciclo FROM ciclos WHERE id_ciclo IN (SELECT id_ciclo FROM cursos WHERE id_curso IN (SELECT id_curso FROM grupos_a WHERE id_gruposa='$id_U'))";
	$resulc=mysqli_query($conexion, $sqlc);$rowc=mysqli_fetch_assoc($resulc);
	switch($rowc["id_ciclo"]){
		case 3:
			$col=7;
			$tabla="f_asistencias";
			$tr[1]="9:15 10:00";$tr[2]="10:00 10:45";$tr[3]="10:45 11:30";$tr[4]="11:30 12:00";
			$tr[5]="12:00 12:45";$tr[6]="12:45 13:30";$tr[7]="13:30 14:15";
			break;
		case 4:
			$col=7;
			$tabla="f_asistencias";
			$tr[1]="9:15 10:00";$tr[2]="10:00 10:45";$tr[3]="10:45 11:30";$tr[4]="11:30 12:00";
			$tr[5]="12:00 12:45";$tr[6]="12:45 13:30";$tr[7]="13:30 14:15";
			break;
		case 5:
			$col=7;
			$tabla="f_asistencias_eso";
			$tr[1]="8:00 9:00";$tr[2]="9:00 10:00";$tr[3]="10:00 11:00";$tr[4]="11:00 11:30";
			$tr[5]="11:30 12:30";$tr[6]="12:30 13:30";$tr[7]="13:30 14:30";
			break;
		case 6:
			$col=7;
			$tabla="f_asistencias_eso";
			$tr[1]="8:00 9:00";$tr[2]="9:00 10:00";$tr[3]="10:00 11:00";$tr[4]="11:00 11:30";
			$tr[5]="11:30 12:30";$tr[6]="12:30 13:30";$tr[7]="13:30 14:30";
			break;
		case 7:
			$col=8;
			$tabla="f_asistencias_b_c";
			$tr[1]="8:00 9:00";$tr[2]="9:00 10:00";$tr[3]="10:00 11:00";$tr[4]="11:00 11:30";
			$tr[5]="11:30 12:30";$tr[6]="12:30 13:30";$tr[7]="13:30 14:30";$tr[8]="14:30 15:30";
			break;
		case 8:
			$col=8;
			$tabla="f_asistencias_b_c";
			$tr[1]="8:00 9:00";$tr[2]="9:00 10:00";$tr[3]="10:00 11:00";$tr[4]="11:00 11:30";
			$tr[5]="11:30 12:30";$tr[6]="12:30 13:30";$tr[7]="13:30 14:30";$tr[8]="14:30 15:30";
			break;
	}
//CAMBIAR FECHAS
	preg_match("/([0-9]{1,2})\/([0-9]{1,2})\/([0-9]{4})/", $_POST["finicio"], $nfecha);
	$finiciob=$nfecha[3] . "-" . $nfecha[2] . "-" . $nfecha[1];
	preg_match("/([0-9]{1,2})\/([0-9]{1,2})\/([0-9]{4})/", $_POST["ffinal"], $nfecha);
	$ffinalb=$nfecha[3] . "-" . $nfecha[2] . "-" . $nfecha[1];
	
//FECHA EXISTE FALTAS DE ASISTENCIAS EN ESE AÑO ACADEMICO Y UNIDAD
	$sqla="SELECT DISTINCT id_matricula FROM " . $tabla . " WHERE id_gruposa='$id_U' AND fecha BETWEEN '$finiciob' AND '$ffinalb' ORDER BY fecha ASC";
	$resulta=mysqli_query($conexion, $sqla);$conta=mysqli_num_rows($resulta);
	if ($conta>0){
		//LISTAR DATOS
		$output='<form id="formListarUniAsist1" action="" method="post" accept-charset="UTF-8" size="100%">
		<p>
		<fieldset form="formListarUniAsist1">
		<legend align="left"><SPAN style="text-align:top">Listado de Faltas de Asistencias</SPAN></legend>
        	<br><br>
		<p align="left">&emsp;&emsp;<b>A&ntilde;o Acad&eacute;mico:&nbsp;</b><input type="text" style="color:black; background:#BDBDBD" name="annoa" value="' . $_POST["annoa"] .'" size="12%" disabled></p>
		<p align="left">&emsp;&emsp;<b>Fecha inicio:&nbsp;</b><input type="date" style="color:black; background:#BDBDBD" name="finicio" value="' . $_POST["finicio"] . '" disabled>
		&emsp;&emsp;<b>Fecha inicio:&nbsp;</b><input type="date" style="color:black; background:#BDBDBD" name="ffinal" value="' . $_POST["ffinal"] . '" disabled></p>
		<p align="left"><b>&emsp;&emsp;Unidad de Tutor:&nbsp;</b><input type="text" style="color:black; background:#BDBDBD" name="unidad" value="' . $_POST["unidad"] .'" size="50%" disabled></p>
		<hr>
		<p align="center"><b><em><font size="3">Faltas de Asistencia de una Unidad entre<br>  "' . $_POST["finicio"] . '"  y  "' . $_POST["ffinal"] . '"</font></em></b></p>
		<p align="center"><table border="2"><tr><th width="20%" style="text-align:center"><font size="3">Estudiante</font></th><th width="15%" style="text-align:center"><font size="3">Fecha</font></th>
			<th width="10%"style="text-align:center"><font size="3">D&iacute;a Completo</font></th></tr>';
			
		while($rowa=mysqli_fetch_assoc($resulta)){//739
			$idMat=$rowa["id_matricula"];//741
			$sqle="SELECT nombre, apellidos FROM estudiantes WHERE id_est IN (SELECT id_est FROM matriculas WHERE id_matriculas='$idMat' AND año_a='$annoa')";// AND id_matriculas IN (SELECT DISTINCT id_matriculas FROM detalle_matricula WHERE id_gruposa='$id_U'))";
			$resulte=mysqli_query($conexion, $sqle);
			$rowe=mysqli_fetch_assoc($resulte);
			$sqlf="SELECT fecha, dia_c FROM " . $tabla . " WHERE id_matricula='$idMat' AND dia_c<>'0' AND fecha BETWEEN '$finiciob' AND '$ffinalb' ORDER BY fecha ASC";
			$resultf=mysqli_query($conexion, $sqlf);$contf=mysqli_num_rows($resultf);
			$output=$output . '<tr><td rowspan=' . $contf . ' style="text-align:center"><font size="2" color="blue">' . $rowe["apellidos"] . ', ' . $rowe["nombre"] . '</font></td>';
			while ($rowf=mysqli_fetch_assoc($resultf)){
					preg_match("/([0-9]{4})\-([0-9]{1,2})\-([0-9]{1,2})/", $rowf["fecha"], $nfecha);
					$fecha=$nfecha[3] . "/" . $nfecha[2] . "/" . $nfecha[1];
					$output=$output . '<td  style="text-align:center"><input type="text" style="text-align:center; color:blue; background:white" name="fecha" size="15%" disabled value="' . $fecha . '"></td>';
				
				if ($rowf["dia_c"] == "I"){
					$output=$output . '<td style="text-align:center"><input type="text" style="text-align:center; color:blue; background:#F78181" name="fc" size="2%" disabled value="' . $rowf["dia_c"] . '"></td></tr>';
				}else{
					$output=$output . '<td style="text-align:center"><input type="text" style="text-align:center; color:blue; background:#BFFF00" name="fc" size="2%" disabled value="' . $rowf["dia_c"] . '"></td></tr>';
				}
				
			}//while
			$output=$output . '<tr><td colspan=2 style="text-align:right; background:#D8D8D8"><font size="2" color="blue">Total Faltas de Asistencia:</font></td>
				<td style="text-align:center; background:#D8D8D8"><font size="2" color="blue">' . $contf . '</font></td></tr>';
		}//while   991  

		$output=$output . '</table></fieldset></p>
		</p><p align="center"><input type="submit" value="Volver Atr&aacute;s" name="Cancelar" style="font-weight:bold; color:black">
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<input type="button" name="imprimir" value="Imprimir"  onClick="window.print();" style="font-weight:bold; color:black"></p>
		</fieldset></p>
		<input type="hidden" name="email" value="' . $_POST["email"] . '">
		</form>';
	}else{
		$error=true;
	}
	
	if ($error){
		$output='<form id="formErrorListarUniAsist1" action="" method="post" accept-charset="UTF-8" size="100%">
		<fieldset form="formErrorListarUniAsist1"><p>
		<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend>
		<br>
		<p align="center">Error en la b&uacute;squeda de datos para las faltas de asistencia por unidad.</p>
		<p align="center"><em>Unidad:&nbsp;</em><b>' . $_POST["unidad"] . '</b></p>
		<p align="center"><em>A&ntilde;o Acad&eacute;mico:&nbsp;</em><b>' . $_POST["annoa"] . '</b></p>
		<p align="center"><em>Fecha inicio:&nbsp;</em><b>' . $_POST["finicio"] . '</b> y <em>Fecha final:&nbsp;</em><b>' . $_POST["ffinal"] . '</b></p>
		<p align="center"><input type="submit" value="Aceptar" name="Cancelar" style="font-weight:bold; color:black"></p>
		<input type="hidden" value="' . $_POST["email"] . '" name="email"></p></fieldset></form>';
		$output=$output . '<br><p><font color="red">'. mysqli_error($conexion) . '</font></p>';
	}


}

mysqli_close($conexion);
return($output);
}
/********************* end listar_por_dias_completo ****************/

/*********************** Alta Asistencia **************************/
function alta_asistencia(){
$output="";
$conexion=bdexternaD();
GLOBAL $user, $emailDoc;
$error=false;

if ((!$_POST || isset($_POST["Salir"])|| isset($_POST["Atras1"])) && ($user->name == "alillo")){
	//Identificacion
	$output=identificacion("asistencia");
}elseif (!$_POST || isset($_POST["SiguienteA"]) || isset($_POST["Continuar"]) || isset($_POST["Atras"]) || isset($_POST["Cancelar"])){
  if (!$_POST || isset($_POST["SiguienteA"])){
	if ($user->name == "alillo"){
		$emailDoc=$_POST["email"];
	}else{//632
		$emailDoc=$user->mail;//$_POST["password"]=$user->pass;
	}
	$sql="SELECT * FROM docentes WHERE email='$emailDoc' AND id_docentes IN (SELECT id_docente FROM asignaturas WHERE tutor=1)";
	$result=mysqli_query($conexion, $sql);
	if ((mysqli_num_rows($result) == 1)){
		while($row=mysqli_fetch_assoc($result)){
			$output=seleccion_asistencia("formAltaAsist1", $row["ID_DOCENTES"]);
	
		}//while
		$error=false;
	}else{
		$error=true;
	}
  }else{
  	$id_doc=$_POST["idDoc"];
  	$output=seleccion_asistencia("formAltaAsist1", $id_doc);
  	$error=false;
  }
  if ($error){
	$output='<form id="formAltaAsistValidar" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formAltaAsistValidar">
	<legend align="left"><SPAN style="text-align:top">Mensaje de Atenci&oacute;n</SPAN></legend>
	<br><br>
	<p align="center">Los datos introducidos no son correctos: (email) o no tiene acceso a este apartado.</p>
	<p align="center"><input type="button" onclick="history.back()" value="Volver a intentarlo" name="Volver Atras" style="font-weight:bold; color:black"></p>
	</fieldset></p>
	</form><br>';
  }

}elseif (isset($_POST["Siguiente2"])){//584
$tr=[];

	$fecha=montar_fecha($_POST["mes"], $_POST["dia"], $_POST["ano"]);
	preg_match("/([0-9]{1,2})\/([0-9]{1,2})\/([0-9]{4})/", $fecha, $nfecha);
	$fechab=$nfecha[3] . "-" . $nfecha[2] . "-" . $nfecha[1];
	$nombU=$_POST["unidad"];
	$id_Doc=$_POST["idDoc"];
	//$sqlt="SELECT id_docente, id_gruposa FROM asignaturas WHERE id_docente IN (SELECT id_docentes FROM docentes WHERE email='$emailD')";
	$sqlt="SELECT id_docente, id_gruposa FROM asignaturas WHERE id_docente='$id_Doc' AND id_gruposa IN (SELECT id_gruposa FROM grupos_a WHERE nombre='$nombU')";
	$result=mysqli_query($conexion, $sqlt);
	$rowt=mysqli_fetch_assoc($result);$id_U=$rowt["id_gruposa"];
	$sqlc="SELECT id_ciclo FROM ciclos WHERE id_ciclo IN (SELECT id_ciclo FROM cursos WHERE id_curso IN (SELECT id_curso FROM grupos_a WHERE id_gruposa='$id_U'))";
	$resulc=mysqli_query($conexion, $sqlc);$rowc=mysqli_fetch_assoc($resulc);
	switch($rowc["id_ciclo"]){
		case 3:
			$col=7;
			$tabla="f_asistencias";
			$tr[1]="9:15 10:00";$tr[2]="10:00 10:45";$tr[3]="10:45 11:30";$tr[4]="11:30 12:00";
			$tr[5]="12:00 12:45";$tr[6]="12:45 13:30";$tr[7]="13:30 14:15";
			break;
		case 4:
			$col=7;
			$tabla="f_asistencias";
			$tr[1]="9:15 10:00";$tr[2]="10:00 10:45";$tr[3]="10:45 11:30";$tr[4]="11:30 12:00";
			$tr[5]="12:00 12:45";$tr[6]="12:45 13:30";$tr[7]="13:30 14:15";
			break;
		case 5:
			$col=7;
			$tabla="f_asistencias_eso";
			$tr[1]="8:00 9:00";$tr[2]="9:00 10:00";$tr[3]="10:00 11:00";$tr[4]="11:00 11:30";
			$tr[5]="11:30 12:30";$tr[6]="12:30 13:30";$tr[7]="13:30 14:30";
			break;
		case 6:
			$col=7;
			$tabla="f_asistencias_eso";
			$tr[1]="8:00 9:00";$tr[2]="9:00 10:00";$tr[3]="10:00 11:00";$tr[4]="11:00 11:30";
			$tr[5]="11:30 12:30";$tr[6]="12:30 13:30";$tr[7]="13:30 14:30";
			break;
		case 7:
			$col=8;
			$tabla="f_asistencias_b_c";
			$tr[1]="8:00 9:00";$tr[2]="9:00 10:00";$tr[3]="10:00 11:00";$tr[4]="11:00 11:30";
			$tr[5]="11:30 12:30";$tr[6]="12:30 13:30";$tr[7]="13:30 14:30";$tr[8]="14:30 15:30";
			break;
		case 8:
			$col=8;
			$tabla="f_asistencias_b_c";
			$tr[1]="8:00 9:00";$tr[2]="9:00 10:00";$tr[3]="10:00 11:00";$tr[4]="11:00 11:30";
			$tr[5]="11:30 12:30";$tr[6]="12:30 13:30";$tr[7]="13:30 14:30";$tr[8]="14:30 15:30";
			break;
	}
	//FECHA EXISTE
	$sqlf="SELECT * FROM " . $tabla . " WHERE fecha='$fechab' AND id_gruposa='$id_U'";
	$resultf=mysqli_query($conexion, $sqlf);
	if (mysqli_num_rows($resultf)>0){//727
		$output='<form id="formErrorAltaAsist" action="" method="post" accept-charset="UTF-8" size="100%">
		<fieldset form="formErrorAltaAsist"><p>
		<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend>
		<br>
		<p align="center">Error en la selecci&oacute;n de fecha, ya existe para dar de alta en faltas de asistencias.</p>
		<p align="center"><input type="submit" value="Aceptar" name="Cancelar" style="font-weight:bold; color:black"></p>
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"></p></fieldset></form>';
	}else{
	//$sql="SELECT column_name FROM information_schema.columns WHERE table_name='$tabla'"; 
	//716
		$output= '<form id="formAltaAsist2" action="" method="post" accept-charset="UTF-8" size="100%">
		<p>
		<fieldset form="formAltaAsist2">
		<legend align="left"><SPAN style="text-align:top">Nueva Alta de Falta de Asistencia</SPAN></legend>
        	<br><br>
		<p align="left">&emsp;&emsp;<b>A&ntilde;o Acad&eacute;mico:&nbsp;</b><input type="text" name="annoa" value="' . $_POST["annoa"] .'" size="12%" disabled>
		&emsp;&emsp;<b>Fecha:&nbsp;</b><input type="date" name="fecha" value="' . $fecha . '" disabled></p><input type="hidden" name="fechab" value="'. $fechab . '">
		<p align="left"><b>&emsp;&emsp;Unidad de Tutor:&nbsp;</b><input type="text" name="unidad" value="' . $_POST["unidad"] .'" size="50%" disabled></p>
		<p align="center"><b>Faltas de Asistencia de una Unidad en una Fecha</b></p>
		<p align="center"><table border="2"><tr><th rowspan=2  width="30%" style="text-align:center"><font size="3">Estudiante</font></th><th rowspan=2 width="5%" style="text-align:center"><font size="3">D&iacute;a Entero</font></th>
			<th colspan='. $col .' width="75%"style="text-align:center"><font size="3">Tramo Horario de ' . $fecha . '</font></th></tr><tr>';
			for ($i=1;$i<=$col;$i++){
				$output=$output . '<th style="text-align:center"><font size="2">' . $tr[$i] . '</font></th>';
			}//for
		$output=$output . '<tr>';
		$A=$_POST["annoa"];
		$sqle="SELECT nombre, apellidos, id_est FROM estudiantes WHERE id_est IN (SELECT id_est FROM matriculas WHERE año_a='$A' AND id_matriculas IN (SELECT id_matriculas FROM detalle_matricula WHERE id_gruposa='$id_U'))";
		$resulte=mysqli_query($conexion, $sqle);$conte=mysqli_num_rows($resulte);//$rowe=mysqli_fetch_assoc($resulte);
		$output=$output . '</tr>';
		if ((mysqli_num_rows($resulte)>0)){
			$error=false;$i=0;
			while($rowe=mysqli_fetch_array($resulte)){
				$i=$i+1;
				$output=$output . '<tr><td style="text-align:center"><font size="2" color="blue">' . $rowe["apellidos"] . ', ' . $rowe["nombre"] . '</font></td><input type="hidden" name="id_est' . $i . '" value="' . $rowe["id_est"] .'">
				<td style="text-align:center"><input type="text" style="color:blue; background:white" name="fc' . $i . '" size="2%" maxlength=1 pattern="I|J|R[^a-z]" title="Una letra:  J o I"></td>';
				for($j=1;$j<=$col;$j++){
					$num=$j.$i;
					$output=$output . '<td style="text-align:center"><input type="text" style="color:blue; background:white" name="ftr' . $num . '" size="2%" maxlength=1 pattern="I|J|R|P[^a-z]" title="Una letra:  J, I o R"></td>';
				}
				$output=$output . '</tr>';
			}//while
		}//if
		else{
			$error=true;
		}
		$output=$output . '</table></p>
		</fieldset></p>
		<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<input type="submit" value="Volver Atr&aacute;s" name="Atras" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<input type="submit" value="Grabar" name="Grabar" style="font-weight:bold; color:black">
		</p>
		<input type="hidden" name="tabla" value="' . $tabla . '"><input type="hidden" name="tramos" value="' . $col . '">
		<input type="hidden" name="conte" value="' . $conte . '"><input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc">
		<input type="hidden" name="idU" value="' . $id_U . '"><input type="hidden" name="annoa" value="' . $_POST["annoa"] . '">
		<input type="hidden" name="fechab" value="' .  $fechab . '"><input type="hidden" name="unidad" value="' . $_POST["unidad"] . '">
		</form>';
		if ($error){
			$output='<form id="formErrorAltaAsist1" action="" method="post" accept-charset="UTF-8" size="100%">
			<fieldset form="formErrorAltaAsist1"><p>
			<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend>
			<br>
			<p align="center">Error en la b&uacute;squeda, no existen registros para dar de alta, seg&uacute;n los datos seleccionados</p>
			<p align="center"><input type="submit" value="Aceptar" name="Cancelar" style="font-weight:bold; color:black"></p>
			<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"></p></fieldset></form>';
		}
	}//else
}elseif (isset($_POST["Grabar"])){
$error1=$error2=false;
$contd=$conttr=0;//776
$tr=[];
$conte=$_POST["conte"]; $col=$_POST["tramos"];$tabla=$_POST["tabla"];$idU=$_POST["idU"];$annoa=$_POST["annoa"];$fecha=$_POST["fechab"];
	for($i=1;$i<=$conte;$i++){
		if ($_POST["fc$i"]=="J" || $_POST["fc$i"]=="I"){
			$contd=$contd+1;
		}
		for($j=1;$j<=$col;$j++){
			if ($_POST["ftr$j$i"]=="J" || $_POST["ftr$j$i"]=="I" || $_POST["ftr$j$i"]=="R"){
				$conttr=$conttr+1;
			}		
		}

	}
	if ($contd==0 && $conttr==0){
	//VOLVER ATRAS
		$output='<form id="formErrorAltaAsist2" action="" method="post" accept-charset="UTF-8" size="100%">
		<fieldset form="formErrorAltaAsist2"><p>
		<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend><br>
		<p align="center"><b>Error al validar los datos de las faltas,</b></p>
		<p align="center"><b>todos los valores vac&iacute;os o los valores distintos: I, J o R.</b></p>
		<p align="center"><input type="submit" value="Continuar" name="Cancelar" style="font-weight:bold; color:black">
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"></p></fieldset></form>';
	}else{
		//CONVERTIR FECHA
		preg_match("/([0-9]{4})\-([0-9]{1,2})\-([0-9]{1,2})/", $_POST["fechab"], $nfecha);
		$fechaS=$nfecha[3] . "/" . $nfecha[2] . "/" . $nfecha[1];
		//GRABAR 813
		$output='<form id="formAltaAsist3" action="" method="post" accept-charset="UTF-8" size="100%">
		<fieldset form="formAltaAsist3"><p>
		<legend align="left"><SPAN style="text-align:top">Grabaci&oacute;n de Alta de Faltas de Asistencias</SPAN></legend>
		<br>
		<p align="left">&nbsp;&nbsp;&nbsp;Nuevas Altas realizadas satisfactoriamente en:</p>
		<p align="left">&nbsp;&nbsp;&nbsp;&nbsp;Unidad&nbsp;<b>'. $_POST["unidad"] . '</b></p>
		<p align="left">&nbsp;&nbsp;&nbsp;&nbsp;Fecha&nbsp;<b>'. $fechaS . '</b></p>
		<p align="left">&nbsp;&nbsp;&nbsp;&nbsp;Estudiantes<br>';
		for($i=1;$i<=$conte;$i++){
			//ID MATRICULA
			$ide=$_POST["id_est$i"];
			$sqle="SELECT id_matriculas FROM matriculas WHERE año_a='$annoa' AND id_est IN (SELECT id_est FROM estudiantes WHERE id_est='$ide')";
			$resulte=mysqli_query($conexion, $sqle);$rowe=mysqli_fetch_assoc($resulte);
			$idMat=$rowe["id_matriculas"];
			//FALTAS
			if ($_POST["fc$i"]=="J" || $_POST["fc$i"]=="I"){	
				$diaC=$_POST["fc$i"];
			}
			else{
				$diaC=0;
			}
			for($j=1;$j<=$col;$j++){
				if ((($_POST["ftr$j$i"]=="J") || ($_POST["ftr$j$i"]=="I") || ($_POST["ftr$j$i"]=="R")) && ($diaC=="")){
					$tr[$j]=$_POST["ftr$j$i"];	
				}elseif (($_POST["ftr$j$i"]=="") && ($diaC != "")){
					$tr[$j]=0;
				}elseif (($_POST["ftr$j$i"]=="") && ($diaC == "")){	
					$tr[$j]=0;
				}elseif (($_POST["ftr$j$i"]!="") && ($diaC != "")){
					$error2=true;
				}
			}
			//GRABAR
			if ($tabla=="f_asistencias" || $tabla=="f_asistencias_eso"){
				if (($diaC != "") || ($tr[1] != "") || ($tr[2] != "") || ($tr[3] != "") || ($tr[4] != "") || ($tr[5] != "") || ($tr[6] != "") || ($tr[7] != "")){		
					$sql1="INSERT INTO " . $tabla . " (ID_FASIST, ID_MATRICULA, ID_GRUPOSA, FECHA, DIA_C, TR1, TR2, TR3, TR4, TR5, TR6, TR7) VALUES (NULL, '$idMat', '$idU', '$fecha', '$diaC', '$tr[1]', '$tr[2]', '$tr[3]', '$tr[4]', '$tr[5]', '$tr[6]', '$tr[7]')";
					if (mysqli_query($conexion, $sql1)){
						$sql2="SELECT apellidos, nombre FROM estudiantes WHERE id_est='$ide'";
						$row2=mysqli_fetch_assoc(mysqli_query($conexion, $sql2));
						$output=$output . '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>' .  $row2["apellidos"] . ', ' . $row2["nombre"] . '</b><br>';
					}else{
						$error1=true;
					}
				}	
			}elseif ($tabla=="f_asistencias_b_c"){
				if (($diaC != "") || ($tr[1] != "") || ($tr[2] != "") || ($tr[3] != "") || ($tr[4] != "") || ($tr[5] != "") || ($tr[6] != "") || ($tr[7] != "") || ($tr[8] != "")){		
					$sql1="INSERT INTO " . $tabla . " (ID_FASIST, ID_MATRICULA, ID_GRUPOSA, FECHA, DIA_C, TR1, TR2, TR3, TR4, TR5, TR6, TR7, TR8) VALUES (NULL, '$idMat', '$idU', '$fecha', '$diaC', '$tr[1]', '$tr[2]', '$tr[3]', '$tr[4]', '$tr[5]', '$tr[6]', '$tr[7]', '$tr[8]')";
					if (mysqli_query($conexion, $sql1)){
						$sql2="SELECT apellidos, nombre FROM estudiantes WHERE id_est='$ide'";
						$row2=mysqli_fetch_assoc(mysqli_query($conexion, $sql2));
						$output=$output . '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>' .  $row2["apellidos"] . ', ' . $row2["nombre"] . '</b><br>';
					}else{
						$error1=true;
					}
				}	
			}//$tabla
		}//for
		$output=$output . '</p><p align="center"><input type="submit" value="Continuar" name="Continuar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<input type="submit" value="Salir" name="Salir" style="font-weight:bold; color:black"></p>
		</fieldset></p>
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"></p></fieldset></form>';
		
		if ($error1){
			$output='<form id="formErrorAltaAsist4" action="" method="post" accept-charset="UTF-8" size="100%">
			<fieldset form="formErrorAltaAsist4"><p>
			<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend>
			<br>
			<p align="center">Error en la grabaci&oacute;n de datos para las altas de faltas de asistencia, de datos seleccionados.</p>
			<p align="center"><em>Unidad:&nbsp;</em><b>' . $_POST["unidad"] . '</b></p>
			<p align="center"><em>Fecha:&nbsp;</em><b>' . $fechaS . '</b></p>
			<p align="center"><input type="submit" value="Aceptar" name="Cancelar" style="font-weight:bold; color:black"></p>
			<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"></p></fieldset></form>';
			$output=$output . '<br><p><font color="red">'. mysqli_error($conexion) . '</font></p>';
			//BORRAR ALGÚN ALTA
			$sql3="DELETE FROM " . $tabla . " WHERE fecha='$fecha' AND id_gruposa='$idU'";
		 	$result3=mysqli_query($conexion, $sql13);//897
		}
		if ($error2){
			$output='<form id="formErrorAltaAsist3" action="" method="post" accept-charset="UTF-8" size="100%">
			<fieldset form="formErrorAltaAsist3"><p>
			<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend><br>
			<p align="center"><b>Error al poner los datos de las faltas,</b></p>
			<p align="center"><b>no pueden existir faltas en d&iacute;a completo y en tramos horarios del mismo estudiante.</b></p>
			<p align="center"><input type="submit" value="Continuar" name="Cancelar" style="font-weight:bold; color:black">
			<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"></p></fieldset></form>';
		}
	}//else
}

mysqli_close($conexion);
return($output);
}/********************** end alta_asistencia *************************************/


/***************************** Modificar Asistencia *******************************/
function modificar_asistencia(){
$output="";
$conexion=bdexternaD();
GLOBAL $user, $emailDoc;
$error=false;

if ((!$_POST || isset($_POST["Salir"])) && ($user->name == "alillo")){
	//Identificacion
	$output=identificacion("asistencia");
}elseif (!$_POST || isset($_POST["SiguienteA"]) || isset($_POST["Continuar"]) || isset($_POST["Atras"]) || isset($_POST["Cancelar"])){
  if (!$_POST || isset($_POST["SiguienteA"])){
	if ($user->name == "alillo"){
		$emailDoc=$_POST["email"];
	}else{//1185
		$emailDoc=$user->mail;//$_POST["password"]=$user->pass;
	}
	$sql="SELECT * FROM docentes WHERE email='$emailDoc' AND id_docentes IN (SELECT id_docente FROM asignaturas WHERE tutor=1)";
	$result=mysqli_query($conexion, $sql);
	if ((mysqli_num_rows($result) == 1)){//1190
		while($row=mysqli_fetch_assoc($result)){
			$output=seleccion_asistencia("formModAsist1", $row["ID_DOCENTES"]);
	
		}//while
		$error=false;
	}else{
		$error=true;
	}
  }else{
  	$id_doc=$_POST["idDoc"];
  	$output=seleccion_asistencia("formModAsist1", $id_doc);//935
  	$error=false;
  }
  if ($error){
	$output='<form id="formBajaAsistValidar" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formBajaAsistValidar">
	<legend align="left"><SPAN style="text-align:top">Mensaje de Atenci&oacute;n</SPAN></legend>
	<br><br>
	<p align="center">Los datos introducidos no son correctos: (email) o no tiene acceso a este apartado.</p>
	<p align="center"><input type="button" onclick="history.back()" value="Volver a intentarlo" name="Volver Atras" style="font-weight:bold; color:black"></p>
	</fieldset></p>
	</form><br>';
  }

}elseif (isset($_POST["Siguiente2"])){
$tr=[];
	//MOSTRAR LISTADO DEL DÍA CON FALTAS DE ASISTENCIA SI EXISTE
	$nombU=$_POST["unidad"];
	//BUSCAR TIPO DE UNIDAD (CURSO)
	$sqlg="SELECT id_gruposa FROM grupos_a WHERE nombre='$nombU'";
	$resulg=mysqli_query($conexion, $sqlg);$rowg=mysqli_fetch_assoc($resulg);
	$id_U=$rowg["id_gruposa"];
	$sqlc="SELECT id_ciclo FROM ciclos WHERE id_ciclo IN (SELECT id_ciclo FROM cursos WHERE id_curso IN (SELECT id_curso FROM grupos_a WHERE id_gruposa='$id_U'))";
	$resulc=mysqli_query($conexion, $sqlc);$rowc=mysqli_fetch_assoc($resulc);
	switch($rowc["id_ciclo"]){
		case 3:
			$col=7;
			$tabla="f_asistencias";
			$tr[1]="9:15 10:00";$tr[2]="10:00 10:45";$tr[3]="10:45 11:30";$tr[4]="11:30 12:00";
			$tr[5]="12:00 12:45";$tr[6]="12:45 13:30";$tr[7]="13:30 14:15";
			break;
		case 4:
			$col=7;
			$tabla="f_asistencias";
			$tr[1]="9:15 10:00";$tr[2]="10:00 10:45";$tr[3]="10:45 11:30";$tr[4]="11:30 12:00";
			$tr[5]="12:00 12:45";$tr[6]="12:45 13:30";$tr[7]="13:30 14:15";
			break;
		case 5:
			$col=7;
			$tabla="f_asistencias_eso";
			$tr[1]="8:00 9:00";$tr[2]="9:00 10:00";$tr[3]="10:00 11:00";$tr[4]="11:00 11:30";
			$tr[5]="11:30 12:30";$tr[6]="12:30 13:30";$tr[7]="13:30 14:30";
			break;
		case 6:
			$col=7;
			$tabla="f_asistencias_eso";
			$tr[1]="8:00 9:00";$tr[2]="9:00 10:00";$tr[3]="10:00 11:00";$tr[4]="11:00 11:30";
			$tr[5]="11:30 12:30";$tr[6]="12:30 13:30";$tr[7]="13:30 14:30";
			break;
		case 7:
			$col=8;
			$tabla="f_asistencias_b_c";
			$tr[1]="8:00 9:00";$tr[2]="9:00 10:00";$tr[3]="10:00 11:00";$tr[4]="11:00 11:30";
			$tr[5]="11:30 12:30";$tr[6]="12:30 13:30";$tr[7]="13:30 14:30";$tr[8]="14:30 15:30";
			break;
		case 8:
			$col=8;
			$tabla="f_asistencias_b_c";
			$tr[1]="8:00 9:00";$tr[2]="9:00 10:00";$tr[3]="10:00 11:00";$tr[4]="11:00 11:30";
			$tr[5]="11:30 12:30";$tr[6]="12:30 13:30";$tr[7]="13:30 14:30";$tr[8]="14:30 15:30";
			break;
	}
	
	//MONTAR FECHA
	$fecha=montar_fecha($_POST["mes"], $_POST["dia"], $_POST["ano"]);
	preg_match("/([0-9]{1,2})\/([0-9]{1,2})\/([0-9]{4})/", $fecha, $nfecha);
	$fechab=$nfecha[3] . "-" . $nfecha[2] . "-" . $nfecha[1];
	//BUSCAR FECHA EN ASISTENCIAS
	$sqla="SELECT * FROM ". $tabla . " WHERE id_gruposa='$id_U' AND fecha='$fechab'";
	$resulta=mysqli_query($conexion, $sqla);
	if (mysqli_num_rows($resulta) > 0){
		$output='<form id="formModiAsist2" action="" method="post" accept-charset="UTF-8" size="100%">
		<p>
		<fieldset form="formModAsist2">
		<legend align="left"><SPAN style="text-align:top">Falta de Asistencias de Unidad en una Fecha</SPAN></legend>
        	<br><br>
		<p align="left">&emsp;&emsp;<b>A&ntilde;o Acad&eacute;mico:&nbsp;</b><input type="text" name="annoa" value="' . $_POST["annoa"] .'" size="12%" disabled>
		&emsp;&emsp;<b>Fecha:&nbsp;</b><input type="date" name="fecha" value="' . $fecha . '" disabled></p><input type="hidden" name="fechab" value="'. $fechab . '">
		<p align="left"><b>&emsp;&emsp;Unidad de Tutor:&nbsp;</b><input type="text" name="unidad" value="' . $_POST["unidad"] .'" size="50%" disabled></p>
		<p align="center"><b>Faltas de Asistencia de una Unidad en una Fecha</b></p>
		<p align="center"><table border="2"><tr><th rowspan=2  width="30%" style="text-align:center"><font size="3">Estudiante</font></th><th rowspan=2 width="5%" style="text-align:center"><font size="3">D&iacute;a Entero</font></th>
		<th colspan='. $col .' width="75%"style="text-align:center"><font size="3">Tramo Horario de ' . $fecha . '</font></th></tr><tr>';
		for ($i=1;$i<=$col;$i++){
			$output=$output . '<th style="text-align:center"><font size="2">' . $tr[$i] . '</font></th>';
		}//for
		$output=$output . '</tr>';
		
		$A=$_POST["annoa"];
		$sqle="SELECT nombre, apellidos, id_est FROM estudiantes WHERE id_est IN (SELECT id_est FROM matriculas WHERE año_a='$A' AND id_matriculas IN (SELECT id_matriculas FROM detalle_matricula WHERE id_gruposa='$id_U'))";
		$resulte=mysqli_query($conexion, $sqle);$conte=mysqli_num_rows($resulte);
		if (mysqli_num_rows($resulte)>0){
			$i=0;
			while($rowe=mysqli_fetch_array($resulte)){
				$i=$i+1;
				$ide=$rowe["id_est"];
				$sqlm="SELECT id_matriculas FROM matriculas WHERE id_est='$ide' AND año_a='$A'";
				$rowm=mysqli_fetch_assoc(mysqli_query($conexion, $sqlm));
				$idM=$rowm["id_matriculas"];
				$output=$output . '<tr><td style="text-align:center"><font size="2" color="blue">' . $rowe["apellidos"] . ', ' . $rowe["nombre"] . '</font></td><input type="hidden" name="id_est' . $i . '" value="' . $ide . '">';
				$sqlA="SELECT * FROM ". $tabla . " WHERE id_matricula='$idM' AND fecha='$fechab'";
				$resultA=mysqli_query($conexion, $sqlA);
				if (mysqli_num_rows($resultA)>0){
					$rowA=mysqli_fetch_assoc($resultA);
				}else{
					$rowA["ID_MATRICULA"]=0;
				}
				if (($rowm["id_matriculas"])==($rowA["ID_MATRICULA"])){
					if (($rowA["DIA_C"]=="J") || ($rowA["DIA_C"]=="I")){
						$output=$output . '<td style="text-align:center"><input type="text" style="color:blue; background:white" name="fc' . $i . '" size="2%" value="' . $rowA["DIA_C"] . '" maxlength=1 pattern="I|J|R[^a-z]" title="Una letra:  J o I"></td>';
					}else{
						$output=$output . '<td style="text-align:center"><input type="text" style="color:blue; background:white" name="fc' . $i . '" size="2%" maxlength=1 pattern="I|J|R[^a-z]" title="Una letra:  J o I"></td>';
					}
					for($j=1;$j<=$col;$j++){
						$num=$j.$i;
						if (($rowA["TR$j"]=="R") || ($rowA["TR$j"]=="J") || ($rowA["TR$j"]=="I")){		
							$output=$output . '<td style="text-align:center"><input type="text" style="color:blue; background:white" name="ftr' . $num . '" size="2%" value="' . $rowA["TR$j"] . '" maxlength=1 pattern="I|J|R|P[^a-z]" title="Una letra:  J, I o R"></td>';
						}else{
							$output=$output . '<td style="text-align:center"><input type="text" style="color:blue; background:white" name="ftr' . $num . '" size="2%" maxlength=1 pattern="I|J|R|P[^a-z]" title="Una letra:  J, I o R"></td>';
						}
					}
				}else{
					$output=$output . '<td style="text-align:center"><input type="text" style="color:blue; background:white" name="fc' . $i . '" size="2%" maxlength=1 pattern="I|J|R[^a-z]" title="Una letra:  J o I"></td>';
					for($j=1;$j<=$col;$j++){
						$num=$j.$i;			
						$output=$output . '<td style="text-align:center"><input type="text" style="color:blue; background:white" name="ftr' . $num . '" size="2%" maxlength=1 pattern="I|J|R|P[^a-z]" title="Una letra:  J, I o R"></td>';
					}
				}
		
				$output=$output . '</tr>';
			}//while
		}//if
		$output=$output . '</table></p>
		</fieldset></p>
		<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<input type="submit" value="Volver Atr&aacute;s" name="Atras" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<input type="submit" value="Grabar" name="Grabar" style="font-weight:bold; color:black">
		</p>
		<input type="hidden" name="tabla" value="' . $tabla . '"><input type="hidden" name="tramos" value="' . $col . '">
		<input type="hidden" name="conte" value="' . $conte . '"><input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc">
		<input type="hidden" name="idU" value="' . $id_U . '"><input type="hidden" name="annoa" value="' . $_POST["annoa"] . '">
		<input type="hidden" name="fechab" value="' .  $fechab . '"><input type="hidden" name="unidad" value="' . $_POST["unidad"] . '">
		</form>';
	}else{
		$output='<form id="formErrorModAsist1" action="" method="post" accept-charset="UTF-8" size="100%">
		<fieldset form="formErrorBajaAsist1"><p>
		<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend>
		<br>
		<p align="center">Error en la b&uacute;squeda de faltas de asistencias o no existen registros,</p>
		<p align="center"> para la fecha&nbsp;<b>' . $fecha . '</b>&nbsp;en la unidad&nbsp;<b>' . $nombU . '</b>.</p>
		<p align="center"><input type="submit" value="Aceptar" name="Cancelar" style="font-weight:bold; color:black"></p>
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc">
		</p></fieldset></form>';		
	}

}elseif (isset($_POST["Grabar"])){
$error1=$error2=false;
$contd=$conttr=0;
$tr=[];
$conte=$_POST["conte"]; $col=$_POST["tramos"];$tabla=$_POST["tabla"];$idU=$_POST["idU"];$annoa=$_POST["annoa"];$fecha=$_POST["fechab"];
	for($i=1;$i<=$conte;$i++){
		if ($_POST["fc$i"]=="J" || $_POST["fc$i"]=="I"){
			$contd=$contd+1;
		}
		for($j=1;$j<=$col;$j++){
			if ($_POST["ftr$j$i"]=="J" || $_POST["ftr$j$i"]=="I" || $_POST["ftr$j$i"]=="R"){
				$conttr=$conttr+1;
			}		
		}

	}
	if ($contd==0 && $conttr==0){
	//VOLVER ATRAS
		$output='<form id="formErrorModAsist2" action="" method="post" accept-charset="UTF-8" size="100%">
		<fieldset form="formErrorModAsist2"><p>
		<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend><br>
		<p align="center"><b>Error al poner los datos de las faltas,</b></p>
		<p align="center"><b>todos los valores vac&iacute;os o los valores distintos: I, J o R.</b></p>
		<p align="center"><b>No se ha realizado ninguna modificaci&oacute;n.</b></p>
		<p align="center"><input type="submit" value="Continuar" name="Cancelar" style="font-weight:bold; color:black">
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"></p></fieldset></form>';
	
	}else{
		//CONVERTIR FECHA
		preg_match("/([0-9]{4})\-([0-9]{1,2})\-([0-9]{1,2})/", $_POST["fechab"], $nfecha);
		$fechaS=$nfecha[3] . "/" . $nfecha[2] . "/" . $nfecha[1];
		//GRABAR
		$output='<form id="formModAsist3" action="" method="post" accept-charset="UTF-8" size="100%">
		<fieldset form="formModAsist3"><p>
		<legend align="left"><SPAN style="text-align:top">Actualizaci&oacute;n de Faltas de Asistencia</SPAN></legend>
		<br>
		<p align="center">Cambios realizados en las faltas de asisencia se han grabado satisfactoriamente en:</p>
		<p align="left">&emsp;&emsp;&emsp;&emsp;Unidad&nbsp;<b>'. $_POST["unidad"] . '</b></p>
		<p align="left">&emsp;&emsp;&emsp;&emsp;Fecha&nbsp;<b>'. $fechaS . '</b></p>
		<p align="left">&emsp;&emsp;&emsp;&emsp;Estudiantes<br>';
		for($i=1;$i<=$conte;$i++){
			//ID MATRICULA
			$ide=$_POST["id_est$i"];
			$sqle="SELECT id_matriculas FROM matriculas WHERE año_a='$annoa' AND id_est IN (SELECT id_est FROM estudiantes WHERE id_est='$ide')";
			$resulte=mysqli_query($conexion, $sqle);$rowe=mysqli_fetch_assoc($resulte);
			$idMat=$rowe["id_matriculas"];
			//FALTAS
			if ($_POST["fc$i"]=="J" || $_POST["fc$i"]=="I"){	
				$diaC=$_POST["fc$i"];
			}
			else{
				$diaC=0;
			}
			for($j=1;$j<=$col;$j++){
				if ((($_POST["ftr$j$i"]=="J") || ($_POST["ftr$j$i"]=="I") || ($_POST["ftr$j$i"]=="R")) && ($diaC=="")){
					$tr[$j]=$_POST["ftr$j$i"];	
				}elseif (($_POST["ftr$j$i"]=="") && ($diaC != "")){
					$tr[$j]=0;
				}elseif (($_POST["ftr$j$i"]=="") && ($diaC == "")){	
					$tr[$j]=0;
				}elseif (($_POST["ftr$j$i"]!="") && ($diaC != "")){
					$error2=true;
				}	
			}
			$sqlA="SELECT * FROM " . $tabla . " WHERE id_matricula='$idMat' AND fecha='$fecha' AND id_gruposa='$idU'";
			$resultA=mysqli_query($conexion, $sqlA);$contA=mysqli_num_rows($resultA);
			if ($contA>0){//1164 
				$rowA=mysqli_fetch_assoc($resultA);
			}else{
				$rowA["ID_MATRICULA"]=0;
			}
			if ($tabla=="f_asistencias" || $tabla=="f_asistencias_eso"){
				if (($diaC != "") || ($tr[1] != "") || ($tr[2] != "") || ($tr[3] != "") || ($tr[4] != "") || ($tr[5] != "") || ($tr[6] != "") || ($tr[7] != "")){		
					if ($idMat==$rowA["ID_MATRICULA"]){
						$sql1="UPDATE " . $tabla . " SET DIA_C='$diaC', TR1='$tr[1]', TR2='$tr[2]', TR3='$tr[3]', TR4='$tr[4]', TR5='$tr[5]', TR6='$tr[6]', TR7='$tr[7]' WHERE ID_MATRICULA='$idMat' AND ID_GRUPOSA='$idU' AND FECHA='$fecha'"; 
						if (mysqli_query($conexion, $sql1)){
							$sql2="SELECT apellidos, nombre FROM estudiantes WHERE id_est='$ide'";
							$row2=mysqli_fetch_assoc(mysqli_query($conexion, $sql2));
							$output=$output . '&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<b>' . $row2["apellidos"] . ', ' . $row2["nombre"] . '</b><br>';
						}else{
							$error1=true;
						}
					}elseif ($rowA["ID_MATRICULA"]==0){
						$sql1="INSERT INTO " . $tabla . " (ID_FASIST, ID_MATRICULA, ID_GRUPOSA, FECHA, DIA_C, TR1, TR2, TR3, TR4, TR5, TR6, TR7) VALUES (NULL, '$idMat', '$idU', '$fecha', '$diaC', '$tr[1]', '$tr[2]', '$tr[3]', '$tr[4]', '$tr[5]', '$tr[6]', '$tr[7]')";
						if (mysqli_query($conexion, $sql1)){
							$sql2="SELECT apellidos, nombre FROM estudiantes WHERE id_est='$ide'";
							$row2=mysqli_fetch_assoc(mysqli_query($conexion, $sql2));
							$output=$output . '&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<b>' . $row2["apellidos"] . ', ' . $row2["nombre"] . '</b><br>';
						}else{
							$error1=true;
						}
					}
				}elseif (($diaC == "") && ($tr[1] == "")  && ($tr[2] == "")  && ($tr[3] == "") && ($tr[4] == "")  && ($tr[5] == "")  && ($tr[6] == "")  && ($tr[7] == "")){
					if ($idMat==$rowA["ID_MATRICULA"]){
						$sql1="DELETE FROM " . $tabla . " WHERE id_matricula='$idMat' AND fecha='$fecha' AND id_gruposa='$idU'";
						if (mysqli_query($conexion, $sql1)){
							$sql2="SELECT apellidos, nombre FROM estudiantes WHERE id_est='$ide'";
							$row2=mysqli_fetch_assoc(mysqli_query($conexion, $sql2));
							$output=$output . '&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<b>' . $row2["apellidos"] . ', ' . $row2["nombre"] . '</b><br>';
						}else{
							$error1=true;
						}
					}
				}
				
			}else{
			  	if (($diaC != "") || ($tr[1] != "") || ($tr[2] != "") || ($tr[3] != "") || ($tr[4] != "") || ($tr[5] != "") || ($tr[6] != "") || ($tr[7] != "") || ($tr[8] != "")){		
					if ($idMat==$rowA["ID_MATRICULA"]){
						$sql1="UPDATE " . $tabla . " SET DIA_C='$diaC', TR1='$tr[1]', TR2='$tr[2]', TR3='$tr[3]', TR4='$tr[4]', TR5='$tr[5]', TR6='$tr[6]', TR7='$tr[7], TR8='$tr[8]' WHERE ID_MATRICULA='$idMat' AND ID_GRUPOSA='$idU' AND FECHA='$fecha'";
						if (mysqli_query($conexion, $sql1)){
							$sql2="SELECT apellidos, nombre FROM estudiantes WHERE id_est='$ide'";
							$row2=mysqli_fetch_assoc(mysqli_query($conexion, $sql2));
							$output=$output . '&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<b>' . $row2["apellidos"] . ', ' . $row2["nombre"] . '</b><br>';
						}else{
							$error1=true;
						}
					}elseif ($rowA["ID_MATRICULA"]==0){{
						$sql1="INSERT INTO " . $tabla . " (ID_FASIST, ID_MATRICULA, ID_GRUPOSA, FECHA, DIA_C, TR1, TR2, TR3, TR4, TR5, TR6, TR7, TR8) VALUES (NULL, '$idMat', '$idU', '$fecha', '$diaC', '$tr[1]', '$tr[2]', '$tr[3]', '$tr[4]', '$tr[5]', '$tr[6]', '$tr[7]', '$tr[8]')";
						if (mysqli_query($conexion, $sql1)){
							$sql2="SELECT apellidos, nombre FROM estudiantes WHERE id_est='$ide'";
							$row2=mysqli_fetch_assoc(mysqli_query($conexion, $sql2));
							$output=$output . '&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<b>' . $row2["apellidos"] . ', ' . $row2["nombre"] . '</b><br>';
						}else{
							$error1=true;
						}
					}
				}elseif (($diaC == "") && ($tr[1] == "")  && ($tr[2] == "")  && ($tr[3] == "") && ($tr[4] == "")  && ($tr[5] == "")  && ($tr[6] == "")  && ($tr[7] == "")){
					if ($idMat==$rowA["ID_MATRICULA"]){
						$sql1="DELETE FROM " . $tabla . " WHERE id_matricula='$idMat' AND fecha='$fecha' AND id_gruposa='$idU'";
						if (mysqli_query($conexion, $sql1)){
							$sql2="SELECT apellidos, nombre FROM estudiantes WHERE id_est='$ide'";
							$row2=mysqli_fetch_assoc(mysqli_query($conexion, $sql2));
							$output=$output . '&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<b>' . $row2["apellidos"] . ', ' . $row2["nombre"] . '</b><br>';
						}else{
							$error1=true;
						}
					}
				}
			  }	
			}//$tabla
				
		}//for
		
		$output=$output .'</p><p align="center"><input type="submit" value="Continuar" name="Continuar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<input type="submit" value="Salir" name="Salir" style="font-weight:bold; color:black"></p>
		</fieldset></p>
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"></p></fieldset></form>';
		if ($error1){
			$output='<form id="formErrorModAsist3" action="" method="post" accept-charset="UTF-8" size="100%">
			<fieldset form="formErrorModAsist3"><p>
			<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend>
			<br>
			<p align="center">Error en la grabaci&oacute;n de datos para los cambios de faltas de asistencia, de datos seleccionados.</p>
			<p align="center"><em>Unidad:&nbsp;</em><b>' . $_POST["unidad"] . '</b></p>
			<p align="center"><em>Fecha:&nbsp;</em><b>' . $fechaS . '</b></p>
			<p align="center"><input type="submit" value="Aceptar" name="Cancelar" style="font-weight:bold; color:black"></p>
			<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"></p></fieldset></form>';
			$output=$output . '<br><p><font color="red">'. mysqli_error($conexion) . '</font></p>';
		}
		if ($error2){
			$output='<form id="formErrorAltaAsist4" action="" method="post" accept-charset="UTF-8" size="100%">
			<fieldset form="formErrorAltaAsist4"><p>
			<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend><br>
			<p align="center"><b>Error al poner los datos de las faltas,</b></p>
			<p align="center"><b>no pueden existir faltas en d&iacute;a completo y en tramos horarios del mismo estudiante.</b></p>
			<p align="center"><input type="submit" value="Continuar" name="Cancelar" style="font-weight:bold; color:black">
			<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"></p></fieldset></form>';
		}
	}//else	
}     
     
mysqli_close($conexion);
return($output);
}/********************** end modificar_asistencia **********************************/


/******************************* Baja Asistencia ************************************/
function baja_asistencia(){
$output="";
$conexion=bdexternaD();
GLOBAL $user, $emailDoc;
$error=false;

if ((!$_POST || isset($_POST["Salir"])) && ($user->name == "alillo")){
	//Identificacion
	$output=identificacion("asistencia");
}elseif (!$_POST || isset($_POST["SiguienteA"]) || isset($_POST["Continuar"]) || isset($_POST["Atras"]) || isset($_POST["Cancelar"])){
  if (!$_POST || isset($_POST["SiguienteA"])){
	if ($user->name == "alillo"){
		$emailDoc=$_POST["email"];
	}else{//1185
		$emailDoc=$user->mail;//$_POST["password"]=$user->pass;
	}
	$sql="SELECT * FROM docentes WHERE email='$emailDoc' AND id_docentes IN (SELECT id_docente FROM asignaturas WHERE tutor=1)";
	$result=mysqli_query($conexion, $sql);
	if ((mysqli_num_rows($result) == 1)){//1190
		while($row=mysqli_fetch_assoc($result)){
			$output=seleccion_asistencia("formBajaAsist1", $row["ID_DOCENTES"]);
	
		}//while
		$error=false;
	}else{
		$error=true;
	}
  }else{
  	$id_doc=$_POST["idDoc"];
  	$output=seleccion_asistencia("formBajaAsist1", $id_doc);//935
  	$error=false;
  }
  if ($error){
	$output='<form id="formBajaAsistValidar" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formBajaAsistValidar">
	<legend align="left"><SPAN style="text-align:top">Mensaje de Atenci&oacute;n</SPAN></legend>
	<br><br>
	<p align="center">Los datos introducidos no son correctos: (email) o no tiene acceso a este apartado.</p>
	<p align="center"><input type="button" onclick="history.back()" value="Volver a intentarlo" name="Volver Atras" style="font-weight:bold; color:black"></p>
	</fieldset></p>
	</form><br>';
  }

}elseif (isset($_POST["Siguiente2"])){
$tr=[];
	//MOSTRAR LISTADO DEL DÍA CON FALTAS DE ASISTENCIA SI EXISTE
	$nombU=$_POST["unidad"];
	//BUSCAR TIPO DE UNIDAD (CURSO)
	$sqlg="SELECT id_gruposa FROM grupos_a WHERE nombre='$nombU'";
	$resulg=mysqli_query($conexion, $sqlg);$rowg=mysqli_fetch_assoc($resulg);
	$id_U=$rowg["id_gruposa"];
	$sqlc="SELECT id_ciclo FROM ciclos WHERE id_ciclo IN (SELECT id_ciclo FROM cursos WHERE id_curso IN (SELECT id_curso FROM grupos_a WHERE id_gruposa='$id_U'))";
	$resulc=mysqli_query($conexion, $sqlc);$rowc=mysqli_fetch_assoc($resulc);
	switch($rowc["id_ciclo"]){
		case 3:
			$col=7;
			$tabla="f_asistencias";
			$tr[1]="9:15 10:00";$tr[2]="10:00 10:45";$tr[3]="10:45 11:30";$tr[4]="11:30 12:00";
			$tr[5]="12:00 12:45";$tr[6]="12:45 13:30";$tr[7]="13:30 14:15";
			break;
		case 4:
			$col=7;
			$tabla="f_asistencias";
			$tr[1]="9:15 10:00";$tr[2]="10:00 10:45";$tr[3]="10:45 11:30";$tr[4]="11:30 12:00";
			$tr[5]="12:00 12:45";$tr[6]="12:45 13:30";$tr[7]="13:30 14:15";
			break;
		case 5:
			$col=7;
			$tabla="f_asistencias_eso";
			$tr[1]="8:00 9:00";$tr[2]="9:00 10:00";$tr[3]="10:00 11:00";$tr[4]="11:00 11:30";
			$tr[5]="11:30 12:30";$tr[6]="12:30 13:30";$tr[7]="13:30 14:30";
			break;
		case 6:
			$col=7;
			$tabla="f_asistencias_eso";
			$tr[1]="8:00 9:00";$tr[2]="9:00 10:00";$tr[3]="10:00 11:00";$tr[4]="11:00 11:30";
			$tr[5]="11:30 12:30";$tr[6]="12:30 13:30";$tr[7]="13:30 14:30";
			break;
		case 7:
			$col=8;
			$tabla="f_asistencias_b_c";
			$tr[1]="8:00 9:00";$tr[2]="9:00 10:00";$tr[3]="10:00 11:00";$tr[4]="11:00 11:30";
			$tr[5]="11:30 12:30";$tr[6]="12:30 13:30";$tr[7]="13:30 14:30";$tr[8]="14:30 15:30";
			break;
		case 8:
			$col=8;
			$tabla="f_asistencias_b_c";
			$tr[1]="8:00 9:00";$tr[2]="9:00 10:00";$tr[3]="10:00 11:00";$tr[4]="11:00 11:30";
			$tr[5]="11:30 12:30";$tr[6]="12:30 13:30";$tr[7]="13:30 14:30";$tr[8]="14:30 15:30";
			break;
	}
	
	//MONTAR FECHA
	$fecha=montar_fecha($_POST["mes"], $_POST["dia"], $_POST["ano"]);
	preg_match("/([0-9]{1,2})\/([0-9]{1,2})\/([0-9]{4})/", $fecha, $nfecha);
	$fechab=$nfecha[3] . "-" . $nfecha[2] . "-" . $nfecha[1];
	//BUSCAR FECHA EN ASISTENCIAS
	$sqla="SELECT * FROM ". $tabla . " WHERE id_gruposa='$id_U' AND fecha='$fechab'";
	$resulta=mysqli_query($conexion, $sqla);
	if (mysqli_num_rows($resulta) > 0){
		$output='<form id="formBajaAsist2" action="" method="post" accept-charset="UTF-8" size="100%">
		<p>
		<fieldset form="formBajaAsist2">
		<legend align="left"><SPAN style="text-align:top">Falta de Asistencias de Unidad en una Fecha</SPAN></legend>
        	<br><br>
		<p align="left">&emsp;&emsp;<b>A&ntilde;o Acad&eacute;mico:&nbsp;</b><input type="text" name="annoa" value="' . $_POST["annoa"] .'" size="12%" disabled>
		&emsp;&emsp;<b>Fecha:&nbsp;</b><input type="date" name="fecha" value="' . $fecha . '" disabled></p><input type="hidden" name="fechab" value="'. $fechab . '">
		<p align="left"><b>&emsp;&emsp;Unidad de Tutor:&nbsp;</b><input type="text" name="unidad" value="' . $_POST["unidad"] .'" size="50%" disabled></p>
		<p align="center"><b>Faltas de Asistencia de una Unidad en una Fecha</b></p>
		<p align="center"><table border="2"><tr><th rowspan=2  width="30%" style="text-align:center"><font size="3">Estudiante</font></th><th rowspan=2 width="5%" style="text-align:center"><font size="3">D&iacute;a Entero</font></th>
		<th colspan='. $col .' width="75%"style="text-align:center"><font size="3">Tramo Horario de ' . $fecha . '</font></th></tr><tr>';
		for ($i=1;$i<=$col;$i++){
			$output=$output . '<th style="text-align:center"><font size="2">' . $tr[$i] . '</font></th>';
		}//for
		$output=$output . '</tr>';
		
		$A=$_POST["annoa"];
		$sqle="SELECT nombre, apellidos, id_est FROM estudiantes WHERE id_est IN (SELECT id_est FROM matriculas WHERE año_a='$A' AND id_matriculas IN (SELECT id_matriculas FROM detalle_matricula WHERE id_gruposa='$id_U'))";
		$resulte=mysqli_query($conexion, $sqle);$conte=mysqli_num_rows($resulte);//$rowe=mysqli_fetch_assoc($resulte);
		if ((mysqli_num_rows($resulte)>0)){
			$error=false;$i=0;
			while($rowe=mysqli_fetch_array($resulte)){// ($rowa=mysqli_fetch_assoc($resulta))){
				$i=$i+1;$ide=$rowe["id_est"];
				$sqlm="SELECT id_matriculas FROM matriculas WHERE id_est='$ide' AND año_a='$A'";
				$rowm=mysqli_fetch_assoc(mysqli_query($conexion, $sqlm));
				$idM=$rowm["id_matriculas"];
				$output=$output . '<tr><td style="text-align:center"><font size="2" color="blue">' . $rowe["apellidos"] . ', ' . $rowe["nombre"] . '</font></td>';
				$sqlA="SELECT * FROM ". $tabla . " WHERE id_matricula='$idM' AND fecha='$fechab' AND id_gruposa='$id_U'";
				$rowA=mysqli_fetch_assoc(mysqli_query($conexion, $sqlA));
				//$output=$output . '<tr><td style="text-align:center"><font size="2" color="blue">' . $rowm["id_matriculas"] . ', ' . $rowe["nombre"] . ',' . $rowA["ID_MATRICULA"] . '</font></td>';
					if ($rowm["id_matriculas"]==$rowA["ID_MATRICULA"]){
						if ($rowA["DIA_C"]=="J" || $rowA["DIA_C"]=="I"){
							$output=$output . '<td style="text-align:center"><input type="text" disabled style="color:blue; background:white" name="fc' . $i . '" size="2%" value="' . $rowA["DIA_C"] . '"></td>';
						}else{
							$output=$output . '<td style="text-align:center"><input type="text" disabled style="color:blue; background:white" name="fc' . $i . '" size="2%" ></td>';
						}
						for($j=1;$j<=$col;$j++){
							$num=$j.$i;
							if ($rowA["TR$j"]=="R" || $rowA["TR$j"]=="J" || $rowA["TR$j"]=="I"){		
								$output=$output . '<td style="text-align:center"><input type="text" disabled style="color:blue; background:white" name="ftr' . $num . '" size="2%" value="' . $rowA["TR$j"] . '"></td>';
							}else{
								$output=$output . '<td style="text-align:center"><input type="text" disabled style="color:blue; background:white" name="ftr' . $num . '" size="2%"></td>';
							}
						}

					}else{
						$output=$output . '<td style="text-align:center"><input type="text" disabled style="color:blue; background:white" name="fc' . $i . '" size="2%" maxlength=1></td>';
						for($j=1;$j<=$col;$j++){
							$num=$j.$i;			
							$output=$output . '<td style="text-align:center"><input type="text" disabled style="color:blue; background:white" name="ftr' . $num . '" size="2%" maxlength=1"></td>';
						}
					}
				
				$output=$output . '</tr>';
			}//while
		}//if
		$output=$output . '</table></p>
		</fieldset></p>
		<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<input type="submit" value="Volver Atr&aacute;s" name="Atras" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<input type="submit" value="Eliminar" name="Eliminar" style="font-weight:bold; color:black">
		</p>
		<input type="hidden" name="tabla" value="' . $tabla . '"><input type="hidden" name="tramos" value="' . $col . '">
		<input type="hidden" name="conte" value="' . $conte . '"><input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc">
		<input type="hidden" name="idU" value="' . $id_U . '"><input type="hidden" name="annoa" value="' . $_POST["annoa"] . '">
		<input type="hidden" name="fechab" value="' .  $fechab . '"><input type="hidden" name="unidad" value="' . $_POST["unidad"] . '">
		</form>';
	}else{
		$output='<form id="formErrorBajaAsist1" action="" method="post" accept-charset="UTF-8" size="100%">
		<fieldset form="formErrorBajaAsist1"><p>
		<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend>
		<br>
		<p align="center">Error en la b&uacute;squeda de faltas de asistencias o no existen registros,</p>
		<p align="center"> para la fecha&nbsp;<b>' . $fecha . '</b>&nbsp;en la unidad&nbsp;<b>' . $nombU . '</b>.</p>
		<p align="center"><input type="submit" value="Aceptar" name="Cancelar" style="font-weight:bold; color:black"></p>
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc">
		</p></fieldset></form>';		
	}
}elseif (isset($_POST["Eliminar"])){
	preg_match("/([0-9]{4})\-([0-9]{1,2})\-([0-9]{1,2})/",$_POST["fechab"], $nfecha);
	$fecha=$nfecha[3] . "/" . $nfecha[2] . "/" . $nfecha[1];
	$output='<form id="formConfirmarBajaAsist" action="" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formConfirmarBajaAsist">
	<legend align="left"><SPAN style="text-align:top">Confirmar Baja</SPAN></legend>
        <br><br><p align="center">Seguro que desea dar de baja las faltas de asistencia</p> 
	<p align="center">para la Unidad&nbsp;<b>' . $_POST["unidad"] . ',</b>&nbsp;en la fecha&nbsp;<b>' . $fecha . '.</b></p>
	<p align="center"><input type="submit" value="Aceptar" name="Aceptar" style="font-weight:bold; color:black">&emsp;
	<input type="submit" name="Cancelar" value="Cancelar" style="font-weight:bold; color:black">
	<input type="hidden" name="tabla" value="' . $_POST["tabla"] . '"><input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc">
	<input type="hidden" name="idU" value="' . $_POST["idU"] . '"><input type="hidden" name="fechab" value="' .  $_POST["fechab"] . '">
	<input type="hidden" name="unidad" value="' . $_POST["unidad"] . '">
	</p></fieldset></p></form>';

}elseif (isset($_POST["Aceptar"])){
	$nombU=$_POST["unidad"];$idU=$_POST["idU"];$fechab=$_POST["fechab"];$tabla=$_POST["tabla"];
	preg_match("/([0-9]{4})\-([0-9]{1,2})\-([0-9]{1,2})/",$_POST["fechab"], $nfecha);
	$fecha=$nfecha[3] . "/" . $nfecha[2] . "/" . $nfecha[1];
	$sql="DELETE FROM " . $tabla . " WHERE id_gruposa='$idU' AND  fecha='$fechab'";
	if(mysqli_query($conexion, $sql)){
		$output= '<form id="formBajaAsist3" action="" method="post" accept-charset="UTF-8">
		<p>
		<fieldset form="formBajaAsist3">
		<legend align="left"><SPAN style="text-align:top">Eliminaci&oacute;n de Faltas de Asistencia</SPAN></legend><br><br>
		<p>&emsp;&emsp;Las faltas de asistencia seleccionadas se han borrado satisfactoriamente para:</p>
		<p><em>&emsp;&emsp;&emsp;&emsp;Unidad:&nbsp;</em><b>' . $_POST["unidad"] . '</b></p>
		<p><em>&emsp;&emsp;&emsp;&emsp;Fecha:&nbsp;</em><b>' . $fecha . '</b></p>
		<br><br>';
		$output=$output . '<p align="center"><input type="submit" value="Continuar" name="Cancelar" style="font-weight:bold; color:black">&emsp;
		<input type="submit" name="Salir" value="Salir" style="font-weight:bold; color:black">
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc">
		</p></fieldset></p></form>';		
	}else{
		$output='<form id="formBajaAsist4" action="" method="post" accept-charset="UTF-8">
		<p>
		<fieldset form="formBajaAsist4">
		<legend align="left"><SPAN style="text-align:top">Eliminaci&oacute;n de Faltas de Asistencia</SPAN></legend><br><br>
		<p><b>&emsp;&emsp;Error al eliminar los registros de faltas de asistencia para:</b></p>
		<p><em>&emsp;&emsp;&emsp;&emsp;Unidad:&nbsp;</em><b>' . $_POST["unidad"] . '</b></p>
		<p><em>&emsp;&emsp;&emsp;&emsp;Fecha:&nbsp;</em><b>' . $fecha . '</b></p>';//1120
		$output=$output . '<br><p>'. mysqli_error($conexion) . '</p>
		<br><br>
		<p align="center"><input type="submit" value="Continuar" name="Cancelar" style="font-weight:bold; color:black">
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc">
		</p></fieldset></p></form>';
	}	

}

mysqli_close($conexion);
return($output);
}/**************** end baja_asitencia ******************************/


/********************************************************************/
/************************ Calendario ********************************/
/********************************************************************/
function calendario(){

$output='<form id="formCalendario" action="" method="post" accept-charset="UTF-8" size="100%">
	<fieldset form="formCalendario">
	<legend align="left"><SPAN style="text-align:top">Ver Canlendario</SPAN></legend>
	<!--embed src="docente/file/calendario_huelva.pdf#toolbar=0" type="application/pdf"-->
	<br><br>
	<!-input type="image" name="boton" src="/drupal/sites/all/modules/colegio/docente/file/descarga.jpg" align="middle"-->
	<p align="center">Hacer clic en el icono pdf para visualizarlo&nbsp;&nbsp;<a href="http://localhost/drupal/sites/default/files/calendario_huelva.pdf" target="_blank">
	<img align="bottom" src="/drupal/sites/all/modules/colegio/docente/file/descarga.jpg" style="width: 40px; height: 40px;"/></a>
	</p>
	</fieldset>
	</form>';

return($output);
}/*********************** end Calendario *****************************/

/****************************************************************************/
/************************ Faltas Disciplina ********************************/
/***************************************************************************/


/************************ Selección Disciplina *****************************/
function seleccion_disciplina($cadena, $doc){
$output="";
$conexion=bdexternaD();
	$idDoc=$doc;
	$output='<form id="' . $cadena . '" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="' . $cadena . '" >
	<legend align="left"><SPAN style="text-align:top">Selecci&oacute;n de datos para Conductas Contrarias</SPAN></legend>
	<br><br>
	<p align=left><label>&emsp;&emsp;A&ntilde;o Acad&eacute;mico:</label>';
	if ($cadena=="formAltaDisci1"){
		$A="2017-2018";//año actual
		$output=$output . '&emsp;&emsp;<select name="annoa" required size="1">';
		$sqla="SELECT DISTINCT año_a FROM matriculas WHERE año_a='$A'";//año actual de estudios
	}elseif (($cadena=="formBajaDisci1") || ($cadena=="formModDisci1")){
		$output=$output . '&emsp;&emsp;<select name="annoa" required size="4">';
		$sqla="SELECT DISTINCT año_a FROM matriculas ORDER BY año_a DESC";
	}
	$resulta=mysqli_query($conexion, $sqla);
	if (mysqli_num_rows($resulta) > 0){
		while($rowa=mysqli_fetch_assoc($resulta)){
			$output= $output . '<option>' . $rowa["año_a"] . '</option>';
		}
	}
	else{
		$output= $output . '<option></option>';
	}
	$output=$output . '</select></p><br><hr><br>
	<p align="center"><label>Selecci&oacute;n de Unidad:</label><select name="unidad" required size="6">';
	//SELECCIONAR CURSO 
	if ($cadena=="formAltaDisci1"){
		$sqlu="SELECT nombre FROM grupos_a WHERE id_gruposa IN (SELECT id_gruposa FROM detalle_matricula WHERE id_gruposa IN (SELECT id_gruposa FROM asignaturas WHERE id_docente='$idDoc' AND tutor=1) AND id_matriculas IN (SELECT id_matriculas FROM matriculas WHERE año_a='$A'))";
	}elseif (($cadena=="formBajaDisci1") || ($cadena=="formModDisci1")){
		$sqlu="SELECT nombre FROM grupos_a WHERE id_gruposa IN (SELECT id_gruposa FROM notas WHERE id_gruposa IN (SELECT id_gruposa FROM asignaturas WHERE id_docente='$idDoc' AND tutor=1))";
	}
	$resultu=mysqli_query($conexion, $sqlu);
	if (mysqli_num_rows($resultu) > 0){
		$cont=0;
		while($rowu=mysqli_fetch_assoc($resultu)){
			$output= $output . '<option>' . $rowu["nombre"] . '</option>';
			$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$error=true;
		$lista="Lista sin unidades";$output= $output . '<option selected>' . $lista . '</option>';
	}
	$output=$output . '</select></p>';
	$fechaA=date("Y");$fechaM=date("m");
	if ($fechaM==09 || $fechaM==10 || $fechaM==11 || $fechaM==12){
		$a1=$fechaA;$a2=$fechaA+1;
		$aa=$a1 . '-' . $a2;
	}else{
		$a1=$fechaA-1;$a2=$fechaA;
		$aa=$a1 . '-' . $a2;
	}
	//SELECCION FECHA
	$output=$output . '<p align="center"><label>Entrada de Fecha:</label>
	<table width="50" bordercolor="blue" solid="1px" border="1"cellspacing="0" cellpadding="1"><tr><td  style="text-align:center" bgcolor="#FFFFFF">
	<b>D&iacute;a</b>
       	 <select name="dia" required>';
	for ($i=1;$i<=31;$i++){
		$output=$output . '<option>' . $i . '</option>';
	}
	$output=$output . '</select>&emsp;&emsp;
	<b>Mes</b>
        <select name="mes" required>
          	<option selected>Enero</option>
          	<option>Febrero</option>
         	<option>Marzo</option>
         	<option>Abril</option>
         	<option>Mayo</option>
         	<option>Junio</option>
         	<option>Julio</option>
         	<option>Agosto</option>
         	<option>Septiembre</option>
         	<option>Octubre</option>
        	<option>Noviembre</option>
        	<option>Diciembre</option>
       	</select>&emsp;&emsp;
	<b>A&ntilde;o</b>
	<select name="ano" required>
		 <option>' . $a1 . '</option>
	 	 <option>' . $a2 . '</option>
	</select></td></tr></table>';
	$output=$output . '</p><br></fieldset></p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($error){
		$output=$output . '<input type="submit" value="Siguiente" name="Siguiente2" style="font-weight:bold; color:black" disabled>';
	}else{
		$output=$output . '<input type="submit" value="Siguiente" name="Siguiente2" style="font-weight:bold; color:black">'; 
	}
	$output=$output . '</p><input type="hidden" value="' . $idDoc . '" name="idDoc"></form>';

return($output);
}
/********************** end_seleccion_disciplina ***********************/


function listados_disciplina(){//220
$output="";
$conexion=bdexternaD();
GLOBAL $user, $emailDoc;
$error=false;

if (!$_POST || isset($_POST["Cancelar"]) || isset($_POST["Volver"])){
	$output='<form id="formListarDisci" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formListarDisci"><br><legend align="left"><SPAN style="text-align:top">B&uacute;squeda de informaci&oacute;n de Faltas Contrarias de Estudiantes</SPAN></legend><br>
	<p>&emsp;&emsp;&emsp;Seleccionar datos para la b&uacute;squeda:&ensp;&nbsp;<select name="datos">
	<option selected>Fecha</option>
	<option>Estudiante</option>
	<option>Docente</option>
	</select>
	&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<input type="submit" name="buscarDatos" value="Buscar Datos" style="font-weight:bold; color:black">
	</p>
	</fieldset></p></form>';
}elseif (isset($_POST["buscarDatos"]) || isset($_POST["Retroceder"])){
	switch($_POST["datos"]){//2042
		case "Fecha":
			$output= '<form id="formListarDiscFecha" action="" method="post" accept-charset="UTF-8" size="100%">
			<p>
			<fieldset form="formListarDiscFecha"><br><legend align="left"><SPAN style="text-align:top">Faltas Disciplinarias por Intervalo de Fechas</SPAN></legend><br>
			<p align="left">&emsp;&emsp;&emsp;Introducir las fechas para realizar la b&uacute;queda:</p>
			<p align="center">Fecha Inicio:&nbsp;<input type="date" style="color:blue" name="finicio" size="12" maxlength="10" placeholder="dd/mm/aaaa" pattern="[0-9]{2}/[0-9]{2}/[0-9]{4}" title="Fecha:dd/mm/aaaa">
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Fecha Fin:&nbsp;<input type="date" style="color:blue" name="ffin" size="12" maxlength="10" placeholder="dd/mm/aaaa" pattern="[0-9]{2}/[0-9]{2}/[0-9]{4}" title="Fecha:dd/mm/aaaa"></p>';
			if (isset($_POST["buscarDatos"])){
				$output=$output . '<p align="center"><input  type="button" onclick="history.back()" value="Volver Atr&aacute;s" name="Volver Atras" style="font-weight:bold; color:black">';
			}else{
				$output=$output . '<p align="center"><input  type="submit" value="Volver Atr&aacute;s" name="Volver"  style="font-weight:bold; color:black">';
			}
			$output=$output . '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			<input type="submit" type="submit" name="BuscarFecha" value="Buscar" style="font-weight:bold; color:black"></p>
			</fieldset></p><input type="hidden" name="datos" value="' . $_POST["datos"] . '"></form>';
			break;
		case "Estudiante":
			$errorE=false;
			$output= '<form id="formListarDisciEst" action="" method="post" accept-charset="UTF-8" size="100%">
			<p>
			<fieldset form="formListarDisciEst"><br><legend align="left"><SPAN style="text-align:top">Faltas Disciplinarias por Estudiante</SPAN></legend><br>
			<p align="left">&emsp;&emsp;&emsp;Seleccionar un estudiante de la lista:</p>
			<p align="center"><select name="est" autofocus required size=15>';
			$sql="SELECT nombre, apellidos FROM estudiantes WHERE id_est IN (SELECT id_est FROM matriculas WHERE id_matriculas IN (SELECT id_matricula FROM f_disciplinarias))";
			$result=mysqli_query($conexion, $sql);$cont=mysqli_num_rows($result);
			if ($cont>0){//2063
				$elem=$cont;
				while ($row=mysqli_fetch_assoc($result)){
					if ($elem==$cont){
						$output=$output . '<option selected>' . $row["apellidos"] . ', ' . $row["nombre"] . '</option>';
					}else{
						$output=$output . '<option>' . $row["apellidos"] . ', ' . $row["nombre"] . '</option>';
					}
					$elem=$elem-1;
				}	
			}
			else{
				$lista="Sin datos";$errorE=true;
				$output=$output . '<option selected>' . $lita . '</option>';
			}
			$output=$output . '</select></p>
			<p align="center"><p align="center"><input  type="submit" value="Volver Atr&aacute;s" name="Volver"  style="font-weight:bold; color:black">
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
			if ($errorE){
				$output=$output . '<input type="submit" name="BuscarEst" value="Buscar" style="font-weight:bold; color:black" disabled>';
			}else{
				$output=$output . '<input type="submit" name="BuscarEst" value="Buscar" style="font-weight:bold; color:black">';
			}		
			$output=$output . '</p></fieldset></p><input type="hidden" name="datos" value="' . $_POST["datos"] . '"></form>';
			break;
		case "Docente":
			$errorD=false;
			$output='<form id="formListarDisciDoc" action="" method="post" accept-charset="UTF-8" size="100%">
			<p>
			<fieldset form="formListarDisciDoc"><br><legend align="left"><SPAN style="text-align:top">Faltas Disciplinarias por Unidad</SPAN></legend><br>
			<p align="left">&emsp;&emsp;&emsp;Seleccionar un docente de la lista:</p>
			<p align="center"><select name="doc" autofocus required size=7>';
			$sql="SELECT nombre, apellidos FROM docentes WHERE id_docentes IN (SELECT id_docente FROM f_disciplinarias)";
			$result=mysqli_query($conexion, $sql);$cont=mysqli_num_rows($result);
			if ($cont>0){
				$elem=$cont;
				while ($row=mysqli_fetch_assoc($result)){
					if ($elem==$cont){
						$output=$output . '<option selected>' . $row["apellidos"] . ', ' . $row["nombre"] . '</option>';
					}else{
						$output=$output . '<option>' . $row["apellidos"] . ', ' . $row["nombre"] . '</option>';
					}
					$elem=$elem-1;
				}		
			}
			else{
				$lista="Sin datos";$errorD=true;
				$output=$output . '<option selected>' . $lita . '</option>';
			}
			$output=$output . '</select></p>
			<p align="center"><p align="center"><input  type="submit" value="Volver Atr&aacute;s" name="Volver"  style="font-weight:bold; color:black">
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
			if ($errorD){
				$output=$output . '<input type="submit" name="BuscarDoc" value="Buscar" style="font-weight:bold; color:black" disabled>';
			}else{
				$output=$output . '<input type="submit" name="BuscarDoc" value="Buscar" style="font-weight:bold; color:black">';
			}
			$output=$output . '</p></fieldset></p><input type="hidden" name="datos" value="' . $_POST["datos"] . '"></form>';
			break;
	}//switch
}elseif (isset($_POST["BuscarFecha"])){
	if ($_POST["finicio"]<>"" && $_POST["ffin"]<>""){
		preg_match("/([0-9]{2})\/([0-9]{2})\/([0-9]{4})/", $_POST["finicio"], $fechaS);
		$fechai=$fechaS[3] . "-" . $fechaS[2] . "-" . $fechaS[1];//3771
		preg_match("/([0-9]{2})\/([0-9]{2})\/([0-9]{4})/", $_POST["ffin"], $fechaS);
		$fechaf=$fechaS[3] . "-" . $fechaS[2] . "-" . $fechaS[1];
	}else{
		$fechai=$fechaf="";
	}
	$sql="SELECT * FROM f_disciplinarias WHERE fecha BETWEEN '$fechai' AND '$fechaf' ORDER BY fecha ASC";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result)>0){
		$output = '<form id="formListarDisciFecha" action="" method="post" accept-charset="UTF-8" size="100%">
		<fieldset form="formListarDisciFecha"><p>
		<legend align="left"><SPAN style="text-align:top">Listado de Conductas Contrarias</SPAN></legend>
		<br>
		<p align="center"><font size="4"><b><em>Faltas Disciplinarias para intervalo de fecha</font></em></b></p>
		<p align="center"><font color="red" size="4"><b><em>"' . $_POST["finicio"] . '"</font><font size="4">&nbsp;a&nbsp;</font><font color="red" size="4">"' . $_POST["ffin"] .   '"</font></em></b></p>';  
		$output=$output . '<table width="100%" border="2"><tr style="align-text:center"><th width="15%"><font size="3">Fecha</font></th><th width="20%"><font size="3">Incidente</font></th>
		<th width="10%"><font size="3">Tramo Horario</font></th><th width="20%"><font size="3">Estudiante</font></th><th width="15%"><font size="3">Unidad</font></th><th width="20%"><font size="3">Docente</font></th></tr>';  
		while ($row=mysqli_fetch_assoc($result)){
			//Fecha
			$output=$output . '<tr><td><font color="blue" size="2">' . $row["FECHA"] . '</font></td>';
			//Incidente
			$output=$output . '<td><font color="blue" size="2">' . $row["INCIDENTE"] . '</font></td>';
			//Tramo
			$Tr=$row["ID_TIPO_FD"];
			$sqlt="SELECT tramo FROM tipos_fd WHERE id_fd='$Tr'";
			$resultt=mysqli_query($conexion, $sqlt);
			$rowt=mysqli_fetch_assoc($resultt);
			$output=$output . '<td><font color="blue" size="2">' . $rowt["tramo"] . '</font></td>';
			//Estudiante
			$M=$row["ID_MATRICULA"];
			$sqle="SELECT nombre, apellidos FROM estudiantes WHERE id_est IN (SELECT id_est FROM matriculas WHERE id_matriculas='$M')";
			$resulte=mysqli_query($conexion, $sqle);
			$rowe=mysqli_fetch_assoc($resulte);
			$output=$output . '<td><font color="blue" size="2">' . $rowe["apellidos"] . ', ' . $rowe["nombre"] . '</font></td>';
			//Unidad
			$U=$row["ID_GRUPOSA"];
			$sqlu="SELECT nombre FROM grupos_a WHERE id_gruposa='$U'";
			$resultu=mysqli_query($conexion, $sqlu);
			$rowu=mysqli_fetch_assoc($resultu);
			$output=$output . '<td><font color="blue" size="2">' . $rowu["nombre"] . '</font></td>';
			//Docente
			$D=$row["ID_DOCENTE"];
			$sqld="SELECT apellidos, nombre FROM docentes WHERE id_docentes='$D'";
			$resultd=mysqli_query($conexion, $sqld);
			$rowd=mysqli_fetch_assoc($resultd);
			$output=$output . '<td><font color="blue" size="2">' . $rowd["apellidos"] . ', ' . $rowd["nombre"] . '</font></td></tr>';
		}
		$output=$output . '</table><br></p></fieldset>
		<p align="center">
		<input type="submit" value="Buscar Fechas" name="Retroceder" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<input type="submit" value="Cancelar" name="Cancelar" style="font-weight:bold; color:black">
		</p><input type="hidden" name="datos" value="' . $_POST["datos"] . '"></form>';	
	}else{
		$output='<form id="formErrorBuscarDisciFecha" action="" method="post" accept-charset="UTF-8" size="100%">
			<fieldset form="formErrorBuscarDisciFecha"><p>
			<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend>
			<br>
			<p align="center">Error en la b&uacute;squeda, no existen registros en el intervalo de fechas seleccionada.</p>';
			if ($_POST["finicio"]<>"" && $_POST["ffin"]<>""){
				$output=$output . '<p align="center">Fecha inicio:&nbsp;<b>' . $_POST["finicio"] . '</b></p>';
				$output=$output . '<p align="center">Fecha f&iacute;n:&nbsp;<b>' . $_POST["ffin"] . '</b></p>';
			}else{
				$output=$output . '<p align="center"><b>Fechas de inicio y fin sin datos</b></p>';	
			}	
			$output=$output . '<p align="center"><input type="submit" value="Aceptar" name="Cancelar" style="font-weight:bold; color:black"></p>
			</p></fieldset></form>';
	}
}elseif (isset($_POST["BuscarEst"])){
	$nombreE=substr($_POST["est"], (strpos($_POST["est"], ",")+1));
	$long=strlen($nombreE);
	$nombreE=ltrim($nombreE);
	$apellidosE=substr($_POST["est"], 0, -($long+1));
	$apellidosE=ltrim($apellidosE);
	$sql="SELECT * FROM f_disciplinarias WHERE id_matricula IN (SELECT id_matriculas FROM matriculas WHERE id_est IN (SELECT id_est FROM estudiantes WHERE nombre='$nombreE' AND apellidos='$apellidosE')) ORDER BY fecha ASC";
	//$sql="SELECT id_matriculas FROM matriculas WHERE id_est IN (SELECT id_est FROM estudiantes WHERE nombre='$nombreE' AND apellidos='$apellidosE') ORDER BY fecha ASC";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result)>0){
		$output = '<form id="formListarDisciEst" action="" method="post" accept-charset="UTF-8" size="100%">
		<fieldset form="formListarDisciEst"><p>
		<legend align="left"><SPAN style="text-align:top">Listado de Conductas Contrarias</SPAN></legend>
		<br>
		<p align="center"><font size="4"><b><em>Faltas Disciplinarias del Estudiante</font></em></b></p>
		<p align="center"><font color="red" size="4"><b><em>"' . $_POST["est"] . '"</font></em></b></p>';  
		$output=$output . '<table width="100%" border="2"><tr style="align-text:center"><th width="15%"><font size="3">Fecha</font></th><th width="20%"><font size="3">Incidente</font></th>
		<th width="10%"><font size="3">Tramo Horario</font></th><th width="20%"><font size="3">Actuaci&oacute;n</font></th><th width="15%"><font size="3">Unidad</font></th><th width="20%"><font size="3">Docente</font></th></tr>';  
		while ($row=mysqli_fetch_assoc($result)){
			//Fecha
			$output=$output .  '<tr><td><font color="blue" size="2">' . $row["FECHA"] . '</font></td>';
			//Incidente
			$output=$output . '<td><font color="blue" size="2">' . $row["INCIDENTE"] . '</font></td>';
			//Tramo
			$Tr=$row["ID_TIPO_FD"];
			$sqlt="SELECT tramo FROM tipos_fd WHERE id_fd='$Tr'";
			$resultt=mysqli_query($conexion, $sqlt);
			$rowt=mysqli_fetch_assoc($resultt);
			$output=$output . '<td><font color="blue" size="2">' . $rowt["tramo"] . '</font></td>';
			//Actuacion
			$output=$output . '<td><font color="blue" size="2">' . $row["ACTUACION"] . '</font></td>';
			//Unidad
			$U=$row["ID_GRUPOSA"];
			$sqlu="SELECT nombre FROM grupos_a WHERE id_gruposa='$U'";
			$resultu=mysqli_query($conexion, $sqlu);
			$rowu=mysqli_fetch_assoc($resultu);
			$output=$output . '<td><font color="blue" size="2">' . $rowu["nombre"] . '</font></td>';
			//Docente
			$D=$row["ID_DOCENTE"];
			$sqld="SELECT apellidos, nombre FROM docentes WHERE id_docentes='$D'";
			$resultd=mysqli_query($conexion, $sqld);
			$rowd=mysqli_fetch_assoc($resultd);
			$output=$output . '<td><font color="blue" size="2">' . $rowd["apellidos"] . ', ' . $rowd["nombre"] . '</font></td></tr>';
		}
		$output=$output . '</table><br></p></fieldset>
		<p align="center">
		<input type="submit" value="Buscar Estudiante" name="Retroceder" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<input type="submit" value="Cancelar" name="Cancelar" style="font-weight:bold; color:black">
		</p><input type="hidden" name="datos" value="' . $_POST["datos"] . '"></form>';	
	}else{
		$output='<form id="formErrorBuscarDisciEst" action="" method="post" accept-charset="UTF-8" size="100%">
			<fieldset form="formErrorBuscarDisciEst"><p>
			<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend>
			<br>
			<p align="center">Error en la b&uacute;squeda, no existen registros del estudiante seleccionado.</p>
			<p align="center">Estudiante:&nbsp;<b>' . $_POST["est"] . '</b></p>
			<p align="center"><input type="submit" value="Aceptar" name="Cancelar" style="font-weight:bold; color:black"></p>
			</p></fieldset></form>';
	}

}elseif (isset($_POST["BuscarDoc"])){
	$nombreD=substr($_POST["doc"], (strpos($_POST["doc"], ",")+1));
	$long=strlen($nombreD);
	$nombreD=ltrim($nombreD);
	$apellidosD=substr($_POST["doc"], 0, -($long+1));
	$apellidosD=ltrim($apellidosD);
	$sql="SELECT * FROM f_disciplinarias WHERE id_docente IN (SELECT id_docente FROM asignaturas WHERE id_docente IN (SELECT id_docentes FROM docentes WHERE nombre='$nombreD' AND apellidos='$apellidosD')) ORDER BY fecha ASC";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result)>0){
		$output = '<form id="formListarDisciDoc" action="" method="post" accept-charset="UTF-8" size="100%">
		<fieldset form="formListarDisciDoc"><p>
		<legend align="left"><SPAN style="text-align:top">Listado de Conductas Contrarias</SPAN></legend>
		<br>
		<p align="center"><font size="4"><b><em>Faltas Disciplinarias a un Docente</font></em></b></p>
		<p align="center"><font color="red" size="4"><b><em>"' . $_POST["doc"] . '"</font></em></b></p>';  
		$output=$output . '<table width="100%" border="2"><tr style="align-text:center"><th width="15%"><font size="3">Fecha</font></th><th width="20%"><font size="3">Estudiante</font></th><th width="15%"><font size="3">Unidad</font></th>
		<th width="20%"><font size="3">Incidente</font></th><th width="10%"><font size="3">Tramo Horario</font></th><th width="20%"><font size="3">Actuaci&oacute;n</font></th></tr>';  
		while ($row=mysqli_fetch_assoc($result)){
			//Fecha
			$output=$output .  '<tr><td><font color="blue" size="2">' . $row["FECHA"] . '</font></td>';
			//Estudiante
			$M=$row["ID_MATRICULA"];
			$sqle="SELECT nombre, apellidos FROM estudiantes WHERE id_est IN (SELECT id_est FROM matriculas WHERE id_matriculas='$M')";
			$resulte=mysqli_query($conexion, $sqle);
			$rowe=mysqli_fetch_assoc($resulte);
			$output=$output . '<td><font color="blue" size="2">' . $rowe["apellidos"] . ', ' . $rowe["nombre"] . '</font></td>';
			//Unidad
			$U=$row["ID_GRUPOSA"];
			$sqlu="SELECT nombre FROM grupos_a WHERE id_gruposa='$U'";
			$resultu=mysqli_query($conexion, $sqlu);
			$rowu=mysqli_fetch_assoc($resultu);
			$output=$output . '<td><font color="blue" size="2">' . $rowu["nombre"] . '</font></td>';
			//Incidente
			$output=$output . '<td><font color="blue" size="2">' . $row["INCIDENTE"] . '</font></td>';
			//Tramo
			$Tr=$row["ID_TIPO_FD"];
			$sqlt="SELECT tramo FROM tipos_fd WHERE id_fd='$Tr'";
			$resultt=mysqli_query($conexion, $sqlt);
			$rowt=mysqli_fetch_assoc($resultt);
			$output=$output . '<td><font color="blue" size="2">' . $rowt["tramo"] . '</font></td>';
			//Actuacion
			$output=$output . '<td><font color="blue" size="2">' . $row["ACTUACION"] . '</font></td></tr>';
		}
		$output=$output . '</table><br></p></fieldset>
		<p align="center">
		<input type="submit" value="Buscar Docente" name="Retroceder" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<input type="submit" value="Cancelar" name="Cancelar" style="font-weight:bold; color:black">
		</p><input type="hidden" name="datos" value="' . $_POST["datos"] . '"></form>';	
	}else{
		$output='<form id="formErrorBuscarDisciDoc" action="" method="post" accept-charset="UTF-8" size="100%">
			<fieldset form="formErrorBuscarDisciDoc"><p>
			<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend>
			<br>
			<p align="center">Error en la b&uacute;squeda, no existen registros del estudiante seleccionado.</p>
			<p align="center">Estudiante:&nbsp;<b>' . $_POST["est"] . '</b></p>
			<p align="center"><input type="submit" value="Aceptar" name="Cancelar" style="font-weight:bold; color:black"></p>
			</p></fieldset></form>';
	}
}
mysqli_close($conexion);
return($output);
}

/************************** Alta Disciplina *******************************/

function alta_disciplina(){
$output="";
$conexion=bdexternaD();
GLOBAL $user, $emailDoc;
$error=false;

if ((!$_POST || isset($_POST["Salir"])|| isset($_POST["Atras1"])) && ($user->name == "alillo")){
	//Identificacion
	$output=identificacion("disciplina");
}elseif (!$_POST || isset($_POST["SiguienteD"]) || isset($_POST["Continuar"]) || isset($_POST["Atras"]) || isset($_POST["Cancelar"])){
  if (!$_POST || isset($_POST["SiguienteD"])){
	if ($user->name == "alillo"){
		$emailDoc=$_POST["email"];
	}else{//632
		$emailDoc=$user->mail;//$_POST["password"]=$user->pass;
	}
	$sql="SELECT * FROM docentes WHERE email='$emailDoc' AND id_docentes IN (SELECT id_docente FROM asignaturas WHERE tutor=1)";
	$result=mysqli_query($conexion, $sql);
	if ((mysqli_num_rows($result) == 1)){
		while($row=mysqli_fetch_assoc($result)){
			$output=seleccion_disciplina("formAltaDisci1", $row["ID_DOCENTES"]);
	
		}//while
		$error=false;
	}else{
		$error=true;
	}
  }else{
  	$id_doc=$_POST["idDoc"];
  	$output=seleccion_disciplina("formAltaDisci1", $id_doc);
  	$error=false;
  }
  if ($error){
	$output='<form id="formAltaAsistValidar" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formAltaAsistValidar">
	<legend align="left"><SPAN style="text-align:top">Mensaje de Atenci&oacute;n</SPAN></legend>
	<br><br>
	<p align="center">Los datos introducidos no son correctos: (email) o no tiene acceso a este apartado.</p>
	<p align="center"><input type="button" onclick="history.back()" value="Volver a intentarlo" name="Volver Atras" style="font-weight:bold; color:black"></p>
	</fieldset></p>
	</form><br>';
  }

}elseif (isset($_POST["Siguiente2"])){
	$fecha=montar_fecha($_POST["mes"], $_POST["dia"], $_POST["ano"]);
	preg_match("/([0-9]{1,2})\/([0-9]{1,2})\/([0-9]{4})/", $fecha, $nfecha);
	$fechab=$nfecha[3] . "-" . $nfecha[2] . "-" . $nfecha[1];
	$nombU=$_POST["unidad"];
	$id_Doc=$_POST["idDoc"];
	
	$sqlt="SELECT id_docente, id_gruposa FROM asignaturas WHERE id_docente='$id_Doc' AND id_gruposa IN (SELECT id_gruposa FROM grupos_a WHERE nombre='$nombU')";
	$result=mysqli_query($conexion, $sqlt);
	$rowt=mysqli_fetch_assoc($result);$id_U=$rowt["id_gruposa"];
	$A=$_POST["annoa"];	
	
	$output='<form id="formAltaDisci2" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formAltaDisci2">
	<legend align="left"><SPAN style="text-align:top">Nueva Alta de Conductas Contrarias</SPAN></legend>
        <br><br>
	<p align="left">&emsp;&emsp;<b>A&ntilde;o Acad&eacute;mico:&nbsp;</b><input type="text" name="annoa" value="' . $_POST["annoa"] .'" size="12%" disabled>
	&emsp;&emsp;<b>Fecha:&nbsp;</b><input type="date" name="fecha" value="' . $fecha . '" disabled></p><input type="hidden" name="fechab" value="'. $fechab . '">
	<p align="left"><b>&emsp;&emsp;Unidad de Tutor:&nbsp;</b><input type="text" name="unidad" value="' . $_POST["unidad"] .'" size="50%" disabled></p>
	<hr><br>';
	//ESTUDIANTE
	$output=$output . '<div style="width:50%; float:left;">
	<p align="center"><label>Seleccionar Estudiante:</label><select name="est" size="6" required style="color:blue; background:white">';
	$sqle="SELECT nombre, apellidos FROM estudiantes WHERE id_est IN (SELECT id_est FROM matriculas WHERE año_a='$A' AND id_matriculas IN (SELECT id_matriculas FROM detalle_matricula WHERE id_gruposa='$id_U'))";
	$resulte=mysqli_query($conexion, $sqle);
	if ($resulte){
		$errore=false;
		if (mysqli_num_rows($resulte) > 0){
			$cont=0;
			while($rowe=mysqli_fetch_assoc($resulte)){
				$output= $output . '<option>' . $rowe["apellidos"] . ', ' . $rowe["nombre"] . '</option>';
				$cont=$cont+1;
			}
			if ($cont>0){
				$errorb=false;
			}else{
				$errorb=true;
				$lista="Lista sin datos";$output= $output . '<option selected>' . $lista . '</option>';
			}
		}else{
			$output='<form id="formErrorAltaDisciEst1" action="" method="post" accept-charset="UTF-8" size="100%">
			<fieldset form="formErrorAltaDisciEst1"><p>
			<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend>
			<br>
			<p align="center">Error en la b&uacute;squeda, no existen registros de estudiantes para dar de alta una conducta contraria.</p>
			<p align="center"><input type="submit" value="Aceptar" name="Cancelar" style="font-weight:bold; color:black"></p>
			<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"></p></fieldset></form>';
			break;
		}
	}else{
		$errore=true;
	}
	$output=$output . '</select></p>
	</div>';//2113
	//SELECCION DOCENTE
	$output=$output . '<div style="width:50%; float:left;">
	<p align="center"><label>Seleccionar Docente:</label><select name="doc" size="6" required style="color:blue; background:white">';
	$sqld="SELECT nombre, apellidos FROM docentes WHERE id_docentes IN (SELECT id_docente FROM asignaturas WHERE id_gruposa='$id_U')";
	$resultd=mysqli_query($conexion, $sqld);
	if ($resultd){
		$errord=false;
		if (mysqli_num_rows($resultd) > 0){
			$cont=0;
			while($rowd=mysqli_fetch_assoc($resultd)){
				$output= $output . '<option>' . $rowd["apellidos"] . ', ' . $rowd["nombre"] . '</option>';
				$cont=$cont+1;
			}
			if ($cont>0){
				$errorb=false;
			}else{
				$errorb=true;
				$lista="Lista sin datos";$output= $output . '<option selected>' . $lista . '</option>';
			}
		}else{
			$output='<form id="formErrorAltaDisciDoc1" action="" method="post" accept-charset="UTF-8" size="100%">
			<fieldset form="formErrorAltaDisciDoc1"><p>
			<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend>
			<br>
			<p align="center">Error en la b&uacute;squeda, no existen registros de docentes para dar de alta una conducta contraria.</p>
			<p align="center"><input type="submit" value="Aceptar" name="Cancelar" style="font-weight:bold; color:black"></p>
			<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"></p></fieldset></form>';
			break;
		}
	}else{
		$errord=true;
	}
	$output=$output . '</select></p>
	</div><hr style="border-color:white"><br>
	<p style="font-size:18px; color:black; text-align:center; background-color:#BDBDBD"><b>Datos de Incidente</b></p>';
	$sqlth="SELECT tramo FROM tipos_fd";
	$resulth=mysqli_query($conexion, $sqlth);
	$output=$output . '&emsp;&emsp;<b>Tramo Horario:&nbsp;</b><select name="tramoH" size="1" required style="color:blue; background:white">';
	if (mysqli_num_rows($resulth) > 0){
		while ($rowth=mysqli_fetch_assoc($resulth)){
			$output= $output . '<option>' . $rowth["tramo"] . '</option>';
		}
	}else{
			$output= $output . '<option></option>';
	}
	$output= $output . '</select><br><br>
	&emsp;&emsp;<b>Incidente:&nbsp;</b><input type="text" name="incidente" style="color:blue; background:white" required size="60%"><br><br>
	&emsp;&emsp;<b>Descripci&oacute;n Detallada:</b><br>
	&emsp;<textarea name="descripcion" style="align:center; color:blue; background:white" rows="4" cols="98" required></textarea>
	<br><hr style="border-color:white"><br>
	<p style="font-size:18px; color:black; text-align:center; background-color:#BDBDBD"><b>Datos de Actuaci&oacute;n</b></p>
	&emsp;&emsp;<b>Gravedad de la Conducta:&nbsp;</b><input type="text" name="gravedad" style="color:blue; background:white" size="40%"><br><br>
	&emsp;&emsp;<b>Actuaci&oacute;n Aplicar:</b><br>
	&emsp;<textarea name="actuacion" style="align:center; color:blue; background:white" rows="4" cols="98"></textarea>
	</p></fieldset>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<input type="submit" value="Volver Atr&aacute;s" name="Atras" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($errorb){
		$output=$output . '<input type="submit" value="Grabar" name="Grabar" style="font-weight:bold; color:black" disabled>';
	}else{
		$output=$output . '<input type="submit" value="Grabar" name="Grabar" style="font-weight:bold; color:black">';
	}
	$output=$output . '</p>
	<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"><input type="hidden" value="' . $id_U . '" name="id_U">
	<input type="hidden" value="' . $_POST["annoa"] . '" name="annoa"><input type="hidden" value="' . $fecha . '" name="fecha">
	<input type="hidden" value="' . $_POST["unidad"] . '" name="unidad">
	</form>';
	if ($errore){
		$output='<form id="formErrorAltaDisciEst2" action="" method="post" accept-charset="UTF-8" size="100%">
		<fieldset form="formErrorAltaDisciEst2"><p>
		<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend>
		<br>
		<p align="center">Error en la b&uacute;squeda de estudiantes para las faltas disciplinarias.</p>
		<p align="center"><em>Unidad:&nbsp;</em><b>' . $_POST["unidad"] . '</b></p>
		<p align="center"><em>A&ntilde;o Acad&eacute;mico:&nbsp;</em><b>' . $_POST["annoa"] . '</b></p>
		<p align="center"><em>Fecha:&nbsp;</em><b>' . $fecha . '</b></p>
		<p align="center"><input type="submit" value="Aceptar" name="Cancelar" style="font-weight:bold; color:black"></p>
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"></p></fieldset></form>';
		$output=$output . '<br><p><font color="red">'. mysqli_error($conexion) . '</font></p>';

	}
	if ($errord){
		$output='<form id="formErrorAltaDisciDoc2" action="" method="post" accept-charset="UTF-8" size="100%">
		<fieldset form="formErrorAltaDisciDoc2"><p>
		<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend>
		<br>
		<p align="center">Error en la b&uacute;squeda de docentes para las faltas disciplinarias.</p>
		<p align="center"><em>Unidad:&nbsp;</em><b>' . $_POST["unidad"] . '</b></p>
		<p align="center"><em>A&ntilde;o Acad&eacute;mico:&nbsp;</em><b>' . $_POST["annoa"] . '</b></p>
		<p align="center"><em>Fecha:&nbsp;</em><b>' . $fecha . '</b></p>
		<p align="center"><input type="submit" value="Aceptar" name="Cancelar" style="font-weight:bold; color:black"></p>
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"></p></fieldset></form>';
		$output=$output . '<br><p><font color="red">'. mysqli_error($conexion) . '</font></p>';
	}
}elseif (isset($_POST["Grabar"])){
	$annoa=$_POST["annoa"];$fechab=$_POST["fechab"];$id_U=$_POST["id_U"];$tramoH=$_POST["tramoH"];
	$incidente=$_POST["incidente"];$descripcion=$_POST["descripcion"];$gravedad=$_POST["gravedad"];$actuacion=$_POST["actuacion"];
	//BUSCAR ID MATRICULA
	$nombreE=substr($_POST["est"], (strpos($_POST["est"], ",")+1));
	$long=strlen($nombreE);
	$nombreE=ltrim($nombreE);
	$apellidosE=substr($_POST["est"], 0, -($long+1));
	$apellidosE=ltrim($apellidosE);
	$sqlm="SELECT id_matriculas FROM matriculas WHERE año_a='$annoa' AND id_matriculas IN (SELECT id_matriculas FROM detalle_matricula WHERE id_gruposa='$id_U') AND id_est IN (SELECT id_est FROM estudiantes WHERE nombre='$nombreE' AND apellidos='$apellidosE')";
	$resultm=mysqli_query($conexion, $sqlm);
	$rowm=mysqli_fetch_assoc($resultm);$id_Mat=$rowm["id_matriculas"];

	//BUSCAR ID DOCENTE
	$nombreD=substr($_POST["doc"], (strpos($_POST["doc"], ",")+1));
	$long=strlen($nombreD);
	$nombreD=ltrim($nombreD);
	$apellidosD=substr($_POST["doc"], 0, -($long+1));
	$apellidosD=ltrim($apellidosD);
	$sqld="SELECT id_docentes FROM docentes WHERE nombre='$nombreD' AND apellidos='$apellidosD'";
	$resultd=mysqli_query($conexion, $sqld);
	$rowd=mysqli_fetch_assoc($resultd);$id_Doc=$rowd["id_docentes"];

	//BUSCAR ID TRAMO HORARIO
	$sqlth="SELECT id_fd FROM tipos_fd WHERE tramo='$tramoH'";
	$resulth=mysqli_query($conexion, $sqlth);
	$rowth=mysqli_fetch_assoc($resulth);$idTipoFd=$rowth["id_fd"];
	
	//GRABAR
	$sql="INSERT INTO f_disciplinarias (ID_FALTASD, ID_TIPO_FD, ID_DOCENTE, ID_GRUPOSA, ID_MATRICULA, FECHA, INCIDENTE, DESCRIPCION, ACTUACION, GRAVEDAD) 
	VALUES (NULL, '$idTipoFd', '$id_Doc', '$id_U', '$id_Mat', '$fechab', '$incidente', '$descripcion', '$actuacion', '$gravedad')";
	$result=mysqli_query($conexion, $sql);
	if ($result){
		$output='<form id="formAltaDisci3" action="" method="post" accept-charset="UTF-8" size="100%">
		<fieldset form="formAltaDisci3"><p>
		<legend align="left"><SPAN style="text-align:top">Grabaci&oacute;n de Alta de Conductas Contrarias</SPAN></legend>
		<br>
		<p align="center">La grabaci&oacute;n del nuevo Alta para la Falta Disciplinaria se ha realizado satisfactoriamente.</p>
		<p align="left">&emsp;&emsp;&emsp;&emsp;<em>Unidad:&nbsp;</em><b>' . $_POST["unidad"] . '</b></p>
		<p align="left">&emsp;&emsp;&emsp;&emsp;<em>A&ntilde;o Acad&eacute;mico:&nbsp;</em><b>' . $_POST["annoa"] . '</b></p>
		<p align="left">&emsp;&emsp;&emsp;&emsp;<em>Fecha:&nbsp;</em><b>' . $_POST["fecha"] . '</b></p>
		<p align="left">&emsp;&emsp;&emsp;&emsp;<em>Estudiante:&nbsp;</em><b>' . $_POST["est"] . '</b></p>
		<p align="left">&emsp;&emsp;&emsp;&emsp;<em>Docente:&nbsp;</em><b>' . $_POST["doc"] . '</b></p>
		<p align="left">&emsp;&emsp;&emsp;&emsp;<em>Tramo Horario:&nbsp;</em><b>' . $_POST["tramoH"] . '</b></p>
		<p align="left">&emsp;&emsp;&emsp;&emsp;<em>Incidente:&nbsp;</em><b>' . $_POST["incidente"] . '</b></p>
		<p align="center"><input type="submit" value="Continuar" name="Continuar" style="font-weight:bold; color:black">
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="submit" value="Salir" name="Salir" style="font-weight:bold; color:black"></p>
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"></p></fieldset></form>';
	}else{
		$output='<form id="formErrorAltaDisci1" action="" method="post" accept-charset="UTF-8" size="100%">
		<fieldset form="formErrorAltaDisci1"><p>
		<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend>
		<br>
		<p align="center">Error en la grabaci&oacute;n para el Alta de las Faltas Disciplinarias.</p>
		<p align="left">&emsp;&emsp;&emsp;&emsp;<em>Unidad:&nbsp;</em><b>' . $_POST["unidad"] . '</b></p>
		<p align="left">&emsp;&emsp;&emsp;&emsp;<em>A&ntilde;o Acad&eacute;mico:&nbsp;</em><b>' . $_POST["annoa"] . '</b></p>
		<p align="left">&emsp;&emsp;&emsp;&emsp;<em>Fecha:&nbsp;</em><b>' . $_POST["fecha"] . '</b></p>
		<p align="left">&emsp;&emsp;&emsp;&emsp;<em>Estudiante:&nbsp;</em><b>' . $_POST["est"] . '</b></p>
		<p align="left">&emsp;&emsp;&emsp;&emsp;<em>Docente:&nbsp;</em><b>' . $_POST["doc"] . '</b></p>
		<p align="left">&emsp;&emsp;&emsp;&emsp;<em>Incidente:&nbsp;</em><b>' . $_POST["incidente"] . '</b></p>
		<p align="center"><input type="submit" value="Aceptar" name="Cancelar" style="font-weight:bold; color:black"></p>
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"></p></fieldset></form>';
		$output=$output . '<br><p><font color="red">'. mysqli_error($conexion) . '</font></p>';
	}
}

mysqli_close($conexion);
return($output);
}/*********************** end alta_disciplina ***********************/

/**************************** modificar Disciplina *******************/
function modificar_disciplina(){
$output="";
$conexion=bdexternaD();
GLOBAL $user, $emailDoc;
$error=false;

if ((!$_POST || isset($_POST["Salir"])) && ($user->name == "alillo")){
	//Identificacion
	$output=identificacion("disciplina");
}elseif (!$_POST || isset($_POST["SiguienteD"]) || isset($_POST["Continuar"]) || isset($_POST["Atras"]) || isset($_POST["Cancelar"])){
  if (!$_POST || isset($_POST["SiguienteD"])){
	if ($user->name == "alillo"){
		$emailDoc=$_POST["email"];
	}else{//632
		$emailDoc=$user->mail;//$_POST["password"]=$user->pass;
	}
	$sql="SELECT * FROM docentes WHERE email='$emailDoc' AND id_docentes IN (SELECT id_docente FROM asignaturas WHERE tutor=1)";
	$result=mysqli_query($conexion, $sql);
	if ((mysqli_num_rows($result) == 1)){
		while($row=mysqli_fetch_assoc($result)){
			$output=seleccion_disciplina("formModDisci1", $row["ID_DOCENTES"]);
	
		}//while
		$error=false;
	}else{
		$error=true;
	}
  }else{
  	$id_doc=$_POST["idDoc"];
  	$output=seleccion_disciplina("formModDisci1", $id_doc);
  	$error=false;
  }
  if ($error){
	$output='<form id="formAltaAsistValidar" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formAltaAsistValidar">
	<legend align="left"><SPAN style="text-align:top">Mensaje de Atenci&oacute;n</SPAN></legend>
	<br><br>
	<p align="center">Los datos introducidos no son correctos: (email) o no tiene acceso a este apartado.</p>
	<p align="center"><input type="button" onclick="history.back()" value="Volver a intentarlo" name="Volver Atras" style="font-weight:bold; color:black"></p>
	</fieldset></p>
	</form><br>';
  }

}elseif (isset($_POST["Siguiente2"]) || isset($_POST["Atras1"])){
	if (isset($_POST["Siguiente2"])){
		$fecha=montar_fecha($_POST["mes"], $_POST["dia"], $_POST["ano"]);
		preg_match("/([0-9]{1,2})\/([0-9]{1,2})\/([0-9]{4})/", $fecha, $nfecha);//2365
		$fechab=$nfecha[3] . "-" . $nfecha[2] . "-" . $nfecha[1];
	}else{
		$fecha=$_POST["fecha"];
		$fechab=$_POST["fechab"];
	}
	$nombU=$_POST["unidad"];
	$id_Doc=$_POST["idDoc"];
	$annoa=$_POST["annoa"];
	$sqlf="SELECT * FROM f_disciplinarias WHERE fecha='$fechab' AND id_gruposa IN (SELECT id_gruposa FROM grupos_a WHERE nombre='$nombU')";
	$resultf=mysqli_query($conexion, $sqlf);$num=mysqli_num_rows($resultf);$cont=0;
	if ($num > 0){
		//EXISTE FECHA
		$output='<form id="formModDisci2" action="" method="post" accept-charset="UTF-8" size="100%">
		<p>
		<fieldset form="formModDisci2">
		<legend align="left"><SPAN style="text-align:top">Cambiar una Conducta Contraria</SPAN></legend>
        	<br><br>
		<p align="left">&emsp;&emsp;<b>A&ntilde;o Acad&eacute;mico:&nbsp;</b><input type="text" name="annoa" value="' . $_POST["annoa"] .'" size="12%" disabled>
		&emsp;&emsp;<b>Fecha:&nbsp;</b><input type="date" name="fecha" value="' . $fecha . '" disabled></p><input type="hidden" name="fechab" value="'. $fechab . '">
		<p align="left"><b>&emsp;&emsp;Unidad de Tutor:&nbsp;</b><input type="text" name="unidad" value="' . $_POST["unidad"] .'" size="50%" disabled></p>
		<hr><br>
		<p align="center"><label>Seleccionar Estudiante:</label><select name="est" size="6" required style="background:white" autofocus>';
		//ESTUDIANTE
		$ID_M=0;
		while ($rowf=mysqli_fetch_assoc($resultf)){
			$cont=$cont+1;
			$idM=$rowf["ID_MATRICULA"];//2385
			$sqle="SELECT apellidos, nombre FROM estudiantes WHERE id_est IN (SELECT id_est FROM matriculas WHERE año_a='$annoa' AND id_matriculas='$idM')";
			$resulte=mysqli_query($conexion, $sqle);
			if (mysqli_num_rows($resulte) > 0){
				while($rowe=mysqli_fetch_assoc($resulte)){
				 if ($ID_M <> $idM){
					$ID_M=$idM;
					if ($cont==1){
						$output= $output . '<option selected>' . $rowe["apellidos"] . ', ' . $rowe["nombre"] . '</option>';
					}else{
						$output= $output . '<option>' . $rowe["apellidos"] . ', ' . $rowe["nombre"] . '</option>';
					}
				  }
				}
			}else{
				$output= $output . '<option></option>';
			}
			$id_U=$rowf["ID_GRUPOSA"];
		}
		$output=$output . '</select></p>
		</p></fieldset>
		<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<input type="submit" value="Volver Atr&aacute;s" name="Atras" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<input type="submit" value="Siguiente" name="Siguiente3" style="font-weight:bold; color:black">
		</p>
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"><input type="hidden" value="' . $id_U . '" name="id_U">
		<input type="hidden" value="' . $_POST["annoa"] . '" name="annoa"><input type="hidden" value="' . $fecha . '" name="fecha">
		<input type="hidden" value="' . $_POST["unidad"] . '" name="unidad">
		</form>';//2412
	}else{
		// NO EXISTE FECHA
		$output='<form id="formErrorModDisciF" action="" method="post" accept-charset="UTF-8" size="100%">
		<fieldset form="formErrorModDisciF"><p>
		<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend>
		<br>
		<p align="center">Error en la b&uacute;squeda, no existen registros<br>
		de conductas contrarias, para la fecha y/o unidad seleccionada.</p>
		<p align="center"><input type="submit" value="Aceptar" name="Cancelar" style="font-weight:bold; color:black"></p>
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"></p></fieldset></form>';

	}
}elseif (isset($_POST["Siguiente3"])){
	$fechab=$_POST["fechab"];$id_U=$_POST["id_U"];$annoa=$_POST["annoa"];
	$nombreE=substr($_POST["est"], (strpos($_POST["est"], ",")+1));
	$long=strlen($nombreE);
	$nombreE=ltrim($nombreE);
	$apellidosE=substr($_POST["est"], 0, -($long+1));//2432
	$apellidosE=ltrim($apellidosE);
	$sqlm="SELECT id_matriculas FROM matriculas WHERE año_a='$annoa' AND id_matriculas IN (SELECT id_matriculas FROM detalle_matricula WHERE id_gruposa='$id_U') AND id_est IN (SELECT id_est FROM estudiantes WHERE nombre='$nombreE' AND apellidos='$apellidosE')";
	$resultm=mysqli_query($conexion, $sqlm);
	$rowm=mysqli_fetch_assoc($resultm);$id_Mat=$rowm["id_matriculas"];
	$output='<form id="formModDisci3" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formModDisci3">
	<legend align="left"><SPAN style="text-align:top">Cambiar una Conducta Contraria</SPAN></legend>
        <br><br>
	<p align="left">&emsp;&emsp;<b>A&ntilde;o Acad&eacute;mico:&nbsp;</b><input type="text" name="annoa" value="' . $_POST["annoa"] .'" size="12%" disabled>
	&emsp;&emsp;<b>Fecha:&nbsp;</b><input type="date" name="fecha" value="' .  $_POST["fecha"] . '" disabled></p><input type="hidden" name="fechab" value="'. $_POST["fechab"] . '">
	<p align="left"><b>&emsp;&emsp;Unidad de Tutor:&nbsp;</b><input type="text" name="unidad" value="' . $_POST["unidad"] .'" size="50%" disabled></p>
	<p align="left"><b>&emsp;&emsp;Estudiante con Incidencia:&nbsp;</b><input type="text" name="est" value="' . $_POST["est"] .'" size="50%" disabled></p>
	<hr><br>
	<p align="center"><label>Seleccionar Docente:</label><select name="doc" size="6" required style="background:white" autofocus>';//2449
	//DOCENTE
	$sqld="SELECT nombre, apellidos FROM docentes WHERE id_docentes IN (SELECT id_docente FROM f_disciplinarias WHERE fecha='$fechab' AND id_gruposa='$id_U' AND id_matricula='$id_Mat')";
	$resultd=mysqli_query($conexion, $sqld);
	$num=mysqli_num_rows($resultd);$cont=0;
	if ($num > 0){
		while($rowd=mysqli_fetch_assoc($resultd)){
			$cont=$cont+1;
			if ($cont==$num){
				$output= $output . '<option selected>' . $rowd["apellidos"] . ', ' . $rowd["nombre"] . '</option>';
			}else{
				$output= $output . '<option>' . $rowd["apellidos"] . ', ' . $rowd["nombre"] . '</option>';
			}
		}
	}else{
			$output= $output . '<option></option>';
	}//2463
	$output=$output . '</select></p>
	</p></fieldset>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<input type="submit" value="Volver Atr&aacute;s" name="Atras1" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<input type="submit" value="Siguiente" name="Siguiente4" style="font-weight:bold; color:black">
	</p>
	<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"><input type="hidden" value="' . $id_U . '" name="id_U">
	<input type="hidden" value="' . $_POST["annoa"] . '" name="annoa"><input type="hidden" value="' . $_POST["fecha"] . '" name="fecha">
	<input type="hidden" value="' . $_POST["unidad"] . '" name="unidad"><input type="hidden" value="' . $_POST["est"] . '" name="est">
	<input type="hidden" value="' . $id_Mat . '" name="id_Mat">
	</form>';
}elseif (isset($_POST["Siguiente4"])){
	$fechab=$_POST["fechab"];$id_U=$_POST["id_U"];$id_Mat=$_POST["id_Mat"];
	$nombreD=substr($_POST["doc"], (strpos($_POST["doc"], ",")+1));
	$long=strlen($nombreD);
	$nombreD=ltrim($nombreD);
	$apellidosD=substr($_POST["doc"], 0, -($long+1));
	$apellidosD=ltrim($apellidosD);
	$sqld="SELECT id_docentes FROM docentes WHERE nombre='$nombreD' AND apellidos='$apellidosD'";
	$resultd=mysqli_query($conexion, $sqld);
	$rowd=mysqli_fetch_assoc($resultd);
	$id_Doc=$rowd["id_docentes"];
	//MOSTRA INCIDENCIA
	$sqli="SELECT * FROM f_disciplinarias WHERE fecha='$fechab' AND id_matricula='$id_Mat' AND  id_gruposa='$id_U' AND id_docente='$id_Doc'";
	$resulti=mysqli_query($conexion, $sqli);
	if ($resulti){
		$rowi=mysqli_fetch_assoc($resulti);
		$id_fd=$rowi["ID_TIPO_FD"];//2491
		$sqlt="SELECT * FROM tipos_fd WHERE id_fd='$id_fd'";
		$resultt=mysqli_query($conexion, $sqlt);
		$rowt=mysqli_fetch_assoc($resultt);
		$output='<form id="formModDisci3" action="" method="post" accept-charset="UTF-8" size="100%">
		<p>
		<fieldset form="formModDisci3">
		<legend align="left"><SPAN style="text-align:top">Cambiar una Conducta Contraria</SPAN></legend>
       		 <br><br>
		<p align="left">&emsp;&emsp;<b>A&ntilde;o Acad&eacute;mico:&nbsp;</b><input type="text" name="annoa" value="' . $_POST["annoa"] .'" size="12%" disabled>
		&emsp;&emsp;<b>Fecha:&nbsp;</b><input type="date" name="fecha" value="' .  $_POST["fecha"] . '" disabled></p><input type="hidden" name="fechab" value="'. $_POST["fechab"] . '">
		<p align="left"><b>&emsp;&emsp;Unidad de Tutor:&nbsp;</b><input type="text" name="unidad" value="' . $_POST["unidad"] .'" size="50%" disabled></p>
		<p align="left"><b>&emsp;&emsp;Estudiante con Incidencia:&nbsp;</b><input type="text" name="est" value="' . $_POST["est"] .'" size="50%" disabled></p>
		<p align="left"><b>&emsp;&emsp;Docente Comunica Incidencia:&nbsp;</b><input type="text" name="est" value="' . $_POST["doc"] .'" size="50%" disabled></p>
		<hr>
		<hr style="border-color:white"><br>
		<p style="font-size:18px; color:black; text-align:center; background-color:#BDBDBD"><b>Datos de Incidente</b></p>';
		$sqlth="SELECT tramo FROM tipos_fd";
		$resulth=mysqli_query($conexion, $sqlth);
		$output=$output . '&emsp;&emsp;<b>Tramo Horario:&nbsp;</b><select name="tramoH" size="1" required style="color:blue; background:white" autofocus>';
		if (mysqli_num_rows($resulth) > 0){
			while ($rowth=mysqli_fetch_assoc($resulth)){
				if ($rowt["TRAMO"]==$rowth["tramo"]){
					$output= $output . '<option selected>' . $rowth["tramo"] . '</option>';
				}else{
					$output= $output . '<option>' . $rowth["tramo"] . '</option>';
				}
			}
		}else{
			$output= $output . '<option></option>';
		}
//<p>&emsp;&emsp;<b>Tramo Horario:&nbsp;</b><input type="text" name="tramoH" style="color:blue; background:white" value="' . $rowt["TRAMO"] .'" size="60%"><br>
		$output= $output . '</select><br><br>
		&emsp;&emsp;<b>Incidente:&nbsp;</b><input type="text" name="incidente" style="color:blue; background:white" value="' . $rowi["INCIDENTE"] .'" size="60%"><br><br>
		&emsp;&emsp;<b>Descripci&oacute;n Detallada:</b><br>
		&emsp;<textarea name="descripcion" style="align:center; color:blue; background:white" rows="4" cols="98">' . $rowi["DESCRIPCION"] .'</textarea>
		<br><hr style="border-color:white"><br>
		<p style="font-size:18px; color:black; text-align:center; background-color:#BDBDBD"><b>Datos de Actuaci&oacute;n</b></p>
		&emsp;&emsp;<b>Gravedad de la Conducta:&nbsp;</b><input type="text" name="gravedad" style="color:blue; background:white" size="40%" value="' . $rowi["GRAVEDAD"] .'"<br><br>
		&emsp;&emsp;<b>Actuaci&oacute;n Aplicar:</b><br>
		&emsp;<textarea name="actuacion" style="align:center; color:blue; background:white" rows="4" cols="98">' . $rowi["ACTUACION"] .'</textarea>
		</p>
		</p></fieldset>
		<p><input type="submit" value="Volver Atr&aacute;s" name="Atras1" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<input type="submit" value="Grabar" name="Grabar" style="font-weight:bold; color:black">
		</p>
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"><input type="hidden" value="' . $rowi["ID_FALTASD"] . '" name="id_FD">
		<input type="hidden" value="' . $_POST["annoa"] . '" name="annoa"><input type="hidden" value="' . $_POST["fecha"] . '" name="fecha">
		<input type="hidden" value="' . $_POST["unidad"] . '" name="unidad"><input type="hidden" value="' . $_POST["est"] . '" name="est">
		<input type="hidden" value="' . $_POST["doc"] . '" name="doc">
		</form>';
	}else{
		$output='<form id="formModErrorDisci1" action="" method="post" accept-charset="UTF-8">
		<p>
		<fieldset form="formModErrorDisci1">
		<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend><br><br>
		<p><b>&emsp;&emsp;Error en la b&uacute;squeda de falta de disciplina para:</b></p>
		<p>&emsp;&emsp;&emsp;&emsp;el/la estudiante&nbsp;<b>' . $_POST["est"] . '</b>,<br> 
		&emsp;&emsp;&emsp;&emsp;de la unidad&nbsp;<b>' . $_POST["unidad"] . '</b>&nbsp; <br>
		&emsp;&emsp;&emsp;&emsp;del a&ntilde;o acad&eacute;mico:&nbsp;<b>' . $_POST["annoa"] . '</b>&nbsp; y en la fecha&nbsp;<b>' .  $_POST["fecha"] . ',</b><br>
		&emsp;&emsp;&emsp;&emsp;incidencia relacionada con el/la docente&nbsp;<b>' . $_POST["doc"] . '.</b></p>';
		$output=$output . '<br><p>'. mysqli_error($conexion) . '</p>
		<br><br>
		<p align="center"><input type="submit" value="Continuar" name="Cancelar" style="font-weight:bold; color:black">
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc">
		</p></fieldset></p></form>';
	}
}elseif (isset($_POST["Grabar"])){
	$id_FD=$_POST["id_FD"];$tramoH=$_POST["tramoH"];
	$incidente=$_POST["incidente"];$descripcion=$_POST["descripcion"];$gravedad=$_POST["gravedad"];$actuacion=$_POST["actuacion"];
	$sqlt="SELECT id_fd FROM tipos_fd WHERE tramo='$tramoH'";
	$resultt=mysqli_query($conexion, $sqlt);
	$rowt=mysqli_fetch_assoc($resultt);$id_th=$rowt["id_fd"];
	//GRABAR
	$sql="UPDATE f_disciplinarias SET ID_TIPO_FD='$id_th', INCIDENTE='$incidente', DESCRIPCION='$descripcion', ACTUACION='$actuacion', GRAVEDAD='$gravedad' WHERE ID_FALTASD='$id_FD'";
	$result=mysqli_query($conexion, $sql);
	if ($result){
		$output='<form id="formModDisci4" action="" method="post" accept-charset="UTF-8" size="100%">
		<fieldset form="formModDisci4"><p>
		<legend align="left"><SPAN style="text-align:top">Grabaci&oacute;n de Cambios de Conducta Contraria</SPAN></legend>
		<br>
		<p align="center">La actualizaci&oacute;n para la Falta Disciplinaria se ha realizado satisfactoriamente.</p>
		<p align="left">&emsp;&emsp;&emsp;&emsp;<em>Unidad:&nbsp;</em><b>' . $_POST["unidad"] . '</b></p>
		<p align="left">&emsp;&emsp;&emsp;&emsp;<em>A&ntilde;o Acad&eacute;mico:&nbsp;</em><b>' . $_POST["annoa"] . '</b></p>
		<p align="left">&emsp;&emsp;&emsp;&emsp;<em>Fecha:&nbsp;</em><b>' . $_POST["fecha"] . '</b></p>
		<p align="left">&emsp;&emsp;&emsp;&emsp;<em>Estudiante:&nbsp;</em><b>' . $_POST["est"] . '</b></p>
		<p align="left">&emsp;&emsp;&emsp;&emsp;<em>Docente:&nbsp;</em><b>' . $_POST["doc"] . '</b></p>
		<p align="left">&emsp;&emsp;&emsp;&emsp;<em>Tramo Horario:&nbsp;</em><b>' . $_POST["tramoH"] . '</b></p>
		<p align="left">&emsp;&emsp;&emsp;&emsp;<em>Incidente:&nbsp;</em><b>' . $_POST["incidente"] . '</b></p>
		<p align="center"><input type="submit" value="Continuar" name="Continuar" style="font-weight:bold; color:black">
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="submit" value="Salir" name="Salir" style="font-weight:bold; color:black"></p>
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"></p></fieldset></form>';
	}else{
		$output='<form id="formErrorModDisci1" action="" method="post" accept-charset="UTF-8" size="100%">
		<fieldset form="formErrorModDisci1"><p>
		<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend>
		<br>
		<p align="center">Error en la grabaci&oacute;n para el Alta de las Faltas Disciplinarias.</p>
		<p align="left">&emsp;&emsp;&emsp;&emsp;<em>Unidad:&nbsp;</em><b>' . $_POST["unidad"] . '</b></p>
		<p align="left">&emsp;&emsp;&emsp;&emsp;<em>A&ntilde;o Acad&eacute;mico:&nbsp;</em><b>' . $_POST["annoa"] . '</b></p>
		<p align="left">&emsp;&emsp;&emsp;&emsp;<em>Fecha:&nbsp;</em><b>' . $_POST["fecha"] . '</b></p>
		<p align="left">&emsp;&emsp;&emsp;&emsp;<em>Estudiante:&nbsp;</em><b>' . $_POST["est"] . '</b></p>
		<p align="left">&emsp;&emsp;&emsp;&emsp;<em>Docente:&nbsp;</em><b>' . $_POST["doc"] . '</b></p>
		<p align="left">&emsp;&emsp;&emsp;&emsp;<em>Incidente:&nbsp;</em><b>' . $_POST["incidente"] . '</b></p>
		<p align="center"><input type="submit" value="Aceptar" name="Cancelar" style="font-weight:bold; color:black"></p>
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"></p></fieldset></form>';
		$output=$output . '<br><p><font color="red">'. mysqli_error($conexion) . '</font></p>';
	}
}

mysqli_close($conexion);
return($output);
}/******************** end modificar_disciplina ********************/

/************************* baja Disciplina *************************/
function baja_disciplina(){
$output="";
$conexion=bdexternaD();
GLOBAL $user, $emailDoc;
$error=false;

if ((!$_POST || isset($_POST["Salir"])) && ($user->name == "alillo")){
	//Identificacion
	$output=identificacion("disciplina");
}elseif (!$_POST || isset($_POST["SiguienteD"]) || isset($_POST["Continuar"]) || isset($_POST["Atras"]) || isset($_POST["Cancelar"])){
  if (!$_POST || isset($_POST["SiguienteD"])){
	if ($user->name == "alillo"){
		$emailDoc=$_POST["email"];
	}else{//632
		$emailDoc=$user->mail;//$_POST["password"]=$user->pass;
	}
	$sql="SELECT * FROM docentes WHERE email='$emailDoc' AND id_docentes IN (SELECT id_docente FROM asignaturas WHERE tutor=1)";
	$result=mysqli_query($conexion, $sql);
	if ((mysqli_num_rows($result) == 1)){
		while($row=mysqli_fetch_assoc($result)){
			$output=seleccion_disciplina("formBajaDisci1", $row["ID_DOCENTES"]);
	
		}//while
		$error=false;
	}else{
		$error=true;
	}
  }else{
  	$id_doc=$_POST["idDoc"];
  	$output=seleccion_disciplina("formBajaDisci1", $id_doc);
  	$error=false;
  }
  if ($error){
	$output='<form id="formAltaAsistValidar" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formAltaAsistValidar">
	<legend align="left"><SPAN style="text-align:top">Mensaje de Atenci&oacute;n</SPAN></legend>
	<br><br>
	<p align="center">Los datos introducidos no son correctos: (email) o no tiene acceso a este apartado.</p>
	<p align="center"><input type="button" onclick="history.back()" value="Volver a intentarlo" name="Volver Atras" style="font-weight:bold; color:black"></p>
	</fieldset></p>
	</form><br>';
  }

}elseif (isset($_POST["Siguiente2"]) || isset($_POST["Atras1"])){
	if (isset($_POST["Siguiente2"])){
		$fecha=montar_fecha($_POST["mes"], $_POST["dia"], $_POST["ano"]);
		preg_match("/([0-9]{1,2})\/([0-9]{1,2})\/([0-9]{4})/", $fecha, $nfecha);//2365
		$fechab=$nfecha[3] . "-" . $nfecha[2] . "-" . $nfecha[1];
	}else{
		$fecha=$_POST["fecha"];
		$fechab=$_POST["fechab"];
	}
	$nombU=$_POST["unidad"];
	$id_Doc=$_POST["idDoc"];
	$annoa=$_POST["annoa"];
	$sqlf="SELECT * FROM f_disciplinarias WHERE fecha='$fechab' AND id_gruposa IN (SELECT id_gruposa FROM grupos_a WHERE nombre='$nombU')";
	$resultf=mysqli_query($conexion, $sqlf);$num=mysqli_num_rows($resultf);$cont=0;
	if ($num > 0){
		//EXISTE FECHA
		$output='<form id="formBajaDisci2" action="" method="post" accept-charset="UTF-8" size="100%">
		<p>
		<fieldset form="formBajaDisci2">
		<legend align="left"><SPAN style="text-align:top">Eliminar una Conducta Contraria</SPAN></legend>
        	<br><br>
		<p align="left">&emsp;&emsp;<b>A&ntilde;o Acad&eacute;mico:&nbsp;</b><input type="text" name="annoa" value="' . $_POST["annoa"] .'" size="12%" disabled>
		&emsp;&emsp;<b>Fecha:&nbsp;</b><input type="date" name="fecha" value="' . $fecha . '" disabled></p><input type="hidden" name="fechab" value="'. $fechab . '">
		<p align="left"><b>&emsp;&emsp;Unidad de Tutor:&nbsp;</b><input type="text" name="unidad" value="' . $_POST["unidad"] .'" size="50%" disabled></p>
		<hr><br>
		<p align="center"><label>Seleccionar Estudiante:</label><select name="est" size="6" required style="background:white" autofocus>';
		//ESTUDIANTE
		$ID_M=0;
		while ($rowf=mysqli_fetch_assoc($resultf)){
			$cont=$cont+1;
			$idM=$rowf["ID_MATRICULA"];//2385
			$sqle="SELECT apellidos, nombre FROM estudiantes WHERE id_est IN (SELECT id_est FROM matriculas WHERE año_a='$annoa' AND id_matriculas='$idM')";
			$resulte=mysqli_query($conexion, $sqle);
			if (mysqli_num_rows($resulte) > 0){
				while($rowe=mysqli_fetch_assoc($resulte)){
				 if ($ID_M <> $idM){
					$ID_M=$idM;
					if ($cont==1){
						$output= $output . '<option selected>' . $rowe["apellidos"] . ', ' . $rowe["nombre"] . '</option>';
					}else{
						$output= $output . '<option>' . $rowe["apellidos"] . ', ' . $rowe["nombre"] . '</option>';
					}
				  }
				}
			}else{
				$output= $output . '<option></option>';
			}
			$id_U=$rowf["ID_GRUPOSA"];
		}
		$output=$output . '</select></p>
		</p></fieldset>
		<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<input type="submit" value="Volver Atr&aacute;s" name="Atras" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<input type="submit" value="Siguiente" name="Siguiente3" style="font-weight:bold; color:black">
		</p>
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"><input type="hidden" value="' . $id_U . '" name="id_U">
		<input type="hidden" value="' . $_POST["annoa"] . '" name="annoa"><input type="hidden" value="' . $fecha . '" name="fecha">
		<input type="hidden" value="' . $_POST["unidad"] . '" name="unidad">
		</form>';//2412
	}else{
		// NO EXISTE FECHA
		$output='<form id="formErrorBajaDisciF" action="" method="post" accept-charset="UTF-8" size="100%">
		<fieldset form="formErrorBajaDisciF"><p>
		<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend>
		<br>
		<p align="center">Error en la b&uacute;squeda, no existen registros<br>
		de conductas contrarias, para la fecha y/o unidad seleccionada.</p>
		<p align="center"><input type="submit" value="Aceptar" name="Cancelar" style="font-weight:bold; color:black"></p>
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"></p></fieldset></form>';

	}
}elseif (isset($_POST["Siguiente3"])){
	$fechab=$_POST["fechab"];$id_U=$_POST["id_U"];$annoa=$_POST["annoa"];
	$nombreE=substr($_POST["est"], (strpos($_POST["est"], ",")+1));
	$long=strlen($nombreE);
	$nombreE=ltrim($nombreE);
	$apellidosE=substr($_POST["est"], 0, -($long+1));//2432
	$apellidosE=ltrim($apellidosE);
	$sqlm="SELECT id_matriculas FROM matriculas WHERE año_a='$annoa' AND id_matriculas IN (SELECT id_matriculas FROM detalle_matricula WHERE id_gruposa='$id_U') AND id_est IN (SELECT id_est FROM estudiantes WHERE nombre='$nombreE' AND apellidos='$apellidosE')";
	$resultm=mysqli_query($conexion, $sqlm);
	$rowm=mysqli_fetch_assoc($resultm);$id_Mat=$rowm["id_matriculas"];
	$output='<form id="formBajaDisci3" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formBajaDisci3">
	<legend align="left"><SPAN style="text-align:top">Eliminar una Conducta Contraria</SPAN></legend>
        <br><br>
	<p align="left">&emsp;&emsp;<b>A&ntilde;o Acad&eacute;mico:&nbsp;</b><input type="text" name="annoa" value="' . $_POST["annoa"] .'" size="12%" disabled>
	&emsp;&emsp;<b>Fecha:&nbsp;</b><input type="date" name="fecha" value="' .  $_POST["fecha"] . '" disabled></p><input type="hidden" name="fechab" value="'. $_POST["fechab"] . '">
	<p align="left"><b>&emsp;&emsp;Unidad de Tutor:&nbsp;</b><input type="text" name="unidad" value="' . $_POST["unidad"] .'" size="50%" disabled></p>
	<p align="left"><b>&emsp;&emsp;Estudiante con Incidencia:&nbsp;</b><input type="text" name="est" value="' . $_POST["est"] .'" size="50%" disabled></p>
	<hr><br>
	<p align="center"><label>Seleccionar Docente:</label><select name="doc" size="6" required style="background:white" autofocus>';//2449
	//DOCENTE
	$sqld="SELECT nombre, apellidos FROM docentes WHERE id_docentes IN (SELECT id_docente FROM f_disciplinarias WHERE fecha='$fechab' AND id_gruposa='$id_U' AND id_matricula='$id_Mat')";
	$resultd=mysqli_query($conexion, $sqld);
	$num=mysqli_num_rows($resultd);$cont=0;
	if ($num > 0){
		while($rowd=mysqli_fetch_assoc($resultd)){
			$cont=$cont+1;
			if ($cont==$num){
				$output= $output . '<option selected>' . $rowd["apellidos"] . ', ' . $rowd["nombre"] . '</option>';
			}else{
				$output= $output . '<option>' . $rowd["apellidos"] . ', ' . $rowd["nombre"] . '</option>';
			}
		}
	}else{
			$output= $output . '<option></option>';
	}//2463
	$output=$output . '</select></p>
	</p></fieldset>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<input type="submit" value="Volver Atr&aacute;s" name="Atras1" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<input type="submit" value="Siguiente" name="Siguiente4" style="font-weight:bold; color:black">
	</p>
	<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"><input type="hidden" value="' . $id_U . '" name="id_U">
	<input type="hidden" value="' . $_POST["annoa"] . '" name="annoa"><input type="hidden" value="' . $_POST["fecha"] . '" name="fecha">
	<input type="hidden" value="' . $_POST["unidad"] . '" name="unidad"><input type="hidden" value="' . $_POST["est"] . '" name="est">
	<input type="hidden" value="' . $id_Mat . '" name="id_Mat">
	</form>';
}elseif (isset($_POST["Siguiente4"])){
	$fechab=$_POST["fechab"];$id_U=$_POST["id_U"];$id_Mat=$_POST["id_Mat"];
	$nombreD=substr($_POST["doc"], (strpos($_POST["doc"], ",")+1));
	$long=strlen($nombreD);
	$nombreD=ltrim($nombreD);
	$apellidosD=substr($_POST["doc"], 0, -($long+1));
	$apellidosD=ltrim($apellidosD);
	$sqld="SELECT id_docentes FROM docentes WHERE nombre='$nombreD' AND apellidos='$apellidosD'";
	$resultd=mysqli_query($conexion, $sqld);
	$rowd=mysqli_fetch_assoc($resultd);
	$id_Doc=$rowd["id_docentes"];
	//MOSTRA INCIDENCIA
	$sqli="SELECT * FROM f_disciplinarias WHERE fecha='$fechab' AND id_matricula='$id_Mat' AND  id_gruposa='$id_U' AND id_docente='$id_Doc'";
	$resulti=mysqli_query($conexion, $sqli);
	if ($resulti){
		$rowi=mysqli_fetch_assoc($resulti);
		$id_fd=$rowi["ID_TIPO_FD"];//2491
		$sqlt="SELECT * FROM tipos_fd WHERE id_fd='$id_fd'";
		$resultt=mysqli_query($conexion, $sqlt);
		$rowt=mysqli_fetch_assoc($resultt);
		$output='<form id="formBajaDisci3" action="" method="post" accept-charset="UTF-8" size="100%">
		<p>
		<fieldset form="formBajaDisci3">
		<legend align="left"><SPAN style="text-align:top">Eliminar una Conducta Contraria</SPAN></legend>
       		 <br><br>
		<p align="left">&emsp;&emsp;<b>A&ntilde;o Acad&eacute;mico:&nbsp;</b><input type="text" name="annoa" value="' . $_POST["annoa"] .'" size="12%" disabled>
		&emsp;&emsp;<b>Fecha:&nbsp;</b><input type="date" name="fecha" value="' .  $_POST["fecha"] . '" disabled></p><input type="hidden" name="fechab" value="'. $_POST["fechab"] . '">
		<p align="left"><b>&emsp;&emsp;Unidad de Tutor:&nbsp;</b><input type="text" name="unidad" value="' . $_POST["unidad"] .'" size="50%" disabled></p>
		<p align="left"><b>&emsp;&emsp;Estudiante con Incidencia:&nbsp;</b><input type="text" name="est" value="' . $_POST["est"] .'" size="50%" disabled></p>
		<p align="left"><b>&emsp;&emsp;Docente Comunica Incidencia:&nbsp;</b><input type="text" name="est" value="' . $_POST["doc"] .'" size="50%" disabled></p>
		<hr>
		<hr style="border-color:white"><br>
		<p style="font-size:18px; color:black; text-align:center; background-color:#BDBDBD"><b>Datos de Incidente</b></p>
		<p>&emsp;&emsp;<b>Tramo Horario:&nbsp;</b><input type="text" name="tramoH" style="color:blue; background:white" value="' . $rowt["TRAMO"] .'" disabled size="60%"><br>
		&emsp;&emsp;<b>Incidente:&nbsp;</b><input type="text" name="incidente" style="color:blue; background:white" value="' . $rowi["INCIDENTE"] .'" disabled size="60%"><br><br>
		&emsp;&emsp;<b>Descripci&oacute;n Detallada:</b><br>
		&emsp;<textarea name="descripcion" style="align:center; color:blue; background:white" rows="4" cols="98" disabled>' . $rowi["DESCRIPCION"] .'</textarea>
		<br><hr style="border-color:white"><br>
		<p style="font-size:18px; color:black; text-align:center; background-color:#BDBDBD"><b>Datos de Actuaci&oacute;n</b></p>
		&emsp;&emsp;<b>Gravedad de la Conducta:&nbsp;</b><input type="text" name="gravedad" style="color:blue; background:white" size="40%" value="' . $rowi["GRAVEDAD"] .'" disabled><br><br>
		&emsp;&emsp;<b>Actuaci&oacute;n Aplicar:</b><br>
		&emsp;<textarea name="actuacion" style="align:center; color:blue; background:white" rows="4" cols="98" disabled>' . $rowi["ACTUACION"] .'</textarea>
		</p>
		</p></fieldset>
		<p><input type="submit" value="Volver Atr&aacute;s" name="Atras1" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<input type="submit" value="Eliminar" name="Eliminar" style="font-weight:bold; color:black">
		</p>
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"><input type="hidden" value="' . $rowi["ID_FALTASD"] . '" name="id_FD">
		<input type="hidden" value="' . $_POST["annoa"] . '" name="annoa"><input type="hidden" value="' . $_POST["fecha"] . '" name="fecha">
		<input type="hidden" value="' . $_POST["unidad"] . '" name="unidad"><input type="hidden" value="' . $_POST["est"] . '" name="est">
		<input type="hidden" value="' . $_POST["doc"] . '" name="doc"><input type="hidden" value="' . $rowi["INCIDENTE"] . '" name="incidente">
		<input type="hidden" value="' . $rowt["TRAMO"] . '" name="tramoH">
		</form>';
	}else{
		$output='<form id="formBajaErrorDisci1" action="" method="post" accept-charset="UTF-8">
		<p>
		<fieldset form="formBajaErrorDisci1">
		<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend><br><br>
		<p><b>&emsp;&emsp;Error en la b&uacute;squeda de falta de disciplina para:</b></p>
		<p>&emsp;&emsp;&emsp;&emsp;el/la estudiante&nbsp;<b>' . $_POST["est"] . '</b>,<br> 
		&emsp;&emsp;&emsp;&emsp;de la unidad&nbsp;<b>' . $_POST["unidad"] . '</b><br>
		&emsp;&emsp;&emsp;&emsp;del a&ntilde;o acad&eacute;mico:&nbsp;<b>' . $_POST["annoa"] . '</b><br>&nbsp; y en la fecha&nbsp;<b>' .  $_POST["fecha"] . ',</b><br>
		&emsp;&emsp;&emsp;&emsp;incidencia relacionada con el/la docente&nbsp;<b>' . $_POST["doc"] . '.</b></p>';
		$output=$output . '<br><p>'. mysqli_error($conexion) . '</p>
		<br><br>
		<p align="center"><input type="submit" value="Continuar" name="Cancelar" style="font-weight:bold; color:black">
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc">
		</p></fieldset></p></form>';
	}
}elseif (isset($_POST["Eliminar"])){//2474
	$output='<form id="formConfirmarBajaDisci" action="" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formConfirmarBajaDisci">
	<legend align="left"><SPAN style="text-align:top">Confirmar Baja</SPAN></legend>
        <br><br><p align="center">Seguro que desea dar de baja la falta de disciplina<br> 
	del estudiante&nbsp;<b>' . $_POST["est"] . '</b>,<br> 
	de la unidad&nbsp;<b>' . $_POST["unidad"] . '</b><br>
	del a&ntilde;o acad&eacute;mico:&nbsp;<b>' . $_POST["annoa"] . '</b>&nbsp; y en la fecha&nbsp;<b>' .  $_POST["fecha"] . ',</b><br>
	incidencia relacionada con el/la docente&nbsp;<b>' . $_POST["doc"] . '.</b></p>
	<p align="center"><input type="submit" value="Aceptar" name="Aceptar" style="font-weight:bold; color:black">&emsp;
	<input type="submit" name="Cancelar" value="Cancelar" style="font-weight:bold; color:black">
	<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"><input type="hidden" value="' . $_POST["id_FD"] . '" name="id_FD">
	<input type="hidden" value="' . $_POST["annoa"] . '" name="annoa"><input type="hidden" value="' . $_POST["fecha"] . '" name="fecha">
	<input type="hidden" value="' . $_POST["unidad"] . '" name="unidad"><input type="hidden" value="' . $_POST["est"] . '" name="est">
	<input type="hidden" value="' . $_POST["doc"] . '" name="doc"><input type="hidden" value="' . $_POST["incidente"] . '" name="incidente">
	<input type="hidden" value="' . $_POST["tramoH"] . '" name="tramoH">
	</p></fieldset></p></form>';
}elseif (isset($_POST["Aceptar"])){
	$id_FD=$_POST["id_FD"];	
	$sql="DELETE FROM f_disciplinarias WHERE id_faltasd='$id_FD'";
	if(mysqli_query($conexion, $sql)){
		$output= '<form id="formBajaDisci4" action="" method="post" accept-charset="UTF-8">
		<p>
		<fieldset form="formBajaDisci4">
		<legend align="left"><SPAN style="text-align:top">Eliminaci&oacute;n de Falta de Disciplina</SPAN></legend><br><br>
		<p>&emsp;&emsp;La conducta contraria seleccionada se ha borrado satisfactoriamente para</p>
		<p>&emsp;&emsp;&emsp;&emsp;<em>A&ntilde;o Acad&eacute;mico:&nbsp;</em><b>' . $_POST["annoa"] . '</b><br>
		&emsp;&emsp;&emsp;&emsp;Unidad&nbsp;<b>' . $_POST["unidad"] . '</b><br>
		&emsp;&emsp;&emsp;&emsp;Estudiante&nbsp;<b>' . $_POST["est"] . '</b>,<br> 
		&emsp;&emsp;&emsp;&emsp;Fecha&nbsp;<b>' . $_POST["fecha"] . '.</b><br>
		&emsp;&emsp;&emsp;&emsp;Docente&nbsp;<b>' . $_POST["doc"] . '</b><br>
		&emsp;&emsp;&emsp;&emsp;Incidente&nbsp;<b>' . $_POST["incidente"] . '</b><br>
		&emsp;&emsp;&emsp;&emsp;Tramo Horario&nbsp;<b>' . $_POST["tramoH"] . '</b></p>
		<br><br>
		<p align="center"><input type="submit" value="Continuar" name="Cancelar" style="font-weight:bold; color:black">&emsp;
		<input type="submit" name="Salir" value="Salir" style="font-weight:bold; color:black">
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc">
		</p></fieldset></p></form>';		
	}else{
		$output='<form id="formBajaErrorDisci2" action="" method="post" accept-charset="UTF-8">
		<p>
		<fieldset form="formBajaErrorDisci2">
		<legend align="left"><SPAN style="text-align:top">Eliminaci&oacute;n de Faltas de Disciplina</SPAN></legend><br><br>
		<p><b>&emsp;&emsp;Error al eliminar los registros de falta de disciplina para:</b></p>
		<p>&emsp;&emsp;&emsp;&emsp;el/la estudiante&nbsp;<b>' . $_POST["est"] . '</b>,<br> 
		&emsp;&emsp;&emsp;&emsp;de la unidad&nbsp;<b>' . $_POST["unidad"] . '</b><br>
		&emsp;&emsp;&emsp;&emsp;del a&ntilde;o acad&eacute;mico:&nbsp;<b>' . $_POST["annoa"] . '</b>&nbsp; y en la fecha&nbsp;<b>' .  $_POST["fecha"] . ',</b><br>
		&emsp;&emsp;&emsp;&emsp;incidencia relacionada con el/la docente&nbsp;<b>' . $_POST["doc"] . '.</b></p>';
		$output=$output . '<br><p>'. mysqli_error($conexion) . '</p>
		<br><br>
		<p align="center"><input type="submit" value="Continuar" name="Cancelar" style="font-weight:bold; color:black">
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc">
		</p></fieldset></p></form>';
	}	
}

mysqli_close($conexion);
return($output);
}/********************* end baja_disciplina ***************************/


function listados_comunicacion(){

$output='ca eqssss';

return($output);
}

function alta_comunicacion(){

$output='comunicacion assss';

return($output);
}

function baja_comunicacion(){
$hoy=localtime(time(),1);
$hora=$hoy["tm_hour"];
GLOBAL $user;

//return 'D&iacute;a:' . $hoy;
if (($hora >=7) && ($hora < 14)){
		return '<p class="saludo"><em>Buenos d&iacute;as </em>' . $user->name . '</p><p>alta de un nuevo departamento<p>';
	}
	elseif (($hora >=14) && ($hora < 20)){
		return '<p class="saludo"><em>Buenos tardes </em>' . $user->name . '</p><p class="saludo">Contraseña:' . $user ->pass .
			'</p><p class="saludo">Email:' . $user->mail . '</p>';
	}
	else {
		return '<p class="saludo"><em>Buenos noches </em>' . $user->name . '</p><p class="saludo">Email:' . $user->mail . '</p>';	
	}	


//$output='comunicac bsss';

return($output);
}

function modificar_comunicacion(){

$output='comunicacion msss';

return($output);
}


/***********************************************************************/
/*************************** Evaluaciones *****************************/
/*********************************************************************/

/********************* Selección de evaluaciones *********************/
function seleccion_evaluaciones ($cadena, $doc){
$output="";
$conexion=bdexternaD();
	$idDoc= $doc; 
	//$fechaA=date("Y") . '-' . date("m") . '-' . date("d");$f1='2018-06-01';
	$output='<form id="' . $cadena . '" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="' . $cadena . '" >
	<legend align="left"><SPAN style="text-align:top">Selecci&oacute;n de datos para Evaluaci&oacute;n</SPAN></legend>
	<br><br>
	<div style="width:50%; float:left;">
	<p align="center"><label>A&ntilde;o Acad&eacute;mico:</label>';//1500
	//SELECCIONAR AÑO ACADEMICO
	if ($cadena=="formAltaEva1"){
		$A="2014-2015";$output=$output . '<select name="annoa" required size="1">';
		$sqla="SELECT DISTINCT año_a FROM matriculas WHERE año_a='$A'";//año actual de estudios
	}elseif (($cadena=="formBajaEva1") || ($cadena=="formModEva1")){
		$output=$output . '<select name="annoa" required size="4">';
		$sqla="SELECT DISTINCT año_a FROM matriculas ORDER BY año_a DESC";
	}
	$resulta=mysqli_query($conexion, $sqla);
	if (mysqli_num_rows($resulta) > 0){
		while($rowa=mysqli_fetch_assoc($resulta)){
			$output= $output . '<option>' . $rowa["año_a"] . '</option>';
		}
	}
	else{
		$output= $output . '<optiond></option>';
	}
		$output=$output . '</select></p><br><hr><br>
	<p align="center"><label>Unidad a evaluar:</label><select name="unidad" required size="6">';
	//SELECCIONAR CURSO 
	if ($cadena=="formAltaEva1"){
		$sqlu="SELECT nombre FROM grupos_a WHERE id_gruposa IN (SELECT id_gruposa FROM detalle_matricula WHERE id_gruposa IN (SELECT id_gruposa FROM asignaturas WHERE id_docente='$idDoc'))";
	}elseif (($cadena=="formBajaEva1") || ($cadena=="formModEva1")){
		$sqlu="SELECT nombre FROM grupos_a WHERE id_gruposa IN (SELECT id_gruposa FROM notas WHERE id_gruposa IN (SELECT id_gruposa FROM asignaturas WHERE id_docente='$idDoc'))";
	}
	$resultu=mysqli_query($conexion, $sqlu);
	if (mysqli_num_rows($resultu) > 0){
		while($rowu=mysqli_fetch_assoc($resultu)){
			$output= $output . '<option>' . $rowu["nombre"] . '</option>';
		}
	}
	else{
		$output= $output . '<optiond></option>';
	}
	$output=$output . '</select></p>
	</div>
	<div style="width:50%; float:left;">
	<p align="center"><label>Convocatoria:</label>';$fechaA='2018-05-01';
	//SELECCIONAR CONVOCATORIA
	if ($cadena=="formAltaEva1"){
		$output=$output . '<select name="conv" required size="1">';
		//$f1=strtotime($f1); $fA=strtotime($fechaA);
		if ($fechaA<'2018-01-01'){
			$sqlc="SELECT nombre, id_conv FROM convocatorias WHERE id_conv=1";
		}elseif ($fechaA<'2018-04-15'){//1547
			$sqlc="SELECT nombre, id_conv FROM convocatorias WHERE id_conv=2";
		}elseif ($fechaA<'2018-06-01'){
			$sqlc="SELECT nombre, id_conv FROM convocatorias WHERE id_conv=3";
		}elseif ($fechaA<'2018-07-01'){
			$sqlc="SELECT nombre, id_conv FROM convocatorias WHERE id_conv=4";
		}elseif ($fechaA<'2018-09-15'){
			$sqlc="SELECT nombre, id_conv FROM convocatorias WHERE id_conv=5";
		}
	}elseif (($cadena=="formBajaEva1") || ($cadena=="formModEva1")){
		$output=$output . '<select name="conv" required size="4">';
		$sqlc="SELECT nombre FROM convocatorias WHERE id_conv IN (SELECT id_conv FROM notas WHERE id_materia IN (SELECT id_materia FROM asignaturas WHERE id_docente='$idDoc'))";
	}
	$resultc=mysqli_query($conexion, $sqlc);
	if (mysqli_num_rows($resultc) > 0){
		while($rowc=mysqli_fetch_assoc($resultc)){
			$output= $output . '<option>' . $rowc["nombre"] . '</option>';
		}
	$conv=$rowc["id_conv"];
	}
	else{
		$output= $output . '<optiond></option>';
	}
	$output=$output . '</select></p><br><hr><br>
	<p align="center"><label>Materia a evaluar:</label><select name="materia" required size="6">';//1541
	//SELECCIONAR MATERIA
	if ($cadena=="formAltaEva1"){
		//$sqlm="SELECT nombre FROM materias WHERE id_materia  IN (SELECT id_materia FROM notas WHERE id_matricula IN (SELECT id_matriculas, año_a FROM matriculas WHERE  año_a='$A'))";
		$sqlm="SELECT nombre FROM materias WHERE id_materia  IN (SELECT id_materia FROM asignaturas WHERE id_docente='$idDoc')";//año academico actual
	}elseif (($cadena=="formBajaEva1") || ($cadena=="formModEva1")){
		$sqlm="SELECT nombre FROM materias WHERE id_materia IN (SELECT id_materia FROM notas WHERE id_materia IN (SELECT id_materia FROM asignaturas WHERE id_docente='$idDoc'))";
	}
	$resultm=mysqli_query($conexion, $sqlm);
	if (mysqli_num_rows($resultu) > 0){
		while($rowm=mysqli_fetch_assoc($resultm)){
			$output= $output . '<option>' . $rowm["nombre"] . '</option>';
		}
	}else{
		$output= $output . '<optiond></option>';
	}
	$output=$output . '</select></p>
	</div><br></fieldset>
	</p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<input type="submit" value="Siguiente" name="Siguiente2" style="font-weight:bold; color:black">  
	</p><input type="hidden" value="' . $idDoc . '" name="idDoc">
	</form>';
return($output);
}/********************* end seleccion_evaluaciones ************************/


/************************** listados evaluaciones ***********************/
function listados_evaluaciones(){		
$output="";
$conexion=bdexternaD();

/*if ((!$_POST || isset($_POST["Salir"])) && ($user->name == "alillo")){
	//Identificacion
	$output=identificacion("evaluaciones");//1499

//}elseif (!$_POST || isset($_POST["Siguiente1"])|| isset($_POST["Atras"]) || isset($_POST["Cancelar"])){//1615

}elseif (!$_POST || isset($_POST["Siguiente1"]) || isset($_POST["Salir"]) || isset($_POST["Atras"]) || isset($_POST["Cancelar"])){
  if (!$_POST || isset($_POST["Siguiente1"])){
	if ($user->name == "alillo"){
		$emailDoc=$_POST["email"];
	}else{//1185
		$emailDoc=$user->mail;//$_POST["password"]=$user->pass;
	}

*/
if (!$_POST){
	//Identificacion
	$output=identificacion("evaluaciones");

}elseif (isset($_POST["SiguienteE"]) || isset($_POST["Atras"]) || isset($_POST["Salir"])){//1602
	if (isset($_POST["SiguienteE"])){
		$emailDoc=$_POST["email"];
		$sql="SELECT * FROM docentes WHERE email='$emailDoc'";
		$result=mysqli_query($conexion, $sql);
		if (mysqli_num_rows($result) == 1){
			$row=mysqli_fetch_assoc($result);$idDoc=$row["ID_DOCENTES"];
			$error=false;
		}else{
			$error=true;
		}
	}
	else{
		$error=false;
		$idDoc=$_POST["idDoc"];
	}
	if (!$error){
		$output= '<form id="formListarEva" action="" method="post" accept-charset="UTF-8" size="100%">
		<p>
		<fieldset form="formListarEva">
		<legend align="left"><SPAN style="text-align:top">B&uacute;squedad de informaci&oacute;n de Evaluaciones</SPAN></legend>
		<br><br>
		<p align="center"><b>Seleccionar el tipo de b&uacute;squedad por:</b>
		&emsp;<select name="tipoDatos" required><option selected>Unidad</option><option>Estudiante</option></select></p>
		<br>
		<p align="center"><input type="submit" value="Buscar Datos" name="Buscar" style="font-weight:bold; color:black">
		<input type="hidden" value="' . $idDoc . '" name="idDoc"></p>
		</p>
		</fieldset>
		</form>';
	}else{
		$output='<form id="formListarEvaValidar" action="" method="post" accept-charset="UTF-8" size="100%">
		<p>
		<fieldset form="formListarEvaValidar">
		<legend align="left"><SPAN style="text-align:top">Mensaje de Atenci&oacute;n</SPAN></legend>
		<br><br>
		<p align="center">Los datos introducidos no son correctos: (email y/o password).</p>
		<p align="center"><input type="button" onclick="history.back()" value="Volver a intentarlo" name="Volver Atras" style="font-weight:bold; color:black"></p>
		</fieldset></p></form>';
	}
}elseif (isset($_POST["Buscar"])|| isset($_POST["Atras1"]) || isset($_POST["Cancelar"])){//1638
	if ($_POST["tipoDatos"]=="Unidad"){//POR UNIDAD
		//SELECCIONAR AÑO
		$output='<form id="formBusEvaUni" action="" method="post" accept-charset="UTF-8" size="100%">
		<p>
		<fieldset form="formBusEvaUni">
		<legend align="left"><SPAN style="text-align:top">Selecci&oacute;n de datos para b&uacute;squeda</SPAN></legend>
		<br><br>
		<p align="center"><label>Elegir un A&ntilde;o Acad&eacute;mico de la lista:</label><select name="annoa" required size="5" autofocus>';
		$sqla="SELECT DISTINCT año_a FROM matriculas ORDER BY año_a DESC";
		$resulta=mysqli_query($conexion, $sqla);
		$reg=0;
		if (mysqli_num_rows($resulta) > 0){
			while($rowa=mysqli_fetch_assoc($resulta)){//1658
				$reg=$reg+1;
				if ($reg == 1){
					$output= $output . '<option selected>' . $rowa["año_a"] . '</option>';
				}else{
					$output= $output . '<option>' . $rowa["año_a"] . '</option>';
				}
			}
			$error=false;
		}
		else{
			$lista="Sin datos de años acad&eacute;micos"; $output= $output . '<optiond selected>' . $lista . '</option>';
			$error=true;
		}
		$output=$output . '</select></p>
		</p>
		</fieldset>
		<p align="left"><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<input type="submit" value="Volver Atr&aacute;s" name="Atras" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
		if ($error){
			$output=$output . '<input type="submit" value="Siguiente" name="SiguienteU" style="font-weight:bold; color:black" disabled>';
		}else{
			$output=$output . '<input type="submit" value="Siguiente" name="SiguienteU" style="font-weight:bold; color:black">';
		}
		$output=$output . '<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"><input type="hidden" value="' . $_POST["tipoDatos"] . '" name="tipoDatos">
		</form>';
	}else{//POR ESTUDIANTE MATRICULADO
		$idDoc=$_POST["idDoc"];
		$output='<form id="formBusEvaEst" action="" method="post" accept-charset="UTF-8" size="100%">
		<p>
		<fieldset form="formBusEvaEst">
		<legend align="left"><SPAN style="text-align:top">Selecci&oacute;n de datos para b&uacute;squeda</SPAN></legend>
		<br><br>
		<p align="center"><label>Elegir un Estudiante de la lista:</label><select name="est" required size="5" autofocus>';
		$sqle="SELECT id_est, nombre, apellidos FROM estudiantes WHERE id_est IN (SELECT id_est FROM matriculas WHERE id_matriculas IN (SELECT id_matriculas FROM detalle_matricula WHERE id_gruposa IN (SELECT id_gruposa FROM asignaturas WHERE id_docente='$idDoc')))";
		//$sqla="SELECT DISTINCT año_a FROM matriculas ORDER BY año_a DESC";
		$resulte=mysqli_query($conexion, $sqle);
		$reg=0;
		if (mysqli_num_rows($resulte) > 0){
			while($rowe=mysqli_fetch_assoc($resulte)){//1658
				$reg=$reg+1;
				if ($reg == 1){
					$output= $output . '<option selected>' . $rowe["apellidos"] . ', ' . $rowe["nombre"] . '</option>';
				}else{
					$output= $output . '<option>' . $rowe["apellidos"] . ', ' . $rowe["nombre"] . '</option>';
				}
			}
			$error=false;
		}
		else{
			$lista="Sin datos de años acad&eacute;micos"; $output= $output . '<optiond selected>' . $lista . '</option>';
			$error=true;
		}
		$output=$output . '</select></p>
		</p>
		</fieldset>
		<p align="left"><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<input type="submit" value="Volver Atr&aacute;s" name="Atras" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
		if ($error){
			$output=$output . '<input type="submit" value="Siguiente" name="SiguienteA" style="font-weight:bold; color:black" disabled>';
		}else{
			$output=$output . '<input type="submit" value="Siguiente" name="SiguienteA" style="font-weight:bold; color:black">';
		}//1733
		$output=$output . '<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"><input type="hidden" value="' . $_POST["tipoDatos"] . '" name="tipoDatos">
		</form>';

		/*$output='<form id="formErrorListaEva" action="" method="post" accept-charset="UTF-8" size="100%">
		<fieldset form="formErrorListaEva"><p>
		<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend>
		<br>
		<p align="center">Se ha producido un error en la b&uacute;squeda de informaci&oacute;n de cursos acad&eacute;micos.</p>
		<p align="center"><input type="submit" value="Aceptar" name="Cancelar" style="font-weight:bold; color:black"></p>
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc">
		<input type="hidden" value="' . $_POST["tipoDatos"] . '" name="tipoDatos"></p></fieldset></form>';
		$output=$output . '<p align="left"><font color="red">'. mysqli_error($conexion) . '</font></p>';	*/

	}
}elseif (isset($_POST["SiguienteU"]) || isset($_POST["Atras2"])){
$ano=$_POST["annoa"];$idDoc=$_POST["idDoc"];
//SELECCIONAR UNIDAD
if ($_POST["tipoDatos"]=="Unidad"){
	$output='<form id="formBusEvaUni1" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formBusEvaUni1">
	<legend align="left"><SPAN style="text-align:top">Selecci&oacute;n de datos para b&uacute;squeda</SPAN></legend>
	<br><br>
	<p align="left">&nbsp;&nbsp;&nbsp;&nbsp;A&ntildeo Acad&eacute;mico:&nbsp;<input type="text" name="annoa" value="' . $_POST["annoa"] . '" disabled size="10%"></p>
	<hr><br>
	<p align="center"><label>Elegir una Unidad de la lista:</label><select name="unidad" required size="7" autofocus>';
	$sqlu="SELECT nombre FROM grupos_a WHERE id_gruposa IN (SELECT id_gruposa FROM notas WHERE id_gruposa IN (SELECT id_gruposa FROM asignaturas WHERE id_docente='$idDoc' AND id_gruposa IN (SELECT id_gruposa FROM detalle_matricula WHERE id_matriculas IN (SELECT id_matriculas FROM matriculas WHERE año_a='$ano'))))";
	$resultu=mysqli_query($conexion, $sqlu);
	$reg=0;
	if (mysqli_num_rows($resultu) > 0){
		while($rowu=mysqli_fetch_assoc($resultu)){
			$reg=$reg+1;
			if ($reg == 1){
				$output= $output . '<option selected>' . $rowu["nombre"] . '</option>';
			}else{
				$output= $output . '<option>' . $rowu["nombre"] . '</option>';
			}
		}
		$error=false;
	}
	else{
		$error=true; $lista="Sin datos de unidades con docente asignado";
		$output= $output . '<option selected>' . $lista . '</option>';
	}
	$output=$output . '</select></p>
	</p>
	</fieldset>
	<p align="left"><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<input type="submit" value="Volver Atr&aacute;s" name="Atras1" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($error){
		$output=$output . '<input type="submit" value="Siguiente" name="SiguienteM" style="font-weight:bold; color:black" disabled>';
	}else{
		$output=$output . '<input type="submit" value="Siguiente" name="SiguienteM" style="font-weight:bold; color:black">';//1733
	}
	$output=$output . '<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"><input type="hidden" value="' . $_POST["annoa"] . '" name="annoa">
	<input type="hidden" value="' . $_POST["tipoDatos"] . '" name="tipoDatos">
	</form>';
}else{
	$nombre=substr($_POST["est"], (strpos($_POST["est"], ",")+1));
	$long=strlen($nombre);
	$nombre=ltrim($nombre);
	$apellidos=substr($_POST["est"], 0, -($long+1));
	$apellidos=ltrim($apellidos);
	$output='<form id="formBusEvaEst1" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formBusEvaEst1">
	<legend align="left"><SPAN style="text-align:top">Selecci&oacute;n de datos para b&uacute;squeda</SPAN></legend>
	<br><br>
	<p align="left">&nbsp;&nbsp;&nbsp;&nbsp;A&ntildeo Acad&eacute;mico:&nbsp;<input type="text" name="annoa" value="' . $_POST["annoa"] . '" disabled size="10%"></p>
	<p align="left">&nbsp;&nbsp;&nbsp;&nbsp;Estudiante:&nbsp;<input type="text" name="est" value="' . $_POST["est"] . '" disabled size="30%"></p>
	<hr><br>
	<p align="center"><label>Elegir una Unidad de la lista:</label><select name="unidad" required size="7" autofocus>';
	$sqlu="SELECT nombre FROM grupos_a WHERE id_gruposa IN (SELECT id_gruposa FROM notas WHERE id_gruposa IN (SELECT id_gruposa FROM asignaturas WHERE id_docente='$idDoc' AND id_gruposa IN (SELECT id_gruposa FROM detalle_matricula WHERE id_matriculas IN (SELECT id_matriculas FROM matriculas WHERE año_a='$ano' AND id_est IN (SELECT id_est FROM estudiantes WHERE apellidos='$apellidos' AND nombre='$nombre')))))";
	$resultu=mysqli_query($conexion, $sqlu);
	$reg=0;
	if (mysqli_num_rows($resultu) > 0){
		while($rowu=mysqli_fetch_assoc($resultu)){
			$reg=$reg+1;
			if ($reg == 1){
				$output= $output . '<option selected>' . $rowu["nombre"] . '</option>';
			}else{
				$output= $output . '<option>' . $rowu["nombre"] . '</option>';
			}
		}
		$error=false;
	}
	else{
		$error=true; $lista="Sin datos de unidades con docente asignado";
		$output= $output . '<option selected>' . $lista . '</option>';
	}
	$output=$output . '</select></p>
	</p>
	</fieldset>
	<p align="left"><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<input type="submit" value="Volver Atr&aacute;s" name="Atras4" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($error){
		$output=$output . '<input type="submit" value="Siguiente" name="SiguienteL" style="font-weight:bold; color:black" disabled>';
	}else{
		$output=$output . '<input type="submit" value="Siguiente" name="SiguienteL" style="font-weight:bold; color:black">';//1733
	}
	$output=$output . '<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"><input type="hidden" value="' . $_POST["annoa"] . '" name="annoa">
	<input type="hidden" value="' . $_POST["tipoDatos"] . '" name="tipoDatos"><input type="hidden" value="' . $_POST["est"] . '" name="est">
	</form>';	
}	
}elseif (isset($_POST["SiguienteM"]) || isset($_POST["Atras3"])){
	//SELECCIONAR MATERIA
	$ano=$_POST["annoa"];$idDoc=$_POST["idDoc"]; $uni=$_POST["unidad"];
	$sqlu="SELECT id_gruposa FROM grupos_a WHERE nombre='$uni'";
	$resultu=mysqli_query($conexion, $sqlu);
	$rowu=mysqli_fetch_assoc($resultu);
	$idU=$rowu["id_gruposa"];
	$output='<form id="formBusEvaUni2" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formBusEvaUni2">
	<legend align="left"><SPAN style="text-align:top">Selecci&oacute;n de datos para b&uacute;squeda</SPAN></legend>
	<br><br>
	<p align="left">&nbsp;&nbsp;&nbsp;&nbsp;A&ntildeo Acad&eacute;mico:&nbsp;<input type="text" name="annoa" value="' . $_POST["annoa"] . '" disabled size="10%"></p>
	<p align="left">&nbsp;&nbsp;&nbsp;&nbsp;Unidad:&nbsp;<input type="text" name="annoa" value="' . $_POST["unidad"] . '" disabled size="30%"></p>
	<hr><br>
	<p align="center"><label>Elegir una Materia de la lista:</label><select name="materia" required size="7" autofocus>';// AND id_gruposa=''
	$sqlm="SELECT nombre FROM materias WHERE id_materia IN (SELECT id_materia FROM notas WHERE id_materia IN (SELECT id_materia FROM asignaturas WHERE id_docente='$idDoc'AND id_gruposa='$idU'))";
	$resultm=mysqli_query($conexion, $sqlm);
	$reg=0;
	if (mysqli_num_rows($resultm) > 0){
		while($rowm=mysqli_fetch_assoc($resultm)){
			$reg=$reg+1;
			if ($reg == 1){
				$output= $output . '<option selected>' . $rowm["nombre"] . '</option>';
			}else{
				$output= $output . '<option>' . $rowm["nombre"] . '</option>';
			}
		}
		$error=false;
	}
	else{
		$error=true; $lista="Sin datos de materias";
		$output= $output . '<optiond selected>' . $lista . '</option>';
	}
	$output=$output . '</select></p>
	</p>
	</fieldset>
	<p align="left"><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<input type="submit" value="Volver Atr&aacute;s" name="Atras2" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($error){
		$output= $output . '<input type="submit" value="Siguiente" name="SiguienteL" style="font-weight:bold; color:black" disabled>';
	}else{
		$output= $output . '<input type="submit" value="Siguiente" name="SiguienteL" style="font-weight:bold; color:black">';
	}//1771
	$output=$output . '<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"><input type="hidden" value="' . $_POST["annoa"] . '" name="annoa">
	<input type="hidden" value="' . $_POST["tipoDatos"] . '" name="tipoDatos"><input type="hidden" value="' . $_POST["unidad"] . '" name="unidad">
	</form>';
}elseif (isset($_POST["SiguienteA"]) || isset($_POST["Atras4"])){
	//SELECCIONAR AÑO
	$idDoc=$_POST["idDoc"];
	$nombre=substr($_POST["est"], (strpos($_POST["est"], ",")+1));
	$long=strlen($nombre);
	$nombre=ltrim($nombre);
	$apellidos=substr($_POST["est"], 0, -($long+1));
	$apellidos=ltrim($apellidos);
	$output='<form id="formBusEvaEst2" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formBusEvaEst2">
	<legend align="left"><SPAN style="text-align:top">Selecci&oacute;n de datos para b&uacute;squeda</SPAN></legend>
	<br><br>
	<p align="left">&nbsp;&nbsp;&nbsp;&nbsp;Estudiante:&nbsp;<input type="text" name="est" value="' . $_POST["est"] . '" disabled size="30%"></p>
	<hr><br>
	<p align="center"><label>Elegir un A&ntilde;o Acad&eacute;mico de la lista:</label><select name="annoa" required size="5" autofocus>';
	$sqla="SELECT DISTINCT año_a FROM matriculas WHERE id_est IN (SELECT id_est FROM estudiantes WHERE apellidos='$apellidos' AND nombre='$nombre' )  ORDER BY año_a DESC";
	$resulta=mysqli_query($conexion, $sqla);
	$reg=0;
	if (mysqli_num_rows($resulta) > 0){
		while($rowa=mysqli_fetch_assoc($resulta)){//1658
			$reg=$reg+1;
			if ($reg == 1){
				$output= $output . '<option selected>' . $rowa["año_a"] . '</option>';
			}else{
				$output= $output . '<option>' . $rowa["año_a"] . '</option>';
			}
		}
		$error=false;
	}
	else{
		$lista="Sin datos de años acad&eacute;micos"; $output= $output . '<optiond selected>' . $lista . '</option>';
		$error=true;
	}
	$output=$output . '</select></p>
	</p>
	</fieldset>
	<p align="left"><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<input type="submit" value="Volver Atr&aacute;s" name="Atras1" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($error){
		$output=$output . '<input type="submit" value="Siguiente" name="SiguienteU" style="font-weight:bold; color:black" disabled>';
	}else{
		$output=$output . '<input type="submit" value="Siguiente" name="SiguienteU" style="font-weight:bold; color:black">';
	}
	$output=$output . '<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"><input type="hidden" value="' . $_POST["tipoDatos"] . '" name="tipoDatos">
	<input type="hidden" value="' . $_POST["est"] . '" name="est">
	</form>';		
}elseif (isset($_POST["SiguienteL"])){
if ($_POST["tipoDatos"]=="Unidad"){
	//SELECCIONAR ESTUDIANTES MATRICULADOS
//$anoActual=date("Y");
	$ano=$_POST["annoa"];$idDoc=$_POST["idDoc"]; $uni=$_POST["unidad"];$mat=$_POST["materia"];
	$sqlu="SELECT id_gruposa FROM grupos_a WHERE nombre='$uni'";
	$rowu=mysqli_fetch_assoc(mysqli_query($conexion, $sqlu));$idU=$rowu["id_gruposa"];
	$sqlm="SELECT id_materia FROM materias WHERE nombre='$mat'";
	$rowm=mysqli_fetch_assoc(mysqli_query($conexion, $sqlm));$idM=$rowm["id_materia"];
	$sqlc="SELECT num_conv FROM ciclos WHERE id_ciclo IN (SELECT id_ciclo FROM cursos WHERE id_curso IN (SELECT id_curso FROM grupos_a WHERE id_gruposa='$idU '))";
	$resultc=mysqli_query($conexion, $sqlc);
	$rowc=mysqli_fetch_assoc($resultc);
	$sqla="SELECT id_matriculas, id_est, año_a FROM matriculas WHERE  año_a='$ano' AND  id_matriculas IN (SELECT id_matriculas FROM detalle_matricula WHERE id_gruposa='$idU' AND id_materia='$idM' AND id_matriculas IN (SELECT id_matricula FROM notas))";
	$resulta=mysqli_query($conexion, $sqla);// $cont=mysqli_num_rows($resulta);
	if (mysqli_num_rows($resulta) > 0){
		//LISTAR
		$output='<form id="formBusEvaUni3" action="" method="post" accept-charset="UTF-8" size="100%">
		<p>
		<fieldset form="formBusEvaUni3">
		<legend align="left"><SPAN style="text-align:top">Listado de notas por unidad</SPAN></legend>
		<br><br>
		<div style="width:50%; float:left;">
		<p align="left">&nbsp;&nbsp;&nbsp;&nbsp;A&ntildeo Acad&eacute;mico:&nbsp;<input type="text" name="annoa" value="' . $_POST["annoa"] . '" disabled size="10%"></p>
		</div>
		<div style="width:50%; float:left;">
		<p align="right">Materia:&nbsp;<input type="text" name="materia" value="' . $_POST["materia"] . '" disabled size="35%">&nbsp;&nbsp;&nbsp;&nbsp;</p>
		</div>
		<p align="left">&nbsp;&nbsp;&nbsp;&nbsp;Unidad:&nbsp;<input type="text" name="annoa" value="' . $_POST["unidad"] . '" disabled size="30%"></p>
		<hr>
		<p align="center"><table border="2"><tr><th style="text-align:center"><font size="3">Estudiante</font></th>
		<th style="text-align:center"><font size="3">Trim 1</font></th>
		<th style="text-align:center"><font size="3">Trim 2</font></th><th style="text-align:center"><font size="3">Trim 3</font></th>
		<th style="text-align:center"><font size="3">Ordinaria</font></th>';
		if ($rowc["num_conv"]==5){
			$output=$output . '<th style="text-align:center"><font size="3">ExtraOrd</font></th></tr>';
		}else{
			$output=$output . '</tr>';
		}
		while ($rowa=mysqli_fetch_assoc($resulta)){
			$idE=$rowa["id_est"];$idMatr=$rowa["id_matriculas"];//1792
			$sqle="SELECT nombre, apellidos FROM estudiantes WHERE id_est='$idE'";
			$rowe=mysqli_fetch_assoc(mysqli_query($conexion, $sqle));
			
			$output=$output . '<tr><td><font size="2" color="blue">' . $rowe["apellidos"] . ', ' . $rowe["nombre"] . '</font></td>';
			$sqln="SELECT id_conv, notan FROM notas WHERE id_matricula='$idMatr' AND id_gruposa='$idU' AND id_materia='$idM'";
			$resultn=mysqli_query($conexion, $sqln);
			if (mysqli_num_rows($resultn) > 0){
				$i=0;$error=false;
				while ($rown=mysqli_fetch_assoc($resultn)){
					$i=$i+1;
					$output=$output . '<td style="text-align:center"><input type="number" name="notan' . $i . '" value="' . $rown["notan"] . '" size="3%" disabled style="color:blue; background:white"></td>';
				
				}//while
				while ($i<$rowc["num_conv"]){
					$i=$i+1;
					$output=$output . '<td style="text-align:center"><input type="number" name="notan' . $i . '" value="" size="3%" disabled style="color:blue; background:white"></td>';
				}//while
				$output=$output . '</tr>';
			}else{	
				$error=true;
				$output='<form id="formErrorListaEva1" action="" method="post" accept-charset="UTF-8" size="100%">
				<fieldset form="formErrorListaEva1"><p>
				<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend>
				<br>
				<p align="center">Se ha producido un error en la b&uacute;squeda de informaci&oacute;n de evaluaciones.</p>
				<p align="center"><input type="submit" value="Aceptar" name="Cancelar" style="font-weight:bold; color:black"></p>
				<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc">
				<input type="hidden" value="' . $_POST["tipoDatos"] . '" name="tipoDatos"></p></fieldset></form>';
				$output=$output . '<p align="left"><font color="red">'. mysqli_error($conexion) . '</font></p>';
			}
		}//while
		if (!$error){
			$output=$output . '</table></p>
			</fieldset>
			<p align="left">
			<input type="submit" value="Volver Atr&aacute;s" name="Atras3" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			<input type="submit" value="Salir" name="Salir" style="font-weight:bold; color:black">
			<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"><input type="hidden" value="' . $_POST["annoa"] . '" name="annoa">
			<input type="hidden" value="' . $_POST["tipoDatos"] . '" name="tipoDatos"><input type="hidden" value="' . $_POST["unidad"] . '" name="unidad">
			</form>';
		}
	}else{
		$output='<form id="formErrorListaEva2" action="" method="post" accept-charset="UTF-8" size="100%">
		<fieldset form="formErrorListaEva2"><p>
		<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend>
		<br>
		<p align="center">Se ha producido un error en la b&uacute;squeda de informaci&oacute;n en matriculas.</p>
		<p align="center"><input type="submit" value="Aceptar" name="Cancelar" style="font-weight:bold; color:black"></p>
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc">
		<input type="hidden" value="' . $_POST["tipoDatos"] . '" name="tipoDatos"></p></fieldset></form>';
		$output=$output . '<p align="left"><font color="red">'. mysqli_error($conexion) . '</font></p>';
	}
}else{
	$ano=$_POST["annoa"];$idDoc=$_POST["idDoc"];$uni=$_POST["unidad"];
	$sqlu="SELECT id_gruposa FROM grupos_a WHERE nombre='$uni'";
	$rowu=mysqli_fetch_assoc(mysqli_query($conexion, $sqlu));$idU=$rowu["id_gruposa"];
	$nombre=substr($_POST["est"], (strpos($_POST["est"], ",")+1));
	$long=strlen($nombre);
	$nombre=ltrim($nombre);
	$apellidos=substr($_POST["est"], 0, -($long+1));
	$apellidos=ltrim($apellidos);//2018
	$sqlmt="SELECT id_matriculas FROM matriculas WHERE año_a='$ano' AND id_matriculas IN (SELECT id_matriculas FROM detalle_matricula WHERE id_gruposa='$idU') AND id_est IN (SELECT id_est FROM estudiantes WHERE apellidos='$apellidos' AND nombre='$nombre')";
	$rowmt=mysqli_fetch_assoc(mysqli_query($conexion, $sqlmt));$idMt=$rowmt["id_matriculas"];
	$sqlc="SELECT num_conv FROM ciclos WHERE id_ciclo IN (SELECT id_ciclo FROM cursos WHERE id_curso IN (SELECT id_curso FROM grupos_a WHERE id_gruposa='$idU'))";
	$resultc=mysqli_query($conexion, $sqlc);
	$rowc=mysqli_fetch_assoc($resultc);
	//MATERIAS
	$sqlm="SELECT nombre, id_materia FROM materias WHERE id_materia IN (SELECT id_materia FROM notas WHERE id_gruposa='$idU' AND id_matricula IN (SELECT id_matriculas FROM matriculas WHERE año_a='$ano' AND id_matriculas IN (SELECT id_matriculas FROM detalle_matricula WHERE id_gruposa='$idU')))";
	$resultm=mysqli_query($conexion, $sqlm);
	if (mysqli_num_rows($resultm) > 0){
		$output='<form id="formBusEvaEst3" action="" method="post" accept-charset="UTF-8" size="100%">
		<p>
		<fieldset form="formBusEvaEst3">
		<legend align="left"><SPAN style="text-align:top">Listado de notas por estudiante</SPAN></legend>
		<br><br>
		<div style="width:50%; float:left;">
		<p align="left">&nbsp;&nbsp;&nbsp;&nbsp;A&ntildeo Acad&eacute;mico:&nbsp;<input type="text" name="annoa" value="' . $_POST["annoa"] . '" disabled size="10%"></p>
		</div>
		<div style="width:50%; float:left;">Unidad:&nbsp;<input type="text" name="materia" value="' . $_POST["unidad"] . '" disabled size="35%">&nbsp;&nbsp;&nbsp;&nbsp;
		<p align="right"></p>
		</div>
		<p align="left">&nbsp;&nbsp;&nbsp;&nbsp;Estudiante:&nbsp;<input type="text" name="est" value="' . $_POST["est"] . '" disabled size="30%"></p>
		<hr>
		<p align="center"><table border="2"><tr><th style="text-align:center"><font size="3">Materia</font></th>
		<th style="text-align:center"><font size="3">Trim 1</font></th>
		<th style="text-align:center"><font size="3">Trim 2</font></th><th style="text-align:center"><font size="3">Trim 3</font></th>
		<th style="text-align:center"><font size="3">Ordinaria</font></th>';
		if ($rowc["num_conv"]==5){
			$output=$output . '<th style="text-align:center"><font size="3">ExtraOrd</font></th></tr>';
		}else{
			$output=$output . '</tr>';
		}
		//$sqlt="SELECT id_gruposa FROM asignaturas WHERE id_docente='$idDoc' AND tutor=1";
		while ($rowm=mysqli_fetch_assoc($resultm)){
			$nombM=$rowm["nombre"];$idM=$rowm["id_materia"];
			$sqln="SELECT id_conv, notan FROM notas WHERE id_matricula='$idMt' AND id_materia='$idM' AND id_gruposa='$idU'";
			$output=$output . '<tr><td><font size="2" color="blue">' . $rowm["nombre"] . '</font></td>';
			$resultn=mysqli_query($conexion, $sqln);
			if (mysqli_num_rows($resultn) > 0){
				$i=0;$error=false;
				while ($rown=mysqli_fetch_assoc($resultn)){
					$i=$i+1;
					$output=$output . '<td style="text-align:center"><input type="number" name="notan' . $i . '" value="' . $rown["notan"] . '" size="3%" disabled style="color:blue; background:white"></td>';
				
				}//while
				while ($i<$rowc["num_conv"]){
					$i=$i+1;
					$output=$output . '<td style="text-align:center"><input type="number" name="notan' . $i . '" value="" size="3%" disabled style="color:blue; background:white"></td>';
				}//while
				$output=$output . '</tr>';
			}else{	
				$error=true;
				$output='<form id="formErrorListaEva1" action="" method="post" accept-charset="UTF-8" size="100%">
				<fieldset form="formErrorListaEva1"><p>
				<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend>
				<br>
				<p align="center">Se ha producido un error en la b&uacute;squeda de informaci&oacute;n de evaluaciones.</p>
				<p align="center"><input type="submit" value="Aceptar" name="Cancelar" style="font-weight:bold; color:black"></p>
				<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc">
				<input type="hidden" value="' . $_POST["tipoDatos"] . '" name="tipoDatos"></p></fieldset></form>';
				$output=$output . '<p align="left"><font color="red">'. mysqli_error($conexion) . '</font></p>';

			}
		}//while
		if (!$error){
			$output=$output . '</table></p>
			</fieldset>
			<p align="left">
			<input type="submit" value="Volver Atr&aacute;s" name="Atras2" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			<input type="submit" value="Salir" name="Salir" style="font-weight:bold; color:black">
			<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"><input type="hidden" value="' . $_POST["annoa"] . '" name="annoa">
			<input type="hidden" value="' . $_POST["tipoDatos"] . '" name="tipoDatos">
			<input type="hidden" value="' . $_POST["est"] . '" name="est">
			</form>';
		}	
	}else{
		$output='<form id="formErrorListaEva2" action="" method="post" accept-charset="UTF-8" size="100%">
		<fieldset form="formErrorListaEva2"><p>
		<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend>
		<br>
		<p align="center">Se ha producido un error en la b&uacute;squeda de informaci&oacute;n en matriculas de materias.</p>
		<p align="center"><input type="submit" value="Aceptar" name="Cancelar" style="font-weight:bold; color:black"></p>
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc">
		<input type="hidden" value="' . $_POST["tipoDatos"] . '" name="tipoDatos"></p></fieldset></form>';
		$output=$output . '<p align="left"><font color="red">'. mysqli_error($conexion) . '</font></p>';
	}//if sqlm
}//if tipoDatos	
}//SiguienteL
	
mysqli_close($conexion);	
return($output);
}/****************** end listados_evaluaciones ***************/


/********************** alta evaluaciones *******************/
function alta_evaluaciones(){		
$output="";
GLOBAL $user;
$conexion=bdexternaD();


if ((!$_POST || isset($_POST["Salir"])) && ($user->name == "alillo")){
	//Identificacion
	$output=identificacion("evaluaciones");//1499

/*}elseif (!$_POST || isset($_POST["Siguiente1"])|| isset($_POST["Atras"]) || isset($_POST["Cancelar"])){//1615*/

}elseif (!$_POST || isset($_POST["SiguienteE"]) || isset($_POST["Salir"]) || isset($_POST["Atras"]) || isset($_POST["Cancelar"])){
  if (!$_POST || isset($_POST["SiguienteE"])){
	if ($user->name == "alillo"){
		$emailDoc=$_POST["email"];
	}else{//1185
		$emailDoc=$user->mail;//$_POST["password"]=$user->pass;
	}
	$sql="SELECT * FROM docentes WHERE email='$emailDoc'";
	$result=mysqli_query($conexion, $sql);
	if ((mysqli_num_rows($result) == 1)){//1190
		while($row=mysqli_fetch_assoc($result)){
			$output=$row["ID_DOCENTES"] . seleccion_evaluaciones("formAltaEva1", $row["ID_DOCENTES"]);
		}//while
		$error=false;
	}else{
		$error=true;
	}
  }else{
  	$id_doc=$_POST["idDoc"];
  	$output=seleccion_evaluaciones("formAltaEva1", $id_doc);
  	$error=false;
  }
  if ($error){
	$output='<form id="formAltaEvaValidar" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formAltaEvaValidar">
	<legend align="left"><SPAN style="text-align:top">Mensaje de Atenci&oacute;n</SPAN></legend>
	<br><br>
	<p align="center">Los datos introducidos no son correctos: (email y/o password).</p>
	<p align="center"><input type="button" onclick="history.back()" value="Volver a intentarlo" name="Volver Atras" style="font-weight:bold; color:black"></p>
	</fieldset></p></form><br>' . $user->pass;
  }

}elseif (isset($_POST["Siguiente2"])){//1692
$Anno=date("Y");  $anno2=$Anno+1; $anno_a=$Anno . '-' . $anno2;
	$nombU=$_POST["unidad"];$nombM=$_POST["materia"];$nombC=$_POST["conv"];
	$sqlu="SELECT id_gruposa FROM grupos_a WHERE nombre='$nombU'";
	$rowu=mysqli_fetch_assoc(mysqli_query($conexion, $sqlu));$idU=$rowu["id_gruposa"];
	$sqlm="SELECT id_materia FROM materias WHERE nombre='$nombM'";
	$rowm=mysqli_fetch_assoc(mysqli_query($conexion, $sqlm));$idM=$rowm["id_materia"];
	$sqlc="SELECT id_conv FROM convocatorias WHERE nombre='$nombC'";
	$rowc=mysqli_fetch_assoc(mysqli_query($conexion, $sqlc));$idC=$rowc["id_conv"];
	$A="2014-2015";//1572
	$sqla="SELECT id_matriculas, id_est, año_a FROM matriculas WHERE  año_a='$A' AND  id_matriculas IN (SELECT id_matriculas FROM detalle_matricula WHERE id_gruposa='$idU' AND id_materia='$idM')";
//$output='anno1: ' . $Anno .  ' anno2: ' . $anno2 . ' anno_a: ' . $anno_a;
	$resulta=mysqli_query($conexion, $sqla);
	if (mysqli_num_rows($resulta) > 0){//1575
		$contEst=0;$existeM=false;
		$output= '<form id="formAltaEva2" action="" method="post" accept-charset="UTF-8" size="100%">
		<p>
		<fieldset form="formAltaEva2">
		<legend align="left"><SPAN style="text-align:top">Entrada de notas</SPAN></legend>
		<br><br>
		<div style="width:50%; float:left;">
		<p align="left">&emsp;&nbsp;A&ntilde;o Acad&eacute;mico:&nbsp;<input type="text" name="annoA" disabled size="10%" value="' . $anno_a . '"></p>
		<p align="left">&emsp;&nbsp;Unidad:&nbsp;<input type="text" name="unidad" disabled size="30%" value="' . $_POST["unidad"] . '"></p>
		</div>
		<div style="width:50%; float:left;">
		<p align="right">Convocatoria:&nbsp;<input align="right" type="text" name="conv" disabled size="16%" value="' . $_POST["conv"] . '">&emsp;&nbsp;</p>
		<p align="right">Materia:&nbsp;<input type="text" name="materia" disabled size="20%" value="' . $_POST["materia"] . '">&emsp;&nbsp;</p>
		</div>
		<br><br>
		<p align="center"><table border="2"><tr><th style="text-align:center"><font size="3">Estudiante</font></th><th style="text-align:center"><font size="3">Nota N&uacute;merica</font></th><th style="text-align:center"><font size="3">Nota Valorativa</font></th></tr>';
		while($rowa=mysqli_fetch_assoc($resulta)){//1722
			$idE=$rowa["id_est"];$idMatr=$rowa["id_matriculas"];$contEst=$contEst+1;
			$sqler="SELECT * FROM notas WHERE id_gruposa='$idU' AND id_materia='$idM' AND id_conv='$idC'";
			$rower=mysqli_fetch_assoc(mysqli_query($conexion, $sqler));$filasnotas=mysqli_num_rows(mysqli_query($conexion, $sqler));
			if (mysqli_num_rows(mysqli_query($conexion, $sqler))>0){
				$existeM=true;break;
			}
			$sqle="SELECT apellidos, nombre FROM estudiantes WHERE id_est='$idE'";
			$rowe=mysqli_fetch_assoc(mysqli_query($conexion, $sqle));
			$output=$output . '<tr><td><font size="2" color="blue">'. $rowe["apellidos"] . ', ' . $rowe["nombre"] . '</font><input type="hidden" name="idmatr' . $contEst . '" value="' . $rowa["id_matriculas"] . '"></td>
			<td style="text-align:center"><input type="number" onkeypress="if (event.keyConde <45 || event.keyCode > 57) event.returnValue= false;" style="color:blue" name="notan'. $contEst . '" size="5%" required></td>
			<td style="text-align:center"><input type="text" style="color:blue" name="notav' . $contEst .'" required></td></tr>'; 
			$annoa=$rowa["año_a"];
		}
		if ($existeM){
			$output=$filasnotas . '<form id="formErrorAltaEva3" action="" method="post" accept-charset="UTF-8" size="100%">
			<fieldset form="formErrorAltaEva3"><p>
			<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend>
			<br>
			<p align="center"><b>Error en la selecci&oacute;n, ya existen los registros para los datos:</b></p>
			<p align="center"><em>A&ntilde;o Acad&eacute;mico:&nbsp;</em><b>' . $_POST["annoa"] . '</b></p>
			<p align="center"><em>Convocatoria:&nbsp;</em><b>' . $_POST["conv"] . '</b></p>
			<p align="center"><em>Materia:&nbsp;</em><b>' . $_POST["materia"] . '</b></p>
			<p align="center"><em>Unidad:&nbsp;</em><b>' . $_POST["unidad"] . '</b></p>
			<p align="center"><input type="submit" value="Continuar" name="Cancelar" style="font-weight:bold; color:black">
			<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"></p></fieldset></form>';
			$output=$output . '<br><p><font color="red">'. mysqli_error($conexion) . '</font></p>';
			
		}else{
			$output=$output . '</table></p>
			</fieldset></p>
			<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			<input type="submit" value="Grabar" name="Grabar" style="font-weight:bold; color:black"></p>
			<input type="hidden" name="contEst" value="' . $contEst . '"><input type="hidden" name="idM" value="' . $idM . '">
			<input type="hidden" name="idC" value="' . $idC . '"><input type="hidden" name="idU" value="' . $idU . '">
			<input type="hidden" name="unidad" value="' . $_POST["unidad"] . '"><input type="hidden" name="conv" value="' . $_POST["conv"] . '">
			<input type="hidden" name="materia" value="' . $_POST["materia"] . '"><input type="hidden" name="annoa" value="' . $annoa . '">
			<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc">
			</form>';
		}
	}else{//1740
		$output='<form id="formErrorAltaEva1" action="" method="post" accept-charset="UTF-8" size="100%">
		<fieldset form="formErrorAltaEva1"><p>
		<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend>
		<br>
		<p align="center">Error en la b&uacute;squeda, no existen registros para dar de alta, seg&uacute;n los datos seleccionados</p>
		<p align="center"><input type="submit" value="Aceptar" name="Cancelar" style="font-weight:bold; color:black"></p>
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"></p></fieldset></form>';
	}
}elseif (isset($_POST["Grabar"])){
	$idM=$_POST["idM"];$idU=$_POST["idU"];$idC=$_POST["idC"];
	$cont=$_POST["contEst"];
	//GRABAR DATOS
	for ($i=1; $i<=$cont; $i++){//1758
		$matr=$_POST["idmatr$i"];
		$notn=$_POST["notan$i"];
		$notv=$_POST["notav$i"];
		$sql="INSERT INTO notas (ID_MATRICULA, ID_MATERIA, ID_GRUPOSA, ID_CONV, NOTAN, NOTAV) VALUES ('$matr', '$idM', '$idU', '$idC', '$notn', '$notv')";
		$result=mysqli_query($conexion, $sql);
		if ($result){
			$error=false;
		}else{
			$error=true;
			break;
		}
	}
	if ($error){
		$output='<form id="formErrorAltaEva2" action="" method="post" accept-charset="UTF-8" size="100%">
		<fieldset form="formErrorAltaEva2"><p>
		<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend><br>
		<p align="center"><b>Error al dar de alta las evaluaciones para los datos:</b></p>
		<p align="center"><em>A&ntilde;o Acad&eacute;mico:&nbsp;</em><b>' . $_POST["annoa"] . '</b></p>
		<p align="center"><em>Convocatoria:&nbsp;</em><b>' . $_POST["conv"] . '</b></p>
		<p align="center"><em>Materia:&nbsp;</em><b>' . $_POST["materia"] . '</b></p>
		<p align="center"><em>Unidad:&nbsp;</em><b>' . $_POST["unidad"] . '</b></p>
		<p align="center"><input type="submit" value="Continuar" name="Cancelar" style="font-weight:bold; color:black">
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"></p></fieldset></form>';
		$output=$output . '<br><p><font color="red">'. mysqli_error($conexion) . '</font></p>';//1783
	}else{
		$output='<form id="formAltaEva3" action="" method="post" accept-charset="UTF-8" size="100%">
		<p align="center"><b>Nuevo Registro de Evaluaciones grabado satisfactoriamente.</b></p><br>
		<p>Selecci&oacute;n de datos para el curso:</p>
		<p><b>A&ntilde;o Acad&eacute;mico:&nbsp;</b>' . $_POST["annoa"] . '</p>
		<p><b>Convocatoria:&nbsp;</b>' . $_POST["conv"] . '</p>
		<p><b>Materia:&nbsp;</b>' . $_POST["materia"] . '</p>
		<p><b>Unidad:&nbsp;</b>' . $_POST["unidad"] . '</p>';
		$output=$output . '<p align="center"><input type="submit" value="Continuar" name="Cancelar" style="font-weight:bold; color:black">&emsp;
		<input type="submit" name="Salir" value="Salir" style="font-weight:bold; color:black">
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"></form>';			
	}
}

mysqli_close($conexion);
return($output);
}/************************* end_alta evaluaciones **************************/


/************************ baja evaluaciones **************************/
function baja_evaluaciones(){	
$output="";
$conexion=bdexternaD();

if (!$_POST || isset($_POST["Salir"])){
	//Identificacion
	$output=identificacion("evaluaciones");//1747

}elseif (isset($_POST["SiguienteE"]) || isset($_POST["Atras"]) || isset($_POST["Cancelar"])){
  if (isset($_POST["SiguienteE"])){
	$emailDoc=$_POST["email"];
	$sql="SELECT id_docentes FROM docentes WHERE email='$emailDoc'";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result) == 1){
		while($row=mysqli_fetch_assoc($result)){
			$output=seleccion_evaluaciones("formBajaEva1", $row["id_docentes"]);
		}
		$error=false;
	}else{//1820
		$error=true;
	}
  }else{
  $id_doc=$_POST["idDoc"];
  $output=seleccion_evaluaciones("formBajaEva1", $id_doc);
  $error=false;
  }
  if ($error){//1569
	$output='<form id="formBajaEvaValidar" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset> form="formBajaEvaValidar">
	<legend align="left"><SPAN style="text-align:top">Mensaje de Atenci&oacute;n</SPAN></legend>
	<br><br>
	<p align="center">Los datos introducidos no son correctos: (email y/o password).</p>
	<p align="center"><input type="button" onclick="history.back()" value="Volver a intentarlo" name="Volver Atras" style="font-weight:bold; color:black"></p>
	</fieldset></p></form>';
  }

}elseif (isset($_POST["Siguiente2"])){//1841
	$nombU=$_POST["unidad"];$nombM=$_POST["materia"];$nombC=$_POST["conv"];$A=$_POST["annoa"];
	$sqlu="SELECT id_gruposa FROM grupos_a WHERE nombre='$nombU'";
	$rowu=mysqli_fetch_assoc(mysqli_query($conexion, $sqlu));$idU=$rowu["id_gruposa"];
	$sqlm="SELECT id_materia FROM materias WHERE nombre='$nombM'";
	$rowm=mysqli_fetch_assoc(mysqli_query($conexion, $sqlm));$idM=$rowm["id_materia"];
	$sqlc="SELECT id_conv FROM convocatorias WHERE nombre='$nombC'";
	$rowc=mysqli_fetch_assoc(mysqli_query($conexion, $sqlc));$idC=$rowc["id_conv"];
	$sqla="SELECT id_matriculas, id_est, año_a FROM matriculas WHERE  año_a='$A' AND  id_matriculas IN (SELECT id_matriculas FROM detalle_matricula WHERE id_gruposa='$idU' AND id_materia='$idM')";
	$resulta=mysqli_query($conexion, $sqla);
	if (mysqli_num_rows($resulta) > 0){//1575
		$contEst=0;$error=false;
		$output= '<form id="formBajaEva2" action="" method="post" accept-charset="UTF-8" size="100%">
		<p>
		<fieldset form="formBajaEva2">
		<legend align="left"><SPAN style="text-align:top">Eliminaci&oacute;n de notas</SPAN></legend>
		<br><br>
		<div style="width:50%; float:left;">
		<p align="left">&emsp;&nbsp;A&ntilde;o Acad&eacute;mico:&nbsp;<input type="text" name="annoA" disabled size="10%" value="' . $_POST["annoa"] . '"></p>
		<p align="left">&emsp;&nbsp;Unidad:&nbsp;<input type="text" name="unidad" disabled size="30%" value="' . $_POST["unidad"] . '"></p>
		</div>
		<div style="width:50%; float:left;">
		<p align="right">Convocatoria:&nbsp;<input align="right" type="text" name="conv" disabled size="16%" value="' . $_POST["conv"] . '">&emsp;&nbsp;</p>
		<p align="right">Materia:&nbsp;<input type="text" name="materia" disabled size="20%" value="' . $_POST["materia"] . '">&emsp;&nbsp;</p>
		</div>
		<br><br>
		<p align="center"><table border="2"><tr><th style="text-align:center"><font size="3">Estudiante</font></th><th style="text-align:center"><font size="3">Nota N&uacute;merica</font></th><th style="text-align:center"><font size="3">Nota Valorativa</font></th></tr>';
		while($rowa=mysqli_fetch_assoc($resulta)){
			$idE=$rowa["id_est"];$idMatr=$rowa["id_matriculas"];$contEst=$contEst+1;
			$sqle="SELECT apellidos, nombre FROM estudiantes WHERE id_est='$idE'";
			$rowe=mysqli_fetch_assoc(mysqli_query($conexion, $sqle));
			$output=$output . '<tr><td><font size="2" color="blue">'. $rowe["apellidos"] . ', ' . $rowe["nombre"] . '</font><input type="hidden" name="idmatr' . $contEst . '" value="' . $rowa["id_matriculas"] . '"></td>';
			$sqln="SELECT notav, notan FROM notas WHERE id_matricula='$idMatr' AND id_materia='$idM' AND id_gruposa='$idU' AND id_conv='$idC'";
			$rown=mysqli_fetch_assoc(mysqli_query($conexion, $sqln));
			if ($rown["notan"]<>"" AND $rown["notav"]<>"") {
				$output=$output . '<td style="text-align:center"><input type="number" value="' . $rown["notan"] . '" style="color:blue; background:white" name="notan'. $contEst . '" size="5%" required disabled></td>
				<td style="text-align:center"><input type="text" style="color:blue; background:white" name="notav' . $contEst .'" required value="' . $rown["notav"] . '" disabled></td></tr>'; 
				$annoa=$rowa["año_a"];
			}else{
				$error=true;
			}
		}
		if (!$error){
			$output=$output . '</table></p>
			</fieldset></p>
			<p><input type="submit" value="Volver Atr&aacute;s" name="Atras" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="submit" value="Eliminar" name="Eliminar" style="font-weight:bold; color:black"></p>
			<input type="hidden" name="contEst" value="' . $contEst . '"><input type="hidden" name="idM" value="' . $idM . '">
			<input type="hidden" name="idC" value="' . $idC . '"><input type="hidden" name="idU" value="' . $idU . '">
			<input type="hidden" name="unidad" value="' . $_POST["unidad"] . '"><input type="hidden" name="conv" value="' . $_POST["conv"] . '">
			<input type="hidden" name="materia" value="' . $_POST["materia"] . '"><input type="hidden" name="annoa" value="' . $_POST["annoa"] . '">
			<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc">
			</form>';
		}else{
			$output='<form id="formErrorBajaEva1" action="" method="post" accept-charset="UTF-8" size="100%">
			<fieldset form="formErrorBajaEva1"><p>
			<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend>
			<br>
			<p align="center">Error en la b&uacute;squeda de evaluaciones o no existen registros</p>
			<p align="center"><input type="submit" value="Aceptar" name="Cancelar" style="font-weight:bold; color:black"></p>
			<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"></p></fieldset></form>';
		}
	}else{
		$output='<form id="formErrorBajaEva2" action="" method="post" accept-charset="UTF-8" size="100%">
		<fieldset form="formErrorBajaEva2"><p>
		<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend>
		<br>
		<p align="center">Se ha producido un error en la b&uacute;squeda de informaci&oacute;n de estudiantes matriculados.</p>
		<p align="center"><input type="submit" value="Aceptar" name="Cancelar" style="font-weight:bold; color:black"></p>
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"></p></fieldset></form>';
		$output=$output . '<p align="left"><font color="red">'. mysqli_error($conexion) . '</font></p>';//1866			
	}
}elseif (isset($_POST["Eliminar"])){
	$output='<form id="formConfirmarBajaEva" action="" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formConfirmarBajaEva"">
	<legend align="left"><SPAN style="text-align:top">Confirmar Baja</SPAN></legend>
        <br><br><p align="center"> Seguro que desea dar de baja las evaluaciones para la Unidad&nbsp;<b>' . $_POST["unidad"] . ',</b>&nbsp;
	de la Materia&nbsp;<b>' . $_POST["materia"] . ',</b>&nbsp;en la convocatoria&nbsp;<b>' . $_POST["conv"] . '</b>&nbsp;y a&ntilde;o acad&eacute;mico&nbsp;
	<b>' . $_POST["annoa"] . '</b></p>
	<p align="center"><input type="submit" value="Aceptar" name="Aceptar" style="font-weight:bold; color:black">&emsp;
	<input type="submit" name="Cancelar" value="Cancelar" style="font-weight:bold; color:black">
	<input type="hidden" name="idM" value="' . $_POST["idM"] . '">
	<input type="hidden" name="idC" value="' . $_POST["idC"] . '"><input type="hidden" name="idU" value="' . $_POST["idU"] . '">
	<input type="hidden" name="unidad" value="' . $_POST["unidad"] . '"><input type="hidden" name="conv" value="' . $_POST["conv"] . '">
	<input type="hidden" name="materia" value="' . $_POST["materia"] . '"><input type="hidden" name="annoa" value="' . $_POST["annoa"] . '">
	<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc">
	</p></fieldset></p></form>';
}elseif (isset($_POST["Aceptar"])){
//$output=$output . $_POST["materia"] . '-----' . $_POST["unidad"] . '----' . $_POST["conv"] . '-----' . $_POST["annoa"];
	$idM=$_POST["idM"];$idU=$_POST["idU"];$conv=$_POST["conv"];$annoa=$_POST["annoa"];
	$sqlc="SELECT id_conv FROM convocatorias WHERE nombre='$conv'";
	$rowc=mysqli_fetch_assoc(mysqli_query($conexion, $sqlc));$idC=$rowc["id_conv"];
	$sql="DELETE FROM notas WHERE id_materia='$idM' AND id_gruposa='$idU' AND id_conv='$idC' AND id_matricula IN (SELECT id_matriculas FROM matriculas WHERE año_a='$annoa')";
	if(mysqli_query($conexion, $sql)){//4054
		$output= '<form id="formBajaEva3" action="" method="post" accept-charset="UTF-8">
		<p align="center"><b>Eliminaci&oacute;n de Evaluaciones</b></p>
		<p>Las evaluaciones seleccionadas se han borrado satisfactoriamente seg&uacute;n:</p>
		<p><em>Unidad:&nbsp;</em><b>' . $_POST["unidad"] . '</b></p>
		<p><em>Materia:&nbsp;</em><b>' . $_POST["materia"] . '</b></p>
		<p><em>Convocatoria:&nbsp;</em><b>' . $_POST["conv"] . '</b></p>
		<p><em>A&ntilde;o Acad&eacute;mico:&nbsp;</em><b>' . $_POST["annoa"] . '</b></p>
		<br><br>';
		$output=$output . '<p align="center"><input type="submit" value="Continuar" name="Cancelar" style="font-weight:bold; color:black">&emsp;
		<input type="submit" name="Salir" value="Salir" style="font-weight:bold; color:black">
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"></form>';		
	}else{
		$output='<form id="formBajaEva4" action="" method="post" accept-charset="UTF-8">
		<fieldset form="formErrorBajaEva4"><p>
		<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend>
		<br>
		<p><b>Error al eliminar los registros de evaluaciones para:</b></p>
		<p><em>Unidad:&nbsp;</em><b>' . $_POST["unidad"] . '</b></p>
		<p><em>Materia:&nbsp;</em><b>' . $_POST["materia"] . '</b></p>
		<p><em>Convocatoria:&nbsp;</em><b>' . $_POST["conv"] . '</b></p>
		<p><em>A&ntilde;o Acad&eacute;mico:&nbsp;</em><b>' . $_POST["annoa"] . '</b></p>';//1865
		$output=$output . '<br><p>'. mysqli_error($conexion) . '</p><br>
		<p align="center"><input type="submit" value="Continuar" name="Cancelar" style="font-weight:bold; color:black">
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"></p></fieldset></form>';
	}	
	
}

mysqli_close($conexion);
return($output);
}/************************ end_baja evaluaciones *************************/


/************************* modificar evaluaciones ***********************/
function modificar_evaluaciones(){	
$output="";
$conexion=bdexternaD();

if (!$_POST || isset($_POST["Salir"])){
	//Identificacion
	$output=identificacion("evaluaciones");

}elseif (isset($_POST["SiguienteE"]) || isset($_POST["Atras"]) || isset($_POST["Cancelar"])){
  if (isset($_POST["SiguienteE"])){
	$emailDoc=$_POST["email"];
	$sql="SELECT * FROM docentes WHERE email='$emailDoc'";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result) == 1){
		while($row=mysqli_fetch_assoc($result)){
			$output=seleccion_evaluaciones("formAltaEva1", $row["ID_DOCENTES"]);
		}
		$error=false;
	}else{
		$error=true;
	}
  }else{
  $id_doc=$_POST["idDoc"];
  $output=seleccion_evaluaciones("formModEva1", $id_doc);
  $error=false;
  }
  if ($error){//1569
	$output='<form id="formModEvaValidar" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset> form="formModEvaValidar">
	<legend align="left"><SPAN style="text-align:top">Mensaje de Atenci&oacute;n</SPAN></legend>
	<br><br>
	<p align="center">Los datos introducidos no son correctos: (email y/o password).</p>
	<p align="center"><input type="button" onclick="history.back()" value="Volver a intentarlo" name="Volver Atras" style="font-weight:bold; color:black"></p>
	</fieldset></p></form>';
  }

}elseif (isset($_POST["Siguiente2"])){
	$nombU=$_POST["unidad"];$nombM=$_POST["materia"];$nombC=$_POST["conv"];$A=$_POST["annoa"];
	$sqlu="SELECT id_gruposa FROM grupos_a WHERE nombre='$nombU'";
	$rowu=mysqli_fetch_assoc(mysqli_query($conexion, $sqlu));$idU=$rowu["id_gruposa"];
	$sqlm="SELECT id_materia FROM materias WHERE nombre='$nombM'";
	$rowm=mysqli_fetch_assoc(mysqli_query($conexion, $sqlm));$idM=$rowm["id_materia"];
	$sqlc="SELECT id_conv FROM convocatorias WHERE nombre='$nombC'";
	$rowc=mysqli_fetch_assoc(mysqli_query($conexion, $sqlc));$idC=$rowc["id_conv"];
	$sqla="SELECT id_matriculas, id_est, año_a FROM matriculas WHERE  año_a='$A' AND  id_matriculas IN (SELECT id_matriculas FROM detalle_matricula WHERE id_gruposa='$idU' AND id_materia='$idM')";
	$resulta=mysqli_query($conexion, $sqla);
	if (mysqli_num_rows($resulta) > 0){//1575
		$contEst=0;$error=false;
		$output= '<form id="formModEva2" action="" method="post" accept-charset="UTF-8" size="100%">
		<p>
		<fieldset form="formModEva2">
		<legend align="left"><SPAN style="text-align:top">Modificaci&oacute;n de notas</SPAN></legend>
		<br><br>
		<div style="width:50%; float:left;">
		<p align="left">&emsp;&nbsp;A&ntilde;o Acad&eacute;mico:&nbsp;<input type="text" name="annoA" disabled size="10%" value="' . $_POST["annoa"] . '"></p>
		<p align="left">&emsp;&nbsp;Unidad:&nbsp;<input type="text" name="unidad" disabled size="30%" value="' . $_POST["unidad"] . '"></p>
		</div>
		<div style="width:50%; float:left;">
		<p align="right">Convocatoria:&nbsp;<input align="right" type="text" name="conv" disabled size="16%" value="' . $_POST["conv"] . '">&emsp;&nbsp;</p>
		<p align="right">Materia:&nbsp;<input type="text" name="materia" disabled size="20%" value="' . $_POST["materia"] . '">&emsp;&nbsp;</p>
		</div>
		<br><br>
		<p align="center"><table border="2"><tr><th style="text-align:center"><font size="3">Estudiante</font></th><th style="text-align:center"><font size="3">Nota N&uacute;merica</font></th><th style="text-align:center"><font size="3">Nota Valorativa</font></th></tr>';
		while($rowa=mysqli_fetch_assoc($resulta)){
			$idE=$rowa["id_est"];$idMatr=$rowa["id_matriculas"];$contEst=$contEst+1;
			$sqle="SELECT apellidos, nombre FROM estudiantes WHERE id_est='$idE'";
			$rowe=mysqli_fetch_assoc(mysqli_query($conexion, $sqle));
			$output=$output . '<tr><td><font size="2" color="blue">'. $rowe["apellidos"] . ', ' . $rowe["nombre"] . '</font><input type="hidden" name="idmatr' . $contEst . '" value="' . $rowa["id_matriculas"] . '"></td>';
			$sqln="SELECT notav, notan FROM notas WHERE id_matricula='$idMatr' AND id_materia='$idM' AND id_gruposa='$idU' AND id_conv='$idC'";
			$rown=mysqli_fetch_assoc(mysqli_query($conexion, $sqln));
			if ($rown["notan"]<>"" AND $rown["notav"]<>"") {
				$output=$output . '<td style="text-align:center"><input type="number" value="' . $rown["notan"] . '" style="color:blue; background:white" name="notan'. $contEst . '" size="5%" required></td>
				<td style="text-align:center"><input type="text" style="color:blue; background:white" name="notav' . $contEst .'" required value="' . $rown["notav"] . '"></td></tr>'; 
				$annoa=$rowa["año_a"];
			}else{
				$error=true;
			}
		}
		if (!$error){
			$output=$output . '</table></p>
			</fieldset></p>
			<p><input type="submit" value="Volver Atr&aacute;s" name="Atras" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="submit" value="Grabar" name="Grabar" style="font-weight:bold; color:black"></p>
			<input type="hidden" name="contEst" value="' . $contEst . '"><input type="hidden" name="idM" value="' . $idM . '">
			<input type="hidden" name="idC" value="' . $idC . '"><input type="hidden" name="idU" value="' . $idU . '">
			<input type="hidden" name="unidad" value="' . $_POST["unidad"] . '"><input type="hidden" name="conv" value="' . $_POST["conv"] . '">
			<input type="hidden" name="materia" value="' . $_POST["materia"] . '"><input type="hidden" name="annoa" value="' . $_POST["annoa"] . '">
			<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc">
			</form>';
		}else{
			$output='<form id="formErrorBajaEva1" action="" method="post" accept-charset="UTF-8" size="100%">
			<fieldset form="formErrorBajaEva1"><p>
			<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend>
			<br>
			<p align="center">Error en la b&uacute;squeda de evaluaciones o no existen registros</p>
			<p align="center"><input type="submit" value="Aceptar" name="Cancelar" style="font-weight:bold; color:black"></p>
			<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"></p></fieldset></form>';
		}
	}else{//2021
		$output='<form id="formErrorBajaEva2" action="" method="post" accept-charset="UTF-8" size="100%">
		<fieldset form="formErrorBajaEva2"><p>
		<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend>
		<br>
		<p align="center">Se ha producido un error en la b&uacute;squeda de informaci&oacute;n de estudiantes matriculados.</p>
		<p align="center"><input type="submit" value="Aceptar" name="Cancelar" style="font-weight:bold; color:black"></p>
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"></p></fieldset></form>';
		$output=$output . '<p align="left"><font color="red">'. mysqli_error($conexion) . '</font></p>';			
	}
}elseif (isset($_POST["Grabar"])){
	$idM=$_POST["idM"];$idU=$_POST["idU"];$idC=$_POST["idC"];
	$cont=$_POST["contEst"];
	//GRABAR DATOS
	for ($i=1; $i<=$cont; $i++){//1758
		$matr=$_POST["idmatr$i"];
		$notn=$_POST["notan$i"];
		$notv=$_POST["notav$i"];
		$sql="UPDATE notas SET notan='$notn', notav='$notv' WHERE id_matricula='$matr' AND id_gruposa='$idU'AND id_materia='$idM' AND id_conv='$idC'";
		$result=mysqli_query($conexion, $sql);
		if ($result){
			$error=false;
		}else{
			$error=true;
			break;
		}
	}
	if ($error){
		$output='<form id="formErrorModEva2" action="" method="post" accept-charset="UTF-8" size="100%">
		<fieldset form="formErrorModEva2"><p>
		<legend align="left"><SPAN style="text-align:top">Atenci&oacute;n</SPAN></legend><br>
		<p align="center"><b>Error al actualizar las evaluaciones para los datos:</b></p>
		<p align="center"><em>A&ntilde;o Acad&eacute;mico:&nbsp;</em><b>' . $_POST["annoa"] . '</b></p>
		<p align="center"><em>Convocatoria:&nbsp;</em><b>' . $_POST["conv"] . '</b></p>
		<p align="center"><em>Materia:&nbsp;</em><b>' . $_POST["materia"] . '</b></p>
		<p align="center"><em>Unidad:&nbsp;</em><b>' . $_POST["unidad"] . '</b></p>
		<p align="center"><input type="submit" value="Continuar" name="Cancelar" style="font-weight:bold; color:black">
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"></p></fieldset></form>';
		$output=$output . '<br><p><font color="red">'. mysqli_error($conexion) . '</font></p>';//1783
	}else{
		$output='<form id="formModEva3" action="" method="post" accept-charset="UTF-8" size="100%">
		<fieldset form="formModEva3"><p>
		<legend align="left"><SPAN style="text-align:top">Actualizaci&oacute;n de Registro de Evaluaciones</SPAN></legend><br>
		<p align="center"><b>Los registros de notas se han grabado satisfactoriamente.</b></p><br>
		<p>Selecci&oacute;n de datos para el curso:</p>
		<p><b>A&ntilde;o Acad&eacute;mico:&nbsp;</b>' . $_POST["annoa"] . '</p>
		<p><b>Convocatoria:&nbsp;</b>' . $_POST["conv"] . '</p>
		<p><b>Materia:&nbsp;</b>' . $_POST["materia"] . '</p>
		<p><b>Unidad:&nbsp;</b>' . $_POST["unidad"] . '</p>';
		$output=$output . '<p align="center"><input type="submit" value="Continuar" name="Cancelar" style="font-weight:bold; color:black">&emsp;
		<input type="submit" name="Salir" value="Salir" style="font-weight:bold; color:black">
		<input type="hidden" value="' . $_POST["idDoc"] . '" name="idDoc"></form>';			
	}

}

mysqli_close($conexion);
return($output);
}/*********************** end_modificar evaluaciones ***********************/


/***************************************************************************/
/************************** Faltas académicas ******************************/
/***************************************************************************/
function listados_academicos(){//472

$output='ca acarrr';

return($output);
}

function alta_academicas(){

$output='academicos aff';

return($output);
}

function modificar_academicas(){

$output='academicos mffgsf';

return($output);
}

function baja_academicas(){

$output='academis bdfdfd';

return($output);
}

/********************************************************/
/***************** Programa Asignaturas *****************/
/********************************************************/


/****************** listados programa ***************/
function listados_programa(){	
$output="";
$conexion=bdexternaD();

if (!$_POST){
	$output='<form id="formListarProg" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formListarProg"><br><legend align="left"><SPAN style="text-align:top">B&uacute;squeda de informaci&oacute;n de Programas de Asignaturas</SPAN></legend><br>
	<label>&emsp;&emsp;&emsp;Seleccionar un dato de la lista para la b&uacute;squeda:</label>&ensp;&nbsp;<p align="center"><select name="datos" size="4" required>
	<option selected>Materia</option>
	<option>Unidad</option>
	<option>Docente</option>
	<option>Tutores</option>
	</select></p><br>
	<p align="center"><input type="submit" name="buscarDatos" value="Buscar Datos" style="font-weight:bold; color:black"></p>
	</fieldset></p></form>';
}
elseif (isset($_POST["buscarDatos"])){//552
	switch($_POST["datos"]){
		case "Materia":
			$output= '<form id="formListarProgMat" action="" method="post" accept-charset="UTF-8" size="100%">
			<p>
			<fieldset form="formListarProgMat"><br><legend align="left"><SPAN style="text-align:top">Mostrar Listado por Materia</SPAN></legend><br>
			<p>&emsp;&emsp;&emsp;Seleccionar una materia de la lista:
			<p align="center"><select name="Mat" size="5" required autofocus>';
			$sqlm="SELECT nombre FROM materias WHERE id_materia IN (SELECT id_materia FROM asignaturas)";
			$resultm=mysqli_query($conexion, $sqlm);
			if (mysqli_num_rows($resultm)>0){
				$cont=0;
				while ($rowm=mysqli_fetch_assoc($resultm)){
					$output=$output . '<option>' . $rowm["nombre"] . '</option>';
					$cont=$cont+1;
				}
				if ($cont>0){
					$error=false;
				}	
			}
			else{
				$lista="Lista sin datos materias";$output=$output . '<option>' . $lista . '</option>';
				$error=true;
			}
			$output=$output . '</select></p></p><br>
			<p align="center"><input  type="button" onclick="history.back()" value="Volver Atr&aacute;s" name="Volver Atras"  style="font-weight:bold; color:black">
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
			if ($error){
				$output=$output . '<input type="submit" name="BuscarMat" value="Buscar" style="font-weight:bold; color:black" disabled>';
			}else{
				$output=$output . '<input type="submit" name="BuscarMat" value="Buscar" style="font-weight:bold; color:black">';
			}
			$output=$output . '</p></fieldset></p></form>';
			break;
		case "Unidad":
			$output= '<form id="formListarProgUnid" action="" method="post" accept-charset="UTF-8" size="100%">
			<p>
			<fieldset form="formListarProgUnidt"><br><legend align="left"><SPAN style="text-align:top">Mostrar Listado por Unidad</SPAN></legend><br>
			<p>&emsp;&emsp;&emsp;Seleccionar una Unidad de la lista:</p>
			<p align="center"><select name="Uni" autofocus required size="7">';
			$sqlu="SELECT nombre FROM grupos_a WHERE id_gruposa IN (SELECT id_gruposa FROM asignaturas)";
			$resultu=mysqli_query($conexion, $sqlu);
			if (mysqli_num_rows($resultu)>0){
				$cont=0;
				while ($rowu=mysqli_fetch_assoc($resultu)){
					$output=$output . '<option>' . $rowu["nombre"] . '</option>';
					$cont=$cont+1;
				}
				if ($cont>0){
					$error=false;
				}	
			}
			else{
				$lista='Lista sin datos unidades';$output=$output . '<option>' . $lista . '</option>';
				$error=true;
			}
			$output=$output . '</select></p></p><br>
			<p align="center"><input  type="button" onclick="history.back()" value="Volver Atr&aacute;s" name="Volver Atras"  style="font-weight:bold; color:black">
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
			if ($error){
				$output=$output . '<input type="submit" name="BuscarUni" value="Buscar" style="font-weight:bold; color:black" disabled>';
			}else{
				$output=$output . '<input type="submit" name="BuscarUni" value="Buscar" style="font-weight:bold; color:black">';
			}
			$output=$output . '</p></fieldset></p></form>';
			break;
		case "Docente":
			$output='<form id="formListarProgDoc" action="" method="post" accept-charset="UTF-8" size="100%">
			<p>
			<fieldset form="formListarProgDoc"><br><legend align="left"><SPAN style="text-align:top">Mostrar Listado por Docente</SPAN></legend><br>
			<p">&emsp;&emsp;&emsp;Seleccionar un Docente de la lista:</p>
			<p align="center"><select name="Doc" autofocus required size=7>';
			$sqld="SELECT nombre, apellidos FROM docentes WHERE id_docentes IN (SELECT id_docente FROM asignaturas)";
			$resultd=mysqli_query($conexion, $sqld);
			if (mysqli_num_rows($resultd)>0){
				$cont=0;
				while ($rowd=mysqli_fetch_assoc($resultd)){
					$output=$output . '<option>' . $rowd["apellidos"] . ', ' . $rowd["nombre"] . '</option>';
					$cont=$cont+1;
				}
				if ($cont>0){
					$error=false;
				}	
			}
			else{
				$lista='Lista sin datos docentes';$output=$output . '<option>' . $lista . '</option>';
				$error=true;
			}
			$output=$output . '</select></p></p><br>
			<p align="center"><input type="button" onclick="history.back()" value="Volver Atr&aacute;s" name="Volver Atras" style="font-weight:bold; color:black">
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
			if ($error){
				$output=$output . '<input type="submit" name="BuscarDoc" value="Buscar" style="font-weight:bold; color:black" disabled>';
			}else{
				$output=$output . '<input type="submit"name="BuscarDoc" value="Buscar" style="font-weight:bold; color:black">';
			}
			$output=$output . '</p></fieldset></p></form>';
			break;
		case "Tutores":
			/*$output='<form id="formListarProgDoc" action="" method="post" accept-charset="UTF-8" size="100%">
			<p>
			<fieldset form="formListarProgDoc"><br><legend align="left"><SPAN style="text-align:top">Mostrar Listado por Tutores</SPAN></legend><br>
			<p">&emsp;&emsp;&emsp;Seleccionar un Tutor de la lista:</p>
			<p align="center"><select name="Tutor" autofocus required size=7>';
			$sqlt="SELECT nombre, apellidos FROM docentes WHERE id_docentes IN (SELECT id_docente FROM asignaturas WHERE tutor=1)";
			$resultt=mysqli_query($conexion, $sqlt);
			if (mysqli_num_rows($resultt)>0){
				$cont=0;
				while ($rowt=mysqli_fetch_assoc($resultt)){
					$output=$output . '<option>' . $rowt["apellidos"] . ', ' . $rowt["nombre"] . '</option>';
					$cont=$cont+1;
				}
				if ($cont>0){
					$error=false;
				}	
			}
			else{
				$lista='Lista sin datos tutores';$output=$output . '<option>' . $lista . '</option>';
				$error=true;
			}
			$output=$output . '</select></p></p><br>
			<p align="center"><input type="button" onclick="history.back()" value="Volver Atr&aacute;s" name="Volver Atras" style="font-weight:bold; color:black">
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
			if ($error){
				$output=$output . '<input type="submit" name="BuscarTut" value="Buscar" style="font-weight:bold; color:black" disabled>';
			}else{
				$output=$output . '<input type="submit"name="BuscarTut" value="Buscar" style="font-weight:bold; color:black">';
			}
			$output=$output . '</p></fieldset></p></form>';*/
			$sql="SELECT * FROM asignaturas WHERE tutor=1";
			$result=mysqli_query($conexion, $sql);
			if (mysqli_num_rows($result)>0){//796
				$output=$output . '<p align="center"><font size="4"><b><em>Listado de Tutores </font></em></b></p>  
				<table border="2"><tr><th><font size="3">Tutor</font></th><th><font size="3">Unidad</font></th><th><font size="3">Materia</font></th></tr>';  
				while ($row=mysqli_fetch_assoc($result)){
					$idm=$row["ID_MATERIA"];$idg=$row["ID_GRUPOSA"];$idd=$row["ID_DOCENTE"];
					$sqlg="SELECT nombre FROM grupos_a WHERE id_gruposa='$idg'";
					$resultg=mysqli_query($conexion, $sqlg);
					$rowg=mysqli_fetch_assoc($resultg);
					$sqlm="SELECT nombre FROM materias WHERE id_materia='$idm'";
					$resultm=mysqli_query($conexion, $sqlm);
					$rowm=mysqli_fetch_assoc($resultm);
					$sqld="SELECT nombre, apellidos FROM docentes WHERE id_docentes='$idd'";
					$resultd=mysqli_query($conexion, $sqld);
					$rowd=mysqli_fetch_assoc($resultd);
					$output=$output . '<tr><td><font color="blue" size="2">' . $rowd["apellidos"] . ', ' . $rowd["nombre"] . '</font></td><td><font color="blue" size="2">' . $rowg["nombre"] . '</font></td><td><font color="blue" size="2">' . $rowm["nombre"] . '</font></td></tr>';
				}
				$output=$output . '</table><br><p align="center"><b>Para realizar una nueva b&uacute;squeda,&nbsp;<a href="http://localhost/drupal/docente/programa/listados_programa">pulse aqu&iacute;</a></b></p>';	
			}else{
				$output='<br><br><p><font color="red"><b>Atenci&oacute;n</b></font></p>
				<p>Error en la b&uacute;squeda de informaci&oacute;n para el listado de tutores</p>';
				$output=$output . '<p>' . mysqli_error($conexion) . '</p>
				<br><p align="center"><b>Para volver al apartado "Listados de Programa Asignaturas",&nbsp;<a href="http://localhost/drupal/docente/programa/listados_programa">pulse aqu&iacute;</a></b></p>';
			}

			break;
	}//switch
}elseif (isset($_POST["BuscarMat"])){//679
	$Mat=$_POST["Mat"];
	$sql="SELECT * FROM asignaturas WHERE id_materia IN (SELECT id_materia FROM materias WHERE nombre='$Mat')";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result)>0){
		$output='<p align="center"><font size="4"><b><em>Listado para Materia "' .  $Mat . '"</font></em></b></p>  
		<table border="2"><tr><th><font size="3">Unidad</font></th><th><font size="3">Docente</font></th><th><font size="3">Tutor</font></th></tr>';  
		while ($row=mysqli_fetch_assoc($result)){
			$idg=$row["ID_GRUPOSA"];$idd=$row["ID_DOCENTE"];
			$sqld="SELECT nombre, apellidos FROM docentes WHERE id_docentes='$idd'";
			$resultd=mysqli_query($conexion, $sqld);
			$rowd=mysqli_fetch_assoc($resultd);
			$sqlg="SELECT nombre FROM grupos_a WHERE id_gruposa='$idg'";
			$resultg=mysqli_query($conexion, $sqlg);
			$rowg=mysqli_fetch_assoc($resultg);
			if ($row["TUTOR"]==1){
				$tutor="S&iacute;";
			}else{
				$tutor="No";
			}
			$output=$output . '<tr><td><font color="blue" size="2">' . $rowg["nombre"] . '</font></td><td><font color="blue" size="2">' . $rowd["apellidos"] . ', ' . $rowd["nombre"] . '</font></td><td><font color="blue" size="2">' . $tutor . '</font></td></tr>';
		}
		$output=$output . '</table><br><p align="center"><b>Para realizar una nueva b&uacute;squeda,&nbsp;<a href="http://localhost/drupal/docente/programa/listados_programa">pulse aqu&iacute;</a></b></p>';	
		
	}else{
		$output='<br><br><p><font color="red"><b>Atenci&oacute;n</b></font></p>
		<p>Error en la b&uacute;squeda de informaci&oacute;n por la materia seleccionada con el nombre "' . $_POST["Mat"] . '"</p>';
		$output=$output . '<p>' . mysqli_error($conexion) . '</p>
		<br><p align="center"><b>Para volver al apartado "Listados de Programa Asignaturas",&nbsp;<a href="http://localhost/drupal/docente/programa/listados_programa">pulse aqu&iacute;</a></b></p>';
	}

}elseif (isset($_POST["BuscarUni"])){
	$Uni=$_POST["Uni"];
	$sql="SELECT DISTINCT id_docente FROM asignaturas WHERE id_gruposa IN (SELECT id_gruposa FROM grupos_a WHERE nombre='$Uni')";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result)>0){
		$output=$output . '<p align="center"><font size="4"><b><em>Listado para Unidad "' .  $Uni . '"</font></em></b></p>  
		<table border="2"><tr><th><font size="3">Docente</font></th><th><font size="3">Materia</font></th><th><font size="3">Tutor</font></th></tr>';  
		$docAnt="";
		while ($row=mysqli_fetch_assoc($result)){
			$sqlg="SELECT id_gruposa FROM grupos_a WHERE nombre='$Uni'";
			$resultg=mysqli_query($conexion, $sqlg);
			$rowg=mysqli_fetch_assoc($resultg);
			$idd=$row["id_docente"];$idg=$rowg["id_gruposa"];
			$sqld="SELECT nombre, apellidos FROM docentes WHERE id_docentes='$idd'";
			$resultd=mysqli_query($conexion, $sqld);
			$rowd=mysqli_fetch_assoc($resultd);
			$doc=$rowd["apellidos"] . ', '. $rowd["nombre"];
			if ($docAnt <> $doc){
				$sqlm="SELECT nombre, id_materia FROM materias WHERE id_materia IN (SELECT id_materia FROM asignaturas WHERE id_gruposa='$idg' AND id_docente='$idd')";
				$resultm=mysqli_query($conexion, $sqlm);
				$c=mysqli_num_rows($resultm);
				if (mysqli_num_rows($resultm)>0){
					$fila=mysqli_num_rows($resultm);
					$output=$output . '<tr><td rowspan=' . $fila . '><font color="blue" size="2">' . $rowd["apellidos"] . ', '. $rowd["nombre"] . '</font></td>';
					while ($rowm=mysqli_fetch_assoc($resultm)){
						$idm=$rowm["id_materia"];
						$sqlt="SELECT tutor FROM asignaturas WHERE id_materia='$idm' AND id_gruposa='$idg' AND id_docente='$idd'";
						$resultt=mysqli_query($conexion, $sqlt);
						$rowt=mysqli_fetch_assoc($resultt);
						if ($rowt["tutor"]==1){
							$tutor="S&iacute;";
						}else{
							$tutor="No";
						}
						$output=$output . '<td><font color="blue" size="2">' . $rowm["nombre"] . '</font></td><td><font color="blue" size="2">' . $tutor . '</font></td></tr>';
					}//while
				}// contador materias
				$docAnt=$doc;
			}//if doc		
		}
		$output=$output . '</table><br><p align="center"><b>Para realizar una nueva b&uacute;squeda,&nbsp;<a href="http://localhost/drupal/docente/programa/listados_programa">pulse aqu&iacute;</a></b></p>';	
	}else{
		$output='<br><br><p><font color="red"><b>Atenci&oacute;n</b></font></p>
		<p>Error en la b&uacute;squeda de informaci&oacute;n para la unidad seleccionada con el nombre "' . $_POST["Uni"] . '"</p>';
		$output=$output . '<p>' . mysqli_error($conexion) . '</p>
		<br><p align="center"><b>Para volver al apartado "Listados de Programa Asignaturas",&nbsp;<a href="http://localhost/drupal/docente/programa/listados_programa">pulse aqu&iacute;</a></b></p>';
	}
}elseif (isset($_POST["BuscarDoc"])){
	$nombDoc=substr($_POST["Doc"], (strpos($_POST["Doc"], ",")+1));
	$long=strlen($nombDoc);
	$nombDoc=ltrim($nombDoc);
	$apelDoc=substr($_POST["Doc"], 0, -($long+1));
	$apelDoc=ltrim($apelDoc);
	$sql="SELECT DISTINCT id_gruposa FROM asignaturas WHERE id_docente IN (SELECT id_docentes FROM docentes WHERE nombre='$nombDoc' AND apellidos='$apelDoc')";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result)>0){
		$output=$output . '<p align="center"><font size="4"><b><em>Listado para Docente "' .  $_POST["Doc"] . '"</font></em></b></p>  
		<table border="2"><tr><th><font size="3">Unidad</font></th><th><font size="3">Materia</font></th><th><font size="3">Tutor</font></th></tr>';  
		$grupo="";
		while ($row=mysqli_fetch_assoc($result)){
			$sqld="SELECT id_docentes FROM docentes WHERE nombre='$nombDoc' AND apellidos='$apelDoc'";
			$resultd=mysqli_query($conexion, $sqld);
			$rowd=mysqli_fetch_assoc($resultd);
			$idg=$row["id_gruposa"];$idd=$rowd["id_docentes"];
			$sqlg="SELECT nombre FROM grupos_a WHERE id_gruposa='$idg'";
			$resultg=mysqli_query($conexion, $sqlg);
			$rowg=mysqli_fetch_assoc($resultg);
		  if ($grupo<>$rowg["nombre"]){
			$sqlm="SELECT nombre, id_materia FROM materias WHERE id_materia IN (SELECT id_materia FROM asignaturas WHERE id_gruposa='$idg' AND id_docente='$idd')";
			$resultm=mysqli_query($conexion, $sqlm);
			$c=mysqli_num_rows($resultm);
			if (mysqli_num_rows($resultm)>0){
				$fila=mysqli_num_rows($resultm);
				$output=$output . '<tr><td rowspan=' . $fila . '><font color="blue" size="2">' . $rowg["nombre"] . '</font></td>';
				while ($rowm=mysqli_fetch_assoc($resultm)){
					$idm=$rowm["id_materia"];
					$sqlt="SELECT tutor FROM asignaturas WHERE id_materia='$idm' AND id_gruposa='$idg' AND id_docente='$idd'";
					$resultt=mysqli_query($conexion, $sqlt);
					$rowt=mysqli_fetch_assoc($resultt);
					if ($rowt["tutor"]==1){
						$tutor="S&iacute;";
					}else{
						$tutor="No";
					}
					$output=$output . '<td><font color="blue" size="2">' . $rowm["nombre"] . '</font></td><td><font color="blue" size="2">' . $tutor . '</font></td></tr>';
				}//WHILE
			}//contador materias	
			$grupo=$rowg["nombre"];
		  }//if grupo
		}
		$output=$output . '</table><br><p align="center"><b>Para realizar una nueva b&uacute;squeda,&nbsp;<a href="http://localhost/drupal/docente/programa/listados_programa">pulse aqu&iacute;</a></b></p>';	
	}else{
		$output='<br><br><p><font color="red"><b>Atenci&oacute;n</b></font></p>
		<p>Error en la b&uacute;squeda de informaci&oacute;n para el/la docente seleccionado/a con el nombre "' . $_POST["Doc"] . '"</p>';
		$output=$output . '<p>' . mysqli_error($conexion) . '</p>
		<br><p align="center"><b>Para volver al apartado "Listados de Programa Asignaturas",&nbsp;<a href="http://localhost/drupal/docente/programa/listados_programa">pulse aqu&iacute;</a></b></p>';
	}
}/*elseif (isset($_POST["BuscarTut"])){
	$nombDoc=substr($_POST["Tutor"], (strpos($_POST["Tutor"], ",")+1));
	$long=strlen($nombDoc);
	$nombDoc=ltrim($nombDoc);
	$apelDoc=substr($_POST["Tutor"], 0, -($long+1));
	$apelDoc=ltrim($apelDoc);//789
	$sql="SELECT * FROM asignaturas WHERE id_docente IN (SELECT id_docentes FROM docentes WHERE nombre='$nombDoc' AND apellidos='$apelDoc')";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result)>0){//796
		$output=$output . '<p align="center"><font size="4"><b><em>Listado para el Tutor "' . $_POST["Tutor"] . '"</font></em></b></p>  
		<table border="2"><tr><th><font size="3">Tutor</font></th><th><font size="3">Unidad</font></th><th><font size="3">Materia</font></th></tr>';  
		while ($row=mysqli_fetch_assoc($result)){
			$idm=$row["ID_MATERIA"];$idg=$row["ID_GRUPOSA"];
			$sqlg="SELECT nombre FROM grupos_a WHERE id_gruposa='$idg'";
			$resultg=mysqli_query($conexion, $sqlg);
			$rowg=mysqli_fetch_assoc($resultg);
			$sqlm="SELECT nombre FROM materias WHERE id_materia='$idm'";
			$resultm=mysqli_query($conexion, $sqlm);
			$rowm=mysqli_fetch_assoc($resultm);
			$output=$output . '<tr><td><font color="blue" size="2">' . $apelDoc . ', ' . $nombDoc . '</font></td><td><font color="blue" size="2">' . $rowg["nombre"] . '</font></td><td><font color="blue" size="2">' . $rowm["nombre"] . '</font></td></tr>';
		}
		$output=$output . '</table><br><p align="center"><b>Para realizar una nueva b&uacute;squeda,&nbsp;<a href="http://localhost/drupal/docente/programa/listados_programa">pulse aqu&iacute;</a></b></p>';	
	}else{
		$output='<br><br><p><font color="red"><b>Atenci&oacute;n</b></font></p>
		<p>Error en la b&uacute;squeda de informaci&oacute;n para el tutor "' . $_POST["Tutor"] . '"</p>';
		$output=$output . '<p>' . mysqli_error($conexion) . '</p>
		<br><p align="center"><b>Para volver al apartado "Listados de Programa Asignaturas",&nbsp;<a href="http://localhost/drupal/docente/programa/listados_programa">pulse aqu&iacute;</a></b></p>';
	}

}*/

mysqli_close($conexion);
return($output);
}/************************* end listados programa ********************/


/************************* alta programa ****************************/
function alta_programa(){	
$output="";
$conexion=bdexternaD();//516

if (!$_POST){
	$output='<form id="formAltaPrograma" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formAltaPrograma">
	<legend align="left"><SPAN style="text-align:top">Introducir datos de nueva Asingnatura</SPAN></legend>
        <br><br>
	<p align="center"><b>Datos relacionados con la ense&ntilde;anza de materias en una unidad por un docente</b></p>
	<p><SPAN style="text-align:center">&emsp;&nbsp;Seleccionar una Materia de la lista:
	<p align="center"><select name="Mat" required size="6">';//536
	$sql="SELECT nombre, id_materia FROM materias WHERE id_materia IN (SELECT id_materia FROM asignar_materia)";
	$result=mysqli_query($conexion, $sql);
	
	if (mysqli_num_rows($result) > 0){
		$cont=0;
		while($row=mysqli_fetch_assoc($result)){
				$output= $output . '<option>' . $row["nombre"] . '</option>';
				$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$lista="Lista sin datos asignaturas";  $output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}
	$output=$output . '</select></p>
	</fieldset>
	</p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($error){
		$output=$output . '<input type="submit" value="Siguiente" name="Siguiente1" style="font-weight:bold; color:black" disabled>';  
	}else{
		$output=$output .'<input type="submit" value="Siguiente" name="Siguiente1" style="font-weight:bold; color:black">';  
	}
	$output=$output . '</p></form>';
 }elseif (isset($_POST["Siguiente1"])){
	//buscar grupo y unidad e idmateria
	$matNomb=$_POST["Mat"];
	$output='<form id="formAltaPrograma1" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formAltaPrograma1">
	<legend align="left"><SPAN style="text-align:top">Introducir datos de nueva Asignatura</SPAN></legend>
        <br><br>
	<p align="center"><b>Materia:</b>&nbsp;<input type="text" name="Mat" value="' . $_POST["Mat"] . '" disabled size="30%"></p>
	<p><SPAN style="text-align:center">&emsp;&nbsp;Seleccionar una Unidad de la lista:
	<p align="center"><select name="Unid" required size="6">';//536
	//seleccionar unidad
	$sqlm="SELECT id_materia FROM materias WHERE nombre='$matNomb'";
	$rowm=mysqli_fetch_assoc(mysqli_query($conexion, $sqlm));
	$idMat=$rowm["id_materia"];
	$sqlu="SELECT nombre FROM grupos_a WHERE id_curso IN (SELECT id_curso FROM asignar_materia WHERE id_materia='$idMat' )";
	$resultu=mysqli_query($conexion, $sqlu);
	if (mysqli_num_rows($resultu) > 0){
		$cont=0;
		while($rowu=mysqli_fetch_assoc($resultu)){
				$output= $output . '<option>' . $rowu["nombre"] . '</option>';
				$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$lista="Lista sin datos unidades";  $output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}
	$output=$output . '</select></p>
	</fieldset>
	</p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($error){
		$output=$output . '<input type="submit" value="Siguiente" name="Siguiente2" style="font-weight:bold; color:black" disabled>';  
	}else{
		$output=$output .'<input type="submit" value="Siguiente" name="Siguiente2" style="font-weight:bold; color:black">';  
	}
	$output=$output . '</p>
	<input type="hidden" name="Mat" value="' . $_POST["Mat"] . '"><input type="hidden" name="idMat" value="' . $idMat . '"></form>';

}elseif (isset($_POST["Siguiente2"])){
	$unidad=$_POST["Unid"];
	$sqlu="SELECT id_curso FROM grupos_a WHERE nombre='$unidad'";
	$rowu=mysqli_fetch_assoc(mysqli_query($conexion, $sqlu));
	$idCur=$rowu["id_curso"];//601
	$sqlc="SELECT id_ciclo FROM cursos WHERE id_curso='$idCur'";
	$rowc=mysqli_fetch_assoc(mysqli_query($conexion, $sqlc));
	switch ($rowc["id_ciclo"]){
		case "3":
			$docente="maestro/a";
			break;
		case "4":
			$docente="maestro/a";
			break;
		case "5":
			$docente="profesor/a";
			break;
		case "6":
			$docente="profesor/a";
			break;
		case "7":
			$docente="profesor/a";
			break;
	}
	//buscar docente
	$output='<form id="formAltaPrograma2" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formAltaPrograma2">
	<legend align="left"><SPAN style="text-align:top">Introducir datos de nueva Asingnatura</SPAN></legend>
        <br><br>
	<p align="center"><b>Materia:</b>&nbsp;<input type="text" name="Mat" value="' . $_POST["Mat"] . '" disabled size="30%"></p>
	<p align="center"><b>Unidad:</b>&nbsp;<input type="text" name="Unid" value="' . $_POST["Unid"] . '" disabled size="50%"></p>
	<p><SPAN style="text-align:center">&emsp;&nbsp;Seleccionar un ' . $docente . ' de la lista:</p>
	<p align="center"><select name="Doc" required size="6">';
	$sqld="SELECT nombre, apellidos FROM docentes WHERE tipo_d='$docente'";
	$resultd=mysqli_query($conexion, $sqld);
	if (mysqli_num_rows($resultd) > 0){//633
		$cont=0;
		while($rowd=mysqli_fetch_assoc($resultd)){
				$output= $output . '<option>' . $rowd["apellidos"] . ', ' . $rowd["nombre"] . '</option>';
				$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$lista="Lista sin datos docentes";  $output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}
	$output=$output . '</select></p>
	<p align="center">Docente tutor de la unidad:&nbsp;&nbsp;<input type="radio" value="1" name="Tutor">&nbsp;&nbsp;S&iacute;
	&nbsp;&nbsp;<input type="radio" value="0" name="Tutor" checked>&nbsp;&nbsp;No</p>
	</fieldset>
	</p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($error){
		$output=$output . '<input type="submit" value="Grabar" name="Grabar" style="font-weight:bold; color:black" disabled>';  
	}else{
		$output=$output .'<input type="submit" value="Grabar" name="Grabar" style="font-weight:bold; color:black">';  
	}
	$output=$output . '</p>
	<input type="hidden" name="Mat" value="' . $_POST["Mat"] . '"><input type="hidden" name="idMat" value="' .  $_POST["idMat"] . '">
	<input type="hidden" name="Unid" value="' . $_POST["Unid"] . '"></form>';
}elseif (isset($_POST["Grabar"])){
	$docente=$_POST["Doc"];
	//id_unidad 
	$nombUni=$_POST["Unid"];
	$sqlu="SELECT id_gruposa FROM grupos_a WHERE nombre='$nombUni'";
	$rowu=mysqli_fetch_assoc(mysqli_query($conexion, $sqlu));
	$idg=$rowu["id_gruposa"];
	//id_docente
	$nombre=substr($_POST["Doc"], (strpos($_POST["Doc"], ",")+1));
	$long=strlen($nombre);
	$nombre=ltrim($nombre);
	$apellidos=substr($_POST["Doc"], 0, -($long+1));
	$apellidos=ltrim($apellidos);
	$sqld="SELECT id_docentes FROM docentes WHERE nombre='$nombre' AND apellidos='$apellidos'";
	$rowd=mysqli_fetch_assoc(mysqli_query($conexion, $sqld));
	$idd=$rowd["id_docentes"];
	//id_materia
	$idmateria=$_POST["idMat"];
	//tutor
	$tutor=$_POST["Tutor"];
	//grabar
	$sql="INSERT INTO asignaturas (ID_MATERIA, ID_DOCENTE, ID_GRUPOSA, TUTOR) VALUES ('$idmateria', '$idd', '$idg', '$tutor')";//680
	if (mysqli_query($conexion, $sql)){
		$output='<p align="center"><b>Alta de nueva Asignatura</b></p>
		<p align="left">Se ha realizado satisfactoriamente el nuevo alta para la siguiente Asignatura:</p>
		<p><b>Materia:&nbsp;</b>' . $_POST["Mat"] . '</p>
		<p><b>Unidad:&nbsp;</b>' .  $_POST["Unid"] . '</p>
		<p><b>Docente:&nbsp;</b>' .  $_POST["Doc"] . '</p>
		<p><b>Tutor:&nbsp;</b>';
		if  ($_POST["Tutor"]==0){
			$output=$output . 'No';
		}else{
			$output=$output . 'S&iacute;';
		}
		$output=$output . '</p>
		<br>
		<p align="center"><b>Para realizar un nuevo alta &nbsp;<a href="http://localhost/drupal/docente/programa/alta_programa">pulse aqu&iacute;.</b></p>';
	}else{
		$output='<p><b><font color="red">Error al realizar el alta del nuevo registro para los siguientes datos:</font></b></p>
		<p><b>Materia:&nbsp;</b>' . $_POST["Mat"] . '</p>
		<p><b>Unidad:&nbsp;</b>' .  $_POST["Unid"] . '</p>
		<p><b>Docente:&nbsp;</b>' .  $_POST["Doc"] . '</p>
		<p><b>Tutor:&nbsp;</b>';
		if  ($_POST["Tutor"]==0){
			$output=$output . 'No';
		}else{
			$output=$output . 'S&iacute;';
		}
		$output=$output . '</p>
		<p align="center">' . mysqli_error($conexion) . '</p>
		<br>
		<p align="center"><b>Para volver al apartado "Alta Programa Asignaturas",&nbsp;<a href="http://localhost/drupal/docente/programa/alta_programa">pulse aqu&iacute;.</b></p>';
	}
}


mysqli_close($conexion);
return($output);
}/**************************** end alta programa **************************/


/************************* baja programa *********************************/
function baja_programa(){	
$output="";
$conexion=bdexternaD();//516

if (!$_POST){
	$output='<form id="formBajaPrograma" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formBajaPrograma">
	<legend align="left"><SPAN style="text-align:top">Eliminar datos de Asignaturas</SPAN></legend>
        <br><br>
	<p align="center"><b>Datos relacionados con la ense&ntilde;anza de materias en una unidad por un docente</b></p>
	<p><SPAN style="text-align:center">&emsp;&nbsp;Seleccionar una Materia de la lista:
	<p align="center"><select name="Mat" required size="6">';//536
	$sql="SELECT nombre FROM materias WHERE id_materia IN (SELECT id_materia FROM asignaturas)";
	$result=mysqli_query($conexion, $sql);
	
	if (mysqli_num_rows($result) > 0){
		$cont=0;
		while($row=mysqli_fetch_assoc($result)){
				$output= $output . '<option>' . $row["nombre"] . '</option>';
				$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$lista="Lista sin datos asignaturas";  $output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}
	$output=$output . '</select></p>
	</fieldset>
	</p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($error){
		$output=$output . '<input type="submit" value="Siguiente" name="Siguiente1" style="font-weight:bold; color:black" disabled>';  
	}else{
		$output=$output .'<input type="submit" value="Siguiente" name="Siguiente1" style="font-weight:bold; color:black">';  
	}
	$output=$output . '</p></form>';
}elseif (isset($_POST["Siguiente1"])){
	//buscar grupo y unidad e idmateria
	$matNomb=$_POST["Mat"];
	$output='<form id="formBajaPrograma1" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formBajaPrograma1">
	<legend align="left"><SPAN style="text-align:top">Eliminar datos de Asingnaturas</SPAN></legend>
        <br><br>
	<p align="center"><b>Materia:</b>&nbsp;<input type="text" name="Mat" value="' . $_POST["Mat"] . '" disabled size="30%"></p>
	<p><SPAN style="text-align:center">&emsp;&nbsp;Seleccionar una Unidad de la lista:
	<p align="center"><select name="Unid" required size="6">';//536
	//seleccionar unidad
	$sqlm="SELECT id_materia FROM materias WHERE nombre='$matNomb'";
	$rowm=mysqli_fetch_assoc(mysqli_query($conexion, $sqlm));
	$idMat=$rowm["id_materia"];
	$sqlu="SELECT nombre FROM grupos_a WHERE id_gruposa IN (SELECT id_gruposa FROM asignaturas WHERE id_materia='$idMat' )";
	$resultu=mysqli_query($conexion, $sqlu);
	if (mysqli_num_rows($resultu) > 0){
		$cont=0;
		while($rowu=mysqli_fetch_assoc($resultu)){
				$output= $output . '<option>' . $rowu["nombre"] . '</option>';
				$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$lista="Lista sin datos unidades";  $output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}
	$output=$output . '</select></p>
	</fieldset>
	</p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($error){
		$output=$output . '<input type="submit" value="Siguiente" name="Siguiente2" style="font-weight:bold; color:black" disabled>';  
	}else{
		$output=$output .'<input type="submit" value="Siguiente" name="Siguiente2" style="font-weight:bold; color:black">';  
	}
	$output=$output . '</p>
	<input type="hidden" name="Mat" value="' . $_POST["Mat"] . '"><input type="hidden" name="idMat" value="' . $idMat . '"></form>';

}elseif (isset($_POST["Siguiente2"])){
	$unidad=$_POST["Unid"];
	$sqlu="SELECT id_gruposa FROM grupos_a WHERE nombre='$unidad'";
	$rowu=mysqli_fetch_assoc(mysqli_query($conexion, $sqlu));
	$idUnid=$rowu["id_gruposa"];//601
	$idm=$_POST["idMat"];
	//buscar docente
	$output='<form id="formBajaPrograma2" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formBajaPrograma2">
	<legend align="left"><SPAN style="text-align:top">Eliminar datos de Asignaturas</SPAN></legend>
        <br><br>
	<p align="center"><b>Materia:</b>&nbsp;<input type="text" name="Mat" value="' . $_POST["Mat"] . '" disabled size="30%"></p>
	<p align="center"><b>Unidad:</b>&nbsp;<input type="text" name="Unid" value="' . $_POST["Unid"] . '" disabled size="50%"></p>
	<p align="center"><b>Docente que ense&ntilde;a:</b>&nbsp;';
	$sqld="SELECT nombre, apellidos FROM docentes WHERE id_docentes IN (SELECT id_docente FROM asignaturas WHERE id_materia='$idm' AND id_gruposa='$idUnid')";
	$rowd=mysqli_fetch_assoc(mysqli_query($conexion, $sqld));
	$output= $output . '<input type="text" name="Doc" value="' . $rowd["apellidos"] . ', ' . $rowd["nombre"] . '" disabled size="50%"></p>';
	$sqlt="SELECT id_docente, tutor FROM asignaturas WHERE id_materia='$idm' AND id_gruposa='$idUnid'";
	$rowt=mysqli_fetch_assoc(mysqli_query($conexion, $sqlt));
	if ($rowt["tutor"]==1){
		$output=$output . '<p align="center">El docente es tutor de la unidad.</p>
		<input type="hidden" name="tutor" value="' . $rowt["tutor"] . '">';
	}else{
		$output=$output . '<input type="hidden" name="tutor" value="' . $rowt["tutor"] . '">';
	}
			
	$output=$output . '</fieldset>
	</p>
	<p><input type="submit" value="Eliminar" name="Eliminar"style="font-weight:bold; color:black"></p>
	<input type="hidden" name="Mat" value="' . $_POST["Mat"] . '"><input type="hidden" name="idMat" value="' .  $_POST["idMat"] . '">
	<input type="hidden" name="Unid" value="' . $_POST["Unid"] . '"><input type="hidden" name="idUnid" value="' . $idUnid. '">
	<input type="hidden" name="idDoc" value="' . $rowt["id_docente"] . '"><input type="hidden" name="Doc" value="' . $rowd["apellidos"] . ', ' . $rowd["nombre"] . '">
	</form>';

}elseif (isset($_POST["Eliminar"])){//4291
	$output='<form id="formConfirmarBajaProg" action="" method="post" accept-charset="UTF-8">
	<p>
	<fieldset form="formConfirmarBajaProg">
	<legend align="left"><SPAN style="text-align:top">Confirmar Baja</SPAN></legend>
        <br><br><p align="center"> Seguro que desea dar de baja el registro de asignatura seleccionada</p>
	<p align="center">Materia:&nbsp;<b>' . $_POST["Mat"] . '</b></p><p align="center">Unidad:&nbsp;<b>' . $_POST["Unid"] . '</b></p><p align="center">Docente:&nbsp;<b>' . $_POST["Doc"] . '</b></p>';
	if ($_POST["tutor"]==1){
		$output=$output . '<p align="center">Tutor: <b>S&iacute;</b></p><input type="hidden" name="tutor" value="' . $_POST["tutor"] . '">';
	}else{
		$output=$output . '<p align="center">Tutor: <b>No</b></p><input type="hidden" name="tutor" value="' . $_POST["tutor"] . '">';
	}
	$output=$output . '<br><p align="center"><input type="submit" value="Aceptar" name="Aceptar" style="font-weight:bold; color:black">&emsp;
	<input type="submit" name="Cancelar" value="Cancelar" style="font-weight:bold; color:black">
	</p></fieldset></p>
	<input type="hidden" name="Mat" value="' . $_POST["Mat"] . '"><input type="hidden" name="idMat" value="' .  $_POST["idMat"] . '">
	<input type="hidden" name="Unid" value="' . $_POST["Unid"] . '"><input type="hidden" name="idUnid" value="' . $_POST["idUnid"] . '">
	<input type="hidden" name="idDoc" value="' . $_POST["idDoc"] . '"><input type="hidden" name="Doc" value="' .  $_POST["Doc"] . '">';
	$output=$output . '</form>';
}else{
	if (isset($_POST["Aceptar"])){
		$idm=$_POST["idMat"];$idd=$_POST["idDoc"];$idg=$_POST["idUnid"];
		//$sql="DELETE FROM asignaturas WHERE id_docente='$idd' AND id_materia='$idm' AND id_gruposa='$idg'";
		//if(mysqli_query($conexion, $sql)){	
			$output= '<p><b>La asignatura seleccionada se ha borrado satisfactoriamente con los datos:</b></p>
			<p>Materia:&nbsp;<b>' . $_POST["Mat"] . '</b></p> 
			<p>Unidad:&nbsp;<b>' . $_POST["Unid"] . '</b></p>
			<p>Docente:&nbsp;<b>' . $_POST["Doc"] . '</b></p>';
			if ($_POST["tutor"]==1){
				$output=$output . '<p>Tutor:&nbsp;<b>S&iacute;</b></p>';
			}else{
				$output=$output . '<p>Tutor:&nbsp;<b>No</b></p>';
			}
			$output=$output . '<br><br>';
			$output=$output . '<p align="center">Si desea eliminar otra asignatura&nbsp;<a href="http://localhost/drupal/docente/programa/baja_programa">pulse aqu&iacute;</a></p>';		
		//}
		//else{
		//	$output='<p><b>Error al eliminar el registro de asisgnatura</p>';
		//	$output=$output . '<p>'. mysqli_error($conexion) . '</p>';
		//}
	}else{
	
		$output='<br><b><p>Operaci&oacute;n de eliminar asignatura ha sido cancelada.</b><br>
		<p>Materia:&nbsp;<b>' . $_POST["Mat"] . '</b></p><p>Unidad:&nbsp;<b>' . $_POST["Unid"] . '</b></p><p>Docente:&nbsp;<b>' . $_POST["Doc"] . '</b></p>';
		if ($_POST["tutor"]==1){
			$output=$output . '<p>Tutor: <b>S&iacute;</b></p>';
		}else{
			$output=$output . '<p>Tutor: <b>No</b></p>';
		}
		$output=$output . '<br>
		<p align="center">Si desea volver al apartado "Baja Programa Asignaturas"&nbsp;<a href="http://localhost/drupal/docente/programa/baja_programa">pulse aqu&iacute;</a></p>'; 

	}
}
mysqli_close($conexion);
return($output);
}/**************************** end baja programa ***************************/


/****************************** modificar programa *************************/
function modificar_programa(){	
$output="";
$conexion=bdexternaD();

if (!$_POST){
	$output='<form id="formModPrograma" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formBModPrograma">
	<legend align="left"><SPAN style="text-align:top">Cambiar datos de Asignaturas</SPAN></legend>
        <br><br>
	<p align="center"><b>Datos relacionados con la ense&ntilde;anza de materias en una unidad por un docente</b></p>
	<p><SPAN style="text-align:center">&emsp;&nbsp;Seleccionar una Materia de la lista:
	<p align="center"><select name="Mat" required size="6">';//536
	$sql="SELECT nombre FROM materias WHERE id_materia IN (SELECT id_materia FROM asignaturas)";
	$result=mysqli_query($conexion, $sql);
	if (mysqli_num_rows($result) > 0){
		$cont=0;
		while($row=mysqli_fetch_assoc($result)){
				$output= $output . '<option>' . $row["nombre"] . '</option>';
				$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$lista="Lista sin datos asignaturas";  $output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}
	$output=$output . '</select></p>
	</fieldset>
	</p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($error){
		$output=$output . '<input type="submit" value="Siguiente" name="Siguiente1" style="font-weight:bold; color:black" disabled>';  
	}else{
		$output=$output .'<input type="submit" value="Siguiente" name="Siguiente1" style="font-weight:bold; color:black">';  
	}
	$output=$output . '</p></form>';
}elseif (isset($_POST["Siguiente1"])){
	//buscar grupo y unidad e idmateria
	$matNomb=$_POST["Mat"];
	$output='<form id="formModPrograma1" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formModPrograma1">
	<legend align="left"><SPAN style="text-align:top">Cambiar datos de Asignaturas</SPAN></legend>
        <br><br>
	<p align="center"><b>Materia:</b>&nbsp;<input type="text" name="Mat" value="' . $_POST["Mat"] . '" disabled size="30%"></p>
	<p><SPAN style="text-align:center">&emsp;&nbsp;Seleccionar una Unidad de la lista:
	<p align="center"><select name="Unid" required size="6">';//536
	//seleccionar unidad
	$sqlm="SELECT id_materia FROM materias WHERE nombre='$matNomb'";
	$rowm=mysqli_fetch_assoc(mysqli_query($conexion, $sqlm));
	$idMat=$rowm["id_materia"];
	$sqlu="SELECT nombre FROM grupos_a WHERE id_gruposa IN (SELECT id_gruposa FROM asignaturas WHERE id_materia='$idMat' )";
	$resultu=mysqli_query($conexion, $sqlu);
	if (mysqli_num_rows($resultu) > 0){
		$cont=0;
		while($rowu=mysqli_fetch_assoc($resultu)){
				$output= $output . '<option>' . $rowu["nombre"] . '</option>';
				$cont=$cont+1;
		}
		if ($cont>0){
			$error=false;
		}
	}
	else{
		$lista="Lista sin datos unidades";  $output= $output . '<option selected>' . $lista . '</option>';
		$error=true;
	}
	$output=$output . '</select></p>
	<p>&emsp;&nbsp;Tipo de modificaciones:&nbsp;<p align="center"><select name="Cambios" required size="3">
	<option selected>Docente</option><option>Tutor</option><option>Ambos cambios</option></select></p></p>
	</fieldset>
	</p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($error){
		$output=$output . '<input type="submit" value="Siguiente" name="Siguiente2" style="font-weight:bold; color:black" disabled>';  
	}else{
		$output=$output .'<input type="submit" value="Siguiente" name="Siguiente2" style="font-weight:bold; color:black">';  
	}
	$output=$output . '</p>
	<input type="hidden" name="Mat" value="' . $_POST["Mat"] . '"><input type="hidden" name="idMat" value="' . $idMat . '"></form>';

}elseif (isset($_POST["Siguiente2"])){
	$unidad=$_POST["Unid"];
	$sqlu="SELECT id_curso FROM grupos_a WHERE nombre='$unidad'";
	$rowu=mysqli_fetch_assoc(mysqli_query($conexion, $sqlu));
	$idCur=$rowu["id_curso"];//601
	$sqlc="SELECT id_ciclo FROM cursos WHERE id_curso='$idCur'";
	$rowc=mysqli_fetch_assoc(mysqli_query($conexion, $sqlc));
	switch ($rowc["id_ciclo"]){
		case "3":
			$docente="maestro/a";
			break;
		case "4":
			$docente="maestro/a";
			break;
		case "5":
			$docente="profesor/a";
			break;
		case "6":
			$docente="profesor/a";
			break;
		case "7":
			$docente="profesor/a";
			break;
	}
	
	$sqlu="SELECT id_gruposa FROM grupos_a WHERE nombre='$unidad'";
	$rowu=mysqli_fetch_assoc(mysqli_query($conexion, $sqlu));
	$idUnid=$rowu["id_gruposa"];
	$idm=$_POST["idMat"];
	$output='<form id="formModPrograma2" action="" method="post" accept-charset="UTF-8" size="100%">
	<p>
	<fieldset form="formModPrograma2">
	<legend align="left"><SPAN style="text-align:top">Cambiar datos de Asignaturas</SPAN></legend>
        <br><br>
	<p align="center"><b>Materia:</b>&nbsp;<input type="text" name="Mat" value="' . $_POST["Mat"] . '" disabled size="30%"></p>
	<p align="center"><b>Unidad:</b>&nbsp;<input type="text" name="Unid" value="' . $_POST["Unid"] . '" disabled size="50%"></p>';//988
	$error=false;
	$sqlt="SELECT tutor, id_docente FROM asignaturas WHERE id_materia='$idm' AND id_gruposa='$idUnid'";
	$rowt=mysqli_fetch_assoc(mysqli_query($conexion, $sqlt));
	if (($_POST["Cambios"]=="Docente") || ($_POST["Cambios"]=="Ambos cambios")){
		$sqld="SELECT nombre, apellidos FROM docentes WHERE id_docentes IN (SELECT id_docente FROM asignaturas WHERE id_materia='$idm' AND id_gruposa='$idUnid')";
		$rowd=mysqli_fetch_assoc(mysqli_query($conexion, $sqld));
		$nombD=$rowd["nombre"];$apeD=$rowd["apellidos"];	
		$sql="SELECT nombre, apellidos FROM docentes WHERE tipo_d='$docente' AND nombre<>'$nombD' AND apellidos<>'$apeD'";
		$output=$output . '<p align="center"><b>Docente:</b>&nbsp;<input type="text" name="Doc" value="' . $rowd["apellidos"] . ', ' . $rowd["nombre"] . '" disabled size="50%"></p>
		<p>&emsp;&nbsp;Cambio de ' . $docente . ' seleccionar uno de la lista:<p align="center"><select name="DocNuevo" required size="6">';
		$result=mysqli_query($conexion, $sql);
		if (mysqli_num_rows($result) > 0){
			$cont=0;
			while($row=mysqli_fetch_assoc($result)){
				$output= $output . '<option>' . $row["apellidos"] . ', ' . $row["nombre"] . '</option>';
				$cont=$cont+1;
			}
			if ($cont>0){
				$error=false;
			}
		}
		else{
			$lista="Lista sin datos docentes";  $output= $output . '<option selected>' . $lista . '</option>';
			$error=true;
		}
		$output=$output .'</select></p></p>';
		if ($_POST["Cambios"]=="Ambos cambios"){
			if ($rowt["tutor"]==0){
				$output=$output . '<p align="center">&emsp;&nbsp;Docente tutor de la unidad:&nbsp;&nbsp;<input type="radio" value="1" name="Tutor">&nbsp;&nbsp;S&iacute;
				&nbsp;&nbsp;<input type="radio" value="0" name="Tutor" checked>&nbsp;&nbsp;No</p>';
			}else{
				$output=$output . '<p align="center">&emsp;&nbsp;Docente tutor de la unidad:&nbsp;&nbsp;<input type="radio" value="1" name="Tutor" checked>&nbsp;&nbsp;S&iacute;
				&nbsp;&nbsp;<input type="radio" value="0" name="Tutor">&nbsp;&nbsp;No</p>';
			}
		}else{
			$output=$output .'<input type="hidden" name="Tutor" value="' . $rowt["tutor"] . '">';
		}
		
	}elseif ($_POST["Cambios"]=="Tutor"){//1052
		if ($_POST["Cambios"]=="Tutor"){
			$sqld="SELECT nombre, apellidos FROM docentes WHERE id_docentes IN (SELECT id_docente FROM asignaturas WHERE id_materia='$idm' AND id_gruposa='$idUnid')";
			$rowd=mysqli_fetch_assoc(mysqli_query($conexion, $sqld));
			$output=$output . '<p align="center"><b>Docente:</b>&nbsp;<input type="text" name="Doc" value="' . $rowd["apellidos"] . ', ' . $rowd["nombre"] . '" disabled size="50%"></p>';
		}//1044
		$output=$output . '<p align="center">&emsp;&nbsp;Docente tutor de la unidad:&nbsp;&nbsp;';
		if ($rowt["tutor"]==0){
			$output=$output . '<input type="radio" value="1" name="Tutor">&nbsp;&nbsp;S&iacute;
			&nbsp;&nbsp;<input type="radio" value="0" name="Tutor" checked>&nbsp;&nbsp;No';
		}else{
			$output=$output . '<input type="radio" value="1" name="Tutor" checked>&nbsp;&nbsp;S&iacute;
			&nbsp;&nbsp;<input type="radio" value="0" name="Tutor">&nbsp;&nbsp;No';
		}
		$output=$output . '</p>';
	}
	$output=$output . '</fieldset></p>
	<p><input type="reset" value="Limpiar" style="font-weight:bold; color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	if ($error){
		$output=$output . '<input type="submit" value="Grabar" name="Grabar" style="font-weight:bold; color:black" disabled>';  
	}else{
		$output=$output . '<input type="submit" value="Grabar" name="Grabar" style="font-weight:bold; color:black">';  
	}
	$output=$output .'</p>
	<input type="hidden" name="Mat" value="' . $_POST["Mat"] . '"><input type="hidden" name="idMat" value="' . $_POST["idMat"] . '">
	<input type="hidden" name="Doc" value="' . $rowd["apellidos"] . ', ' . $rowd["nombre"] . '"><input type="hidden" name="idUnid" value="' . $idUnid . '">
	<input type="hidden" name="Unid" value="' . $_POST["Unid"] . '"><input type="hidden" name="Cambios" value="' . $_POST["Cambios"] . '"></form>';
}elseif (isset($_POST["Grabar"])){
	$nombre=substr($_POST["DocNuevo"], (strpos($_POST["DocNuevo"], ",")+1));
	$long=strlen($nombre);
	$nombre=ltrim($nombre);
	$apellidos=substr($_POST["DocNuevo"], 0, -($long+1));
	$apellidos=ltrim($apellidos);
	$sqlnd="SELECT id_docentes FROM docentes WHERE nombre='$nombre' AND apellidos='$apellidos'";
	$rownd=mysqli_fetch_assoc(mysqli_query($conexion, $sqlnd));
	$idnd=$rownd["id_docentes"];
	$output='<p align="center"><b>El registro de modificar asignatura se ha realizado satisfactoriamente.</b></p>
	<p><em>Datos actualizados</em></p>
	<p>Materia:&nbsp;<b>' . $_POST["Mat"] . '</b></p> 
	<p>Unidad:&nbsp;<b>' . $_POST["Unid"] . '</b></p>';	
	$idm=$_POST["idMat"];$idu=$_POST["idUnid"];$tutor=$_POST["Tutor"];	
	if ($_POST["Cambios"]=="Docente"){
		$output=$output . '<p>Cambio Docente:&nbsp;<b>' . $_POST["DocNuevo"] . '</b></p>';
		if ($_POST["Tutor"]==1){
			$output=$output . '<p>Tutor:&nbsp;<b>S&iacute;</b></p>';
		}else{
			$output=$output . '<p>Tutor:&nbsp;<b>No</b></p>';
		}
		$sql="UPDATE asignaturas SET id_docente='$idnd' WHERE ID_MATERIA='$idm' AND ID_GRUPOSA='$idu'";
	}elseif ($_POST["Cambios"]=="Tutor"){
		$output=$output . '<p>Docente:&nbsp;<b>' . $_POST["Doc"] . '</b></p>';
		if ($_POST["Tutor"]==1){
			$output=$output . '<p>Cambio Tutor:&nbsp;<b>S&iacute;</b></p>';
		}else{
			$output=$output . '<p>Cambio Tutor:&nbsp;<b>No</b></p>';
		}
		$sql="UPDATE asignaturas SET TUTOR='$tutor' WHERE ID_MATERIA='$idm' AND ID_GRUPOSA='$idu'";
	}else{
		$output=$output . '<p>Cambio Docente:&nbsp;<b>' . $_POST["DocNuevo"] . '</b></p>';
		if ($_POST["Tutor"]==1){
			$output=$output . '<p>Cambio Tutor:&nbsp;<b>S&iacute;</b></p>';
		}else{
			$output=$output . '<p>Cambio Tutor:&nbsp;<b>No</b></p>';
		}
		$sql="UPDATE asignaturas SET TUTOR='$tutor', id_docente='$idnd' WHERE ID_MATERIA='$idm' AND ID_GRUPOSA='$idu'";
	}
	//grabar datos
	if (mysqli_query($conexion, $sql)){
		$output=$output . '<br>
		<p align="center">Si desea modificar otra asignatura&nbsp;<a href="http://localhost/drupal/docente/programa/modificar_programa">pulse aqu&iacute;</a></p>';
	}else{//1123
		$output='<p><b><font color="red">Error al realizar la actualizaci&oacute;n del registro de asignatura para:</font></b></p>
		<p><b>Materia:&nbsp;</b>' . $_POST["Mat"] . '</p>
		<p><b>Unidad:&nbsp;</b>' .  $_POST["Unid"] . '</p>
		<p align="center">' . mysqli_error($conexion) . '</p>
		<br>
		<p align="center"><b>Para volver al apartado "Modificar Programa Asignaturas",&nbsp;<a href="http://localhost/drupal/docente/programa/alta_programa">pulse aqu&iacute;.</b></p>';
	}
}

mysqli_close($conexion);//4571
return($output);
}/**************************end modificar programa **********************/


/*********************************************************************/
/********************** Tablon de Guardias ***************************/
/*********************************************************************/
function guardias(){

$output='<form id="formGuardias" action="" method="post" accept-charset="UTF-8" size="100%">
	<fieldset form="formGuardias">
	<legend align="left"><SPAN style="text-align:top">Ver Tabl&oacute;n</SPAN></legend>
	<br><br>
	<p align="center">Hacer clic en el icono pdf para visualizarlo&nbsp;&nbsp;<a href="http://localhost/drupal/sites/default/files/calendario_huelva.pdf" target="_blank">
	<img align="bottom" src="/drupal/sites/all/modules/colegio/docente/file/descarga.jpg" style="width: 40px; height: 40px;"/></a>
	</p>
	</fieldset>
	</form>';
return($output);
}/********************** end tablón de guardias **************************/



/*************************************************************************/
/******************************* Tutorías ********************************/
/*************************************************************************/

function listados_tutorias(){

$output = '<p>' . t('M&oacute;dulo que permite la inserción de mensajes de feedback.') . '</p>';

return($output);
}

function alta_tutorias(){

$output='tutorias b';

return($output);
}
function baja_tutorias(){

$output='tutorias b';

return($output);
}
function modificar_tutorias(){

$output='tutorias b';

return($output);
}
